"use strict";function uploadparser(e){this.buffer_parser.write(e)}function uploadparser_done(){!this.buffer_exceeded&&(this.$upload=!0),this.buffer_parser.end()}function parse_multipart_header(e){var r=new Array(2),t=' name="',n=t.length,i=e.indexOf(t),a="";return-1!==i&&(a=e.substring(i+n,e.indexOf('"',i+n))),a?r[0]=a:r[0]="undefined_"+Math.floor(1e5*Math.random()).toString(),t=' filename="',n=t.length,i=e.indexOf(t),a="",-1!==i&&(a=e.substring(i+n,e.indexOf('"',i+n))),a?r[1]=a:r[1]=null,r}function HttpFile(){this.name,this.filename,this.type,this.path,this.length=0,this.width=0,this.height=0,this.rem=!0}function compile_autovendor(e){var r="/*auto*/",t=-1!==e.substring(0,100).indexOf(r);return t&&(e=autoprefixer(e.replace(r,""))),e.replace(REG_CSS_1,"").replace(REG_CSS_2,"{").replace(REG_CSS_3,"}").replace(REG_CSS_4,":").replace(REG_CSS_5,";").replace(REG_CSS_6,function(e,r,t){for(var n=r;n>0;n--)if(("'"===t[n]||'"'===t[n])&&":"===t[n-1])return e;return","}).replace(REG_CSS_7,"}").replace(REG_CSS_8,"{").replace(REG_CSS_9,"}").trim()}function autoprefixer(e){e=autoprefixer_keyframes(e);for(var r,t=[],n=0,i=0,a=AUTOVENDOR.length;a>i;i++)for(r=AUTOVENDOR[i],n=0;-1!==n;)if(n=e.indexOf(r,n+1),-1!==n){var s=e.indexOf(";",n),o=e.indexOf("}",n),u=Math.min(s,o);if(-1===u&&(u=Math.max(s,o)),-1!==u){var l="-"===e.substring(n-1,n);if(!l){var c=e.substring(n,u);u=c.indexOf(":"),-1!==u&&c.substring(0,u+1).replace(/\s/g,"")===r+":"&&t.push({name:r,property:c})}}}for(var f=[],a=t.length,i=0;a>i;i++){var p=t[i].name;r=t[i].property;var d=r,g=";",h=d+g;if("opacity"!==p)if("font-smoothing"!==p)if("background"!==p&&"background-image"!==p)if("text-overflow"!==p)if("display"!==p)h+="-webkit-"+d+g,h+="-moz-"+d,-1===p.indexOf("animation")&&(h+=g+"-ms-"+d),e=e.replacer(r,"@[["+f.length+"]]"),f.push(h);else{if(-1===r.indexOf("box"))continue;h=d+g,h+=d.replacer("box","-webkit-box")+g,h+=d.replacer("box","-moz-box"),e=e.replacer(r,"@[["+f.length+"]]"),f.push(h)}else h=d+g,h+=d.replacer("text-overflow","-ms-text-overflow"),e=e.replacer(r,"@[["+f.length+"]]"),f.push(h);else-1!==r.indexOf("repeating-linear-gradient")?(h=d.replacer("repeating-linear-","-webkit-repeating-linear-")+g,h+=d.replacer("repeating-linear-","-moz-repeating-linear-")+g,h+=d.replacer("repeating-linear-","-ms-repeating-linear-")+g,h+=d,e=e.replacer(r,"@[["+f.length+"]]"),f.push(h)):-1!==r.indexOf("repeating-radial-gradient")?(h=d.replacer("repeating-radial-","-webkit-repeating-radial-")+g,h+=d.replacer("repeating-radial-","-moz-repeating-radial-")+g,h+=d.replacer("repeating-radial-","-ms-repeating-radial-")+g,h+=d,e=e.replacer(r,"@[["+f.length+"]]"),f.push(h)):-1!==r.indexOf("linear-gradient")?(h=d.replacer("linear-","-webkit-linear-")+g,h+=d.replacer("linear-","-moz-linear-")+g,h+=d.replacer("linear-","-ms-linear-")+g,h+=d,e=e.replacer(r,"@[["+f.length+"]]"),f.push(h)):-1!==r.indexOf("radial-gradient")&&(h=d.replacer("radial-","-webkit-radial-")+g,h+=d.replacer("radial-","-moz-radial-")+g,h+=d.replacer("radial-","-ms-radial-")+g,h+=d,e=e.replacer(r,"@[["+f.length+"]]"),f.push(h));else h=d+g,h+=d.replacer("font-smoothing","-webkit-font-smoothing")+g,h+=d.replacer("font-smoothing","-moz-osx-font-smoothing"),e=e.replacer(r,"@[["+f.length+"]]"),f.push(h);else{var m=+d.replace("opacity","").replace(":","").replace(/\s/g,"");if(isNaN(m))continue;h+="filter:alpha(opacity="+Math.floor(100*m)+")",e=e.replacer(r,"@[["+f.length+"]]"),f.push(h)}}a=f.length;for(var i=0;a>i;i++)e=e.replacer("@[["+i+"]]",f[i]);return f=null,t=null,e}function autoprefixer_keyframes(e){for(var r=[],t=0;-1!==t;)if(t=e.indexOf("@keyframes",t+1),-1!==t){for(var n=0,i=-1,a=t+10;a<e.length;a++)if("{"===e[a]&&n++,"}"===e[a]){if(!(n>1)){i=a;break}n--}if(-1!==i){var s=e.substring(t,i+1);r.push({name:"keyframes",property:s})}}for(var o=[],u=r.length,l=0;u>l;l++){var c=r[l].name,f=r[l].property;if("keyframes"===c){var p=f.substring(1),d="\n",g="@"+p+d;g+="@-webkit-"+p+d,g+="@-moz-"+p+d,g+="@-o-"+p+d,e=e.replacer(f,"@[["+o.length+"]]"),o.push(g)}}u=o.length;for(var l=0;u>l;l++)e=e.replace("@[["+l+"]]",o[l]);return e}function minify_javascript(e){for(var r,t,n,i,a=0,s=[],o=!1,u=!1,l=/[0-9a-z$]/i,c=/\W/,f={$:!0,_:!0},p=!1;;){var d=e[a],t=e[a-1],n=e[a+1];if(a++,void 0===d)break;if(!r){if(!p){if("/"===d&&"*"===n){o=!0;continue}if("*"===d&&"/"===n){o=!1,a++;continue}if(o)continue;if("/"===d&&"/"===n){u=!0;continue}if(u&&("\n"===d||"\r"===d)){u=!1,l.test(i)&&s.push(" "),i="";continue}if(u)continue}if("	"===d||"\n"===d||"\r"===d){if(!i||!l.test(i))continue;s.push(" "),i="";continue}if(!p&&" "===d&&(c.test(t)||c.test(n))&&!f[t]&&!f[n])continue;p?("\\"!==i&&"/"===d||"\\"===i&&"/"===d&&"\\"===s[s.length-2])&&(p=!1):p=("="===i||"("===i||":"===i||"{"===i||"["===i||"?"===i)&&"/"===d}if(r&&"\\"===d)s.push(d),s.push(n),a++,i=n;else{if(!p&&('"'===d||"'"===d||"`"===d)){if(r&&r!==d){s.push(d);continue}r=d===r?0:d}("}"===d&&";"===i||("}"===d||"]"===d)&&" "===s[s.length-1]&&l.test(s[s.length-2]))&&s.pop(),s.push(d),i=d}}return s.join("").trim()}function MultipartParser(){this.boundary=null,this.boundaryChars=null,this.lookbehind=null,this.state=S.PARSER_UNINITIALIZED,this.index=null,this.flags=0}function view_parse_localization(e,r){var t=!1;if(e=e.replace(REG_NOTRANSLATE,function(){return t=!0,""}).trim(),t)return e;var n=view_find_localization(e,0),i="",a=0;if(!n)return e;for(;n;)n&&(i+=e.substring(a?a+1:0,n.beg)+(n.command?localize(r,n):"")),a=n.end,n=view_find_localization(e,n.end);return i+=e.substring(a+1)}function localize(e,r){if(!e&&(e="default"),F.resources[e]&&F.resources[e].$empty)return r.command;var t=F.translate(e,r.command);if(r.escape)for(var n=0;;){if(n=t.indexOf(r.escape,n),-1===n)break;var i=t[n-1];"\\"!==i?(t=t.substring(0,n)+"\\"+t.substring(n),n++):n+=2}return t}function view_parse(e,r,t,n){function i(e){var r=REG_TAGREMOVE.test(e);return a&&(p||(p=!0,e=e.replace(/^\s+/,""))),e?(!a&&r&&(e+=" "),d=$VIEWCACHE.indexOf(e),-1===d&&(d=$VIEWCACHE.length,$VIEWCACHE.push(e)),"$VIEWCACHE["+d+"]"):"$EMPTY"}r&&(e=removeComments(e));var a=!1,s=!1,o=!1;e=e.replace(REG_NOCOMPRESS,function(e){var r=e.lastIndexOf(" ");if(-1===r)return"";switch(e.substring(r,e.length-1).trim()){case"all":a=!0,s=!0,o=!0;break;case"html":a=!0;break;case"js":case"script":case"javascript":s=!0;break;case"css":case"style":o=!0}return""}).trim(),s||(e=compressJS(e,0,t)),o||(e=compressCSS(e,0,t)),e=F.$versionprepare(e),a||(e=compressView(e,r,t));var u="'",l=" ",c="var $EMPTY='';var $length=0;var $source=null;var $tmp=index;var $output=$EMPTY",f=view_find_command(e,0),p=!1,d=-1,g=0;if((n.$hasComponents||REG_COMPONENTS.test(e))&&REG_HEAD.test(e)){g=e.indexOf("@{import(");for(var h=!0;-1!==g;){var m=e.substring(g,e.indexOf(")",g));if(-1!==m.indexOf("components")){h=!1;break}g=e.indexOf("@{import(",g+m.length)}h&&n.$hasComponents&&(e=n.$hasComponents instanceof Array?e.replace(REG_HEAD,function(e){for(var r="",t=0;t<n.$hasComponents.length;t++){var i=F.components.groups[n.$hasComponents[t]];i&&(r+=i.links)}return r+e}):e.replace(REG_HEAD,function(e){return F.components.links+e}))}f||(c+="+"+i(e)),g=0;for(var E,_=null,v="",S="",b=0,R=[],$=[],O=!1,x=!1,T=!1,y="",A="";f;){_?(E=e.substring(_.end+1,f.beg),E&&(view_parse_plus(c)&&(c+="+"),c+=i(E))):(E=e.substring(0,f.beg),E&&(view_parse_plus(c)&&(c+="+"),c+=i(E)));var w=e.substring(f.beg+2,f.end).trim(),C=w.substring(0,8),D=w.substring(0,7);if("continue"!==w&&"break"!==w){if(f.command=f.command.replace(REG_HELPERS,function(e){var r=e.indexOf("(");return-1===r?e:e.substring(0,r)+".call(self"+(e.endsWith("()")?")":","+e.substring(r+1))}),"'"===w[0]||'"'===w[0])if("%"===w[1]){var P=F.config[w.substring(2,w.length-1)];null!=P&&(c+="+"+u+P+u)}else c+="+"+u+new Function("self","return self.$import("+w[0]+"!"+w.substring(1)+")")(n)+u;else if("compile"===D&&-1===w.lastIndexOf(")"))y=c+"+(F.onCompileView.call(self,'"+(" "===C[7]?w.substring(8):"")+"',",c="",A=w.substring(8),T=!0,O=!0;else if("section "===C&&-1===w.lastIndexOf(")"))y=c,c="+(function(){var $output=$EMPTY",A=w.substring(8),x=!0,O=!0;else if("helper "===D)y=c,c="function "+w.substring(7).trim()+"{var $output=$EMPTY",O=!0,$.push(w.substring(7,w.indexOf("(",7)).trim());else if("foreach "===C)b++,-1!==w.indexOf("foreach var ")&&(w=w.replace(" var ",l)),w=view_prepare_keywords(w),v=(w.substring(8,w.indexOf(l,8))||"").trim(),g=w.trim().indexOf(l,v.length+10),-1===g&&(g=w.indexOf("[",v.length+10)),c+="+(function(){var $source="+w.substring(g).trim()+";if(!($source instanceof Array))$source=framework_utils.ObjectToArray($source);if(!$source.length)return $EMPTY;var $length=$source.length;var $output=$EMPTY;var index=0;for(var $i=0;$i<$length;$i++){index=$i;var "+v+"=$source[$i];$output+=$EMPTY";else if("end"===w)O&&0>=b?(b=0,T?(c=y+"unescape($EMPTY"+c+"),model) || $EMPTY)",y=""):x?(c=y+c+";repository['$section_"+A+"']=repository['$section_"+A+"']?repository['$section_"+A+"']+$output:$output;return $EMPTY})()",y=""):(c+=";return $output;}",R.push(c),c=y,y=""),x=!1,T=!1,O=!1):(b--,c+="}return $output;})()",v="");else if("if "===w.substring(0,3))c+=";if("+view_prepare_keywords(w).substring(3)+"){$output+=$EMPTY";else if("else if"===D)c+="} else if("+view_prepare_keywords(w).substring(7)+"){$output+=$EMPTY";else if("else"===w)c+="} else {$output+=$EMPTY";else if("endif"===w||"fi"===w)c+="}$output+=$EMPTY";else{S=view_prepare(f.command,v,$,n);var N=!1;if(RELEASE&&-1===S.indexOf("+")&&REG_SKIP_1.test(S)&&!REG_SKIP_2.test(S))for(var G=0,k=RENDERNOW.length;k>G;G++)if(S.startsWith(RENDERNOW[G])){if(!G){var M=-1!==S.indexOf("'meta'"),I=-1!==S.indexOf("'head'"),L=-1!==S.indexOf("'components'");if(S=S.replace(/'(meta|head|components)',/g,"").replace(/(,,|,\)|\s{1,})/g,""),M||I||L){var H="";M&&(H+=M?"'meta'":""),I&&(H+=(H?",":"")+(I?"'head'":"")),L&&(H+=(H?",":"")+(L?"'components'":"")),c+="+self.$import("+H+")"}}N=!0;break}if(N&&!b)try{var B=new Function("self","config","return "+S)(n,F.config).replace(REG_7,"\\\\").replace(REG_8,"\\'");B&&(d=$VIEWCACHE.indexOf(B),-1===d&&(d=$VIEWCACHE.length,$VIEWCACHE.push(B)),c+="+$VIEWCACHE["+d+"]")}catch(Y){F.errors.push({error:Y.stack,name:t,url:null,date:new Date}),view_parse_plus(c)&&(c+="+"),c+=wrapTryCatch(S,f.command,f.line)}else S&&(view_parse_plus(c)&&(c+="+"),c+=wrapTryCatch(S,f.command,f.line))}_=f,f=view_find_command(e,f.end)}else c+=";"+w+";",_=f,f=view_find_command(e,f.end)}_&&(E=e.substring(_.end+1),E&&(c+="+"+i(E))),RELEASE&&(c=c.replace(/(\+\$EMPTY\+)/g,"+").replace(/(\$output=\$EMPTY\+)/g,"$output=").replace(/(\$output\+=\$EMPTY\+)/g,"$output+=").replace(/(\}\$output\+=\$EMPTY)/g,"}").replace(/(\{\$output\+=\$EMPTY;)/g,"{").replace(/(\+\$EMPTY\+)/g,"+").replace(/(>'\+'<)/g,"><").replace(/'\+'/g,""));var U="(function(self,repository,model,session,query,body,url,global,helpers,user,config,functions,index,output,cookie,files,mobile,settings){var get=query;var post=body;var G=F.global;var R=this.repository;var M=model;var theme=this.themeName;var language=this.language;var sitemap=this.repository.$sitemap;var cookie=function(name){return self.req.cookie(name)};"+(R.length?R.join("")+";":"")+"var controller=self;"+c+";return $output;})";try{U=SUtilCommon.eval(U)}catch(Y){throw new Error(t+": "+Y.message.toString())}return U}function view_prepare_keywords(e){return e.replace(REG_SITEMAP,function(e){return" self."+e.trim()})}function wrapTryCatch(e,r,t){return F.isDebug?"(function(){try{return "+e+"}catch(e){throw new Error(unescape('"+escape(r)+"') + ' - Line: "+t+" - ' + e.message.toString());}return $EMPTY})()":e}function view_parse_plus(e){var r=e[e.length-1];return"!"!==r&&"?"!==r&&"+"!==r&&"."!==r&&":"!==r}function view_prepare(e,r,t,n){var i=e.indexOf("."),a=e.indexOf("("),s=e.indexOf("["),o=[],u=0;-1!==i&&o.push(i),-1!==a&&o.push(a),-1!==s&&o.push(s);var l=Math.min.apply(this,o);-1===l&&(l=e.length);var c=e.substring(0,l);if(c===r)return"$STRING("+e+").encode()";if("!"===c[0]&&c.substring(1)===r)return"$STRING("+e.substring(1)+")";switch(c){case"foreach":case"end":return"";case"section":return u=e.indexOf("("),-1===u?"":"(repository['$section_"+e.substring(u+1,e.length-1).replace(/'|"/g,"")+"'] || '')";case"log":case"LOG":return"("+("log"===c?"F.":"")+e+"?$EMPTY:$EMPTY)";case"logger":case"LOGGER":return"("+("logger"===c?"F.":"")+e+"?$EMPTY:$EMPTY)";case"console":return"("+e+"?$EMPTY:$EMPTY)";case"!cookie":return"$STRING("+e+")";case"!isomorphic":return"$STRING("+e+")";case"M":case"R":case"G":case"model":case"repository":case"get":case"post":case"query":case"global":case"session":case"user":case"config":case"controller":return view_is_assign(e)?"self.$set("+e+")":"$STRING("+e+").encode()";case"body":return view_is_assign(e)?"self.$set("+e+")":-1===e.lastIndexOf(".")?"output":"$STRING("+e+").encode()";case"files":case"mobile":case"continue":case"break":case"language":case"TRANSLATE":case"helpers":return e;case"cookie":case"isomorphic":case"settings":case"CONFIG":case"function":case"MODEL":case"SCHEMA":case"MODULE":case"functions":return"$STRING("+e+").encode()";case"!M":case"!R":case"!G":case"!controller":case"!repository":case"!get":case"!post":case"!body":case"!query":case"!global":case"!session":case"!user":case"!config":case"!functions":case"!model":case"!CONFIG":case"!SCHEMA":case"!function":case"!MODEL":case"!MODULE":return"$STRING("+e.substring(1)+")";case"resource":return"$STRING( self."+e+").encode()";case"RESOURCE":return"$STRING("+e+").encode()";case"!resource":return"$STRING( self."+e.substring(1)+")";case"!RESOURCE":return"$STRING("+e.substring(1)+")";case"host":case"hostname":return-1===e.indexOf("(")?"self.host()":"self."+e;case"href":return-1===e.indexOf("(")?"self.href()":"self."+e;case"url":return-1===e.indexOf("(")?"self."+e:"self.$"+e;case"title":case"description":case"keywords":case"author":return-1===e.indexOf("(")?"(repository['$"+e+"'] || '').toString().encode()":"self.$"+e;case"title2":return"self.$"+e;case"!title":case"!description":case"!keywords":case"!author":return"(repository['$"+e.substring(1)+"'] || '')";case"head":return-1===e.indexOf("(")?"self."+e+"()":"self.$"+e;case"sitemap_url":case"sitemap_name":case"sitemap_navigation":return"self."+e;case"sitemap":case"place":return-1===e.indexOf("(")?"(repository['$"+e+"'] || '')":"self.$"+e;case"meta":return-1===e.indexOf("(")?"self.$meta()":"self.$"+e;case"import":case"favicon":case"js":case"css":case"script":case"absolute":return"self.$"+e+(-1===e.indexOf("(")?"()":"");case"components":if(n.$hasComponents||(n.$hasComponents=[]),n.$hasComponents instanceof Array){var f=e.match(REG_COMPONENTS_GROUP);f&&f.length&&(f=f[0].toString().replace(/'|"'/g,""),-1===n.$hasComponents.indexOf(f)&&n.$hasComponents.push(f))}return"self.$"+e+(-1===e.indexOf("(")?"()":"");case"index":return"("+e+")";case"component":return n.$hasComponents=!0,"self."+e;case"routeJS":case"routeCSS":case"routeScript":case"routeStyle":case"routeImage":case"routeFont":case"routeDownload":case"routeVideo":case"routeStatic":return"self."+e;case"translate":return"self."+e;case"json":case"sitemap_change":case"sitemap_replace":case"sitemap_add":case"helper":case"view":case"layout":case"image":case"template":case"templateToggle":case"viewCompile":case"viewToggle":case"download":case"selected":case"disabled":case"checked":case"etag":case"header":case"modified":case"options":case"readonly":case"canonical":case"dns":case"next":case"prefetch":case"prerender":case"prev":return"self.$"+e;case"now":return"(new Date()"+e.substring(3)+")";case"radio":case"text":case"checkbox":case"hidden":case"textarea":case"password":return"self.$"+exports.appendModel(e);default:return F.helpers[c]?"helpers."+view_insert_call(e):"$STRING("+(-1===t.indexOf(c)?"!"===e[0]?e.substring(1)+")":e+").encode()":e+")")}}function view_insert_call(e){var r=e.indexOf("(");if(-1===r)return e;for(var t=e.length,n=0,i=r+1;t>i;i++){var a=e[i];if("("===a||")"===a)if("("!==a){if(!(n>0)){var s=e.substring(r+1);return e.substring(0,r)+".call(self"+(s.length>1?","+s:")")}n--}else n++}return e}function view_is_assign(e){for(var r=e.length,t=0,n=0;r>n;n++){var i=e[n];if("["!==i)if("]"!==i){var a=e[n+1]||"";if("+"===i&&("+"===a||"="===a)&&!t)return!0;if("-"===i&&("-"===a||"="===a)&&!t)return!0;if("*"===i&&("*"===a||"="===a)&&!t)return!0;if("="===i&&!t)return!0}else t--;else t++}return!1}function view_find_command(e,r){if(r=e.indexOf("@{",r),-1===r)return null;for(var t=e.length,n=0,i=r+2;t>i;i++){var a=e[i];if("{"!==a){if("}"===a){if(!(n>0)){var s=e.substring(r+2,i).trim();return"{"===s[0]?view_find_command(e,r+1):{beg:r,end:i,line:view_line_counter(e.substr(0,r)),command:s}}n--}}else n++}return null}function view_line_counter(e){var r=e.match(/\n/g);return r?r.length:0}function view_find_localization(e,r){if(r=e.indexOf("@(",r),-1===r)return null;for(var t=e.length,n=0,i=e[r-1],a="",s=r+2;t>s;s++){var o=e[s];if("("!==o){if(")"===o){if(!n){var u=e.substring(s+1,s+2);return(i===u&&'"'===i||"'"===i||"`"===i)&&(a=i),{beg:r,end:s,command:e.substring(r+2,s).trim(),escape:a}}n--}}else n++}return null}function removeComments(e){for(var r="<!--",t="-->",n=e.indexOf(r),i=0;-1!==n&&(i=e.indexOf(t,n+4),-1!==i);){var a=e.substring(n,i+3);-1!==a.indexOf("[if")||-1!==a.indexOf("[endif")?n=e.indexOf(r,i+3):(e=e.replacer(a,""),n=e.indexOf(r,n))}return e}function compressView(e,r){for(var t=[];;){var n=e.indexOf("@{");if(-1===n)break;var i=e.indexOf("}",n+2);if(-1===i)break;t.push(e.substring(n,i+1)),e=e.substring(0,n)+"#@"+(t.length-1)+"#"+e.substring(i+1)}return e=compressHTML(e,r,!1),e.replace(/#@\d+#/g,function(e){return t[+e.substring(2,e.length-1)]})}function compressJS(e,r,t){if(!F.config["allow-compile-script"])return e;var n='<script type="text/javascript">',i="</script>",a=e.indexOf(n,r||0);if(-1===a&&(n="<script>",a=e.indexOf(n,r||0),-1===a))return e;var s=e.indexOf(i,a+n.length);if(-1===s)return e;var o=e.substring(a,s+i.length).trim(),u=e.indexOf(o);if(-1===u)return e;var l=o.substring(n.length,o.length-i.length).trim(),c=exports.compile_javascript(l,t);return e=e.replacer(o,n+c.trim()+i.trim()),compressJS(e,a+c.length+9,t)}function compressCSS(e,r,t){if(!F.config["allow-compile-style"])return e;var n='<style type="text/css">',i="</style>",a=e.indexOf(n,r||0);if(-1===a&&(n="<style>",a=e.indexOf(n,r||0),-1===a))return e;var s=e.indexOf(i,a+n.length);if(-1===s)return e;var o=e.substring(a,s+i.length),u=o.substring(n.length,o.length-i.length).trim(),l=exports.compile_css(u,t);return e=e.replacer(o,(n+l.trim()+i).trim()),compressCSS(e,a+l.length+8,t)}function variablesCSS(e){if(!e)return e;var r={};return e=e.replace(REG_CSS_10,function(e){var t=e.indexOf(":");if(-1===t)return e;var n=e.substring(0,t).trim();return r[n]=e.substring(t+1,e.length-1).trim(),""}),e=e.replace(REG_CSS_11,function(e){var t=r[e];return t?t:e}).trim()}function nested(e,r,t){if(!e)return e;for(var n,i,a,s=0,o="",u=!1,l=0,c=!1,f="",p=!1,d="",g=!1,h="",m=!1;;){var E=e[s++];if(!E)break;if("/"!==E||"*"!==e[s]){if(g)h+=E,"*"===E&&"/"===e[s]&&(g=!1,s++,"auto*"===h&&(o+="/*auto*/"));else if("\n"!==E&&"\r"!==E)if("$"===E&&t&&t(),"@"===E&&"{"===e[s]&&(m=!0),m)f+=E,"}"===E&&(m=!1);else if(("'"===E||'"'===E)&&(E===a&&"\\"!==e[s]?a="":a||(a=E)),a)f+=E;else if("@"===E&&(i=s,p=!0),!p||d||";"!==E&&"{"!==E||(d=E,";"!==E))if(f+=E,"{"!==E){if("}"===E){if(l>0){l--,c=!0;continue}if(!c){o+=f,f="",u=!1,p=!1,d="";continue}if(p){-1!==f.indexOf("@keyframes")?o+=f:(i=f.indexOf("{"),o+=f.substring(0,i+1)+process_nested(f.substring(i),r).trim()+"}"),u=!1,p=!1,d="",f="";continue}for(var _=n-1,v="";;){var S=e[_--];if("{"!==S){if("}"===S||"\n"===S||"\r"===S||void 0===S||d&&d===S)break;v=S+v}}u=!1,p=!1,d="",f="",o+=process_nested(e.substring(n-1,s),(r||"")+v.trim())}}else{if(u){l++;continue}u=!0,l=0,n=s,c=!1}else o+=e.substring(i-1,s),p=!1,f=""}else g=!0,s++,h=""}return o+f}function process_nested(e,r){return e=e.trim(),e=make_nested(e.substring(1,e.length-1),r),nested(e,r)}function make_nested(e,r){for(var t=0,n="",i="",a=0,s=!1,o=!1;;){var u=e[t++];if(!u)break;if("\n"!==u&&"\r"!==u)if((" "!==u||" "!==n[n.length-1])&&(n+=u),"{"!==u){if("}"===u){if(a>0){a--,o=!0;continue}if(!o){i+=r+" "+n.trim(),n="",s=!1;continue}i+=n}}else{if(s){a++;continue}s=!0,a=0,o=!1}}return i}function compressHTML(e,r,t){if(!e||!r)return e;e=removeComments(e);for(var n=["script","textarea","pre","code"],i="["+(new Date).getTime()+"]#",a={},s=0,o=n.length,u=65,l=0;o>l;l++)for(var c=n[l],f="<"+c,p="</"+c,d=e.indexOf(f),g=0,h=p.length;-1!==d;){if(g=e.indexOf(p,d+3),-1===g){if(!t)break;g=e.length}var m=i+s++ +String.fromCharCode(u++);u>90&&(u=65);var E=e.substring(d,g+h);if(!l){if(g=E.indexOf(">"),h=E.indexOf('type="text/template"'),g>h&&-1!==h){d=e.indexOf(f,d+f.length);continue}if(h=E.indexOf('type="text/html"'),g>h&&-1!==h){d=e.indexOf(f,d+f.length);continue}if(h=E.indexOf('type="text/ng-template"'),g>h&&-1!==h){d=e.indexOf(f,d+f.length);continue}}a[m]=E,e=e.replacer(E,m),d=e.indexOf(f,d+f.length)}for(;;){if(!REG_6.test(e))break;e=e.replace(REG_6,function(e){return e.replace(/\s+/g," ")})}e=e.replace(/>\n\s+/g,">").replace(/(\w|\W)\n\s+</g,function(e){return e.trim().replace(/\s/g,"")}).replace(REG_5,"><").replace(REG_4,function(e){var r=e[e.length-1];return"<"===r?r:" "+r}).replace(REG_1,"").replace(REG_2,"");for(var m in a)e=e.replacer(m,a[m]);return e}function viewengine_read(e,r){var t,n=F.config,i="."===e[0],a=i?e.substring(1):F.path.views(e);if(RELEASE){t="404/"+e;var s=F.temporary.other[t];if(void 0!==s)return null}if(existsSync(a))return view_parse(view_parse_localization(modificators(Fs.readFileSync(a).toString("utf8"),a),r.language),n["allow-compile-html"],a,r);var o;return i?r.themeName&&(o=a.lastIndexOf("/"),-1!==o&&(a=a.substring(0,a.lastIndexOf("/",o-1))+a.substring(o),existsSync(a)))?view_parse(view_parse_localization(modificators(Fs.readFileSync(a).toString("utf8"),a),r.language),n["allow-compile-html"],a,r):(RELEASE&&(F.temporary.other[t]=null),null):(o=e.lastIndexOf("/"),-1===o?(RELEASE&&(F.temporary.other[t]=null),null):(a=F.path.views(e.substring(o+1)),existsSync(a)?view_parse(view_parse_localization(modificators(Fs.readFileSync(a).toString("utf8"),a),r.language),n["allow-compile-html"],a,r):(RELEASE&&(F.temporary.other[t]=null),null)))}function modificators(e,r,t){if(!F.modificators)return e;for(var n=0,i=F.modificators.length;i>n;n++){var a=F.modificators[n](t||"view",r,e);a&&(e=a)}return e}function viewengine_load(e,r,t){var n=F.routes.views[e];n?r="."+n.filename:r+=".html";var i="view#"+r+(t.language||""),a=F.temporary.views[i];return a?a:(a=viewengine_read(r,t),F.isDebug||(F.temporary.views[i]=a),a)}function viewengine_dynamic(e,r,t,n){var i=n?F.temporary.views[n]||null:null;return i?i:(i=view_parse(view_parse_localization(modificators(e,""),r),F.config["allow-compile-html"],null,t),n&&!F.isDebug&&(F.temporary.views[n]=i),i)}function cleanURL(e,r){for(var t,n=e.substring(0,r),i=!1,a=r,s=e.length;s>a;a++){var o=e[a];("/"!==o||"/"!==t||i)&&(t=o,n+=o)}return n}function destroyStream(e){return e instanceof ReadStream?(e.destroy(),"function"==typeof e.close&&e.on("open",function(){"number"==typeof this.fd&&this.close()})):e instanceof Stream&&"function"==typeof e.destroy&&e.destroy(),e}function isFinished(e){return e.socket?e.writable&&(!e.socket._writableState||e.socket._writableState.finished||e.socket._writableState.destroyed)?!0:e.readable&&(!e.socket._readableState||e.socket._writableState.ended||e.socket._readableState.destroyed)?!0:!1:e._readableState&&(e._readableState.ended||e._readableState.destroyed)?!0:e._writableState&&(e._writableState.finished||e._writableState.destroyed)?!0:!1}function onFinished(e,r){if(e.$onFinished)return r&&r(),void(r=null);if(e.$onFinishedQueue)return void(e.$onFinishedQueue instanceof Array?e.$onFinishedQueue.push(r):e.$onFinishedQueue=[e.$onFinishedQueue,r]);e.$onFinishedQueue=r;var t=function(){if(!e.$onFinished&&(e.$onFinished=!0),e.$onFinishedQueue instanceof Array){for(;e.$onFinishedQueue.length;)e.$onFinishedQueue.shift()();e.$onFinishedQueue=null}else e.$onFinishedQueue&&(e.$onFinishedQueue(),e.$onFinishedQueue=null)};isFinished(e)?setImmediate(t):(e.socket&&(e.socket.$totalstream||(e.socket.$totalstream=e,e.socket.prependListener("error",t),e.socket.prependListener("close",t))),e.prependListener("error",t),e.prependListener("end",t),e.prependListener("close",t),e.prependListener("aborted",t),e.prependListener("finish",t))}function existsSync(e){try{return!!Fs.statSync(e)}catch(r){return!1}}const Crypto=require("crypto"),Fs=require("fs"),ReadStream=Fs.ReadStream,Stream=require("stream"),ENCODING="utf8",EMPTYARRAY=[],EMPTYOBJECT={},CONCAT=[null,null];global.framework_utils||(global.framework_utils=require("./utils")),Object.freeze(EMPTYOBJECT),Object.freeze(EMPTYARRAY);const REG_1=/[\n\r\t]+/g,REG_2=/\s{2,}/g,REG_4=/\n\s{2,}./g,REG_5=/>\n\s{1,}</g,REG_6=/[<\w"\u0080-\u07ff\u0400-\u04FF]+\s{2,}[\w\u0080-\u07ff\u0400-\u04FF>]+/,REG_7=/\\/g,REG_8=/'/g,REG_BLOCK_BEG=/@\{block.*?\}/i,REG_BLOCK_END=/@\{end\}/i,REG_SKIP_1=/\('|"/,REG_SKIP_2=/,(\s)?\w+/,REG_HEAD=/<\/head>/i,REG_COMPONENTS=/@{(\s)?(component|components)(\s)?\(/i,REG_COMPONENTS_GROUP=/('|")[a-z0-9]+('|")/i,REG_NOTRANSLATE=/@\{notranslate\}/gi,REG_NOCOMPRESS=/@\{nocompress\s\w+}/gi,REG_TAGREMOVE=/[^>]\n\s{1,}$/,REG_HELPERS=/helpers\.[a-z0-9A-Z_$]+\(.*?\)+/g,REG_SITEMAP=/\s+(sitemap_navigation\(|sitemap\()+/g,REG_CSS_1=/\n|\s{2,}/g,REG_CSS_2=/\s?\{\s{1,}/g,REG_CSS_3=/\s?\}\s{1,}/g,REG_CSS_4=/\s?:\s{1,}/g,REG_CSS_5=/\s?;\s{1,}/g,REG_CSS_6=/,\s{1,}/g,REG_CSS_7=/\s\}/g,REG_CSS_8=/\s\{/g,REG_CSS_9=/;\}/g,REG_CSS_10=/\$[a-z0-9-_]+:.*?;/gi,REG_CSS_11=/\$[a-z0-9-_]+/gi,HTTPVERBS={get:!0,post:!0,options:!0,put:!0,"delete":!0,patch:!0,upload:!0,head:!0,trace:!0,propfind:!0},RENDERNOW=["self.$import(","self.route","self.$js(","self.$css(","self.$favicon(","self.$script(","$STRING(self.resource(","$STRING(RESOURCE(","self.translate(","language","self.sitemap_url(","self.sitemap_name(","$STRING(CONFIG(","$STRING(config.","$STRING(config[","$STRING(config("],AUTOVENDOR=["filter","appearance","column-count","column-gap","column-rule","display","transform","transform-style","transform-origin","transition","user-select","animation","perspective","animation-name","animation-duration","animation-timing-function","animation-delay","animation-iteration-count","animation-direction","animation-play-state","opacity","background","background-image","font-smoothing","text-size-adjust","backface-visibility","box-sizing","overflow-scrolling"],WRITESTREAM={flags:"w"},EMPTYBUFFER=framework_utils.createBufferSize(0);var INDEXFILE=0,INDEXMIXED=0;global.$STRING=function(e){return null!=e?e.toString():""},global.$VIEWCACHE=[],exports.parseMULTIPART=function(e,r,t,n){var i=r.split(";")[1];if(!i)return F.reqstats(!1,!1),F.stats.request.error400++,e.res.writeHead(400),void e.res.end();e.once("close",function(){!e.$upload&&e.clear()});var a,s,o,u=new MultipartParser,l=0,c=t.length,f=0,p=function(){f--};e.files=[],e.body={};var d=framework_utils.combine(n,(F.id?"i-"+F.id+"_":"")+"uploadedfile-");i=i.substring(i.indexOf("=",2)+1),e.buffer_exceeded=!1,e.buffer_has=!0,e.buffer_parser=u,u.initWithBoundary(i),u.onPartBegin=function(){e.buffer_exceeded||(s=new HttpFile,s.$data=framework_utils.createBufferSize(),s.$step=0,s.$is=!1,s.length=0)},u.onHeaderValue=function(r,t,n){if(!e.buffer_exceeded){var i=r.slice(t,n).toString(ENCODING);if(1===s.$step){var o=i.indexOf(";");return-1===o?s.type=i.trim():s.type=i.substring(0,o).trim(),void(s.$step=2)}if(0===s.$step){if(-1===i.indexOf("form-data; "))return e.buffer_exceeded=!0,void(!s.$is&&destroyStream(a));if(i=parse_multipart_header(i),s.$step=1,s.$is=null!==i[1],s.name=i[0],!s.$is)return void destroyStream(a);s.filename=i[1];var o=s.filename.lastIndexOf("\\");-1===o&&(o=s.filename.lastIndexOf("/")),-1!==o&&(s.filename=s.filename.substring(o+1)),s.path=d+INDEXFILE++ +".bin"}}},u.onPartData=function(r,t,n){if(!e.buffer_exceeded){var i=r.slice(t,n),u=i.length;if(l+=u,l>=c)return e.buffer_exceeded=!0,void(o?o.push(s.path):o=[s.path]);if(!s.$is)return CONCAT[0]=s.$data,CONCAT[1]=i,void(s.$data=Buffer.concat(CONCAT));if(s.length)return a.write(i),void(s.length+=u);var d=null;switch(s.type){case"image/jpeg":d=framework_image.measureJPG(r.slice(t));break;case"image/gif":d=framework_image.measureGIF(i);break;case"image/png":d=framework_image.measurePNG(i);break;case"image/svg+xml":d=framework_image.measureSVG(i)}d?(s.width=d.width,s.height=d.height):(s.width=0,s.height=0),e.files.push(s),F.$events["upload-begin"]&&F.emit("upload-begin",e,s),f++,a=Fs.createWriteStream(s.path,WRITESTREAM),a.once("close",p),a.once("error",p),a.write(i),s.length+=u}},u.onPartEnd=function(){if(a&&(a.end(),a=null),!e.buffer_exceeded){if(s.$is)return s.$data=void 0,s.$is=void 0,s.$step=void 0,void(F.$events["upload-end"]&&F.emit("upload-end",e,s));s.$data=s.$data.toString(ENCODING);var r=e.body[s.name];void 0===r?e.body[s.name]=s.$data:r instanceof Array?e.body[s.name].push(s.$data):(r=[r],r.push(s.$data),e.body[s.name]=r)}},u.onEnd=function(){f?setImmediate(u.onEnd):(o&&F.unlink(o),e.$total_end2())},e.on("data",uploadparser),e.on("end",uploadparser_done)},exports.parseMULTIPART_MIXED=function(e,r,t,n){var i=r.split(";")[1];if(!i)return F.reqstats(!1,!1),F.stats.request.error400++,e.res.writeHead(400),void e.res.end();e.once("close",function(){!e.$upload&&e.clear()});var a,s,o=new MultipartParser,u=0,l=0,c=framework_utils.combine(t,(F.id?"i-"+F.id+"_":"")+"uploadedmixed-");i=i.substring(i.indexOf("=",2)+1),e.buffer_exceeded=!1,e.buffer_has=!0,e.buffer_parser=o,o.initWithBoundary(i),o.onPartBegin=function(){s=new HttpFile,s.$step=0,s.$is=!1,s.length=0},o.onHeaderValue=function(r,t,n){if(!e.buffer_exceeded){var i=r.slice(t,n).toString(ENCODING);if(1===s.$step){var o=i.indexOf(";");return-1===o?s.type=i.trim():s.type=i.substring(0,o).trim(),void(s.$step=2)}0===s.$step&&(i=parse_multipart_header(i),s.$step=1,s.$is=null!==i[1],s.name=i[0],s.$is?(s.filename=i[1],s.path=c+INDEXMIXED++ +".bin",a=Fs.createWriteStream(s.path,WRITESTREAM),a.once("close",function(){u--}),a.once("error",function(){u--}),u++):destroyStream(a))}},o.onPartData=function(r,t,i){if(!e.buffer_exceeded){var o=r.slice(t,i),u=o.length;if(s.$is){if(s.length)return a.write(o),void(s.length+=u);a.write(o),s.length+=u,n(e,s,l++)}}},o.onPartEnd=function(){a&&(a.end(),a=null),!e.buffer_exceeded&&s.$is&&(s.$is=void 0,s.$step=void 0)},o.onEnd=function(){u?setImmediate(o.onEnd):(n(e,null),F.responseContent(e,e.res,200,EMPTYBUFFER,"text/plain",!1))},e.on("data",uploadparser),e.on("end",uploadparser_done)},exports.routeSplit=function(e,r){var t;if(!r&&(t=F.temporary.other[e]))return t;if(!e||"/"===e)return t=["/"];var n=!1,i="",a=0;t=[];for(var s=0,o=e.length;o>s;s++){var u=e[s];"/"!==u?(i+=r?u:u.toLowerCase(),n="/"===u):i&&!n&&(t.push(i),a++,i="")}return i?t.push(i):a||t.push("/"),t},exports.routeSplitCreate=function(e,r){r||(e=e.toLowerCase()),"/"===e[0]&&(e=e.substring(1)),"/"===e[e.length-1]&&(e=e.substring(0,e.length-1));for(var t=0,n=0,i=[],a=0,s=e.length;s>a;a++)switch(e[a]){case"/":if(0!==t)break;i.push(e.substring(n+(i.length?1:0),a)),n=a;break;case"{":t++;break;case"}":t--}return!t&&i.push(e.substring(n+(i.length?1:0),e.length)),1!==i.length||i[0]||(i[0]="/"),i},exports.routeCompare=function(e,r,t,n){var i=e.length,a=r.length;if(a!==i&&!n)return!1;if(n&&1===a&&"/"===r[0])return!0;for(var s=1===i&&"/"===e[0],o=0;i>o;o++){var u=r[o];if(!t&&n&&void 0===u)return!0;if((t||s||"{"!==u[0])&&e[o]!==u)return t?!1:n?o>=a:!1}return!0},exports.routeCompareSubdomain=function(e,r){if(!e&&!r||e&&!r)return!0;if(!e&&r)return!1;for(var t=0,n=r.length;n>t;t++){if("*"===r[t])return!0;var i=r[t].lastIndexOf("*");if(-1===i){if(r[t]===e)return!0}else if(-1!==e.indexOf(r[t].replace("*","")))return!0}return!1},exports.routeCompareFlags=function(e,r,t){for(var n=!1,i=e,a=r,s=e.length,o=r.length,u=s>o?i:a,l=s>o?a:i,c=Math.max(s,o),f="authorize",p="unauthorize",d=0;c>d;d++){var g=u[d],h=g[0];if("!"!==h&&"#"!==h&&"$"!==h&&"@"!==h&&"+"!==h&&(t||g!==f&&g!==p)){var m=l.indexOf(g);if(-1===m&&!HTTPVERBS[g])return g===f||g===p?-1:0;n=n||-1!==m&&HTTPVERBS[g]}}return n?1:0},exports.routeCompareFlags2=function(e,r,t){if(t&&r.MEMBER&&t!==r.MEMBER)return-1;if(!r.isWEBSOCKET){if(r.isXHR&&!e.xhr||r.isMOBILE&&!e.mobile||r.isROBOT&&!e.robot||r.isUPLOAD&&!e.$upload)return 0;var n=e.method;if(r.method){if(r.method!==n)return 0}else if(!r.flags2[n.toLowerCase()])return 0;if(r.isREFERER&&-1===e.flags.indexOf("referer")||!r.isMULTIPLE&&r.isJSON&&-1===e.flags.indexOf("json"))return 0}for(var i=!1,a=!1,s=0,o=e.flags.length;o>s;s++){var u=e.flags[s];switch(u){case"json":continue;case"xml":if(r.isRAW||r.isXML)continue;return 0;case"proxy":if(!r.isPROXY)return 0;continue;case"debug":if(!r.isDEBUG&&r.isRELEASE)return 0;continue;case"release":if(!r.isRELEASE&&r.isDEBUG)return 0;continue;case"referer":continue;case"upload":if(!r.isUPLOAD)return 0;continue;case"https":if(!r.isHTTPS&&r.isHTTP)return 0;continue;case"http":if(!r.isHTTP&&r.isHTTPS)return 0;continue;case"xhr":case"+xhr":if(!r.isBOTH&&!r.isXHR)return 0;continue}var l="@"===u[0];if(1===t||1===r.MEMBER){if(!l||!i||r.isROLE){if(!l&&!r.flags2[u])return 0;l&&(r.flags2[u]&&(i=!0),a=!0)}}else if(!r.isGET&&!l&&!r.flags2[u]||r.isROLE&&l&&!r.flags2[u]||r.isROLE&&!l)return 0}return r.isROLE&&a?i?1:-1:1},exports.routeParam=function(e,r){if(!r||!e||!r.param.length)return EMPTYARRAY;for(var t=[],n=0,i=r.param.length;i>n;n++){var a=e[r.param[n]];t.push("/"===a?"":a)}return t},HttpFile.prototype.rename=HttpFile.prototype.move=function(e,r){var t=this;return Fs.rename(t.path,e,function(n){n||(t.path=e,t.rem=!1),r&&r(n)}),t},HttpFile.prototype.copy=function(e,r){var t=this;if(!r)return void Fs.createReadStream(t.path).pipe(Fs.createWriteStream(e));var n=Fs.createReadStream(t.path),i=Fs.createWriteStream(e);return n.on("close",r),n.pipe(i),t},HttpFile.prototype.$$rename=HttpFile.prototype.$$move=function(e){var r=this;return function(t){return r.rename(e,t)}},HttpFile.prototype.$$copy=function(e){var r=this;return function(t){return r.copy(e,t)}},HttpFile.prototype.readSync=function(){return Fs.readFileSync(this.path)},HttpFile.prototype.read=function(e){var r=this;return Fs.readFile(r.path,e),r},HttpFile.prototype.$$read=function(){var e=this;return function(r){e.read(r)}},HttpFile.prototype.md5=function(e){var r=this,t=Crypto.createHash("md5"),n=Fs.createReadStream(r.path);return n.on("data",function(e){t.update(e)}),n.on("error",function(r){e&&(e(r,null),e=null)}),onFinished(n,function(){destroyStream(n),e&&(e(null,t.digest("hex")),e=null)}),r},HttpFile.prototype.$$md5=function(){var e=this;return function(r){e.md5(r)}},HttpFile.prototype.stream=function(e){return Fs.createReadStream(this.path,e)},HttpFile.prototype.pipe=function(e,r){return Fs.createReadStream(this.path,r).pipe(e,r)},HttpFile.prototype.isImage=function(){return-1!==this.type.indexOf("image/")},HttpFile.prototype.isVideo=function(){return-1!==this.type.indexOf("video/")},HttpFile.prototype.isAudio=function(){return-1!==this.type.indexOf("audio/")},HttpFile.prototype.image=function(e){return void 0===e&&(e="im"===F.config["default-image-converter"]),framework_image.init(this.path,e,this.width,this.height)},exports.compile_css=function(e,r){if(global.F&&(e=modificators(e,r,"style"),F.onCompileStyle))return F.onCompileStyle(r,e);try{var t=!1;return e=nested(e,"",function(){t=!0}),e=compile_autovendor(e),t&&(e=variablesCSS(e)),e}catch(n){return F.error(new Error("CSS compiler exception : "+n.message)),""}},exports.compile_javascript=function(e,r){return global.F&&(e=modificators(e,r,"script"),F.onCompileScript)?F.onCompileScript(r,e).trim():e},exports.compile_html=function(e,r){return compressCSS(compressJS(compressHTML(e,!0),0,r),0,r)};var Buffer=require("buffer").Buffer,s=0,S={PARSER_UNINITIALIZED:s++,START:s++,START_BOUNDARY:s++,HEADER_FIELD_START:s++,HEADER_FIELD:s++,HEADER_VALUE_START:s++,HEADER_VALUE:s++,HEADER_VALUE_ALMOST_DONE:s++,HEADERS_ALMOST_DONE:s++,PART_DATA_START:s++,PART_DATA:s++,PART_END:s++,END:s++},f=1,FB={PART_BOUNDARY:f,LAST_BOUNDARY:f*=2},LF=10,CR=13,SPACE=32,HYPHEN=45,COLON=58,A=97,Z=122,lower=function(e){return 32|e};for(s in S)exports[s]=S[s];exports.MultipartParser=MultipartParser,MultipartParser.stateToString=function(e){for(var r in S){var t=S[r];if(t===e)return r}},MultipartParser.prototype.initWithBoundary=function(e){var r=this;r.boundary=framework_utils.createBufferSize(e.length+4),r.boundary.write("\r\n--",0,"ascii"),r.boundary.write(e,4,"ascii"),r.lookbehind=framework_utils.createBufferSize(r.boundary.length+8),r.state=S.START,r.boundaryChars={};for(var t=0;t<r.boundary.length;t++)r.boundaryChars[r.boundary[t]]=!0},MultipartParser.prototype.write=function(e){var r,t,n=this,i=0,a=e.length,s=n.index,o=n.index,u=n.state,l=n.flags,c=n.lookbehind,f=n.boundary,p=n.boundaryChars,d=n.boundary.length,g=d-1,h=e.length,m=function(e){n[e+"Mark"]=i},E=function(e){delete n[e+"Mark"]},_=function(e,r,t,i){if(void 0===t||t!==i){var a="on"+e.substr(0,1).toUpperCase()+e.substr(1);a in n&&n[a](r,t,i)}},v=function(r,t){var a=r+"Mark";a in n&&(t?(_(r,e,n[a],i),delete n[a]):(_(r,e,n[a],e.length),n[a]=0))};for(i=0;a>i;i++)switch(r=e[i],u){case S.PARSER_UNINITIALIZED:return i;case S.START:o=0,u=S.START_BOUNDARY;case S.START_BOUNDARY:if(o==f.length-2){if(r===HYPHEN)l|=FB.LAST_BOUNDARY;else if(r!==CR)return i;o++;break}if(o-1===f.length-2){if(l&FB.LAST_BOUNDARY&&r===HYPHEN)_("end"),u=S.END,l=0;else{if(l&FB.LAST_BOUNDARY||r!==LF)return i;o=0,_("partBegin"),u=S.HEADER_FIELD_START}break}r!==f[o+2]&&(o=-2),r===f[o+2]&&o++;break;case S.HEADER_FIELD_START:u=S.HEADER_FIELD,m("headerField"),o=0;case S.HEADER_FIELD:if(r===CR){E("headerField"),u=S.HEADERS_ALMOST_DONE;break}if(o++,r===HYPHEN)break;if(r===COLON){if(1===o)return i;v("headerField",!0),u=S.HEADER_VALUE_START;break}if(t=lower(r),A>t||t>Z)return i;break;case S.HEADER_VALUE_START:if(r===SPACE)break;m("headerValue"),u=S.HEADER_VALUE;case S.HEADER_VALUE:r===CR&&(v("headerValue",!0),_("headerEnd"),u=S.HEADER_VALUE_ALMOST_DONE);break;case S.HEADER_VALUE_ALMOST_DONE:if(r!==LF)return i;u=S.HEADER_FIELD_START;break;case S.HEADERS_ALMOST_DONE:if(r!==LF)return i;_("headersEnd"),u=S.PART_DATA_START;break;case S.PART_DATA_START:u=S.PART_DATA,m("partData");case S.PART_DATA:if(s=o,!o){for(i+=g;h>i&&!(e[i]in p);)i+=d;i-=g,r=e[i]}if(o<f.length)f[o]===r?(o||v("partData",!0),o++):o=0;else if(o===f.length)o++,r===CR?l|=FB.PART_BOUNDARY:r===HYPHEN?l|=FB.LAST_BOUNDARY:o=0;else if(o-1===f.length)if(l&FB.PART_BOUNDARY){if(o=0,r===LF){l&=~FB.PART_BOUNDARY,_("partEnd"),_("partBegin"),u=S.HEADER_FIELD_START;break}}else l&FB.LAST_BOUNDARY&&r===HYPHEN?(_("partEnd"),_("end"),u=S.END,l=0):o=0;o?c[o-1]=r:s&&(_("partData",c,0,s),s=0,m("partData"),i--);break;case S.END:break;default:return i}return v("headerField"),v("headerValue"),v("partData"),n.index=o,n.state=u,n.flags=l,a},MultipartParser.prototype.end=function(){if(this.state===S.HEADER_FIELD_START&&0===this.index||this.state===S.PART_DATA&&this.index==this.boundary.length)this.onPartEnd&&this.onPartEnd(),this.onEnd&&this.onEnd();else if(this.state!=S.END)return this.onPartEnd&&this.onPartEnd(),this.onEnd&&this.onEnd(),new Error("MultipartParser.end() : stream ended unexpectedly : "+this.explain())},MultipartParser.prototype.explain=function(){return"state = "+MultipartParser.stateToString(this.state)},exports.appendModel=function(e){var r=e.indexOf("(");if(-1===r)return e;var t=e.substring(r+1);return e.substring(0,r)+"(model"+(")"===t[0]?t:","+t)},exports.preparePath=function(e,r){var t=F.config["default-root"];if(!t)return e;var n="/"===e[0];return n&&"/"===e[1]||":"===e[4]||":"===e[5]?e:r?e.substring(t.length-1):t+(n?e.substring(1):e)},exports.parseURI=function(e){var r,t,n=F.temporary.other[e.host];n?(r=n.port,t=n.hostname):(r=e.host.lastIndexOf(":"),-1===r?(r=null,t=e.host):(t=e.host.substring(0,r),r=e.host.substring(r+1)),F.temporary.other[e.host]={port:r,hostname:t});var i,a=e.url.indexOf("?",1),s=null;-1===a?(a=null,i=e.url):(i=e.url.substring(0,a),a=e.url.substring(a),s=a.substring(1));var o=i.indexOf("//");return-1!==o&&(i=cleanURL(i,o),e.url=i,a&&(e.url+=a)),{auth:null,hash:null,host:e.host,hostname:t,href:e.$protocol+"://"+e.host+e.url,path:e.url,pathname:i,port:r,protocol:e.$protocol+":",query:s,search:a,slashes:!0}},exports.encodeUnicodeURL=function(e){for(var r=e,t=0,n=e.length;n>t;t++){var i=e.charCodeAt(t);i>127&&(r=r.replace(e[t],encodeURIComponent(e[t])))}return r},exports.parseBlock=function(e,r){if(!REG_BLOCK_BEG.test(r))return r;var t="\n",n=r.split(t),i=!1,a=!1,s="";e=(e||"").replace(/\s/g,"").split(",");for(var o=0,u=n.length;u>o;o++){var l=n[o];if(l)if(REG_BLOCK_END.test(l))i=!1,a=!1;else if(i){if(a)continue;s+=l+t}else{var c=l.search(REG_BLOCK_BEG);if(-1!==c){i=!0,a=!0;for(var f=l.substring(c+8,l.indexOf("}",c)).replace(/\|\|/g,",").replace(/\s/g,"").split(","),p=0,d=f.length;d>p;p++)if(-1!==e.indexOf(f[p])){a=!1;break}}else s+=l+t}}return s.trim()},exports.restart=function(){INDEXMIXED=0,INDEXFILE=0},global.HttpFile=HttpFile,exports.HttpFile=HttpFile,exports.viewEngineCompile=viewengine_dynamic,exports.viewEngine=viewengine_load,exports.parseLocalization=view_parse_localization,exports.findLocalization=view_find_localization,exports.destroyStream=destroyStream,exports.onFinished=onFinished,exports.modificators=modificators;