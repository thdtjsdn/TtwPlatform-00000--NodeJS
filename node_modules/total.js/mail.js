"use strict";function Mailer(){this.debug=!1,this.Message=Message,this.Mail=Message,this.connections={},this.$events={}}function Message(e,t){this.subject=e||"",this.body=t||"",this.files,this.addressTo=[],this.addressReply,this.addressCC,this.addressBCC,this.addressFrom={name:"",address:""},this.closed=!1,this.tls=!1,this.$callback}function writeattachment_data(e){for(var t=e.length,s=0,r=0;t>s;)s+=68,s>t&&(s=t),this.$mailer.$writeline(this.$mailerobj,e.slice(r,s).toString("base64")),r=s}function prepareBASE64(e){for(var t=0,s="",r=e.length;r>t;){var n=t+68;n>r&&(n=r),s+=e.substring(t,n)+CRLF,t=n}return s}function unicode_encode(e){return e?"=?utf-8?B?"+framework_utils.createBuffer(e.toString()).toString("base64")+"?=":""}const Net=require("net"),Tls=require("tls"),Fs=require("fs"),CRLF="\r\n",REG_ESMTP=/\besmtp\b/i,REG_STATE=/\d+/,REG_WINLINE=/\r\n/g,REG_NEWLINE=/\n/g,REG_AUTH=/(AUTH LOGIN|AUTH PLAIN)/i,EMPTYARRAY=[];var INDEXSENDER=0,INDEXATTACHMENT=0;global.framework_utils||(global.framework_utils=require("./utils"));const BUF_CRLF=framework_utils.createBuffer(CRLF),CONCAT=[null,null];Mailer.prototype.emit=function(e,t,s,r,n,i,a,o){var l=this.$events[e];if(l){for(var c=!1,u=0,d=l.length;d>u;u++)l[u].$once&&(c=!0),l[u].call(this,t,s,r,n,i,a,o);c&&(l=l.remove(function(e){return e.$once}),l.length?this.$events[e]=l:this.$events[e]=void 0)}return this},Mailer.prototype.on=function(e,t){return this.$events[e]?this.$events[e].push(t):this.$events[e]=[t],this},Mailer.prototype.once=function(e,t){return t.$once=!0,this.on(e,t)},Mailer.prototype.removeListener=function(e,t){var s=this.$events[e];return s&&(s=s.remove(function(e){return e===t}),s.length?this.$events[e]=s:this.$events[e]=void 0),this},Mailer.prototype.removeAllListeners=function(e){return e?this.$events[e]=void 0:this.$events={},this},Mailer.prototype.create=function(e,t){return new Message(e,t)},Message.prototype.unsubscribe=function(e){var t=e.substring(0,6);return this.$unsubscribe="http:/"===t||"https:"===t?"<"+e+">":"<mailto:"+e+">",this},Message.prototype.callback=function(e){return this.$callback=e,this},Message.prototype.sender=function(e,t){return this.from(e,t)},Message.prototype.from=function(e,t){if(">"===e[e.length-1]){var s=e.indexOf("<");t=e.substring(0,s-1),e=e.substring(s+1,e.length-1)}return this.addressFrom.name=t||"",this.addressFrom.address=e,this},Message.prototype.to=function(e,t,s){if("boolean"==typeof t&&(s=t,t=void 0),">"===e[e.length-1]){var r=e.indexOf("<");t=e.substring(0,r-1),e=e.substring(r+1,e.length-1)}return s&&(this.addressTo=[]),t?this.addressTo.push({email:e,name:t}):this.addressTo.push(e),this},Message.prototype.cc=function(e,t,s){if("boolean"==typeof t&&(s=t,t=void 0),">"===e[e.length-1]){var r=e.indexOf("<");t=e.substring(0,r-1),e=e.substring(r+1,e.length-1)}return(s||!this.addressCC)&&(this.addressCC=[]),t?this.addressCC.push({email:e,name:t}):this.addressCC.push(e),this},Message.prototype.bcc=function(e,t){return(t||!this.addressBCC)&&(this.addressBCC=[]),this.addressBCC.push(e),this},Message.prototype.reply=function(e,t){return(t||!this.addressReply)&&(this.addressReply=[]),this.addressReply.push(e),this},Message.prototype.attachment=function(e,t){!t&&(t=framework_utils.getName(e));var s=framework_utils.getExtension(t);return!this.files&&(this.files=[]),this.files.push({name:t,filename:e,type:framework_utils.getContentType(s),extension:s}),this},Message.prototype.manually=function(){return this.$sending&&clearImmediate(this.$sending),this},Message.prototype.attachmentInline=function(e,t,s){!t&&(t=framework_utils.getName(e)),!this.files&&(this.files=[]);var r=framework_utils.getExtension(t);return this.files.push({name:t,filename:e,type:framework_utils.getContentType(r),disposition:"inline",contentId:s,extension:r}),this},Message.prototype.send2=function(e){var t=F.temporary["mail-settings"];if(!t){var s=F.config["mail-smtp-options"];s&&(t=s),F.temporary["mail-settings"]=t||{}}return mailer.send(F.config["mail-smtp"],t,this,e),this},Message.prototype.send=function(e,t,s){return mailer.send(e,t,this,s),this},Mailer.prototype.switchToTLS=function(e,t){var s=this;e.tls=!0,e.socket.removeAllListeners();var r=framework_utils.copy(t.tls,{socket:e.socket,host:e.socket.$host,ciphers:"SSLv3"});e.socket2=Tls.connect(r,function(){return s.$send(e,t,!0)}),e.socket2.on("error",function(t){mailer.destroy(e),s.closed=!0,s.callback&&s.callback(t),s.callback=null,e["try"]||-1!==t.stack.indexOf("ECONNRESET")||mailer.$events.error&&mailer.emit("error",t,e)}),e.socket2.on("clientError",function(t){mailer.destroy(e),s.callback&&s.callback(t),s.callback=null,mailer.$events.error&&!e["try"]&&mailer.emit("error",t,e)}),e.socket2.on("connect",function(){!t.secure&&s.$send(e,t)})},Mailer.prototype.destroy=function(e){return e.destroyed?this:(e.destroyed=!0,e.closed=!0,e.socket&&(e.socket.removeAllListeners(),e.socket.end(),e.socket.destroy(),e.socket=null),e.socket2&&(e.socket2.removeAllListeners(),e.socket2.end(),e.socket2.destroy(),e.socket2=null),delete this.connections[e.id],this)};const ATTACHMENT_SO={encoding:"base64"};Mailer.prototype.$writeattachment=function(e){var t=e.files?e.files.shift():!1;if(!t)return mailer.$writeline(e,"--"+e.boundary+"--","","."),e.messagecallback&&e.messagecallback(null,e.instance),e.messagecallback=null,this;var s=t.name,r=Fs.createReadStream(t.filename,ATTACHMENT_SO),n=[],i=t.extension,a="ics"===i;return n.push("--"+e.boundary),a||(t.contentId?(n.push('Content-Disposition: inline; filename="'+s+'"'),n.push("Content-ID: <"+t.contentId+">")):n.push('Content-Disposition: attachment; filename="'+s+'"')),n.push("Content-Type: "+t.type+";"+(a?' charset="utf-8"; method=REQUEST':"")),n.push("Content-Transfer-Encoding: base64"),n.push(CRLF),mailer.$writeline(e,n.join(CRLF)),r.$mailer=mailer,r.$mailerobj=e,r.on("data",writeattachment_data),CLEANUP(r,function(){mailer.$writeline(e,CRLF),mailer.$writeattachment(e)}),this},Mailer.prototype["try"]=function(e,t,s){return this.send(e,t,void 0,s)},Mailer.prototype.send2=function(e,t){var s=F.temporary["mail-settings"];if(!s){var r=F.config["mail-smtp-options"];r&&(s="object"==typeof r?r:r.toString().parseJSON()),s||(s={}),F.temporary["mail-settings"]=s}return this.send(F.config["mail-smtp"],s,e,t)},Mailer.prototype.send=function(e,t,s,r){t instanceof Array?(r=s,s=t,t={}):"function"==typeof t&&(r=t,t={});var n=this,i="abcdefghijkl"+INDEXSENDER++;n.connections[i]={};var a=n.connections[i];if(a.id=i,a["try"]=void 0===s,a.messages=a["try"]?EMPTYARRAY:s instanceof Array?s:[s],a.callback=r,a.closed=!1,a.message=null,a.files=null,a.count=0,a.socket,a.tls=!1,a.date=global.F?global.F.datetime:new Date,e=e||null,t&&t.secure&&!t.port&&(t.port=465),t=framework_utils.copy(t,{secure:!1,port:25,user:"",password:"",timeout:1e4,tls:null}),t.secure){var o=framework_utils.copy(t);o.host=e,a.socket=Tls.connect(o,function(){return mailer.$send(a,t)})}else a.socket=Net.createConnection(t.port,e);if(!e){var l=new Error("No SMTP server configuration. Mail message won't be sent.");return r&&r(l),F.error(l,"mail-smtp"),n}return a.socket.$host=e,a.host=e.substring(e.lastIndexOf(".",e.lastIndexOf(".")-1)+1),a.socket.on("error",function(e){mailer.destroy(a),a.callback&&a.callback(e),a.callback=null,a["try"]||-1!==e.stack.indexOf("ECONNRESET")||mailer.$events.error&&mailer.emit("error",e,a)}),a.socket.on("clientError",function(e){mailer.destroy(a),a.callback&&a.callback(e),a.callback=null,mailer.$events.error&&!a["try"]&&mailer.emit("error",e,a)}),a.socket.setTimeout(t.timeout||8e3,function(){var e=new Error(framework_utils.httpStatus(408));mailer.destroy(a),a.callback&&a.callback(e),a.callback=null,mailer.$events.error&&!a["try"]&&mailer.emit("error",e,a)}),a.socket.on("connect",function(){return!t.secure&&mailer.$send(a,t)}),n},Mailer.prototype.$writemessage=function(e,t){var s=this,r=e.messages.shift(),n=[];global.F&&global.F.stats.other.mail++,e.boundary="--totaljs"+e.date.getTime()+e.count,e.files=r.files,e.count++,t.push("MAIL FROM: <"+r.addressFrom.address+">"),n.push("Message-ID: <total"+INDEXATTACHMENT++ +"@WIN-t"+INDEXATTACHMENT+">"),n.push("MIME-Version: 1.0"),n.push("From: "+(r.addressFrom.name?unicode_encode(r.addressFrom.name)+" <"+r.addressFrom.address+">":r.addressFrom.address));var i;if(r.headers)for(var a=Object.keys(r.headers),o=0,i=a.length;i>o;o++)n.push(a[o]+": "+r.headers[a[o]]);i=r.addressTo.length;var l,c,u="";if(i){for(var o=0;i>o;o++)c=r.addressTo[o],l=c instanceof Object?"<"+c.email+">":"<"+c+">",t.push("RCPT TO: "+l),u+=(u?", ":"")+(c instanceof Object?unicode_encode(c.name)+" ":"")+l;n.push("To: "+u),u=""}if(r.addressCC){i=r.addressCC.length;for(var o=0;i>o;o++)c=r.addressCC[o],l=c instanceof Object?"<"+c.email+">":"<"+c+">",t.push("RCPT TO : "+l),u+=(u?", ":"")+(c instanceof Object?unicode_encode(c.name)+" ":"")+l;n.push("Cc : "+u),u=""}if(r.addressBCC){i=r.addressBCC.length;for(var o=0;i>o;o++)t.push("RCPT TO: <"+r.addressBCC[o]+">")}if(t.push("DATA"),t.push(""),n.push("Date: "+e.date.toUTCString()),n.push("Subject: "+unicode_encode(r.subject)),r.$unsubscribe&&n.push("List-Unsubscribe: "+r.$unsubscribe),r.addressReply){i=r.addressReply.length;for(var o=0;i>o;o++)u+=(""!==u?", ":"")+"<"+r.addressReply[o]+">";n.push("Reply-To: "+u),u=""}return n.push("Content-Type: multipart/mixed; boundary="+e.boundary),n.push(""),n.push("--"+e.boundary),n.push("Content-Type: "+(-1!==r.body.indexOf("<")&&-1!==r.body.lastIndexOf(">")?"text/html":"text/plain")+"; charset=utf-8"),n.push("Content-Transfer-Encoding: base64"),n.push(""),n.push(prepareBASE64(framework_utils.createBuffer(r.body.replace(REG_WINLINE,"\n").replace(REG_NEWLINE,CRLF)).toString("base64"))),e.message=n.join(CRLF),e.messagecallback=r.$callback,e.instance=r,n=null,s},Mailer.prototype.$writeline=function(e){if(e.closed)return!1;for(var t=e.socket2?e.socket2:e.socket,s=1;s<arguments.length;s++){var r=arguments[s];r&&(mailer.debug&&void 0,t.write(r+CRLF))}return!0},Mailer.prototype.$send=function(e,t,s){var r=this,n=[],i=!1,a=!1,o="",l=[],c=e.socket2?e.socket2:e.socket,u=e.host,d=null,h=!t.tls||e.tls&&t.tls;h&&mailer.$events.send&&mailer.emit("send",e),c.setEncoding("utf8"),c.on("end",function(){mailer.destroy(e),e.callback&&e.callback(),e.callback=null,d=null}),c.on("data",function(t){if(!e.closed)for(;;){var s=t.indexOf(BUF_CRLF);if(-1===s){d?(CONCAT[0]=d,CONCAT[1]=t,d=Buffer.concat(CONCAT)):d=t;break}var r=t.slice(0,s).toString("utf8");t=t.slice(s+BUF_CRLF.length),r&&c&&c.emit("line",r)}}),c.on("line",function(s){s=s.toUpperCase(),mailer.debug&&void 0;var d=+s.match(REG_STATE)[0];if(250!==d||a||REG_AUTH.test(s)&&(t.user&&t.password||t.xoauth2)&&(a=!0,t.xoauth2&&-1!==s.indexOf("XOAUTH2")?l.push("AUTH XOAUTH2 "+t.xoauth2):-1===s.lastIndexOf("XOAUTH")?(l.push("AUTH LOGIN"),l.push(framework_utils.createBuffer(t.user).toString("base64")),l.push(framework_utils.createBuffer(t.password).toString("base64"))):l.push("AUTH PLAIN "+framework_utils.createBuffer("\x00"+t.user+"\x00"+t.password).toString("base64"))),"-"!==s.substring(3,4))switch(!i&&a&&(i=!0,d=334),d){case 220:if(e.isTLS)return void mailer.switchToTLS(e,t);o=e.isTLS||t.user&&t.password||REG_ESMTP.test(s)?"EHLO":"HELO",mailer.$writeline(e,o+" "+u);break;case 250:case 251:case 235:case 999:if(mailer.$writeline(e,n.shift()),n.length)return;return void(e.messages.length?(mailer.$writemessage(e,n),mailer.$writeline(e,n.shift())):mailer.$writeline(e,"QUIT"));case 221:return mailer.destroy(e),e.callback&&e.callback(null,e["try"]?!0:e.count),void(e.callback=null);case 334:if(!r.tls&&!e.isTLS&&t.tls)return e.isTLS=!0,void mailer.$writeline(e,"STARTTLS");var h=l.shift();if(h)mailer.$writeline(e,h);else{var m=new Error("Forbidden.");mailer.destroy(e),e.callback&&e.callback(m),e.callback=null,mailer.$events.error&&!e["try"]&&mailer.emit("error",m,e)}return;case 354:return mailer.$writeline(e,e.message),mailer.$writeattachment(e),void(e.message=null);default:if(400>d)return;var m=new Error(s);return mailer.$events.error&&!e["try"]&&mailer.emit("error",m,e),e.messagecallback&&e.messagecallback(m,e.instance),e.messagecallback=null,void(e.message?(n=[],e.count--,c.emit("line","999 TRY NEXT MESSAGE")):(mailer.destroy(e),e.callback&&e.callback(m),e.callback=null))}}),s&&r.$writeline(e,"EHLO "+u)},Mailer.prototype.restart=function(){var e=this;e.removeAllListeners(),e.debug=!1,INDEXSENDER=0,INDEXATTACHMENT=0};var mailer=new Mailer;module.exports=mailer;