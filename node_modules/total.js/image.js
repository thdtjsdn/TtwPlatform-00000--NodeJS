"use strict";function u16(e,t){return e[t]<<8|e[t+1]}function u32(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function Image(e,t,r,i){var n=typeof e;this.width=r,this.height=i,this.builder=[],this.filename="string"===n?e:null,this.currentStream="object"===n?e:null,this.isIM=null==t?"im"===F.config["default-image-converter"]:t,this.outputType="string"===n?framework_utils.getExtension(e):"jpg",this.islimit=!1}function sort(e,t){return e.priority>t.priority?1:-1}function wrap(e,t){return(t?" ":"")+("-"===e?e:D+e.replace(REGEXP_ESCAPE,"")+D)}const sof={192:!0,193:!0,194:!0,195:!0,197:!0,198:!0,199:!0,201:!0,202:!0,203:!0,205:!0,206:!0,207:!0},child=require("child_process"),exec=child.exec,spawn=child.spawn,Fs=require("fs"),REGEXP_SVG=/(width="\d+")+|(height="\d+")+/g,REGEXP_PATH=/\//g,REGEXP_ESCAPE=/'/g,D="win"===require("os").platform().substring(0,3).toLowerCase()?'"':"'";var CACHE={},middlewares={};global.framework_utils||(global.framework_utils=require("./utils")),exports.measureGIF=function(e){return{width:e[6],height:e[8]}},exports.measureJPG=function(e){var t=e.length,r=0,i=255==e[0]&&216==e[1];if(i){for(r+=2;t>r;){for(;255!=e[r];)r++;for(;255==e[r];)r++;{if(sof[e[r]]){var n=u16(e,r+6),o=u16(e,r+4);return{width:n,height:o}}r+=u16(e,++r)}}return null}},exports.measurePNG=function(e){return{width:u32(e,16),height:u32(e,20)}},exports.measureSVG=function(e){var t=e.toString("utf8").match(REGEXP_SVG);if(t){for(var r=0,i=0,n=0,o=t.length;o>n;n++){var a=t[n];if(r>0&&i>0)break;!r&&a.startsWith('width="')&&(r=a.parseInt2()),!i&&a.startsWith('height="')&&(i=a.parseInt2())}return{width:r,height:i}}},exports.measure=function(e,t){switch(e){case".jpg":case".jpeg":case"jpg":case"jpeg":case"image/jpeg":return exports.measureJPG(t);case".gif":case"gif":case"image/gif":return exports.measureGIF(t);case".png":case"png":case"image/png":return exports.measurePNG(t);case".svg":case"svg":case"image/svg+xml":return exports.measureSVG(t)}},Image.prototype.clear=function(){var e=this;return e.builder=[],e},Image.prototype.measure=function(e){var t=this,r=t.filename.lastIndexOf(".");if(!t.filename)return void e(new Error("Measure does not support stream."));if(-1===r)return void e(new Error("This type of file is not supported."));var i=t.filename.substring(r).toLowerCase(),n=require("fs").createReadStream(t.filename,{start:0,end:".jpg"===i?4e4:24});return n.on("data",function(t){switch(i){case".jpg":return void e(null,exports.measureJPG(t));case".gif":return void e(null,exports.measureGIF(t));case".png":return void e(null,exports.measurePNG(t))}e(new Error("This type of file is not supported."))}),n.on("error",e),t},Image.prototype.$$measure=function(){var e=this;return function(t){e.measure(t)}},Image.prototype.save=function(e,t,r){var i=this;"function"==typeof e&&(t=e,e=null),!i.builder.length&&i.minify(),e=e||i.filename||"";var n=i.cmd(i.filename?i.filename:"-",e);F.isWindows&&(n=n.replace(REGEXP_PATH,"\\"));var o=exec(n,function(r){if(o.kill(),o=null,i.clear(),t){if(r)return void t(r,!1);var n=middlewares[i.outputType];if(!n)return t(null,!0);var a=Fs.createReadStream(e),s=Fs.createWriteStream(e+"_");a.pipe(n()).pipe(s),s.on("finish",function(){Fs.rename(e+"_",e,function(){t(null,!0)})})}});return i.currentStream&&(i.currentStream instanceof Buffer?o.stdin.end(i.currentStream):i.currentStream.pipe(o.stdin)),CLEANUP(o.stdin),r&&r(o.stdin),i},Image.prototype.$$save=function(e,t){var r=this;return function(i){r.save(e,i,t)}},Image.prototype.pipe=function(e,t,r){var i=this;"object"==typeof t&&(r=t,t=null),!i.builder.length&&i.minify(),!t&&(t=i.outputType);var n=spawn(i.isIM?"convert":"gm",i.arg(i.filename?wrap(i.filename):"-",(t?t+":":"")+"-"));n.stderr.on("data",e.emit.bind(e,"error")),n.stdout.on("data",e.emit.bind(e,"data")),n.stdout.on("end",e.emit.bind(e,"end")),n.on("error",e.emit.bind(e,"error"));var o=middlewares[t];return o?n.stdout.pipe(o()).pipe(e,r):n.stdout.pipe(e,r),i.currentStream&&(i.currentStream instanceof Buffer?n.stdin.end(i.currentStream):i.currentStream.pipe(n.stdin)),i},Image.prototype.stream=function(e,t){var r=this;!r.builder.length&&r.minify(),e||(e=r.outputType);var i=spawn(r.isIM?"convert":"gm",r.arg(r.filename?wrap(r.filename):"-",(e?e+":":"")+"-"));r.currentStream&&(r.currentStream instanceof Buffer?i.stdin.end(r.currentStream):r.currentStream.pipe(i.stdin)),t&&t(i.stdin);var n=middlewares[e];return n?i.stdout.pipe(n()):i.stdout},Image.prototype.cmd=function(e,t){var r=this,i="";if(!r.islimit){var n=F.config["default-image-consumption"];r.limit("memory",15*n),r.limit("map",30*n)}r.builder.sort(sort);for(var o=r.builder.length,a=0;o>a;a++)i+=(i?" ":"")+r.builder[a].cmd;return(r.isIM?"convert":"gm -convert")+wrap(e,!0)+" "+i+wrap(t,!0)},Image.prototype.arg=function(e,t){var r=this,i=[];if(!r.isIM&&i.push("-convert"),e&&i.push(e),!r.islimit){var n=F.config["default-image-consumption"];r.limit("memory",15*n),r.limit("map",30*n)}r.builder.sort(sort);for(var o=r.builder.length,a=0;o>a;a++){var s=r.builder[a],u=s.cmd.indexOf(" ");-1===u?i.push(s.cmd):(i.push(s.cmd.substring(0,u)),i.push(s.cmd.substring(u+1).replace(/"/g,"")))}return t&&i.push(t),i},Image.prototype.identify=function(e){var t=this;return exec((t.isIM?"identify":"gm identify")+wrap(t.filename,!0),function(t,r){if(t)return void e(t,null);var i=r.split(" "),n=i[2].split("x"),o={type:i[1],width:framework_utils.parseInt(n[0]),height:framework_utils.parseInt(n[1])};e(null,o)}),t},Image.prototype.$$identify=function(){var e=this;return function(t){e.identify(t)}},Image.prototype.push=function(e,t,r,i){var n=this,o=e;null!=t&&(o+=i&&"string"==typeof t?" "+D+t.replace(REGEXP_ESCAPE,"")+D:" "+t);var a=CACHE[o];return a?(a.priority=r,n.builder.push(a)):(CACHE[o]={cmd:o,priority:r},n.builder.push(CACHE[o])),n},Image.prototype.output=function(e){var t=this;return"."===e[0]&&(e=e.substring(1)),t.outputType=e,t},Image.prototype.resize=function(e,t,r){r=r||"";var i=this,n="";return e&&t?n=e+"x"+t:e&&!t?n=e+"x":!e&&t&&(n="x"+t),i.push("-resize",n+r,1,!0)},Image.prototype.thumbnail=function(e,t,r){r=r||"";var i=this,n="";return e&&t?n=e+"x"+t:e&&!t?n=e:!e&&t&&(n="x"+t),i.push("-thumbnail",n+r,1,!0)},Image.prototype.geometry=function(e,t,r){r=r||"";var i=this,n="";return e&&t?n=e+"x"+t:e&&!t?n=e:!e&&t&&(n="x"+t),i.push("-geometry",n+r,1,!0)},Image.prototype.filter=function(e){return this.push("-filter",e,1,!0)},Image.prototype.trim=function(){return this.push("-trim +repage",1)},Image.prototype.limit=function(e,t){return this.islimit=!0,this.push("-limit",e+" "+t,1)},Image.prototype.extent=function(e,t){var r=this,i="";return e&&t?i=e+"x"+t:e&&!t?i=e:!e&&t&&(i="x"+t),r.push("-extent",i,4,!0)},Image.prototype.miniature=function(e,t,r,i){return this.filter(i||"Hamming").thumbnail(e,t).background(r?r:"white").align("center").extent(e,t)},Image.prototype.resizeCenter=function(e,t,r){return this.resize(e,t,"^").background(r?r:"white").align("center").crop(e,t)},Image.prototype.resizeAlign=function(e,t,r,i){return this.resize(e,t,"^").background(i?i:"white").align(r||"center").crop(e,t)},Image.prototype.scale=function(e,t,r){r=r||"";var i=this,n="";return e&&t?n=e+"x"+t:e&&!t?n=e:!e&&t&&(n="x"+t),i.push("-scale",n+r,1,!0)},Image.prototype.crop=function(e,t,r,i){return this.push("-crop",e+"x"+t+"+"+(r||0)+"+"+(i||0),4,!0)},Image.prototype.quality=function(e){return this.push("-quality",e||80,5,!0)},Image.prototype.align=function(e){var t;switch(e){case"left top":case"top left":t="NorthWest";break;case"left bottom":case"bottom left":t="SouthWest";break;case"right top":case"top right":t="NorthEast";break;case"right bottom":case"bottom right":t="SouthEast";break;case"left center":case"center left":case"left":t="West";break;case"right center":case"center right":case"right":t="East";break;case"bottom center":case"center bottom":case"bottom":t="South";break;case"top center":case"center top":case"top":t="North";break;case"center center":case"center":case"middle":t="Center";break;default:t=e}return t&&this.push("-gravity",t,3,!0),this},Image.prototype.gravity=function(e){return this.align(e)},Image.prototype.blur=function(e){return this.push("-blur",e,10,!0)},Image.prototype.normalize=function(){return this.push("-normalize",null,10)},Image.prototype.rotate=function(e){return this.push("-rotate",e||0,8,!0)},Image.prototype.flip=function(){return this.push("-flip",null,10)},Image.prototype.flop=function(){return this.push("-flop",null,10)},Image.prototype.minify=function(){return this.push("+profile","*",null,10,!0)},Image.prototype.grayscale=function(){return this.push("-colorspace","Gray",10,!0)},Image.prototype.bitdepth=function(e){return this.push("-depth",e,10,!0)},Image.prototype.colors=function(e){return this.push("-colors",e,10,!0)},Image.prototype.background=function(e){return this.push("-background",e,2,!0).push("-extent 0x0",null,2)},Image.prototype.fill=function(e){return this.push("-fill",e,2,!0)},Image.prototype.sepia=function(){return this.push("-modulate","115,0,100",4).push("-colorize","7,21,50",5)},Image.prototype.watermark=function(e,t,r,i,n){return this.push("-draw","image over {1},{2} {3},{4} {5}{0}{5}".format(e,t||0,r||0,i||0,n||0,D),6,!0)},Image.prototype.make=function(e){return e.call(this,this),this},Image.prototype.command=function(e,t,r,i){return r===!0&&(r=0,i=!0),this.push(e,t,r||10,i)},exports.Image=Image,exports.Picture=Image,exports.init=function(e,t,r,i){return new Image(e,t,r,i)},exports.load=function(e,t,r,i){return new Image(e,t,r,i)},exports.middleware=function(e,t){"."===e[0]&&(e=e.substring(1)),middlewares[e]=t},exports.restart=function(){middlewares={}},exports.clear=function(){CACHE={}},global.Image=exports;