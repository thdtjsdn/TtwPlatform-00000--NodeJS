"use strict";function Framework(){this.$id=null,this.version=2940,this.version_header="2.9.4",this.version_node=process.version.toString().replace("v","").replace(/\./g,"").parseFloat(),this.config={debug:!0,trace:!0,"trace-console":!0,name:"Total.js",version:"1.0.0",author:"",secret:Os.hostname()+"-"+Os.platform()+"-"+Os.arch(),"default-xpoweredby":"Total.js","etag-version":"","directory-controllers":"/controllers/","directory-components":"/components/","directory-views":"/views/","directory-definitions":"/definitions/","directory-temp":"/tmp/","directory-models":"/models/","directory-resources":"/resources/","directory-public":"/public/","directory-public-virtual":"/app/","directory-modules":"/modules/","directory-source":"/source/","directory-logs":"/logs/","directory-tests":"/tests/","directory-databases":"/databases/","directory-workers":"/workers/","directory-packages":"/packages/","directory-private":"/private/","directory-isomorphic":"/isomorphic/","directory-configs":"/configs/","directory-services":"/services/","directory-themes":"/themes/","static-url":"","static-url-script":"/js/","static-url-style":"/css/","static-url-image":"/img/","static-url-video":"/video/","static-url-font":"/fonts/","static-url-download":"/download/","static-url-components":"/components.","static-accepts":{flac:!0,jpg:!0,jpeg:!0,png:!0,gif:!0,ico:!0,js:!0,css:!0,txt:!0,xml:!0,woff:!0,woff2:!0,otf:!0,ttf:!0,eot:!0,svg:!0,zip:!0,rar:!0,pdf:!0,docx:!0,xlsx:!0,doc:!0,xls:!0,html:!0,htm:!0,appcache:!0,manifest:!0,map:!0,ogv:!0,ogg:!0,mp4:!0,mp3:!0,webp:!0,webm:!0,swf:!0,"package":!0,json:!0,md:!0,m4v:!0,jsx:!0},"default-layout":"layout","default-theme":"","default-request-length":10,"default-websocket-request-length":2,"default-websocket-encodedecode":!0,"default-maximum-file-descriptors":0,"default-timezone":"","default-root":"","default-response-maxage":"11111111","default-errorbuilder-status":200,"default-cors-maxage":120,"default-request-timeout":3e3,"default-dependency-timeout":1500,"default-image-converter":"gm","default-image-quality":93,"default-image-consumption":30,"allow-static-files":!0,"allow-gzip":!0,"allow-websocket":!0,"allow-websocket-compression":!0,"allow-compile":!0,"allow-compile-script":!0,"allow-compile-style":!0,"allow-compile-html":!0,"allow-performance":!1,"allow-custom-titles":!1,"allow-cache-snapshot":!1,"allow-debug":!1,"allow-head":!1,"allow-filter-errors":!0,"disable-strict-server-certificate-validation":!0,"disable-clear-temporary-directory":!1,"default-interval-clear-resources":20,"default-interval-clear-cache":10,"default-interval-precompile-views":61,"default-interval-websocket-ping":3,"default-interval-clear-dnscache":120,"default-interval-uptodate":5},this.global={},this.resources={},this.connections={},this.functions={},this.themes={},this.versions=null,this.workflows={},this.uptodates=null,this.schedules=[],this.isDebug=!0,this.isTest=!1,this.isLoaded=!1,this.isWorker=!0,this.isCluster=process.env.PASSENGER_APP_ENV?!1:require("cluster").isWorker,this.routes={sitemap:null,web:[],system:{},files:[],cors:[],websockets:[],middleware:{},redirects:{},resize:{},request:[],views:{},merge:{},mapping:{},packages:{},blocks:{},resources:{},mmr:{}},this.owners=[],this.modificators=null,this.helpers={},this.modules={},this.models={},this.sources={},this.controllers={},this.dependencies={},this.isomorphic={},this.components={has:!1,css:!1,js:!1,views:{},instances:{},version:null,links:"",groups:{}},this.convertors=[],this.tests=[],this.errors=[],this.problems=[],this.changes=[],this.server=null,this.port=0,this.ip="",this.validators={email:new RegExp("^[a-zA-Z0-9-_.+]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"),url:/^(https?:\/\/(?:www\.|(?!www))[^\s.#!:?+=&@!$'~*,;\/()[\]]+\.[^\s#!?+=&@!$'~*,;()[\]\\]{2,}\/?|www\.[^\s#!:.?+=&@!$'~*,;\/()[\]]+\.[^\s#!?+=&@!$'~*,;()[\]\\]{2,}\/?)/i,phone:/^[+]?[(]?[0-9]{3}[)]?[-\s.]?[0-9]{3}[-\s.]?[0-9]{4,6}$/im,zip:/^\d{5}(?:[-\s]\d{4})?$/,uid:/^\d{14,}[a-z]{3}[01]{1}$/},this.workers={},this.databases={},this.directory=HEADERS.workers.cwd=directory,this.isLE=Os.endianness?"LE"===Os.endianness():!0,this.isHTTPS=!1,this.datetime=new Date,this.temporary={path:{},notfound:{},processing:{},range:{},views:{},versions:{},dependencies:{},other:{},internal:{},owners:{},ready:{}},this.stats={other:{websocketPing:0,websocketCleaner:0,obsolete:0,restart:0,mail:0},request:{request:0,pending:0,web:0,xhr:0,file:0,websocket:0,get:0,options:0,head:0,post:0,put:0,path:0,upload:0,schema:0,mmr:0,blocked:0,"delete":0,mobile:0,desktop:0},response:{view:0,json:0,websocket:0,timeout:0,custom:0,binary:0,pipe:0,file:0,image:0,destroy:0,stream:0,streaming:0,plain:0,empty:0,redirect:0,forward:0,notModified:0,sse:0,mmr:0,errorBuilder:0,error400:0,error401:0,error403:0,error404:0,error408:0,error431:0,error500:0,error501:0}},this.cache=new FrameworkCache,this.path=new FrameworkPath,this._request_check_redirect=!1,this._request_check_referer=!1,this._request_check_POST=!1,this._request_check_robot=!1,this._length_middleware=0,this._length_request_middleware=0,this._length_files=0,this._length_wait=0,this._length_themes=0,this._length_cors=0,this._length_subdomain_web=0,this._length_subdomain_websocket=0,this._length_convertors=0,this.isVirtualDirectory=!1,this.isTheme=!1,this.isWindows="win"===Os.platform().substring(0,3).toLowerCase(),this.$events={}}function scriptNow(){return new Date}function flags_to_object(e){var t={};return e.forEach(function(e){t[e]=!0}),t}function merge_middleware(e,t,r){"string"==typeof t&&(t=[t]);for(var o=0,n=t.length;n>o;o++){var i=e.indexOf(t[o]);-1===i&&(r?e.unshift(t[o]):e.push(t[o]))}return e}function sitemapurl(e){var t,r=e.indexOf("/");-1!==r&&(t=e.substring(r),e=e.substring(0,r));var o=F.sitemap(e,!0,"");return o&&(e=o.url,t&&(e+="/"===e[e.length-1]?t.substring(1):t)),e}function onSchema_callback(e,t,r){e?r(e):r(null,t)}function compile_file(e){fsFileRead(e.options.filename,function(t,r){var o=e.req,n=o.uri;if(t)return F.error(t,e.options.filename,n),F.temporary.notfound[o.$key]=!0,delete F.temporary.processing[o.$key],void e.$file();var i=F.path.temp((F.id?"i-"+F.id+"_":"")+createTemporaryKey(n.pathname));F.path.verify("temp"),Fs.writeFileSync(i,compile_content(o.extension,framework_internal.parseBlock(F.routes.blocks[n.pathname],r.toString(ENCODING)),e.options.filename),ENCODING);var s=Fs.statSync(i),a=F.temporary.path[o.$key]=[i,s.size,s.mtime.toUTCString()];compile_gzip(a,function(){delete F.temporary.processing[o.$key],e.$file()})})}function compile_merge(e){var t=e.req,r=t.uri,o=F.routes.merge[r.pathname],n=o.filename;if(!F.config.debug&&existsSync(n)){var i=Fs.statSync(n),s=F.temporary.path[t.$key]=[n,i.size,i.mtime.toUTCString()];return void compile_gzip(s,function(){delete F.temporary.processing[t.$key],e.$file()})}var a=Fs.createWriteStream(n);a.on("finish",function(){var r=Fs.statSync(n),o=F.temporary.path[t.$key]=[n,r.size,r.mtime.toUTCString()];this.destroy&&this.destroy(),compile_gzip(o,function(){delete F.temporary.processing[t.$key],e.$file()})});var l=0,c=null;return o.files.wait(function(e,n){var i;if("#"!==e[0]){var s=e.split("#");i=s[1],i&&(e=s[0])}if(e.startsWith("http://")||e.startsWith("https://"))return void U.request(e,FLAGS_DOWNLOAD,function(r,o){var s=compile_content(t.extension,framework_internal.parseBlock(i,o),e);"js"===t.extension?";"!==s[s.length-1]&&(s+=";"):"html"===t.extension&&s[s.length-1]!==NEWLINE&&(s+=NEWLINE),DEBUG&&merge_debug_writer(a,e,t.extension,l++,i),a.write(s),n()});if("~"!==e[0]){var u=F.path["public"](e);F.isVirtualDirectory&&!existsSync(u)&&(u=F.path.virtual(e)),e=u}else e=e.substring(1);var p=e.indexOf("*");if(-1!==p){var u=e.substring(p+1).toLowerCase(),f=u.length;return!c&&(c=[]),c.push(arguments[0]),void U.ls(e.substring(0,p),function(e){for(var t=0,r=e.length;r>t;t++)o.files.push("~"+e[t]);n()},function(e,t){return t?!0:e.substring(e.length-f).toLowerCase()===u})}fsFileRead(e,function(s,c){if(s)return F.error(s,o.filename,r),void n();var u=compile_content(t.extension,framework_internal.parseBlock(i,c.toString(ENCODING)),e);"js"===t.extension?";"!==u[u.length-1]&&(u+=";\r\n"):"html"===t.extension&&u[u.length-1]!==NEWLINE&&(u+=NEWLINE),DEBUG&&merge_debug_writer(a,e,t.extension,l++,i),a.write(u),n()})},function(){if(a.end(),c)for(var e=0,t=c.length;t>e;e++)o.files.splice(o.files.indexOf(c[e]),1)}),F}function merge_debug_writer(e,t,r,o,n){var i="===========================================================================================",s="js"===r?"/*\n":"css"===r?"/*!\n":"<!--\n",a="js"===r||"css"===r?"\n */":"\n-->",l="html"!==r?" * ":" ";e.write((o>0?"\n\n":"")+s+l+i+"\n"+l+"MERGED : "+t+"\n"+(n?l+"BLOCKS: "+n+"\n":"")+l+i+a+"\n\n",ENCODING)}function component_debug(e,t,r){var o="===========================================================================================",n="js"===r?"/*\n":"css"===r?"/*!\n":"<!--\n",i="js"===r||"css"===r?"\n */":"\n-->",s="html"!==r?" * ":" ";return n+s+o+"\n"+s+"COMPONENT: "+e+"\n"+s+o+i+"\n\n"+t}function compile_check(e){var t=e.req,r=t.uri;return F.routes.merge[r.pathname]?(compile_merge(e),F):void fsFileExists(e.options.filename,function(r,o,n,i){if(r){if(!e.noCompress&&("js"===t.extension||"css"===t.extension)&&F.config["allow-compile"]&&!REG_NOCOMPRESS.test(e.options.filename))return compile_file(e);var s=F.temporary.path[t.$key]=[e.options.filename,o,i.mtime.toUTCString()];F.config["allow-gzip"]&&COMPRESSION[U.getContentType(t.extension)]?compile_gzip(s,function(){e.$file(),delete F.temporary.processing[t.$key]}):(e.$file(),delete F.temporary.processing[t.$key])}else F.isVirtualDirectory?F.compile_virtual(e):(F.temporary.notfound[t.$key]=!0,delete F.temporary.processing[t.$key],e.$file())})}function compile_gzip(e,t){var r=F.path.temp("file"+e[0].hash().toString().replace("-","0")+".gz");e.push(r);var o=Fs.createReadStream(e[0]),n=Fs.createWriteStream(r);CLEANUP(n,function(){fsFileExists(r,function(r,o){e.push(o),t()})}),o.pipe(Zlib.createGzip(GZIPFILE)).pipe(n),CLEANUP(o)}function compile_content(e,t,r){if(r&&REG_NOCOMPRESS.test(r))return t;switch(e){case"js":return F.config["allow-compile-script"]?framework_internal.compile_javascript(t,r):t;case"css":t=F.config["allow-compile-style"]?framework_internal.compile_css(t,r):t;var o=t.match(REG_COMPILECSS);if(o)for(var n=0,i=o.length;i>n;n++){var s=o[n],a=s.substring(4,s.length-1);t=t.replace(s,"url("+F.$version(a)+")")}return t}return t}function connection_tunning(e){e.setNoDelay(!0),e.setKeepAlive(!0,10)}function requestcontinue_middleware(e,t){F.$requestcontinue(e,t,e.headers)}function cors_callback0(e){e.$total_end()}function cors_callback1(e){e.$total_urlencoded()}function cors_callback_multipart(e,t,r){4===e.$type?F.$requestcontinue_mmr(e,t,r):e.$total_multipart(r)}function websocketcontinue_middleware(e){F.$websocketcontinue(e,e.$wspath,e.headers)}function next_upgrade_continue(e,t){e.upgrade(t)}function FrameworkRoute(){this.route={}}function FrameworkPath(){}function FrameworkCache(){this.items={},this.count=1,this.interval}function subscribe_timeout(e){e.controller&&e.controller.precache&&e.controller.precache(null,null,null),e.$total_cancel()}function subscribe_timeout_middleware(e){e.$total_execute2()}function subscribe_validate_callback(e,t){e.$total_execute(t)}function Controller(e,t,r,o){this.name=e,t?(this.language=t.$language,this.req=t):this.req=EMPTYREQUEST,this.isConnected=!0,this.isController=!0,this._currentView=o,r?(this.res=r,this.req.controller=this.res.controller=this):this.res=EMPTYOBJECT}function next_controller_invalid(e,t){e.content(t)}function querystring_encode(e,t){return null!=e?e instanceof Date?encodeURIComponent(e.format()):"string"==typeof e?encodeURIComponent(e):e.toString():t||""}function WebSocket(e,t,r){this._keys=[],this.id=r,this.online=0,this.connections={},this.name=t,this.isController=!0,this.url=U.path(e),this.route=null,this.$events={}}function websocket_valid_array(e,t){return-1!==t.indexOf(e)}function websocket_valid_fn(e,t,r){return r&&r(e,t)?!0:!1}function websocketcheck_ping(e){e.$ping||(e.close(),F.stats.other.websocketCleaner++)}function WebSocketClient(e,t){this.$ping=!0,this.container,this._id,this.id="",this.socket=t,this.req=e,this.errors=0,this.length=0,this.current={},this.type=2}function websocket_inflate(e){this.$websocket.inflatechunks.push(e),this.$websocket.inflatechunkslength+=e.length}function websocket_deflate(e){this.$websocket.deflatechunks.push(e),this.$websocket.deflatechunkslength+=e.length}function websocket_ondata(e){this.$websocket.$ondata(e)}function websocket_onerror(e){this.destroy&&this.destroy(),this.$websocket.$onerror(e)}function websocket_close(){this.destroy&&this.destroy(),this.$websocket.$onclose()}function buffer_concat(e,t){for(var r=U.createBufferSize(t),o=0,n=0,i=e.length;i>n;n++)e[n].copy(r,o),o+=e[n].length;return r}function extend_request(e){PROTOREQ=e,Object.defineProperty(e,"ip",{get:function(){if(this._ip)return this._ip;var e=this.headers["x-forwarded-for"];return e?this._ip=e.split(",",1)[0]||this.connection.remoteAddress:this._ip||(this._ip=this.connection.remoteAddress),this._ip}}),Object.defineProperty(e,"query",{get:function(){return!this._querydata&&F.$onParseQueryUrl(this),this._querydata},set:function(e){this._querydata=e}}),Object.defineProperty(e,"subdomain",{get:function(){if(this._subdomain)return this._subdomain;var e=this.uri.host.toLowerCase().replace(/^www\./i,"").split(".");return e.length>2?this._subdomain=e.slice(0,e.length-2):this._subdomain=null,this._subdomain}}),Object.defineProperty(e,"host",{get:function(){return this.headers.host}}),Object.defineProperty(e,"split",{get:function(){return this.$path?this.$path:this.$path=framework_internal.routeSplit(this.uri.pathname,!0)}}),Object.defineProperty(e,"secured",{get:function(){return"https:"===this.uri.protocol||"wss:"===this.uri.protocol}}),Object.defineProperty(e,"language",{get:function(){return this.$language||(this.$language=(((this.headers["accept-language"]||"").split(";")[0]||"").split(",")[0]||"").toLowerCase()),this.$language},set:function(e){this.$language=e}}),Object.defineProperty(e,"mobile",{get:function(){return void 0===this.$mobile&&(this.$mobile=REG_MOBILE.test(this.headers["user-agent"])),this.$mobile}}),Object.defineProperty(e,"robot",{get:function(){return void 0===this.$robot&&(this.$robot=REG_ROBOT.test(this.headers["user-agent"])),this.$robot}}),e.signature=function(e){return F.encrypt((this.headers["user-agent"]||"")+"#"+this.ip+"#"+this.url+"#"+(e||""),"request-signature",!1)},e.localize=function(){return F.onLocale&&(this.$language=F.onLocale(this,this.res,this.isStaticFile)),this.$language},e.noCache=function(){return this.res&&this.res.noCache(),this},e.notModified=function(e,t){return F.notModified(this,this.res,e,t)},e.cookie=function(e){if(this.cookies)return $decodeURIComponent(this.cookies[e]||"");var t=this.headers.cookie;if(!t)return"";this.cookies={};for(var r=t.split(";"),o=0,n=r.length;n>o;o++){var i=r[o].trim(),s=i.indexOf("=");-1!==s&&(this.cookies[i.substring(0,s)]=i.substring(s+1))}return $decodeURIComponent(this.cookies[e]||"")},e.authorization=function(){var e=this.headers.authorization;if(!e)return HEADERS.authorization;var t={user:"",password:"",empty:!0};try{var r=U.createBuffer(e.replace("Basic ","").trim(),"base64").toString(ENCODING).split(":");t.user=r[0]||"",t.password=r[1]||"",t.empty=!t.user||!t.password}catch(o){}return t},e.authorize=function(e){var t=F.onAuthorize;if(!t)return e(null,null,!1),this;var r=this;return t(r,r.res,r.flags,function(t,o){"boolean"!=typeof t&&(o=t,t=!o),r.isAuthorized=t,e(null,o,t)}),this},e.clear=function(e){var t=this,r=t.files;if(!r||e&&t._manual)return t;t.body=null,t.query=null,t.cookies=null;var o=r.length;if(!o)return t;for(var n=[],i=0;o>i;i++)r[i].rem&&n.push(r[i].path);return F.unlink(n),t.files=null,t},e.hostname=function(e){var t=this,r=t.uri;return e&&"/"!==e[0]&&(e="/"+e),r.protocol+"//"+r.hostname+(r.port&&80!==r.port?":"+r.port:"")+(e||"")},e.$total_success=function(){this.$total_timeout&&clearTimeout(this.$total_timeout),this.$total_canceled=!0,this.controller&&(this.controller.res.controller=null,this.controller=null)},e.$total_file=function(){var e=this.method[0];"G"===e||"H"===e?this.$total_endfile():this.on("end",this.$total_endfile)},e.$total_multipart=function(e){F.stats.request.upload++,this.$total_route=F.lookup(this,this.uri.pathname,this.flags,0),this.$total_header=e,this.$total_route?(F.path.verify("temp"),framework_internal.parseMULTIPART(this,e,this.$total_route,F.config["directory-temp"])):this.$total_status(404)},e.$total_urlencoded=function(){this.$total_route=F.lookup(this,this.uri.pathname,this.flags,0),this.$total_route?(this.buffer_has=!0,this.buffer_exceeded=!1,this.on("data",this.$total_parsebody),this.$total_end()):this.$total_status(404)},e.$total_status=function(e){null==e?F.stats.request.blocked++:F.stats.request["error"+e]++,F.reqstats(!1,!1),this.res.writeHead(e),this.res.end(U.httpStatus(e)),F.$events["request-end"]&&F.emit("request-end",this,this.res),this.clear(!0)},e.$total_end=function(){var e=this.method[0];"G"===e||"H"===e||"O"===e?(this.$total_route&&this.$total_route.schema&&(this.$total_schema=!0),this.buffer_data=null,this.$total_prepare()):this.on("end",this.$total_end2)},e.$total_execute=function(e,t){var r=this.$total_route,o=this.res;if((t||!r)&&(F.stats.response["error"+e]++,500!==e&&F.$events.error&&F.emit("error"+e,this,o,this.$total_exception)),!r)return void(400===e&&this.$total_exception instanceof framework_builders.ErrorBuilder?(F.stats.response.errorBuilder++,this.$language&&this.$total_exception.setResource(this.$language),o.options.body=this.$total_exception.output(!0),o.options.code=this.$total_exception.status,o.options.type=this.$total_exception.contentType,o.$text()):(o.options.body=U.httpStatus(e)+prepare_error(this.$total_exception),o.options.type=CT_TEXT,o.options.code=e||404,o.$text()));var n=r.controller;r.isMOBILE_VARY&&(this.$mobile=!0),void 0===r.currentViewDirectory&&(r.currentViewDirectory=n&&"#"!==n[0]&&"default"!==n&&"unknown"!==n?"/"+n+"/":"");var i=new Controller(n,this,o,r.currentViewDirectory);i.isTransfer=this.$total_transfer,i.exception=this.$total_exception,this.controller=i,!this.$total_canceled&&r.timeout&&(this.$total_timeout&&clearTimeout(this.$total_timeout),this.$total_timeout=setTimeout(subscribe_timeout,r.timeout,this)),r.isDELAY&&o.writeContinue(),this.$total_schema&&(this.body.$$controller=i),r.middleware?async_middleware(0,this,o,r.middleware,subscribe_timeout_middleware,r.options,i):this.$total_execute2()},e.$total_execute2=function(){var e=this.$total_route.controller,t=this.controller;try{if(F.onTheme&&(t.themeName=F.onTheme(t)),t.isCanceled)return;var r="@"+e;if(F.$events.controller&&F.emit("controller",t,e,this.$total_route.options),F.$events[r]&&F.emit(r,t,e,this.$total_route.options),t.isCanceled)return;this.$total_route.isCACHE&&!F.temporary.other[this.uri.pathname]&&(F.temporary.other[this.uri.pathname]=this.path),this.$total_route.isGENERATOR?async.call(t,this.$total_route.execute,!0)(t,framework_internal.routeParam(this.$total_route.param.length?this.split:this.path,this.$total_route)):this.$total_route.param.length?this.$total_route.execute.apply(t,framework_internal.routeParam(this.split,this.$total_route)):this.$total_route.execute.call(t,t.req,t.res)}catch(o){F.error(o,e,this.uri),this.$total_exception=o,this.$total_route=F.lookup(this,"#500",EMPTYARRAY,0),this.$total_execute(500,!0)}},e.$total_parsebody=function(e){this.buffer_exceeded||(this.buffer_exceeded||(CONCAT[0]=this.buffer_data,CONCAT[1]=e,this.buffer_data=Buffer.concat(CONCAT)),this.buffer_data.length/1024<this.$total_route.length||(this.buffer_exceeded=!0,this.buffer_data=U.createBuffer()))},e.$total_cancel=function(){F.stats.response.timeout++,clearTimeout(this.$total_timeout),this.controller&&(this.controller.isTimeout=!0,this.controller.isCanceled=!0,this.$total_route=F.lookup(this,"#408",EMPTYARRAY,0),this.$total_execute(408,!0))},e.$total_validate=function(e,t,r){if(this.$total_schema=!1,!this.$total_route.schema||"DELETE"===this.method)return t(this,r);var o=this;F.onSchema(this,this.$total_route.schema[0],this.$total_route.schema[1],function(e,n){e?(o.$total_400(e),t=null):(F.stats.request.schema++,o.body=n,o.$total_schema=!0,t(o,r))},e.schema[2],e.novalidate)},e.$total_authorize=function(e,t,r){var o=e?1:2,n=this.buffer_exceeded?431:401;if(this.$flags+=o,t&&(this.user=t),!this.$total_route||!this.$total_route.isUNIQUE||r||this.$total_route.MEMBER&&this.$total_route.MEMBER!==o){var i=F.lookup(this,this.buffer_exceeded?"#431":this.uri.pathname,this.flags,this.buffer_exceeded?0:o),s=this.$isAuthorized?404:401,n=this.buffer_exceeded?431:s;!i&&(i=F.lookup(this,"#"+s,EMPTYARRAY,0)),this.$total_route=i,this.$total_route&&this.$total_schema?this.$total_validate(this.$total_route,subscribe_validate_callback,n):this.$total_execute(n)}else 401===n&&this.$total_schema?this.$total_validate(this.$total_route,subscribe_validate_callback,n):this.$total_execute(n,!0)},e.$total_end2=function(){var e=this.$total_route;if(this.buffer_exceeded)return e=F.lookup(this,"#431",EMPTYARRAY,0),this.buffer_data=null,void(e?(this.$total_route=e,this.$total_execute(431,!0)):this.res.throw431());if(!this.buffer_data||e&&e.isBINARY||(this.buffer_data=this.buffer_data.toString(ENCODING)),!this.buffer_data)return e&&e.schema&&(this.$total_schema=!0),this.buffer_data=null,void this.$total_prepare();if(e.isXML){if(2!==this.$type)return this.$total_400('Invalid "Content-Type".'),void(this.buffer_data=null);try{F.$onParseXML(this),this.buffer_data=null,this.$total_prepare()}catch(t){F.error(t,null,this.uri),this.$total_500(t)}}else{if(e.isRAW)return this.body=this.buffer_data,this.buffer_data=null,void this.$total_prepare();if(!this.$type)return this.buffer_data=null,void this.$total_400('Invalid "Content-Type".');if(1===this.$type)try{F.$onParseJSON(this),this.buffer_data=null}catch(r){return void this.$total_400("Invalid JSON data.")}else F.$onParseQueryBody(this);e.schema&&(this.$total_schema=!0),this.buffer_data=null,this.$total_prepare()}},e.$total_endfile=function(){var e=this,t=this.res;if(!F._length_files)return t["continue"]();for(var r=0;r<F._length_files;r++){var o=F.routes.files[r];try{if(o.extensions&&!o.extensions[e.extension])continue;if(o.url){var n=!1,i=o.url.length;if(!o.wildcard&&!o.fixedfile&&i!==e.path.length-1)continue;for(var s=0;i>s;s++)if(o.url[s]!==e.path[s]){n=!0;break}if(n)continue}else if(o.onValidate&&!o.onValidate.call(F,e,t,!0))continue;return void(o.middleware?e.$total_endfilemiddleware(o):o.execute.call(F,e,t,!1))}catch(a){return F.error(a,o.controller,e.uri),void t.throw500()}}t["continue"]()},e.$total_endfilemiddleware=function(e){this.$total_filemiddleware=e,async_middleware(0,this,this.res,e.middleware,total_endmiddleware,e.options)},e.$total_400=function(e){this.$total_route=F.lookup(this,"#400",EMPTYARRAY,0),this.$total_exception=e,this.$total_execute(400,!0)},e.$total_500=function(e){this.$total_route=F.lookup(this,"#500",EMPTYARRAY,0),this.$total_exception=e,this.$total_execute(500,!0)},e.$total_prepare=function(){var e=this,t=e.flags.length;if(F.onAuthorize)F.onAuthorize(e,e.res,e.flags,function(r,o){var n=t!==e.flags.length;n&&(e.$flags+=e.flags.slice(t).join("")),"boolean"!=typeof r&&(o=r,r=!o),e.isAuthorized=r,e.$total_authorize(r,o,n)});else{e.$total_route||(e.$total_route=F.lookup(e,e.buffer_exceeded?"#431":e.uri.pathname,e.flags,0)),e.$total_route||(e.$total_route=F.lookup(e,"#404",EMPTYARRAY,0));var r=e.buffer_exceeded?431:404;e.$total_schema&&e.$total_route?e.$total_validate(e.$total_route,subscribe_validate_callback,r):e.$total_execute(r)}}}function total_endmiddleware(e){try{e.$total_filemiddleware.execute.call(F,e,e.res,!1)}catch(t){F.error(t,e.$total_filemiddleware.controller+" :: "+e.$total_filemiddleware.name,e.uri),e.res.throw500()}}function extend_response(e){PROTORES=e,e.cookie=function(e,t,r,o){var n=this;if(!n.headersSent&&!n.success){var i=e+"=",s=[i+t],a=typeof r;r&&!U.isDate(r)&&"object"===a&&(o=r,r=o.expires||o.expire||null),"string"===a&&(r=r.parseDateExpiration()),o||(o={}),o.path=o.path||"/",r&&s.push("Expires="+r.toUTCString()),o.domain&&s.push("Domain="+o.domain),o.path&&s.push("Path="+o.path),o.secure&&s.push("Secure"),(o.httpOnly||o.httponly||o.HttpOnly)&&s.push("HttpOnly");var l=n.getHeader("set-cookie")||[],c=l.findIndex(function(e){return e.startsWith(i)});return-1!==c&&l.splice(c,1),l.push(s.join("; ")),n.setHeader("Set-Cookie",l),n}},e.noCache=function(){var e=this;return e.$nocache?e:(e.req&&(delete e.req.headers["if-none-match"],delete e.req.headers["if-modified-since"]),e.getHeader(HEADER_CACHE)&&(e.removeHeader(HEADER_CACHE),e.removeHeader("Expires"),e.removeHeader("Etag"),e.removeHeader("Last-Modified"),e.setHeader(HEADER_CACHE,"private, no-cache, no-store, max-age=0"),e.setHeader("Expires",-1)),e.$nocache=!0,e)},e.status=function(e){return this.options.code=e,this},e.send=function(e,t,r){if(this.headersSent)return this;if(this.controller&&this.req.$total_success(),e instanceof Buffer&&!t&&!r)return this.end(e),this;var o=this,n=this.req,i=r,s="HEAD"===n.method;switch(void 0===t&&(t=e,e=o.$statuscode||200),typeof t){case"string":i||(i="text/html");break;case"number":i||(i="text/plain"),t=U.httpStatus(t);break;case"boolean":case"object":if(!s){if(t instanceof framework_builders.ErrorBuilder){var a=t.output(!0);200!==t.status&&(o.options.code=t.status),i=t.contentType?t.contentType:CT_JSON,t=a,F.stats.response.errorBuilder++}else t=JSON.stringify(t);!i&&(i=CT_JSON)}}var l=n.headers["accept-encoding"]||"",c={};c[HEADER_CACHE]="private, no-cache, no-store, max-age=0",c.Vary="Accept-Encoding"+(n.$mobile?", User-Agent":""),/text|application/.test(i)&&(i+="; charset=utf-8"),c[HEADER_TYPE]=i,o.$custom(),!l&&isGZIP(n)&&(l="gzip");var u=F.config["allow-gzip"]&&-1!==l.indexOf("gzip");if(s)return u&&(c["Content-Encoding"]="gzip"),o.writeHead(200,c),o.end(),o;if(!u)return o.writeHead(e,c),o.end(t,ENCODING),o;var p=U.createBuffer(t);return Zlib.gzip(p,function(r,n){r?(o.writeHead(e,c),o.end(t,ENCODING)):(c["Content-Encoding"]="gzip",o.writeHead(e,c),o.end(n,ENCODING))}),o},e.content=function(e,t,r,o,n){if("object"==typeof o){var i=n;n=o,o=i}var s=this;return s.options.code=e,s.options.compress=void 0===o||o===!0,s.options.body=t,s.options.type=r,n&&(s.options.headers=n),s.$text(),s},e.redirect=function(e,t){return this.options.url=e,t&&(this.options.permanent=t),this.$redirect(),this},e.file=function(e,t,r,o){return this.options.filename=e,r&&(this.options.headers=r),o&&(this.options.callback=o),t&&(this.options.download=t),this.$file()},e.stream=function(e,t,r,o,n,i){var s=this;return s.options.type=e,s.options.stream=t,r&&(s.options.download=r),o&&(s.options.headers=o),n&&(s.options.callback=n),s.options.compress=i?!1:!0,s.$stream(),s},e.binary=function(e,t,r,o,n){return this.options.type=t,this.options.body=e,this.options.encoding=r,o&&(this.options.download=o),n&&(this.options.headers=n),this.$binary(),this},e.proxy=function(e,t,r,o){var n=this;return n.success||n.headersSent?n:(o&&(n.options.callback=o),t&&(n.options.headers=t),r&&(n.options.timeout=r),U.resolve(e,function(e,t){var o={};o[HEADER_CACHE]="private, no-cache, no-store, max-age=0",n.options.headers&&U.extend_headers2(o,n.options.headers);var i={protocol:t.protocol,auth:t.auth,method:"GET",hostname:t.hostname,port:t.port,path:t.path,agent:!1,headers:o},s="https:"===i.protocol?require("https"):http,a=F.config["allow-gzip"]&&-1!==(n.req.headers["accept-encoding"]||"").lastIndexOf("gzip"),l=s.get(i,function(e){if(!n.success&&!n.headersSent){var t=e.headers["content-type"],r=-1!==(e.headers["content-encoding"]||"").lastIndexOf("gzip"),o=!r&&a&&(-1!==t.indexOf("text/")||-1!==t.lastIndexOf("javascript")||-1!==t.lastIndexOf("json")),i=e.headers["content-disposition"]||"";return i&&n.setHeader("Content-Disposition",i),n.setHeader(HEADER_TYPE,t),n.setHeader("Vary","Accept-Encoding"+(n.req.$mobile?", User-Agent":"")),n.on("error",function(){e.close(),response_end(n)}),o?(n.setHeader("Content-Encoding","gzip"),void e.pipe(Zlib.createGzip(GZIPSTREAM)).pipe(n)):void(r&&!a?e.pipe(Zlib.createGunzip()).pipe(n):e.pipe(n))}});r&&l.setTimeout(r,function(){n.throw408()}),l.on("close",function(){n.success||(F.stats.response.pipe++,response_end(n))})}),n)},e.image=function(e,t,r,o){var n=this;return n.options.make=t,r&&(n.options.headers=r),o&&(n.options.callback=o),"object"==typeof e?n.options.stream=e:n.options.filename=e,n.$image(),n},e.image_nocache=function(e,t,r,o){return this.options.cache=!1,this.image(e,t,r,o)},e.json=function(e){var t=this;return F.stats.response.json++,t.options.body=JSON.stringify(e),t.options.type=CT_JSON,t.$text()},e["continue"]=function(e){var t=this,r=t.req;if(e&&(t.options.callback=e),t.success||t.headersSent)return t;if(!F.config["static-accepts"][r.extension])return t.throw404(),t;if(r.$key=createTemporaryKey(r),F.temporary.notfound[r.$key])return t.throw404(),t;var o=r.uri.pathname,n=o.lastIndexOf("/"),i=F.routes.resize[o.substring(0,n+1)],s=!1,a=null;if(i?(o=o.substring(n+1),s=i.extension["*"]||i.extension[r.extension],s?(o=i.path+$decodeURIComponent(o),a=F.onMapping(o,o,!1,!1)):a=F.onMapping(o,o,!0,!0)):a=F.onMapping(o,o,!0,!0),!s)return F.components.has&&F.components[r.extension]&&r.uri.pathname===F.config["static-url-components"]+r.extension&&(t.noCompress=!0,a=F.path.temp("components"+(r.query.group?"_g"+r.query.group:"")+"."+r.extension)),t.options.filename=a,t.$file(),t;if(!i.ishttp)return t.options.cache=i.cache,t.options.make=i.fn,t.options.filename=a,t.$image(),t;if(F.temporary.processing[r.uri.pathname])return setTimeout($continue_timeout,500,t),t;var l=F.path.temp(r.$key);return F.temporary.path[r.$key]?(t.options.filename=r.uri.pathname,t.$file(),t):(F.temporary.processing[r.uri.pathname]=!0,U.download(o,FLAGS_DOWNLOAD,function(e,o){var n=Fs.createWriteStream(l);o.pipe(n),CLEANUP(n,function(){delete F.temporary.processing[r.uri.pathname];var e=o.headers["content-type"];return 200===o.statusCode&&e&&e.startsWith("image/")?(t.options.cache=i.cache,t.options.filename=l,t.options.maker=i.fn,void t.$image()):void t.throw404()})}),t)},e.$file=function(){var e=this,t=e.options;if(e.headersSent)return e;var r=this.req;if(!r.$key&&(r.$key=createTemporaryKey(r)),F.temporary.notfound[r.$key])return DEBUG&&(F.temporary.notfound[r.$key]=void 0),e.throw404(),e;"@"===t.filename[0]&&(t.filename=F.path["package"](t.filename.substring(1)));var o,n=F.temporary.path[r.$key];if(r.extension||(r.$key&&(r.extension=U.getExtension(r.$key)),!r.extension&&n&&(r.extension=U.getExtension(n),o=r.extension.lastIndexOf(";"),-1!==o&&(r.extension=r.extension.substring(0,o))),!r.extension&&t.filename&&(r.extension=U.getExtension(t.filename))),n&&RELEASE&&!e.$nocache&&r.headers["if-modified-since"]===n[2])return $file_notmodified(e,n),e;if(void 0===n)return F.temporary.processing[r.$key]?(r.processing>F.config["default-request-timeout"]?e.throw408():(r.processing+=500,setTimeout($file_processing,500,e)),e):(F.temporary.processing[r.$key]=!0,compile_check(e),e);var i,s=U.getContentType(r.extension),a=r.headers["accept-encoding"]||"";!a&&isGZIP(r)&&(a="gzip");var l=F.config["allow-gzip"]&&COMPRESSION[s]&&-1!==a.indexOf("gzip")&&n.length>2,c=r.headers.range,u=!e.$nocache&&RELEASE&&"text/cache-manifest"!==s;if(i=u?l?c?HEADERS.file_release_compress_range:HEADERS.file_release_compress:c?HEADERS.file_release_range:HEADERS.file_release:l?c?HEADERS.file_debug_compress_range:HEADERS.file_debug_compress:c?HEADERS.file_debug_range:HEADERS.file_debug,r.$mobile?i.Vary="Accept-Encoding, User-Agent":i.Vary="Accept-Encoding",i[HEADER_TYPE]=s,REG_TEXTAPPLICATION.test(s)&&(i[HEADER_TYPE]+="; charset=utf-8"),u&&!e.getHeader("Expires")?i.Expires=DATE_EXPIRES:i.Expires&&RELEASE&&delete i.Expires,e.options.headers&&(i=U.extend_headers(i,e.options.headers)),e.options.download){var p=encodeURIComponent(e.options.download);i["Content-Disposition"]="attachment; "+(REG_UTF8.test(e.options.download)?"filename*=utf-8''"+p:'filename="'+p+'"')}else i["Content-Disposition"]&&delete i["Content-Disposition"];return e.getHeader("Last-Modified")?delete i["Last-Modified"]:i["Last-Modified"]=n[2],i.Etag=ETAG+F.config["etag-version"],c?($file_range(n[0],c,i,e),e):((DEBUG||e.$nocache)&&F.isProcessed(r.$key)&&(F.temporary.path[r.$key]=void 0),n[1]&&!l?i[HEADER_LENGTH]=n[1]:i[HEADER_LENGTH]&&delete i[HEADER_LENGTH],F.stats.response.file++,void("HEAD"===r.method?(e.writeHead(e.options.code||200,i),e.end(),response_end(e)):l?(n[4]?i[HEADER_LENGTH]=n[4]:delete i[HEADER_LENGTH],e.writeHead(e.options.code||200,i),fsStreamRead(n[3],void 0,$file_nocompress,e)):(e.writeHead(e.options.code||200,i),fsStreamRead(n[0],void 0,$file_nocompress,e))))},e.$redirect=function(){var e=this;return e.headersSent?e:(HEADERS.redirect.Location=e.options.url,e.writeHead(e.options.permanent?301:302,HEADERS.redirect),e.end(),response_end(e),F.stats.response.redirect++,e)},e.$binary=function(){var e=this;if(e.headersSent)return e;var t=e.req,r=e.options,o=t.headers["accept-encoding"]||"";!o&&isGZIP(t)&&(o="gzip");var n=F.config["allow-gzip"]&&COMPRESSION[r.type]&&-1!==o.indexOf("gzip"),i=n?HEADERS.binary_compress:HEADERS.binary;return i.Vary="Accept-Encoding"+(t.$mobile?", User-Agent":""),r.download?i["Content-Disposition"]="attachment; filename="+encodeURIComponent(r.download):i["Content-Disposition"]&&delete i["Content-Disposition"],i[HEADER_TYPE]=r.type,r.headers&&(i=U.extend_headers(i,r.headers)),F.stats.response.binary++,"HEAD"===t.method?(e.writeHead(r.code||200,i),e.end(),response_end(e)):n?(e.writeHead(r.code||200,i),Zlib.gzip(r.encoding&&"binary"!==r.encoding?r.body.toString(r.encoding):r.body,function(t,r){return e.end(r)}),response_end(e)):(e.writeHead(r.code||200,i),e.end(r.encoding&&"binary"!==r.encoding?r.body.toString(r.encoding):r.body),response_end(e)),e},e.$stream=function(){var e=this,t=e.req,r=e.options;if(e.headersSent)return e;var o=t.headers["accept-encoding"]||"";!o&&isGZIP(t)&&(o="gzip");var n,i=(void 0===r.compress||r.compress)&&F.config["allow-gzip"]&&COMPRESSION[r.type]&&-1!==o.indexOf("gzip");return n=RELEASE?i?HEADERS.stream_release_compress:HEADERS.stream_release:i?HEADERS.stream_debug_compress:HEADERS.stream_debug,n.Vary="Accept-Encoding"+(t.$mobile?", User-Agent":""),RELEASE&&(n.Expires=DATE_EXPIRES,n["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT"),r.download?n["Content-Disposition"]="attachment; filename="+encodeURIComponent(r.download):n["Content-Disposition"]&&delete n["Content-Disposition"],n[HEADER_TYPE]=r.type,r.headers&&(n=U.extend_headers(n,r.headers)),F.stats.response.stream++,F.reqstats(!1,t.isStaticFile),"HEAD"===t.method?(e.writeHead(r.code||200,n),e.end(),response_end(e),e):i?(e.writeHead(r.code||200,n),e.on("error",function(){r.stream.close()}),r.stream.pipe(Zlib.createGzip(GZIPSTREAM)).pipe(e),framework_internal.onFinished(e,function(){return framework_internal.destroyStream(r.stream)}),response_end(e),e):(e.writeHead(r.code||200,n),framework_internal.onFinished(e,function(){return framework_internal.destroyStream(r.stream)}),r.stream.pipe(e),response_end(e),e)},e.$image=function(){var e=this,t=e.options;if(t.cache===!1)return $image_nocache(e);var r=this.req;if(!r.$key&&(r.$key=createTemporaryKey(r)),F.temporary.notfound[r.$key])return DEBUG&&(F.temporary.notfound[r.$key]=void 0),e.throw404(),e;var o=r.$key||createTemporaryKey(r);if(F.temporary.notfound[o])return e.throw404(),e;var n=F.temporary.path[o];if(t.filename&&"@"===t.filename[0]&&(t.filename=F.path["package"](t.filename.substring(1))),void 0!==n)return e.$file(),e;if(F.temporary.processing[r.$key])return r.processing>F.config["default-request-timeout"]?e.throw408():(r.processing+=500,setTimeout($image_processing,500,e)),e;var i=F.id?"i-"+F.id+"_":"";return t.name=F.path.temp(i+o),F.temporary.processing[o]=!0,t.stream?fsFileExists(t.name,$image_stream,e):fsFileExists(t.filename,$image_filename,e),e},e.$custom=function(){return F.stats.response.custom++,response_end(this),this},e.$text=function(){var e=this,t=e.req,r=e.options;if(e.headersSent)return e;var o=t.headers["accept-encoding"]||"";!o&&isGZIP(t)&&(o="gzip");var n,i=F.config["allow-gzip"]&&(void 0===r.compress||r.compress)?-1!==o.indexOf("gzip"):!1;return n=t.$mobile?i?HEADERS.content_mobile_release:HEADERS.content_mobile:i?HEADERS.content_compress:HEADERS.content,REG_TEXTAPPLICATION.test(r.type)&&(r.type+="; charset=utf-8"),n[HEADER_TYPE]=r.type,r.headers&&(n=U.extend_headers(n,r.headers)),"HEAD"===t.method?(e.writeHead(r.code||200,n),e.end()):i?(e.writeHead(r.code||200,n),Zlib.gzip(r.body instanceof Buffer?r.body:U.createBuffer(r.body),function(t,r){return e.end(r,e.options.encoding||ENCODING)})):(e.writeHead(r.code||200,n),e.end(r.body,e.options.encoding||ENCODING)),response_end(e),e},e.throw400=function(e){return this.options.code=400,e&&(this.options.problem=e),this.$throw()},e.throw401=function(e){return this.options.code=401,e&&(this.options.problem=e),this.$throw()},e.throw403=function(e){return this.options.code=403,e&&(this.options.problem=e),this.$throw()},e.throw404=function(e){return this.options.code=404,e&&(this.options.problem=e),this.$throw()},e.throw408=function(e){return this.options.code=408,e&&(this.options.problem=e),this.$throw()},e.throw409=function(e){return this.options.code=409,e&&(this.options.problem=e),this.$throw()},e.throw431=function(e){return this.options.code=431,e&&(this.options.problem=e),this.$throw()},e.throw500=function(e){return e&&F.error(e,null,this.req.uri),this.options.code=500,this.options.body=U.httpStatus(500)+e?prepare_error(e):"",this.$throw()},e.throw501=function(e){return this.options.code=501,e&&(this.options.problem=e),this.$throw()},e.$throw=function(){var e=this;if(e.success||e.headersSent)return e;var t=e.req;e.options.problem&&F.problem(e.options.problem,"response"+e.options.code+"()",t.uri,t.ip),e.writeHead(e.options.code||501,e.options.headers||HEADERS.responseCode),"HEAD"===t.method?e.end():e.end(e.options.body||U.httpStatus(e.options.code)+prepare_error(e.options&&e.options.problem));var r="error"+e.options.code;return F.$events[r]&&F.emit(r,t,e,e.options.problem),F.stats.response[r]++,response_end(e),e}}function $continue_timeout(e){e["continue"]()}function $file_processing(e){e.$file()}function $file_notmodified(e,t){var r=e.req,o=HEADERS.file_lastmodified;e.getHeader("Last-Modified")?delete o["Last-Modified"]:o["Last-Modified"]=t[2],e.getHeader("Expires")?delete o.Expires:o.Expires=DATE_EXPIRES,e.getHeader("ETag")?delete o.Etag:o.Etag=ETAG+F.config["etag-version"],o[HEADER_TYPE]=U.getContentType(r.extension),e.writeHead(304,o),e.end(),F.stats.response.notModified++,response_end(e)}function $file_nocompress(e,t,r){e.pipe(r),framework_internal.onFinished(r,function(){t(),framework_internal.destroyStream(e)}),response_end(r)}function $file_range(e,t,r,o){var n=t.replace(REG_RANGE,"").split("-"),i=+n[0]||0,s=+n[1]||0,a=F.temporary.range[e];a||(a=Fs.statSync(e).size,RELEASE&&(F.temporary.range[e]=a)),0===s&&(s=a-1),i>s&&(i=0,s=a-1),s>a&&(s=a-1);var l=s-i+1;r[HEADER_LENGTH]=l,r["Content-Range"]="bytes "+i+"-"+s+"/"+a;var c=o;return F.stats.response.streaming++,"HEAD"===c.method?(o.writeHead(206,r),o.end(),response_end(o),F):(o.writeHead(206,r),RANGE.start=i,RANGE.end=s,fsStreamRead(e,RANGE,$file_range_callback,o),F)}function $file_range_callback(e,t,r){framework_internal.onFinished(r,function(){framework_internal.destroyStream(e),t()}),e.pipe(r),response_end(r)}function $image_nocache(e){var t=e.options;if(t.stream){var r=framework_image.load(t.stream,IMAGEMAGICK);return t.make.call(r,r,e),t.type=U.getContentType(r.outputType),t.stream=r,F.stats.response.image++,e.$stream(),F}fsFileExists(t.filename,function(r){if(r){F.path.verify("temp");var o=framework_image.load(t.filename,IMAGEMAGICK);t.make.call(o,o,e),F.stats.response.image++,t.type=U.getContentType(o.outputType),t.stream=o,e.$stream()}else t.headers=null,e.throw404()})}function $image_processing(e){e.$image()}function $image_stream(e,t,r,o,n){var i=n.req,s=n.options;if(e)return delete F.temporary.processing[i.$key],F.temporary.path[i.$key]=[s.name,o.size,o.mtime.toUTCString()],n.options.filename=s.name,n.options.stream=null,n.$file(),void(DEBUG&&(F.temporary.path[i.$key]=void 0));F.path.verify("temp");var a=framework_image.load(s.stream,IMAGEMAGICK);if(s.make.call(a,a,n),i.extension=U.getExtension(s.name),i.extension!==a.outputType){var l=s.name.lastIndexOf("."+i.extension);-1!==l?s.name=s.name.substring(0,l)+"."+a.outputType:s.name+="."+a.outputType}F.stats.response.image++,a.save(s.name,function(e){if(delete F.temporary.processing[i.$key],e)F.temporary.notfound[i.$key]=!0,n.throw500(e),DEBUG&&(F.temporary.notfound[i.$key]=void 0);else{var t=Fs.statSync(s.name);F.temporary.path[i.$key]=[s.name,t.size,t.mtime.toUTCString()],s.filename=s.name,n.$file()}})}function $image_filename(e,t,r,o,n){var i=n.req,s=n.options;if(!e)return delete F.temporary.processing[i.$key],F.temporary.notfound[i.$key]=!0,n.throw404(),void(DEBUG&&(F.temporary.notfound[i.$key]=void 0));F.path.verify("temp");var a=framework_image.load(s.filename,IMAGEMAGICK);if(s.make.call(a,a,n),i.extension=U.getExtension(s.name),i.extension!==a.outputType){var l=s.name.lastIndexOf("."+i.extension);-1===l?s.name+="."+a.outputType:s.name=s.name.substring(0,l)+"."+a.outputType}F.stats.response.image++,a.save(s.name,function(e){if(delete F.temporary.processing[i.$key],e)F.temporary.notfound[i.$key]=!0,n.throw500(e),DEBUG&&(F.temporary.notfound[i.$key]=void 0);else{var t=Fs.statSync(s.name);F.temporary.path[i.$key]=[s.name,t.size,t.mtime.toUTCString()],n.options.filename=s.name,n.$file()}})}function response_end(e){F.reqstats(!1,e.req.isStaticFile),e.success=!0,!e.req.isStaticFile&&F.$events["request-end"]&&F.emit("request-end",e.req,e),e.req.clear(!0),e.controller&&e.req.$total_success(),e.options.callback&&e.options.callback(),e.controller=null}function $decodeURIComponent(e){try{return decodeURIComponent(e)}catch(t){return e}}function fsFileRead(e,t,r,o,n){U.queue("F.files",F.config["default-maximum-file-descriptors"],function(i){Fs.readFile(e,function(e,s){i(),t(e,s,r,o,n)})})}function fsFileExists(e,t,r,o,n){U.queue("F.files",F.config["default-maximum-file-descriptors"],function(i){Fs.lstat(e,function(e,s){i(),t(!e&&s.isFile(),s?s.size:0,s?s.isFile():!1,s,r,o,n)})})}function fsStreamRead(e,t,r,o,n){r||(r=t,t=void 0);var i;t?(i=HEADERS.fsStreamReadRange,i.start=t.start,i.end=t.end,i.start>i.end&&delete i.end):i=HEADERS.fsStreamRead,U.queue("F.files",F.config["default-maximum-file-descriptors"],function(t){var s=Fs.createReadStream(e,i);s.on("error",NOOP),r(s,t,o,n)},e)}function createTemporaryKey(e){return(e.uri?e.uri.pathname:e).replace(REG_TEMPORARY,"-").substring(1)}function prepare_error(e){return e?e instanceof ErrorBuilder?" :: "+e.plain():e.stack?RELEASE?"":e.stack:RELEASE?"":" :: "+e.toString():""}function prepare_filename(e){return"@"===e[0]?F.isWindows?U.combine(F.config["directory-temp"],e.substring(1)):F.path["package"](e.substring(1)):U.combine("/",e)}function prepare_staticurl(e,t){if(!e)return e;if("~"===e[0]){if(t)return U.path(e.substring(1))}else if("//"===e.substring(0,2)||"http:/"===e.substring(0,6)||"https:/"===e.substring(0,7))return e;return e}function prepare_isomorphic(e,t){return'if(window["isomorphic"]===undefined)window.isomorphic=window.I={};isomorphic["'+e.replace(/\.js$/i,"")+'"]=(function(framework,F,U,utils,Utils,is_client,is_server){var module={},exports=module.exports={};'+t+";return exports;})(null,null,null,null,null,true,false)"}function isGZIP(e){var t=e.headers["user-agent"];return t&&-1!==t.lastIndexOf("Firefox")}function prepare_viewname(e){return e.substring(e.indexOf("/",2)+1)}function existsSync(e,t){try{var r=Fs.statSync(e);return r?t?r.isFile():!0:!1}catch(o){return!1}}function async_middleware(e,t,r,o,n,i,s){if(r.success||r.headersSent)return t.$total_route&&t.$total_success(),void(n=null);var a=o[e++];if(!a)return n&&n(t,r);var l=F.routes.middleware[a];if(!l)return F.error("Middleware not found: "+a,null,t.uri),async_middleware(e,t,r,o,n,i,s);var c=l.call(framework,t,r,function(a){return a===!1?(t.$total_route&&t.$total_success(),void(n=null)):a instanceof Error||a instanceof ErrorBuilder?(r.throw500(a),void(n=null)):void async_middleware(e,t,r,o,n,i,s)},i,s);c===!1&&(t.$total_route&&t.$total_success(),n=null)}function parseComponent(e,t){var r={};r.css="",r.js="",r.install="";for(var o=0,n=0;;){if(o=e.indexOf('<script type="text/totaljs">'),-1===o)break;if(n=e.indexOf("</script>",o),-1===n)break;r.install+=(r.install?"\n":"")+e.substring(o,n).replace(/<(\/)?script.*?>/g,""),e=e.substring(0,o).trim()+e.substring(n+9).trim()}for(;;){if(o=e.indexOf("<style"),-1===o)break;if(n=e.indexOf("</style>",o),-1===n)break;r.css+=(r.css?"\n":"")+e.substring(o,n).replace(/<(\/)?style.*?>/g,""),e=e.substring(0,o).trim()+e.substring(n+8).trim()}for(;;){if(o=e.indexOf("<script>"),-1===o&&(o=e.indexOf('<script type="text/javascript">'),-1===o))break;if(n=e.indexOf("</script>",o),-1===n)break;r.js+=(r.js?"\n":"")+e.substring(o,n).replace(/<(\/)?script.*?>/g,""),e=e.substring(0,o).trim()+e.substring(n+9).trim()}return r.js&&(r.js=framework_internal.compile_javascript(r.js,t)),r.css&&(r.css=framework_internal.compile_css(r.css,t)),r.body=e,r}function controller_json_workflow(e){var t=this;t.id=e,t.$exec(t.route.workflow,null,t.callback())}function parseSchema(e){var t=F.temporary.internal["$$$"+e];return t?t:(t=e.split("/"),t[1]||(t[1]=t[0],t[0]="default"),F.temporary.internal["$$$"+e]=t,t)}const Qs=require("querystring"),Os=require("os"),Fs=require("fs"),Zlib=require("zlib"),Path=require("path"),Crypto=require("crypto"),Parser=require("url"),Child=require("child_process"),Util=require("util"),http=require("http"),ENCODING="utf8",HEADER_CACHE="Cache-Control",HEADER_TYPE="Content-Type",HEADER_LENGTH="Content-Length",CT_TEXT="text/plain",CT_HTML="text/html",CT_JSON="application/json",COMPRESSION={"text/plain":!0,"text/javascript":!0,"text/css":!0,"text/jsx":!0,"application/javascript":!0,"application/x-javascript":!0,"application/json":!0,"text/xml":!0,"image/svg+xml":!0,"text/x-markdown":!0,"text/html":!0},REG_TEMPORARY=/\//g,REG_MOBILE=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet/i,REG_ROBOT=/search|agent|bot|crawler|spider/i,REG_VERSIONS=/(href|src)="[a-zA-Z0-9\/:\-.]+\.(jpg|js|css|png|gif|svg|html|ico|json|less|sass|scss|swf|txt|webp|woff|woff2|xls|xlsx|xml|xsl|xslt|zip|rar|csv|doc|docx|eps|gzip|jpe|jpeg|manifest|mov|mp3|flac|mp4|ogg|package|pdf)"/gi,REG_COMPILECSS=/url\(.*?\)/g,REG_ROUTESTATIC=/^(\/\/|https:|http:)+/,REG_RANGE=/bytes=/,REG_EMPTY=/\s/g,REG_ACCEPTCLEANER=/\s|\./g,REG_SANITIZE_BACKSLASH=/\/\//g,REG_WEBSOCKET_ERROR=/ECONNRESET|EHOSTUNREACH|EPIPE|is closed/i,REG_WINDOWSPATH=/\\/g,REG_SCRIPTCONTENT=/<|>|;/,REG_HTTPHTTPS=/^(\/)?(http|https):\/\//i,REG_NOCOMPRESS=/[.|-]+min\.(css|js)$/i,REG_TEXTAPPLICATION=/text|application/,REG_ENCODINGCLEANER=/[;\s]charset=utf-8/g,REG_SKIPERROR=/epipe|invalid\sdistance/i,REG_UTF8=/[^\x20-\x7E]+/,FLAGS_PROXY=["post","json"],FLAGS_INSTALL=["get"],FLAGS_DOWNLOAD=["get","dnscache"],QUERYPARSEROPTIONS={maxKeys:69},EMPTYARRAY=[],EMPTYOBJECT={},EMPTYREQUEST={uri:{}},SINGLETONS={},REPOSITORY_HEAD="$head",REPOSITORY_META_TITLE="$title",REPOSITORY_META_DESCRIPTION="$description",REPOSITORY_META_KEYWORDS="$keywords",REPOSITORY_META_AUTHOR="$author",REPOSITORY_META_IMAGE="$image",REPOSITORY_PLACE="$place",REPOSITORY_SITEMAP="$sitemap",ATTR_END='"',ETAG="858",CONCAT=[null,null],CLUSTER_CACHE_SET={TYPE:"cache-set"},CLUSTER_CACHE_REMOVE={TYPE:"cache-remove"},CLUSTER_CACHE_REMOVEALL={TYPE:"cache-remove-all"},CLUSTER_CACHE_CLEAR={TYPE:"cache-clear"},GZIPFILE={memLevel:9},GZIPSTREAM={memLevel:1};Object.freeze(EMPTYOBJECT),Object.freeze(EMPTYARRAY),Object.freeze(EMPTYREQUEST),global.EMPTYOBJECT=EMPTYOBJECT,global.EMPTYARRAY=EMPTYARRAY;var PROTORES,PROTOREQ,RANGE={start:0,end:0},HEADERS={},SUCCESSHELPER={success:!0};HEADERS.responseCode={},HEADERS.responseCode[HEADER_TYPE]=CT_TEXT,HEADERS.responseCode["X-Powered-By"]="Total.js",HEADERS.redirect={},HEADERS.redirect[HEADER_TYPE]=CT_HTML+"; charset=utf-8",HEADERS.redirect[HEADER_LENGTH]="0",HEADERS.sse={},HEADERS.sse[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.sse.Pragma="no-cache",HEADERS.sse.Expires="-1",HEADERS.sse[HEADER_TYPE]="text/event-stream",HEADERS.sse["X-Powered-By"]="Total.js",HEADERS.mmr={},HEADERS.mmr[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.mmr.Pragma="no-cache",HEADERS.mmr.Expires="-1",HEADERS.mmr["X-Powered-By"]="Total.js",HEADERS.proxy={},HEADERS.proxy["X-Proxy"]="total.js",HEADERS.file_lastmodified={},HEADERS.file_lastmodified["Access-Control-Allow-Origin"]="*",HEADERS.file_lastmodified[HEADER_CACHE]="public, max-age=11111111",HEADERS.file_lastmodified["X-Powered-By"]="Total.js",HEADERS.file_release_compress={},HEADERS.file_release_compress[HEADER_CACHE]="public, max-age=11111111",HEADERS.file_release_compress.Vary="Accept-Encoding",HEADERS.file_release_compress["Access-Control-Allow-Origin"]="*",HEADERS.file_release_compress["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS.file_release_compress["Content-Encoding"]="gzip",HEADERS.file_release_compress["X-Powered-By"]="Total.js",HEADERS.file_release_compress_range={},HEADERS.file_release_compress_range["Accept-Ranges"]="bytes",HEADERS.file_release_compress_range[HEADER_CACHE]="public, max-age=11111111",HEADERS.file_release_compress_range.Vary="Accept-Encoding",HEADERS.file_release_compress_range["Access-Control-Allow-Origin"]="*",HEADERS.file_release_compress_range["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS.file_release_compress_range["Content-Encoding"]="gzip",HEADERS.file_release_compress_range[HEADER_LENGTH]="0",HEADERS.file_release_compress_range["Content-Range"]="",HEADERS.file_release_compress_range["X-Powered-By"]="Total.js",HEADERS.file_release={},HEADERS.file_release[HEADER_CACHE]="public, max-age=11111111",HEADERS.file_release.Vary="Accept-Encoding",HEADERS.file_release["Access-Control-Allow-Origin"]="*",HEADERS.file_release["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS.file_release["X-Powered-By"]="Total.js",HEADERS.file_release_range={},HEADERS.file_release_range["Accept-Ranges"]="bytes",HEADERS.file_release_range[HEADER_CACHE]="public, max-age=11111111",HEADERS.file_release_range.Vary="Accept-Encoding",HEADERS.file_release_range["Access-Control-Allow-Origin"]="*",HEADERS.file_release_range["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS.file_release_range[HEADER_LENGTH]="0",HEADERS.file_release_range["Content-Range"]="",HEADERS.file_release_range["X-Powered-By"]="Total.js",HEADERS.file_debug_compress={},HEADERS.file_debug_compress[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.file_debug_compress.Vary="Accept-Encoding",HEADERS.file_debug_compress["Access-Control-Allow-Origin"]="*",HEADERS.file_debug_compress.Pragma="no-cache",HEADERS.file_debug_compress.Expires="-1",HEADERS.file_debug_compress["Content-Encoding"]="gzip",HEADERS.file_debug_compress["X-Powered-By"]="Total.js",HEADERS.file_debug_compress_range={},HEADERS.file_debug_compress_range["Accept-Ranges"]="bytes",HEADERS.file_debug_compress_range[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.file_debug_compress_range.Vary="Accept-Encoding",HEADERS.file_debug_compress_range["Access-Control-Allow-Origin"]="*",HEADERS.file_debug_compress_range["Content-Encoding"]="gzip",HEADERS.file_debug_compress_range.Pragma="no-cache",HEADERS.file_debug_compress_range.Expires="-1",HEADERS.file_debug_compress_range[HEADER_LENGTH]="0",HEADERS.file_debug_compress_range["Content-Range"]="",HEADERS.file_debug_compress_range["X-Powered-By"]="Total.js",HEADERS.file_debug={},HEADERS.file_debug[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.file_debug.Vary="Accept-Encoding",HEADERS.file_debug.Pragma="no-cache",HEADERS.file_debug.Expires="-1",HEADERS.file_debug["Access-Control-Allow-Origin"]="*",HEADERS.file_debug["X-Powered-By"]="Total.js",HEADERS.file_debug_range={},HEADERS.file_debug_range["Accept-Ranges"]="bytes",HEADERS.file_debug_range[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.file_debug_range.Vary="Accept-Encoding",HEADERS.file_debug_range["Access-Control-Allow-Origin"]="*",HEADERS.file_debug_range.Pragma="no-cache",HEADERS.file_debug_range.Expires="-1",HEADERS.file_debug_range[HEADER_LENGTH]="0",HEADERS.file_debug_range["Content-Range"]="",HEADERS.file_debug_range["X-Powered-By"]="Total.js",HEADERS.content_mobile_release={},HEADERS.content_mobile_release[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.content_mobile_release.Vary="Accept-Encoding, User-Agent",HEADERS.content_mobile_release["Content-Encoding"]="gzip",HEADERS.content_mobile_release.Expires="-1",HEADERS.content_mobile_release["X-Powered-By"]="Total.js",HEADERS.content_mobile={},HEADERS.content_mobile[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.content_mobile.Vary="Accept-Encoding, User-Agent",HEADERS.content_mobile.Expires="-1",HEADERS.content_mobile["X-Powered-By"]="Total.js",HEADERS.content_compress={},HEADERS.content_compress[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.content_compress.Vary="Accept-Encoding",HEADERS.content_compress["Content-Encoding"]="gzip",HEADERS.content_compress.Expires="-1",HEADERS.content_compress["X-Powered-By"]="Total.js",HEADERS.content={},HEADERS.content[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.content.Vary="Accept-Encoding",HEADERS.content.Expires="-1",HEADERS.content["X-Powered-By"]="Total.js",HEADERS.stream_release_compress={},HEADERS.stream_release_compress[HEADER_CACHE]="public, max-age=11111111",HEADERS.stream_release_compress["Access-Control-Allow-Origin"]="*",HEADERS.stream_release_compress["Content-Encoding"]="gzip",HEADERS.stream_release_compress["X-Powered-By"]="Total.js",HEADERS.stream_release={},HEADERS.stream_release[HEADER_CACHE]="public, max-age=11111111",HEADERS.stream_release["Access-Control-Allow-Origin"]="*",HEADERS.stream_release["X-Powered-By"]="Total.js",HEADERS.stream_debug_compress={},HEADERS.stream_debug_compress[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.stream_debug_compress.Pragma="no-cache",HEADERS.stream_debug_compress.Expires="-1",HEADERS.stream_debug_compress["Access-Control-Allow-Origin"]="*",HEADERS.stream_debug_compress["Content-Encoding"]="gzip",HEADERS.stream_debug_compress["X-Powered-By"]="Total.js",HEADERS.stream_debug={},HEADERS.stream_debug[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.stream_debug.Pragma="no-cache",HEADERS.stream_debug.Expires="-1",HEADERS.stream_debug["Access-Control-Allow-Origin"]="*",HEADERS.stream_debug["X-Powered-By"]="Total.js",HEADERS.binary_compress={},HEADERS.binary_compress[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.binary_compress["Content-Encoding"]="gzip",HEADERS.binary_compress["X-Powered-By"]="Total.js",HEADERS.binary={},HEADERS.binary[HEADER_CACHE]="public",HEADERS.binary["X-Powered-By"]="Total.js",HEADERS.authorization={user:"",password:"",empty:!0},HEADERS.fsStreamRead={flags:"r",mode:"0666",autoClose:!0},HEADERS.fsStreamReadRange={flags:"r",mode:"0666",autoClose:!0,start:0,end:0},HEADERS.workers={cwd:""},HEADERS.mmrpipe={end:!1},HEADERS.responseLocalize={},HEADERS.responseNotModified={},HEADERS.responseNotModified[HEADER_CACHE]="public, max-age=11111111",HEADERS.responseNotModified["X-Powered-By"]="Total.js",HEADERS.response503={},HEADERS.response503[HEADER_CACHE]="private, no-cache, no-store, max-age=0",HEADERS.response503[HEADER_TYPE]=CT_HTML,HEADERS.response503["X-Powered-By"]="Total.js",HEADERS.notModifiedEtag={},HEADERS.notModifiedEtag["X-Powered-By"]="Total.js",HEADERS.notModifiedLastModifiedDate={},HEADERS.notModifiedLastModifiedDate["X-Powered-By"]="Total.js",Object.freeze(HEADERS.authorization);var IMAGEMAGICK=!1,_controller="",_owner="",_flags;!global.framework_internal&&(global.framework_internal=require("./internal")),!global.framework_builders&&(global.framework_builders=require("./builders")),!global.framework_utils&&(global.framework_utils=require("./utils")),!global.framework_mail&&(global.framework_mail=require("./mail")),!global.framework_image&&(global.framework_image=require("./image")),!global.framework_nosql&&(global.framework_nosql=require("./nosql")),global.Builders=framework_builders;var U=global.Utils=global.utils=global.U=global.framework_utils;global.Mail=framework_mail,global.WTF=function(e,t,r){return F.problem(e,t,r)},global.NOBIN=function(e){return F.nosql(e).binary},global.NOCOUNTER=function(e){return F.nosql(e).counter},global.NOMEM=global.NOSQLMEMORY=function(e,t){return global.framework_nosql.inmemory(e,t)},global.CONFIG=function(e){return F.config[e]},global.UPTODATE=function(e,t,r,o,n){return F.uptodate(e,t,r,o,n)},global.INSTALL=function(e,t,r,o,n){return F.install(e,t,r,o,n)},global.UNINSTALL=function(e,t,r){return F.uninstall(e,t,r)},global.RESOURCE=function(e,t){return F.resource(e,t)},global.TRANSLATE=function(e,t){return F.translate(e,t)},global.TRANSLATOR=function(e,t){return F.translator(e,t)},global.TRACE=function(e,t,r,o){return F.trace(e,t,r,o)},global.$$$=global.GETSCHEMA=function(e,t,r,o){return framework_builders.getschema(e,t,r,o)},global.CREATE=function(e,t){return framework_builders.getschema(e,t)["default"]()},global.SCRIPT=function(e,t,r,o){return F.script(e,t,r,o)},global.SINGLETON=function(e,t){return SINGLETONS[e]||(SINGLETONS[e]=new Function("return "+(t||"{}"))())},global.FUNCTION=function(e){return F.functions[e]},global.ROUTING=function(e){return F.routing(e)},global.SCHEDULE=function(e,t,r,o){return F.schedule(e,t,r,o)},global.FINISHED=framework_internal.onFinished,global.DESTROY=framework_internal.destroyStream,global.UID=function(){return UIDGENERATOR.date+(++UIDGENERATOR.index).padLeft(4,"0")+UIDGENERATOR.instance+(UIDGENERATOR.index%2?1:0)},global.ROUTE=function(e,t,r,o,n){return F.route(e,t,r,o,n)},global.GROUP=function(e,t){return F.group(e,t)},global.WEBSOCKET=function(e,t,r,o){return F.websocket(e,t,r,o)},global.FILE=function(e,t,r){return F.file(e,t,r)},global.REDIRECT=function(e,t,r,o){return F.redirect(e,t,r,o)},global.AUTH=function(e){F.onAuthorize=e},global.WEBSOCKETCLIENT=function(e){var t=require("./websocketclient").create();return e&&e.call(t,t),t},global.$CREATE=function(e){e=parseSchema(e);var t=framework_builders.getschema(e[0],e[1]);return t?t["default"]():null},global.$MAKE=function(e,t,r,o,n,i){e=parseSchema(e);var s=framework_builders.getschema(e[0],e[1]);return s?s.make(t,r,o,i,n):void 0},global.$QUERY=function(e,t,r,o){e=parseSchema(e);var n=framework_builders.getschema(e[0],e[1]);return n&&n.query(t,r,o),!!n},global.$GET=function(e,t,r,o){e=parseSchema(e);var n=framework_builders.getschema(e[0],e[1]);return n&&n.get(t,r,o),!!n},global.$WORKFLOW=function(e,t,r,o,n){e=parseSchema(e);var i=framework_builders.getschema(e[0],e[1]);return i&&i.workflow2(t,r,o,n),!!i},global.$TRANSFORM=function(e,t,r,o,n){e=parseSchema(e);var i=framework_builders.getschema(e[0],e[1]);return i&&i.transform2(t,r,o,n),!!i},global.$ASYNC=function(e,t,r,o){r&&"object"==typeof r&&(o=r,r=void 0),e=parseSchema(e);var n=framework_builders.getschema(e[0],e[1])["default"]();return o&&(n.$$controller=o),n.$async(t,r)},global.$OPERATION=function(e,t,r,o,n){e=parseSchema(e);var i=framework_builders.getschema(e[0],e[1]);return i&&i.operation2(t,r,o,n),!!i},global.DB=global.DATABASE=function(){return"object"==typeof F.database?F.database:F.database.apply(framework,arguments)},global.ON=function(){return F.on.apply(F,arguments)},global.OFF=function(){return arguments.length>1?F.removeListener.apply(F,arguments):F.removeAllListeners.apply(F,arguments)},global.EMIT=function(){return F.emit.apply(F,arguments)},global.LOG=function(){return F.log.apply(F,arguments)},global.LOGGER=function(){return F.logger.apply(F,arguments)},global.MAKE=global.TRANSFORM=function(e,t){if("function"==typeof e){var r=t;t=e,e=r}var o;return"function"==typeof t?(o={},t.call(o,o)):o=t,e?TransformBuilder.transform.apply(o,arguments):o},global.NEWTRANSFORM=function(){return TransformBuilder.addTransform.apply(this,arguments)},global.NEWSCHEMA=function(e,t){return t||(t=e,e="default"),framework_builders.newschema(e,t)},global.CLEANUP=function(e,t){FINISHED(e,function(){DESTROY(e),t&&(t(),t=null)})},global.SUCCESS=function(e,t){if("function"==typeof e)return function(t,r){e(t,SUCCESS(t,r))};var r;return e instanceof Error?(r=e,e=!1):e instanceof framework_builders.ErrorBuilder?e.hasError()?(r=e.output(),e=!1):e=!0:null==e&&(e=!0),SUCCESSHELPER.success=!!e,SUCCESSHELPER.value=null==t?void 0:t,SUCCESSHELPER.error=r?r:void 0,SUCCESSHELPER},global.TRY=function(e,t){try{return e(),!0}catch(r){return t&&t(r),!1}},global.OBSOLETE=function(e,t){global.F&&F.stats.other.obsolete++},global.DEBUG=!1,global.TEST=!1,global.RELEASE=!1,global.is_client=!1,global.is_server=!0;var directory=U.$normalize(require.main?Path.dirname(require.main.filename):process.cwd()).replace("/root",""),DATE_EXPIRES=(new Date).add("y",1).toUTCString();const WEBSOCKET_COMPRESS=U.createBuffer([0,0,255,255]),WEBSOCKET_COMPRESS_OPTIONS={windowBits:Zlib.Z_DEFAULT_WINDOWBITS},UIDGENERATOR={date:(new Date).format("yyMMddHHmm"),instance:"abcdefghijklmnoprstuwxy".split("").random().join("").substring(0,3),index:1},EMPTYBUFFER=U.createBufferSize(0);global.EMPTYBUFFER=EMPTYBUFFER;const controller_error_status=function(e,t,r){return 500!==t&&r&&e.problem(r),e.res.success||e.res.headersSent||!e.isConnected?e:(e.precache&&e.precache(null,null,null),e.req.path=EMPTYARRAY,e.req.$total_success(),e.req.$total_route=F.lookup(e.req,"#"+t,EMPTYARRAY,0),e.req.$total_exception=r,e.req.$total_execute(t,!0),e)};var PERF={};Framework.prototype={get cluster(){return require("./cluster")},get id(){return F.$id},set id(e){return CLUSTER_CACHE_SET.id=e,CLUSTER_CACHE_REMOVE.id=e,CLUSTER_CACHE_REMOVEALL.id=e,CLUSTER_CACHE_CLEAR.id=e,F.$id=e,F.$id},get onLocate(){return this.onLocale},set onLocate(e){OBSOLETE("F.onLocate",'Rename "F.onLocate" method for "F.onLocale".'),this.onLocale=e}};var framework=new Framework;global.framework=global.F=module.exports=framework,F.prototypes=function(e){var t={};return t.Chunker=framework_utils.Chunker.prototype,t.Controller=Controller.prototype,t.Database=framework_nosql.Database.prototype,t.DatabaseBinary=framework_nosql.DatabaseBinary.prototype,t.DatabaseBuilder=framework_nosql.DatabaseBuilder.prototype,t.DatabaseBuilder2=framework_nosql.DatabaseBuilder2.prototype,t.DatabaseCounter=framework_nosql.DatabaseCounter.prototype,t.ErrorBuilder=framework_builders.ErrorBuilder.prototype,t.HttpFile=framework_internal.HttpFile.prototype,t.HttpRequest=PROTOREQ,t.HttpResponse=PROTORES,t.Image=framework_image.Image.prototype,t.Message=Mail.Message.prototype,t.OperationOptions=framework_builders.OperationOptions.prototype,t.Page=framework_builders.Page.prototype,t.Pagination=framework_builders.Pagination.prototype,t.RESTBuilder=framework_builders.RESTBuilder.prototype,t.RESTBuilderResponse=framework_builders.RESTBuilderResponse.prototype,t.SchemaBuilder=framework_builders.SchemaBuilder.prototype,t.SchemaOptions=framework_builders.SchemaOptions.prototype,t.TransformBuilder=framework_builders.TransformBuilder.prototype,t.UrlBuilder=framework_builders.UrlBuilder.prototype,t.WebSocket=WebSocket.prototype,t.WebSocketClient=WebSocketClient.prototype,e.call(t,t),F},F.on=function(e,t){if("init"===e||"ready"===e||"load"===e){if(this.isLoaded)return void t.call(this)}else if(-1!==e.indexOf("#")){var r=e.split("#");switch(r[0]){case"middleware":F.temporary.ready[e]&&t.call(this);break;case"component":F.temporary.ready[e]&&t.call(this);break;case"model":F.temporary.ready[e]&&t.call(this,F.models[r[1]]);break;case"source":F.temporary.ready[e]&&t.call(this,F.sources[r[1]]);break;case"package":case"module":F.temporary.ready[e]&&t.call(this,F.modules[r[1]]);break;case"controller":F.temporary.ready[e]&&t.call(this,F.controllers[r[1]])}}return F.$events[e]?F.$events[e].push(t):F.$events[e]=[t],this},F.emit=function(e,t,r,o,n,i,s,a){var l=F.$events[e];if(l){for(var c=!1,u=0,p=l.length;p>u;u++)l[u].$once&&(c=!0),l[u].call(F,t,r,o,n,i,s,a);c&&(l=l.remove(function(e){return e.$once}),l.length?F.$events[e]=l:F.$events[e]=void 0)}return F},F.once=function(e,t){return t.$once=!0,F.on(e,t)},F.removeListener=function(e,t){var r=F.$events[e];return r&&(r=r.remove(function(e){return e===t}),r.length?F.$events[e]=r:F.$events[e]=void 0),F},F.removeAllListeners=function(e){return e?F.$events[e]=void 0:F.$events={},F},F.$owner=function(){return _owner},F.isSuccess=function(e){return e===SUCCESSHELPER},F.convert=function(e,t){if(t){if(-1!==F.convertors.findIndex("name",e))return!1;if(t===Number)t=U.parseFloat;else if(t===Boolean)t=U.parseBoolean;else if("string"==typeof t)switch(t.toLowerCase()){case"json":t=U.parseJSON;break;case"float":case"number":case"double":t=U.parseFloat;break;case"int":case"integer":t=U.parseInt2;break;default:return void 0}return F.convertors.push({name:e,convertor:t}),F._length_convertors=F.convertors.length,!0}for(var r=0,o=F.convertors.length;o>r;r++)e[F.convertors[r].name]&&(e[F.convertors[r].name]=F.convertors[r].convertor(e[F.convertors[r].name]));return e},F.controller=function(e){return F.controllers[e]||null},F.useConfig=function(e){return F.$configure_configs(e,!0)},F.useSMTP=function(e,t,r){return"function"==typeof t&&(r=t,t=void 0),Mail["try"](e,t,function(o){o||(delete F.temporary["mail-settings"],F.config["mail-smtp"]=e,F.config["mail-smtp-options"]=t),r?r(o):o&&F.error(o,"F.useSMTP()",null)}),F},F.$routesSort=function(e){F.routes.web.sort(function(e,t){return e.priority>t.priority?-1:e.priority<t.priority?1:0}),F.routes.websockets.sort(function(e,t){return e.priority>t.priority?-1:e.priority<t.priority?1:0});for(var t,r={},o=F.routes.web.length,n=0;o>n;n++){var i=F.routes.web[n],s=F.temporary.internal[i.controller];s&&(i.controller=s),!i.isMOBILE||i.isUPLOAD||i.isXHR||i.isJSON||i.isSYSTEM||i.isXML||-1===i.flags.indexOf("get")||(t=i.url.join("/"),r[t]=!0)}for(var n=0;o>n;n++){var i=F.routes.web[n];i.isMOBILE||i.isUPLOAD||i.isXHR||i.isJSON||i.isSYSTEM||i.isXML||-1===i.flags.indexOf("get")||(t=i.url.join("/"),i.isMOBILE_VARY=r[t]===!0)}return(!e||1===e)&&F.routes.web.forEach(function(e){var t=F.routes.web.findItem(function(t){return t.hash===e.hash&&t!==e});e.isUNIQUE=null==t}),Object.keys(F.temporary.other).forEach(function(e){"1"===e[0]&&(F.temporary.other[e]=void 0)}),F},F.parseComponent=parseComponent,F.script=function(e,t,r,o){var n,i,s=void 0===t&&void 0===r;try{n=new Function("next","value","now","var model=value;var global,require,process,GLOBAL,root,clearImmediate,clearInterval,clearTimeout,setImmediate,setInterval,setTimeout,console,$STRING,$VIEWCACHE,framework_internal,TransformBuilder,Pagination,Page,URLBuilder,UrlBuilder,SchemaBuilder,framework_builders,framework_utils,framework_mail,Image,framework_image,framework_nosql,Builders,U,utils,Utils,Mail,WTF,SOURCE,INCLUDE,MODULE,NOSQL,NOBIN,NOCOUNTER,NOSQLMEMORY,NOMEM,DATABASE,DB,CONFIG,INSTALL,UNINSTALL,RESOURCE,TRANSLATOR,LOG,LOGGER,MODEL,GETSCHEMA,CREATE,UID,TRANSFORM,MAKE,SINGLETON,NEWTRANSFORM,NEWSCHEMA,EACHSCHEMA,FUNCTION,ROUTING,SCHEDULE,OBSOLETE,DEBUG,TEST,RELEASE,is_client,is_server,F,framework,Controller,setTimeout2,clearTimeout2,String,Number,Boolean,Object,Function,Date,isomorphic,I,eval;UPTODATE,NEWOPERATION,OPERATION,$$$,EMIT,ON,$QUERY,$GET,$WORKFLOW,$TRANSFORM,$OPERATION,$MAKE,$CREATE,HttpFile;EMPTYCONTROLLER,ROUTE,FILE,TEST,WEBSOCKET,MAIL,LOGMAIL;try{"+e+";\n}catch(e){next(e)}")}catch(a){i=a}return i?(r&&r(i),s?i:F):s?function(){return function(e,t,r){return n.call(EMPTYOBJECT,function(e){e instanceof Error?t(e,void 0,r):t(null,e,r)},e,scriptNow)}}():(n.call(EMPTYOBJECT,function(e){r&&(e instanceof Error?r(e):r(null,e))},t,scriptNow,o),F)},F.database=function(e){return F.nosql(e)},global.NOSQL=F.nosql=function(e){var t=F.databases[e];if(t)return t;var r=e.substring(0,6);return"http:/"===r||"https:"===r?t=framework_nosql.load(U.getName(e),e):(F.path.verify("databases"),t=framework_nosql.load(e,F.path.databases(e))),F.databases[e]=t,t},F.stop=F.kill=function(e){for(var t in F.workers){var r=F.workers[t];TRY(function(){return r&&r.kill&&r.kill(e||"SIGTERM")})}return F.emit("exit",e),!F.isWorker&&process.send&&TRY(function(){return process.send("total:stop")}),F.cache.stop(),F.server&&F.server.close&&F.server.close(),setTimeout(function(){return global.process.exit(e||"SIGTERM")},TEST?2e3:100),F},F.redirect=function(e,t,r,o){var n=e.startsWith("http://")||e.startsWith("https");if(n)return"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),"/"===t[t.length-1]&&(t=t.substring(0,t.length-1)),F.routes.redirects[e]={url:t,path:r,permanent:o},F._request_check_redirect=!0,F.owners.push({type:"redirects",owner:_owner,id:e}),F;"/"!==e[0]&&(e="/"+e);var i;return r instanceof Array?(i=r,r=o===!0):o instanceof Array?(i=o,r=r===!0):r=r===!0,o=r,U.isStaticFile(e)?(F.file(e,function(e,r){t.startsWith("http://")||t.startsWith("https://")?r.redirect(t,o):r.redirect("/"!==t[0]?"/"+t:t,o)}),F):(F.route(e,function(){return t.startsWith("http://")||t.startsWith("https://")?void this.redirect(t+this.href(),o):("/"!==t[0]&&(t="/"+t),void this.redirect(t+this.href(),o))},i),F)},F.schedule=function(e,t,r){void 0===r&&(r=t,t=!1);var o=typeof e;"string"===o?(e=e.parseDate(),t&&e<F.datetime&&(e=F.datetime.add(t))):"number"===o&&(e=new Date(e));var n=e.getTime();t&&(t=t.replace("each","1"));var i=U.GUID(5);return F.schedules.push({expire:n,fn:r,repeat:t,owner:_owner,id:i}),i},F.clearSchedule=function(e){return F.schedules=F.schedules.remove("id",e),F},F.resize=function(e,t,r){var o={},n=!0;if("function"==typeof r){var i=r;r=t,t=i}var s=e.match(/\*.\*$|\*?\.(jpg|png|gif|jpeg)$/gi);if(s)switch(e=e.replace(s,""),s.toString().toLowerCase()){case"*.*":o["*"]=!0;break;case"*.jpg":case"*.gif":case"*.png":case"*.jpeg":o[s.toString().toLowerCase().replace(/\*/g,"").substring(1)]=!0}var a=e;if(r&&r.length)for(var l=0,c=r.length;c>l;l++){var u=r[l];"."===u[0]?o[u.substring(1)]=!0:"~"===u[0]||"/"===u[0]||u.match(/^http:|https:/gi)?a=u:"nocache"===u&&(n=!1)}return o.length||(o.jpg=!0,o.jpeg=!0,o.png=!0,o.gif=!0),o.jpg&&!o.jpeg?o.jpeg=!0:o.jpeg&&!o.jpg&&(o.jpg=!0),F.routes.resize[e]={fn:t,path:U.path(a||e),ishttp:a.match(/http:|https:/gi)?!0:!1,extension:o,cache:n},F.owners.push({type:"resize",owner:_owner,id:e}),F},F.restful=function(e,t,r,o,n,i){var s,a=t?t.indexOf("cors"):-1,l={};-1!==a&&t.splice(a,1),r&&(s=[],t&&s.push.apply(s,t),F.route(e,s,r),l.get=!0);var c=U.path(e)+"{id}";return o&&(l.get=!0,s=[],t&&s.push.apply(s,t),F.route(c,s,o)),n&&(l.post=!0,s=["post"],t&&s.push.apply(s,t),F.route(e,s,n),s=["put"],l.put=!0,t&&s.push.apply(s,t),F.route(c,s,n)),i&&(l["delete"]=!0,s=["delete"],t&&s.push.apply(s,t),F.route(c,s,i)),-1!==a&&F.cors(U.path(e)+"*",Object.keys(l),-1===t.indexOf("authorize")),F},F.restful2=function(e,t,r,o,n,i){var s,a=t?t.indexOf("cors"):-1,l={};return-1!==a&&t.splice(a,1),r&&(s=[],l.get=!0,t&&s.push.apply(s,t),F.route(e,s,r)),o&&(s=[],l.get=!0,t&&s.push.apply(s,t),F.route(U.path(e)+"{id}",s,o)),n&&(s=["post"],l.post=!0,t&&s.push.apply(s,t),F.route(e,s,n)),i&&(s=["delete"],l["delete"]=!0,t&&s.push.apply(s,t),F.route(e,s,i)),-1!==a&&F.cors(U.path(e)+"*",Object.keys(l),-1===t.indexOf("authorize")),F},global.CORS=F.cors=function(e,t,r){var o,n,i={},s=[],a=[],l=[];if(t instanceof Array)for(var c=0,u=t.length;u>c;c++){var p=t[c],f=typeof p;if("string"===f)p=p.toLowerCase();else if("number"===f){o=p;continue}if("boolean"===f||p.startsWith("credential"))r=!0;else if(p.startsWith("http://")||p.startsWith("https://"))s.push(p);else if("id:"!==p.substring(0,3))switch(p){case"post":case"put":case"delete":case"options":case"patch":case"head":case"get":a.push(p.toUpperCase());break;default:l.push(t[c].toLowerCase())}else n=p.substring(3)}return i.isWILDCARD=-1!==e.lastIndexOf("*"),i.isWILDCARD&&(e=e.replace("*","")),e=framework_internal.preparePath(framework_internal.encodeUnicodeURL(e.trim())),i.hash=e.hash(),i.owner=_owner,i.url=framework_internal.routeSplitCreate(e),i.origins=s.length?s:null,i.methods=a.length?a:null,i.headers=l.length?l:null,i.credentials=r,i.age=o||F.config["default-cors-maxage"],i.id=n,F.routes.cors.push(i),F._length_cors=F.routes.cors.length,F.routes.cors.sort(function(e,t){var r=e.url.length,o=t.url.length;return r>o?-1:o>r?1:e.isWILDCARD&&t.isWILDCARD?1:0}),PERF.OPTIONS=!0,F},F.group=function(e,t){return _flags=e,t.call(this),_flags=void 0,this},F.web=F.route=function(e,t,r,o,n){var i,s,a,l;if(e instanceof Array)return e.forEach(function(e){return F.route(e,t,r,o)}),F;var c="function"==typeof e?e:null;if(c&&(e="/"),"#"===e[0])if(e=e.substring(1),"400"!==e&&"401"!==e&&"403"!==e&&"404"!==e&&"408"!==e&&"409"!==e&&"431"!==e&&"500"!==e&&"501"!==e){var u=t instanceof Array?t:r;u instanceof Array||(u=EMPTYARRAY);var p=e.indexOf("/");if(-1!==p&&(s=e.substring(p),e=e.substring(0,p)),l=F.sitemap(e,!0,n),!l)throw new Error('Sitemap item "'+e+'" not found.');if(i=e,e=l.url,l.localizeUrl&&void 0===n){var f={};F.temporary.internal.resources.forEach(function(t){var r=F.sitemap(l.id,!0,t);r.url&&r.url!==e&&(f[r.url]={name:l.id,language:t})}),Object.keys(f).forEach(function(e){return F.route("#"+l.id,t,r,o,f[e].language)})}s?e+="/"===e[e.length-1]?s.substring(1):s:l.wildcard&&(e+="*")}else e="#"+e;e||(e="/"),"[ "!==e[0]&&"/"!==e[0]&&(e="/"+e),e.endsWith("/")&&(e=e.substring(0,e.length-1)),e=framework_internal.encodeUnicodeURL(e);var d=typeof t,p=0,m=e;i||(i=e),("object"===d||t instanceof Array)&&(s=t,t=r,r=s);var h=0,g=null;h=e.count("/"),"[ "===e[0]&&(p=e.indexOf(" ]"),p>0&&(g=e.substring(1,p).trim().toLowerCase().split(","),e=e.substring(p+1),h+=-1!==g.indexOf("*")?50:100));var y=-1!==e.indexOf("*");y&&(e=e.replace("*","").replace("//","/"),h-=100);var b,E,v,_,w,k=!1,S=!1,T="",$=!1,R=!1,O=!1,C=!1,A=!1,x=!1,P=!1,D=!1,j=null,N=[],H=0,L=!1,I=null;if(_flags&&(r||(r=[]),_flags.forEach(function(e){-1===r.indexOf(e)&&r.push(e)})),r){s=[];for(var q=0,M=0;M<r.length;M++){var G=typeof r[M];if("number"!==G)if("object"!==G){var Y=r[M][0];if("&"!==Y)if("id:"!==r[M].substring(0,3))if("#"!==Y)if("*"!==Y)if("//"!==r[M].substring(0,3)){var B=r[M].toString().toLowerCase();if(B.startsWith("http://")||B.startsWith("https://"))N.push(B);else switch(q++,B){case"json":R=!0;continue;case"delay":q--,O=!0;continue;case"binary":A=!0;continue;case"cors":x=!0,q--;continue;case"credential":case"credentials":N.push(B),q--;continue;case"sync":case"yield":case"synchronize":L=!0,q--;continue;case"novalidate":D=!0;break;case"noxhr":case"-xhr":S=!0;continue;case"raw":k=!0,s.push(B);break;case"mobile":$=!0;break;case"robot":C=!0,F._request_check_robot=!0;break;case"authorize":case"authorized":case"logged":H=1,h+=2,s.push("authorize");break;case"unauthorize":case"unauthorized":case"unlogged":H=2,h+=2,s.push("unauthorize");break;case"referer":case"referrer":s.push("referer");break;case"delete":case"get":case"head":case"options":case"patch":case"post":case"propfind":case"put":case"trace":s.push(B),T+=(T?",":"")+B,N.push(B);break;default:"@"===B[0]&&(P=!0),s.push(B)}}else w=r[M].substring(3).trim();else E=r[M].trim().substring(1),p=E.indexOf("-->"),-1!==p?(b=E.substring(0,p).trim(),E=E.substring(p+3).trim()):(b=E,E=null),b=b.replace(/\\/g,"/").split("/"),1===b.length&&(b[1]=b[0],b[0]="default"),p=b[1].indexOf("#"),-1!==p&&(b[2]=b[1].substring(p+1).trim(),b[1]=b[1].substring(0,p).trim(),b[2]&&"*"!==b[2][0]&&(b[2]="*"+b[2]));else!j&&(j=[]),j.push(r[M].substring(1));else I=r[M].substring(3).trim()}else _=r[M];else v=r[M]}r=s,h+=2*q}else r=["get"],T="get";"string"===d?(a=t,t=function(e,t,r){var o=U.parseTheme(e);return o&&(e=prepare_viewname(e)),function(){if(r&&!this.language&&(this.language=r),t&&this.sitemap(t.id,r),"~"===e[0]?this.themeName="":o&&(this.themeName=o),!this.route.workflow)return this.view(e);var n=this;this.$exec(this.route.workflow,null,function(t,r){t?n.content(t):n.view(e,r)})}}(a,l,n)):"function"!=typeof t&&(a=(l&&"/"!==l.url?l.id:E?"":e)||"",E&&(a||E)?E&&(t=controller_json_workflow):(a.endsWith("/")&&(a=a.substring(0,a.length-1)),p=a.lastIndexOf("/"),-1!==p&&(a=a.substring(p+1)),a&&"/"!==a||(a="index"),t=function(e,t,r){return function(){if(r&&!this.language&&(this.language=r),t&&this.sitemap(t.id,r),"~"===e[0]&&this.theme(""),!this.route.workflow)return this.view(e);var o=this;this.$exec(this.route.workflow,null,function(t,r){t?o.content(t):o.view(e,r)})}}(a,l,n))),L||(L="GeneratorFunction"===t.constructor.name||0===t.toString().indexOf("function*"));var W=framework_internal.preparePath(e.trim()),z=U.path(W)+(y?"*":""),J=W.hash(),V=framework_internal.routeSplitCreate(W),X=[],K=[],Z=null,Q=null;-1!==e.indexOf("{")&&(V.forEach(function(e,t){if("{"===e.substring(0,1)){X.push(t);var r=e.substring(1,e.length-1),o=e.substring(1,e.length-1).trim();if(K.push(o),"/"===r[0]){var n=r.lastIndexOf("/");-1!==n&&(Z||(Z={},Q=[]),K[K.length-1]="regexp"+(Q.length+1),Z[t]=new RegExp(r.substring(1,n),r.substring(n+1)),Q.push(t))}}}),h-=X.length),-1!==e.indexOf("#")&&(h-=100),-1!==r.indexOf("proxy")&&(R=!0,h++),(R||-1!==r.indexOf("xml")||k)&&-1===r.indexOf("delete")&&-1===r.indexOf("post")&&-1===r.indexOf("put")&&-1===r.indexOf("patch")&&(r.push("post"),T+=(T?",":"")+"post",h++),-1!==r.indexOf("upload")&&-1===r.indexOf("post")&&-1===r.indexOf("put")&&(r.push("post"),T+=(T?",":"")+"post"),-1===r.indexOf("get")&&-1===r.indexOf("options")&&-1===r.indexOf("post")&&-1===r.indexOf("delete")&&-1===r.indexOf("put")&&-1===r.indexOf("upload")&&-1===r.indexOf("head")&&-1===r.indexOf("trace")&&-1===r.indexOf("patch")&&-1===r.indexOf("propfind")&&(r.push("get"),T+=(T?",":"")+"get"),F.config["allow-head"]&&-1!==r.indexOf("get")&&(r.append("head"),T+=(T?",":"")+"head"),-1!==r.indexOf("referer")&&(F._request_check_referer=!0),F._request_check_POST||-1===r.indexOf("delete")&&-1===r.indexOf("post")&&-1===r.indexOf("put")&&-1===r.indexOf("upload")&&-1===r.indexOf("json")&&-1===r.indexOf("patch")&&-1===r.indexOf("options")||(F._request_check_POST=!0);var ee=!1;-1!==T.indexOf(",")&&(ee=!0),T=-1!==T.indexOf(",")||""===T?void 0:T.toUpperCase(),"#"===i[1]&&(i=i.substring(1)),A&&!k&&(A=!1),g&&F._length_subdomain_web++;var te=new FrameworkRoute,re=te.route;re.hash=J,re.id=I,re.name=i,re.priority=h,re.sitemap=l?l.id:"",re.schema=b,re.novalidate=D,re.workflow=E,re.subdomain=g,re.description=w,re.controller=_controller?_controller:"unknown",re.owner=_owner,re.urlraw=z,re.url=V,re.param=X,re.paramnames=K.length?K:null,re.flags=r||EMPTYARRAY,re.flags2=flags_to_object(r),re.method=T,re.execute=t,re.length=1024*(o||F.config["default-request-length"]),re.middleware=j,re.timeout=void 0===v?O?0:F.config["default-request-timeout"]:v,re.isGET=-1!==r.indexOf("get"),re.isMULTIPLE=ee,re.isJSON=R,re.isXML=-1!==r.indexOf("xml"),re.isRAW=k,re.isBINARY=A,re.isMOBILE=$,re.isROBOT=C,re.isMOBILE_VARY=$,re.isGENERATOR=L,re.MEMBER=H,re.isWILDCARD=y,re.isROLE=P,re.isREFERER=-1!==r.indexOf("referer"),re.isHTTPS=-1!==r.indexOf("https"),re.isHTTP=-1!==r.indexOf("http"),re.isDEBUG=-1!==r.indexOf("debug"),re.isRELEASE=-1!==r.indexOf("release"),re.isPROXY=-1!==r.indexOf("proxy"),re.isBOTH=S?!1:!0,re.isXHR=-1!==r.indexOf("xhr"),re.isUPLOAD=-1!==r.indexOf("upload"),re.isSYSTEM=e.startsWith("/#"),re.isCACHE=!(e.startsWith("/#")||c||X.length||y),re.isPARAM=X.length>0,re.isDELAY=O,re.CUSTOM=c,re.options=_,re.regexp=Z,re.regexpIndexer=Q,re.type="web",re.isUPLOAD&&(PERF.upload=!0),re.isJSON&&(PERF.json=!0),re.isXML&&(PERF.xml=!0),re.isBINARY&&(PERF.binary=!0),1===re.MEMBER&&(PERF.auth=!0),2===re.MEMBER&&(PERF.unauth=!0);for(var X=T?T.split(","):EMPTYARRAY,M=0;M<X.length;M++)PERF[X[M]]=!0,PERF[X[M].toLowerCase()]=!0;return re.isSYSTEM?F.routes.system[e.substring(1)]=re:(F.routes.web.push(re),x&&F.cors(m,N),!_controller&&F.$routesSort(1)),F.emit("route","web",te),te},F.mmr=function(e,t){return e=framework_internal.preparePath(U.path(e)),F.routes.mmr[e]={exec:t},F._request_check_POST=!0,F},F.routing=function(e){for(var t=0,r=F.routes.web.length;r>t;t++){var o=F.routes.web[t];if(o.name===e){var n=U.path(o.url.join("/"));return"/"!==n[0]&&(n="/"+n),{controller:o.controller,url:n,id:o.id,flags:o.flags,middleware:o.middleware,execute:o.execute,timeout:o.timeout,options:o.options,length:o.length}}}},global.MERGE=F.merge=function(e){"#"===e[0]&&(e=sitemapurl(e.substring(1)));for(var t=[],r=1,o=arguments.length;o>r;r++){var n=arguments[r];n instanceof Array||(n=[n]);for(var i=0,s=n.length;s>i;i++){var a=n[i],l=a[0];"@"===l?a="~"+F.path["package"](a.substring(1)):"="===l?a="~"+F.path.themes(a.substring(1)):"#"===l&&(a="~"+F.path.temp("isomorphic_"+a.substring(1)+".min.js")),t.push(a)}}e=framework_internal.preparePath(F.$version(e)),"/"!==e[0]&&(e="/"+e);var c=F.path.temp((F.id?"i-"+F.id+"_":"")+"merged_"+createTemporaryKey(e));return F.routes.merge[e]={filename:c.replace(/\.( js|css )$/g,function(e){return".min"+e}),files:t},Fs.unlink(F.routes.merge[e].filename,NOOP),F.owners.push({type:"merge",owner:_owner,id:e}),F},F.mapping=function(){return F.map.apply(F,arguments)},F.send=function(e,t){return process.send(e,t),F},global.MAP=F.map=function(e,t,r){"#"===e[0]&&(e=sitemapurl(e.substring(1))),"/"!==e[0]&&(e="/"+e);var o=!1;if(t=U.$normalize(t),e=framework_internal.preparePath(F.$version(e)),"#"===t[0])return F.owners.push({type:"mapping",owner:_owner,id:e}),F.routes.mapping[e]=F.path.temp("isomorphic_"+t.substring(1)+".min.js"),F;var n,i=t.indexOf("#");if(-1!==i){var s=t.split("#");t=s[0],n=s[1]}var a=t[0];"@"===a?(t=F.path["package"](t.substring(1)),o=!0):"="===a&&(t=F.isWindows?U.combine(F.config["directory-themes"],t.substring(1)):F.path.themes(t.substring(1)),o=!0);var l=U.getExtension(t).length>0;if(!o&&!t.startsWith(directory)){var s="~"===t[0]?F.path.root(t.substring(1)):F.path["public"](t);existsSync(s)&&(t=s)}if(l)return F.routes.mapping[e]=t,F.owners.push({type:"mapping",owner:_owner,id:e}),n&&(F.owners.push({type:"blocks",owner:_owner,id:e}),F.routes.blocks[e]=n),F;e=U.path(e),t=U.path(t);var c=t,u="",p=!1;if("/"===c[0]&&(p=!0),"~"===c[0]&&(u+="~",c=c.substring(1)),"."===c[0]&&(u+=".",c=c.substring(1)),p||"/"!==c[0]||(u+="/",c=c.substring(1)),r instanceof Array)for(var f=0,d=r.length;d>f;f++)"."===r[f][0]&&(r[f]=r[f].substring(1)),r[f]=r[f].toLowerCase();return setTimeout(function(){U.ls(F.isWindows?t.replace(/\//g,"\\"):t,function(o){for(var i=0,s=o.length;s>i;i++){F.isWindows&&(o[i]=o[i].replace(t,"").replace(/\\/g,"/"));var a=o[i].replace(c,"");if(r)if("function"==typeof r){if(!r(a))continue}else if(-1===r.indexOf(U.getExtension(a)))continue;"/"===a[0]&&(a=a.substring(1));var l=e+a;F.routes.mapping[l]=u+o[i],F.owners.push({type:"mapping",owner:_owner,id:l}),n&&(F.owners.push({type:"blocks",owner:_owner,id:l}),F.routes.blocks[l]=n)}})},o?500:1),this},global.MIDDLEWARE=F.middleware=function(e,t){return F.install("middleware",e,t),_owner&&F.owners.push({type:"middleware",owner:_owner,id:e}),F},F.use=function(e,t,r,o){if(!t&&!r){if(e instanceof Array)for(var n=0;n<e.length;n++)F.routes.request.push(e[n]);else F.routes.request.push(e);return F._length_request_middleware=F.routes.request.length,F}t instanceof Array&&(r=t,t=null),"*"===t&&(t=null);var i;if(t&&(t=framework_internal.routeSplitCreate(framework_internal.preparePath(t.trim())).join("/")),!r||-1!==r.indexOf("web"))for(var n=0,s=F.routes.web.length;s>n;n++)i=F.routes.web[n],(!t||i.url.join("/").startsWith(t))&&(!i.middleware&&(i.middleware=[]),merge_middleware(i.middleware,e,o));if(!r||-1!==r.indexOf("file")||-1!==r.indexOf("files"))for(var n=0,s=F.routes.files.length;s>n;n++)i=F.routes.files[n],(!t||i.url.join("/").startsWith(t))&&(!i.middleware&&(i.middleware=[]),merge_middleware(i.middleware,e,o));if(!r||-1!==r.indexOf("websocket")||-1!==r.indexOf("websockets"))for(var n=0,s=F.routes.websockets.length;s>n;n++)i=F.routes.websockets[n],(!t||i.url.join("/").startsWith(t))&&(!i.middleware&&(i.middleware=[]),merge_middleware(i.middleware,e,o));return F},F.websocket=function(e,t,r,o){var n,i="function"==typeof e?e:null;if(i&&(e="/"),"#"===e[0]){var s=e.indexOf("/");-1!==s&&(n=e.substring(s),e=e.substring(0,s)),e=e.substring(1);var a=F.sitemap(e,!0);if(!a)throw new Error('Sitemap item "'+e+'" not found.');e=a.url,n?e+="/"===e[e.length-1]?n.substring(1):n:a.wildcard&&(e+="*")}""===e&&(e="/"),e=framework_internal.encodeUnicodeURL(e);var l,c,u,p,f,d=0,s=e.indexOf(" ]"),m=null;d=e.count("/"),s>0&&(m=e.substring(1,s).trim().toLowerCase().split(","),e=e.substring(s+1),d+=-1!==m.indexOf("*")?50:100);var h=-1!==e.indexOf("*");h&&(e=e.replace("*","").replace("//","/"),d=-10-d);var g=framework_internal.preparePath(e.trim()),y=framework_internal.routeSplitCreate(g),b=[],E=null,v=null,_=g.hash(),w=U.path(g)+(h?"*":""),k=[];-1!==e.indexOf("{")&&y.forEach(function(e,t){if("{"===e.substring(0,1)){b.push(t);var r=e.substring(1,e.length-1),o=e.substring(1,e.length-1).trim();if(k.push(o),"/"===r[0]){var n=r.lastIndexOf("/");-1!==n&&(E||(E={},v=[]),k[k.length-1]="regexp"+(v.length+1),E[t]=new RegExp(r.substring(1,n),r.substring(n+1)),v.push(t))}}}),"string"==typeof c&&(c=c[c]),"string"==typeof p&&(p=p[p]),n=[];var S=!1,T=!1,$=!1,R=0,O=0;r||(r=[]),_flags&&_flags.forEach(function(e){-1===r.indexOf(e)&&r.push(e)});for(var C=0;C<r.length;C++){var A=r[C],x=typeof A;if("object"!==x)if("number"!==x)if("id:"!==A.substring(0,3))if("#"!==A[0])if(A=A.toString().toLowerCase(),A.startsWith("http://")||A.startsWith("https://"))!c&&(c=[]),c.push(A);else if(R++,"json"===A&&(S=!0),"binary"===A&&(T=!0),"raw"===A&&(T=!1,S=!1),"@"!==A[0]){if("json"!==A&&"binary"!==A&&"raw"!==A)switch(A){case"authorize":case"authorized":case"logged":O=1,d++,n.push("authorize");break;case"unauthorize":case"unauthorized":case"unlogged":O=2,d++,n.push("unauthorize");break;case"get":case"http":case"https":case"debug":case"release":n.push(A);break;default:p||(p=[]),p.push(A)}}else $=!0,n.push(A);else!l&&(l=[]),l.push(r[C].substring(1));else f=A.substring(3).trim();else o=A;else u=r[C]}r=n,-1===r.indexOf("get")&&r.unshift("get"),d+=2*R,m&&F._length_subdomain_websocket++;var P=new FrameworkRoute,D=P.route;return D.id=f,D.urlraw=w,D.hash=_,D.controller=_controller?_controller:"unknown",D.owner=_owner,D.url=y,D.paramnames=k.length?k:null,D.param=b,D.subdomain=m,D.priority=d,D.flags=r||EMPTYARRAY,D.flags2=flags_to_object(r),D.onInitialize=t,D.protocols=p||EMPTYARRAY,D.allow=c||[],D.length=1024*(o||F.config["default-websocket-request-length"]),D.isWEBSOCKET=!0,D.MEMBER=O,D.isJSON=S,D.isBINARY=T,D.isROLE=$,D.isWILDCARD=h,D.isHTTPS=r.indexOf("https"),D.isHTTP=r.indexOf("http"),D.isDEBUG=r.indexOf("debug"),D.isRELEASE=r.indexOf("release"),D.CUSTOM=i,D.middleware=l?l:null,D.options=u,D.isPARAM=b.length>0,D.regexp=E,D.regexpIndexer=v,D.type="websocket",F.routes.websockets.push(D),F.initwebsocket&&F.initwebsocket(),F.emit("route","websocket",D),!_controller&&F.$routesSort(2),P},F.initwebsocket=function(){F.routes.websockets.length&&F.config["allow-websocket"]&&F.server&&(F.server.on("upgrade",F._upgrade),F.initwebsocket=null)},F.file=function(e,t,r){var o;if(e instanceof Array){o=t;var n=r;r=e,e=o,t=n}else t instanceof Array&&(o=t,t=r,r=o);!t&&e&&(t=e,e=void 0);var i,s,a,l,c=!1,u=!1,p=null,f=e;if(_flags&&(!r&&(r=[]),_flags.forEach(function(e){-1===r.indexOf(e)&&r.push(e)})),r)for(var d=0,m=r.length;m>d;d++){var h=r[d];"object"!=typeof h?"id:"!==h.substring(0,3)?("#"===h[0]&&(!s&&(s=[]),s.push(h.substring(1))),"."===h[0]&&(h=h.substring(1).toLowerCase(),!i&&(i={}),i[h]=!0)):p=h.substring(3).trim():a=h}if("string"==typeof e){if("/"===e&&(e=""),l=e?framework_internal.routeSplitCreate(e):EMPTYARRAY,e=void 0,o=l.last(),"*.*"===o)c=!0,l.splice(l.length-1,1);else if(o){var g=o.indexOf("*.");-1!==g?(i={},i[o.substring(g+2).trim()]=!0,c=!1,l.splice(l.length-1,1)):"*"===o?(c=!0,l.splice(l.length-1,1)):U.getExtension(o)&&(u=!0,c=!1)}}else i||e||(e=t);var y=new FrameworkRoute,b=y.route;return b.id=p,b.urlraw=f,b.controller=_controller?_controller:"unknown",b.owner=_owner,b.url=l,b.fixedfile=u,b.wildcard=c,b.extensions=i,b.onValidate=e,b.execute=t,b.middleware=s,b.options=a,b.type="file",F.routes.files.push(b),F.routes.files.sort(function(e,t){return e.url?-1:t.url&&e.url.length>t.url.length?-1:1}),F.emit("route","file",b),F._length_files++,F},global.LOCALIZE=F.localize=function(e,t,r){"#"===e[0]&&(e=sitemapurl(e.substring(1))),e=e.replace("*",""),null==r&&(r=!0),t===!0?(t=[],r=!0):t||(t=[]);var o;t=t.remove(function(e){return e=e.toLowerCase(),"nocompress"===e&&(r=!1),"compress"===e||"nocompress"===e||"minify"===e});var o=e.lastIndexOf(".");return-1===o?t.push(".html",".htm",".md",".txt"):(t.push(e.substring(o).toLowerCase()),e=e.substring(0,o)),e=framework_internal.preparePath(e),F.file(e,function(e,t){F.onLocale&&(e.$language=F.onLocale(e,t,e.isStaticFile));var o="locate_"+(e.$language?e.$language:"default")+"_"+e.url,n=F.temporary.other[o];if(n)return void(F.$notModified(e,t,n.$mtime)||(HEADERS.responseLocalize["Last-Modified"]=n.$mtime,t.options.body=n,t.options.type=U.getContentType(e.extension),t.$text()));var i=e.uri.pathname,s=F.onMapping(i,i,!0,!0);Fs.readFile(s,function(n,i){return n?t.throw404():(i=F.translator(e.$language,framework_internal.modificators(i.toString(ENCODING),s,"static")),void Fs.lstat(s,function(n,a){var l=a.mtime.toUTCString();!r||"html"!==e.extension&&"htm"!==e.extension||(i=framework_internal.compile_html(i,s)),RELEASE&&(F.temporary.other[o]=U.createBuffer(i),F.temporary.other[o].$mtime=l,F.$notModified(e,t,l))||(HEADERS.responseLocalize["Last-Modified"]=l,t.options.body=i,t.options.type=U.getContentType(e.extension),t.options.headers=HEADERS.responseLocalize,t.$text())}))})},t),F},F.$notModified=function(e,t,r){return r===e.headers["if-modified-since"]?(HEADERS.responseNotModified["Last-Modified"]=r,t.success=!0,t.writeHead(304,HEADERS.responseNotModified),t.end(),F.stats.response.notModified++,F.reqstats(!1,e.isStaticFile),!0):void 0},F.error=function(e,t,r){return arguments.length?e?(F.errors&&(F.datetime=new Date,F.errors.push({error:e.stack,name:t,url:r?"string"==typeof r?r:Parser.format(r):void 0,date:F.datetime}),F.errors.length>50&&F.errors.shift()),F.onError(e,t,r),F):F:function(e){e&&F.error(e,t,r)}},F.problem=F.wtf=function(e,t,r,o){F.$events.problem&&F.emit("problem",e,t,r,o),e instanceof framework_builders.ErrorBuilder?e=e.plain():"object"==typeof e&&(e=JSON.stringify(e));var n={message:e,name:t,url:r?"string"==typeof r?r:Parser.format(r):void 0,ip:o};return F.logger("problems",n.message,"url: "+n.url,"source: "+n.name,"ip: "+n.ip),F.problems&&(F.problems.push(n),F.problems.length>50&&F.problems.shift()),F},F.change=function(e,t,r,o){F.$events.change&&F.emit("change",e,t,r,o),e instanceof framework_builders.ErrorBuilder?e=e.plain():"object"==typeof e&&(e=JSON.stringify(e));var n={message:e,name:t,url:r?"string"==typeof r?r:Parser.format(r):void 0,ip:o};return F.logger("changes",n.message,"url: "+n.url,"source: "+n.name,"ip: "+n.ip),F.changes&&(F.changes.push(n),F.changes.length>50&&F.changes.shift()),F},F.trace=function(e,t,r,o){if(!F.config.trace)return F;F.$events.trace&&F.emit("trace",e,t,r,o),e instanceof framework_builders.ErrorBuilder?e=e.plain():"object"==typeof e&&(e=JSON.stringify(e)),F.datetime=new Date;var n={message:e,name:t,url:r?"string"==typeof r?r:Parser.format(r):void 0,ip:o,date:F.datetime};return F.logger("traces",n.message,"url: "+n.url,"source: "+n.name,"ip: "+n.ip),F.config["trace-console"]&&void 0,F.traces&&(F.traces.push(n),F.traces.length>50&&F.traces.shift()),F},global.MODULE=F.module=function(e){return F.modules[e]||null},F.modify=function(e){return F.modificators||(F.modificators=[]),F.modificators.push(e),e.$owner=_owner,F},F.$load=function(e,t,r,o){function n(e,t,r,o,i){existsSync(s)&&(o||(o=".js"),Fs.readdirSync(e).forEach(function(a){var l=Fs.statSync(Path.join(e,a)).isDirectory();if(l&&i)return void r.push({name:a});if(l){if(".package"===o&&a.endsWith(o)){var c=a.substring(0,a.length-o.length);return void r.push({name:"/"===c[0]?c.substring(1):c,filename:Path.join(s,a),is:!0})}return t++,void n(Path.join(e,a),t,r,o)}var u=U.getExtension(a);if(u&&(u="."+u),u===o){var c=(t?U.$normalize(e).replace(s,"")+"/":"")+a.substring(0,a.length-u.length);r.push({name:"/"===c[0]?c.substring(1):c,filename:Path.join(s,c)+o})}}))}var i=[],s="";t||(t=directory),t="~"+t;try{F.temporary.internal.resources=Fs.readdirSync(F.path.resources()).map(function(e){return e.substring(0,e.lastIndexOf("."))})}catch(a){F.temporary.internal.resources=[]}var l=[],c=[],u=-1!==t.indexOf(".package");return e&&-1===e.indexOf("modules")||c.push(function(e){s=U.combine(t,u?"/modules/":F.config["directory-modules"]),i=[],n(s,0,i,".js"),i.forEach(function(e){return l.push(function(t){return F.install("module",e.name,e.filename,void 0,void 0,void 0,!0,void 0,void 0,t,o)})}),e()}),e&&-1===e.indexOf("isomorphic")||c.push(function(e){s=U.combine(t,u?"/isomorphic/":F.config["directory-isomorphic"]),i=[],n(s,0,i,".js"),i.forEach(function(e){return l.push(function(t){return F.install("isomorphic",e.name,e.filename,void 0,void 0,void 0,!0,void 0,void 0,t,o)})}),e()}),e&&-1===e.indexOf("packages")||c.push(function(e){s=U.combine(t,u?"/packages/":F.config["directory-packages"]),i=[],n(s,0,i,".package");var r=U.$normalize(s);i.wait(function(e,t){return e.is?void U.ls(e.filename,function(n,i){var s=F.path.temp(e.name)+".package";!existsSync(s)&&Fs.mkdirSync(s);for(var a=0,c=i.length;c>a;a++){var u=F.path.temp(U.$normalize(i[a]).replace(r,"")+"/");!existsSync(u)&&Fs.mkdirSync(u)}n.wait(function(t,r){var o=Fs.createReadStream(t),n=Fs.createWriteStream(Path.join(s,t.replace(e.filename,"").replace(/\.package$/i,"")));o.pipe(n),n.on("finish",r)},function(){setTimeout(function(){l.push(function(t){return F.install("package2",e.name,e.filename,void 0,void 0,void 0,!0,void 0,void 0,t,o)}),t()},50)})}):(l.push(function(t){return F.install("package",e.name,e.filename,void 0,void 0,void 0,!0,void 0,void 0,t,o)}),t())},e)}),e&&-1===e.indexOf("models")||c.push(function(e){s=U.combine(t,u?"/models/":F.config["directory-models"]),i=[],n(s,0,i),i.forEach(function(e){return l.push(function(t){return F.install("model",e.name,e.filename,void 0,void 0,void 0,!0,void 0,void 0,t,o)})}),e()}),e&&-1===e.indexOf("themes")||c.push(function(e){i=[],s=U.combine(t,u?"/themes/":F.config["directory-themes"]),n(s,0,i,void 0,!0),i.forEach(function(e){var t=e.name,r=Path.join(s,t),n=Path.join(r,"index.js");F.themes[e.name]=U.path(r),F._length_themes++,existsSync(n)&&l.push(function(t){return F.install("theme",e.name,n,void 0,void 0,void 0,!0,void 0,void 0,t,o)})}),e()}),e&&-1===e.indexOf("definitions")||c.push(function(e){s=U.combine(t,u?"/definitions/":F.config["directory-definitions"]),i=[],n(s,0,i),i.forEach(function(e){return l.push(function(t){return F.install("definition",e.name,e.filename,void 0,void 0,void 0,!0,void 0,void 0,t,o)})}),e()}),e&&-1===e.indexOf("controllers")||c.push(function(e){i=[],s=U.combine(t,u?"/controllers/":F.config["directory-controllers"]),n(s,0,i),i.forEach(function(e){return l.push(function(t){return F.install("controller",e.name,e.filename,void 0,void 0,void 0,!0,void 0,void 0,t,o)})}),e()}),e&&-1===e.indexOf("components")||c.push(function(e){i=[],s=U.combine(t,u?"/components/":F.config["directory-components"]),n(s,0,i,".html"),i.forEach(function(e){return l.push(function(t){return F.install("component",e.name,e.filename,void 0,void 0,void 0,void 0,void 0,void 0,t,o)})}),e()}),c.async(function(){var t=l.length;F.consoledebug("load dependencies "+t+"x"),l.async(function(){e&&-1===e.indexOf("service")&&F.cache.stop(),F.$routesSort(),(!e||-1!==e.indexOf("dependencies"))&&F.$configure_dependencies(),F.consoledebug("load dependencies {0}x ( done )".format(t)),r&&r()})}),F},F.$startup=function(e){var t=Path.join(directory,"/startup/");if(!existsSync(t))return e();var r=[];return Fs.readdirSync(t).forEach(function(e){var t=U.getExtension(e);"js"===t&&r.push(e)}),r.length?(r.wait(function(e,r){var o=t+e+(new Date).format("yyMMdd_HHmmss");Fs.renameSync(t+e,o);var n=Child.fork(o,[],{cwd:directory});n.on("exit",function(){n=null,r()})},e),this):e()},F.uptodate=function(e,t,r,o,n,i){"string"==typeof r&&"string"!=typeof o&&(o=r,r=null);var s={type:e,name:"",url:t,interval:o,options:r,count:0,updated:F.datetime,errors:[],callback:n};return F.uptodates||(F.uptodates=[]),F.uptodates.push(s),F.install(e,t,r,function(e,t){e&&s.errors.push(e),s.name=t,s.callback&&s.callback(e,t)},void 0,void 0,void 0,void 0,i),F},F.install=function(type,name,declaration,options,callback,internal,useRequired,skipEmit,uptodateName,next,packageName){var obj=null;"config"!==type&&"version"!==type&&"string"==typeof name&&(name.startsWith("http://")||name.startsWith("https://")?"object"==typeof declaration&&(callback=options,options=declaration,declaration=name,name=""):"@"===name[0]&&(declaration=F.path["package"](name.substring(1)),name=Path.basename(name).replace(/\.js$/i,""),void 0===useRequired&&(useRequired=!0)));var t=typeof declaration,key="",tmp,content,err;if(F.datetime=new Date,"object"===t&&(t=typeof options,"function"===t&&(callback=options),options=declaration,declaration=void 0),void 0===declaration&&(declaration=name,name=""),"function"==typeof options&&(callback=options,options=void 0),"eval"!==type&&"string"==typeof declaration){if(declaration.startsWith("http://")||declaration.startsWith("https://"))return"package"===type?(F.consoledebug("download",type,declaration),U.download(declaration,FLAGS_INSTALL,function(e,t){if(e)return F.error(e,"F.install('{0}', '{1}')".format(type,declaration),null),next&&next(),void(callback&&callback(e));var r=Path.basename(declaration,".package"),o=F.path.temp(r+".download"),n=Fs.createWriteStream(o),i=Crypto.createHash("md5");t.on("data",function(e){i.update(e)}),t.pipe(n),n.on("finish",function(){var e=i.digest("hex");return F.temporary.versions[declaration]===e?(next&&next(),void(callback&&callback(null,uptodateName||name,!0))):(F.temporary.versions[declaration]=e,void F.install(type,r,o,options,callback,void 0,void 0,!0,uptodateName,next))})}),F):(F.consoledebug("download",type,declaration),U.request(declaration,FLAGS_INSTALL,function(e,t,r){if(200===r||e||(e=new Error(t)),e)F.error(e,"F.install('{0}', '{1}')".format(type,declaration),null),next&&next(),callback&&callback(e);else{var o=t.hash("md5");if(F.temporary.versions[declaration]===o)return next&&next(),void(callback&&callback(null,uptodateName||name,!0));F.temporary.versions[declaration]=o,F.install(type,name,t,options,callback,declaration,void 0,void 0,uptodateName,next)}}),F);if("~"===declaration[0]&&(declaration=declaration.substring(1)),"config"!==type&&"resource"!==type&&"package"!==type&&"component"!==type&&!REG_SCRIPTCONTENT.test(declaration)){var relative=F.path.root(declaration);if(existsSync(relative)&&(declaration=relative),!existsSync(declaration))throw new Error("The "+type+": "+declaration+" doesn't exist.");useRequired=!0}}if("middleware"===type)return F.routes.middleware[name]="function"==typeof declaration?declaration:eval(declaration),F._length_middleware=Object.keys(F.routes.middleware).length,next&&next(),callback&&callback(null,name),key=type+"."+name,F.dependencies[key]?F.dependencies[key].updated=F.datetime:(F.dependencies[key]={name:name,type:type,installed:F.datetime,updated:null,count:0},internal&&(F.dependencies[key].url=internal)),F.dependencies[key].count++,setTimeout(function(){F.emit(type+"#"+name),F.emit("install",type,name),F.temporary.ready[type+"#"+name]=F.datetime},500),F.consoledebug("install",type+"#"+name),F;if("config"===type||"configuration"===type||"settings"===type)return F.$configure_configs(declaration instanceof Array?declaration:declaration.toString().split("\n"),!0),setTimeout(function(){delete F.temporary["mail-settings"],F.emit(type+"#"+name,F.config),F.emit("install",type,name),F.temporary.ready[type+"#"+name]=F.datetime},500),F.consoledebug("install",type+"#"+name),next&&next(),callback&&callback(null,name),F;if("version"===type||"versions"===type)return F.$configure_versions(declaration.toString().split("\n")),setTimeout(function(){F.emit(type+"#"+name),F.emit("install",type,name),F.temporary.ready[type+"#"+name]=F.datetime},500),F.consoledebug("install",type+"#"+name),next&&next(),callback&&callback(null,name),F;if("workflow"===type||"workflows"===type)return F.$configure_workflows(declaration.toString().split("\n")),setTimeout(function(){F.emit(type+"#"+name),F.emit("install",type,name),F.temporary.ready[type+"#"+name]=F.datetime,F.consoledebug("install",type+"#"+name)},500),next&&next(),callback&&callback(null,name),F;if("sitemap"===type)return F.$configure_sitemap(declaration.toString().split("\n")),setTimeout(function(){F.emit(type+"#"+name),F.emit("install",type,name),F.temporary.ready[type+"#"+name]=F.datetime,F.consoledebug("install",type+"#"+name)},500),next&&next(),callback&&callback(null,name),F;if("component"===type){!name&&internal&&(name=U.getName(internal).replace(/\.html/gi,"").trim()),F.uninstall(type,uptodateName||name,uptodateName?"uptodate":void 0);var hash="\n/*"+name.hash()+"*/\n",temporary=(F.id?"i-"+F.id+"_":"")+"components";content=parseComponent(internal?declaration:Fs.readFileSync(declaration).toString(ENCODING),name),content.js&&Fs.appendFileSync(F.path.temp(temporary+".js"),hash+(F.config.debug?component_debug(name,content.js,"js"):content.js)+hash.substring(0,hash.length-1)),content.css&&Fs.appendFileSync(F.path.temp(temporary+".css"),hash+(F.config.debug?component_debug(name,content.css,"css"):content.css)+hash.substring(0,hash.length-1)),content.js&&(F.components.js=!0),content.css&&(F.components.css=!0),content.body?(F.components.views[name]="."+F.path.temp("component_"+name),Fs.writeFile(F.components.views[name].substring(1)+".html",U.minifyHTML(content.body),NOOP)):delete F.components.views[name],F.components.has=!0;var link=F.config["static-url-components"];if(F.components.version=F.datetime.getTime(),F.components.links=(F.components.js?'<script src="{0}js?version={1}"></script>'.format(link,F.components.version):"")+(F.components.css?'<link type="text/css" rel="stylesheet" href="{0}css?version={1}" />'.format(link,F.components.version):""),content.install)try{var filecomponent=F.path.temp("component-"+name+".js");_owner=(packageName?packageName+"@":"")+type+"#"+name,Fs.writeFileSync(filecomponent,content.install.trim()),obj=require(filecomponent),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(filecomponent)),obj.$owner=_owner,F.temporary.owners[_owner]=!0,_controller="",F.components.instances[name]=obj,obj&&"function"==typeof obj.install&&obj.install(options||F.config[_owner],name)}catch(e){F.error(e,"F.install('component', '{0}')".format(name))}else if(!internal){var js=declaration.replace(/\.html$/i,".js");existsSync(js)&&(_owner=(packageName?packageName+"@":"")+type+"#"+name,F.temporary.owners[_owner]=!0,obj=require(js),obj.$owner=_owner,_controller="",F.components.instances[name]=obj,"function"==typeof obj.install&&obj.install(options||F.config[_owner],name),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration)))}return obj&&obj.group&&(key=obj.group.hash(),temporary+="_g"+key,tmp=F.components.groups[obj.group],tmp||(tmp=F.components.groups[obj.group]={}),content.js&&(Fs.appendFileSync(F.path.temp(temporary+".js"),hash+(F.config.debug?component_debug(name,content.js,"js"):content.js)+hash.substring(0,hash.length-1)),tmp.js=!0),content.css&&(Fs.appendFileSync(F.path.temp(temporary+".css"),hash+(F.config.debug?component_debug(name,content.css,"css"):content.css)+hash.substring(0,hash.length-1)),tmp.css=!0),tmp.version=F.datetime.getTime(),tmp.links=(tmp.js?'<script src="{0}js?group={2}&version={1}"></script>'.format(link,tmp.version,key):"")+(tmp.css?'<link type="text/css" rel="stylesheet" href="{0}css?group={2}&version={1}" />'.format(link,tmp.version,key):"")),!skipEmit&&setTimeout(function(){F.emit(type+"#"+name),F.emit("install",type,name),F.temporary.ready[type+"#"+name]=F.datetime},500),F.consoledebug("install",type+"#"+name),next&&next(),callback&&callback(null,name),F}if("package"===type){var id=Path.basename(declaration,"."+U.getExtension(declaration)),dir="~"===F.config["directory-temp"][0]?Path.join(F.config["directory-temp"].substring(1),id+".package"):Path.join(F.path.root(),F.config["directory-temp"],id+".package");return F.routes.packages[id]=dir,F.restore(declaration,dir,function(){var e=Path.join(dir,"index.js");return existsSync(e)?(F.install("module",id,e,options||F.config["package#"+name],function(e){setTimeout(function(){F.emit("module#"+name),F.emit(type+"#"+name),F.emit("install","module",name),F.emit("install",type,name),F.temporary.ready["package#"+name]=F.datetime,F.temporary.ready["module#"+name]=F.datetime},500),F.consoledebug("install","package#"+name),callback&&callback(e,name)},internal,useRequired,!0,void 0),void(next&&next())):(next&&next(),void(callback&&callback(null,name)))}),F}if("theme"===type)return _owner=(packageName?packageName+"@":"")+type+"#"+name,obj=require(declaration),obj.$owner=_owner,F.temporary.owners[_owner]=!0,"function"==typeof obj.install&&obj.install(options||F.config[_owner],name),!skipEmit&&setTimeout(function(){F.emit(type+"#"+name),F.emit("install",type,name),F.temporary.ready[type+"#"+name]=F.datetime},500),F.consoledebug("install",type+"#"+name),next&&next(),callback&&callback(null,name),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration)),F;if("package2"===type){type=type.substring(0,type.length-1);var id=U.getName(declaration,".package"),dir="~"===F.config["directory-temp"][0]?Path.join(F.config["directory-temp"].substring(1),id):Path.join(F.path.root(),F.config["directory-temp"],id),filename=Path.join(dir,"index.js");return F.install("module",id.replace(/\.package$/i,""),filename,options||F.config["package#"+name],function(e){setTimeout(function(){F.emit("module#"+name),F.emit(type+"#"+name),F.emit("install",type,name),F.emit("install","module",name),F.temporary.ready["package#"+name]=F.datetime,F.temporary.ready["module#"+name]=F.datetime},500),F.consoledebug("install","package#"+name),callback&&callback(e,name)},internal,useRequired,!0),next&&next(),F}var plus=F.id?"i-"+F.id+"_":"";if("view"===type){var item=F.routes.views[name];return key=type+"."+name,void 0===item&&(item={},item.filename=F.path.temporary(plus+"installed-view-"+U.GUID(10)+".tmp"),item.url=internal,item.count=0,F.routes.views[name]=item),item.count++,Fs.writeFileSync(item.filename,framework_internal.modificators(declaration,name)),setTimeout(function(){F.emit(type+"#"+name),F.emit("install",type,name),F.temporary.ready[type+"#"+name]=F.datetime},500),F.consoledebug("install",type+"#"+name),next&&next(),callback&&callback(null,name),F}if("definition"===type||"eval"===type){_controller="",_owner=(packageName?packageName+"@":"")+type+"#"+name,F.temporary.owners[_owner]=!0,err=null;try{if(useRequired){var relative=F.path.root(declaration);existsSync(relative)&&(declaration=relative),delete require.cache[require.resolve(declaration)],obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration))}else obj="function"==typeof declaration?SUtilCommon.eval("("+declaration.toString()+")()"):eval(declaration)}catch(ex){err=ex}return err?(F.error(err,"F.install('"+type+"')",null),next&&next(),callback&&callback(err,name),F):(F.consoledebug("install",type+"#"+(name||"::undefined::")),next&&next(),callback&&callback(null,name),setTimeout(function(){F.emit(type+"#"+name),F.emit("install",type,name),F.temporary.ready[type+"#"+name]=F.datetime},500),F)}if("isomorphic"===type){content="",err=null;try{if(!name&&"string"==typeof internal){var tmp=internal.match(/[a-z0-9]+\.js$/i);tmp&&(name=tmp.toString().replace(/\.js/i,""))}if(useRequired){var relative=F.path.root(declaration);existsSync(relative)&&(declaration=relative),delete require.cache[require.resolve(declaration)],obj=require(declaration),content=Fs.readFileSync(declaration).toString(ENCODING),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration))}else obj="function"==typeof declaration?SUtilCommon.eval("("+declaration.toString()+")()"):SUtilCommon.eval(declaration),content=declaration.toString()}catch(ex){err=ex}return err?(F.error(err,"F.install('"+type+"')",null),next&&next(),callback&&callback(err,name),F):("string"==typeof obj.id?name=obj.id:"string"==typeof obj.name&&(name=obj.name),obj.url?"/"!==obj.url[0]&&(obj.url="/"+obj.url):obj.url="/"+name+".js",tmp=F.path.temp("isomorphic_"+name+".min.js"),F.map(framework_internal.preparePath(obj.url),tmp),F.isomorphic[name]=obj,Fs.writeFileSync(tmp,prepare_isomorphic(name,framework_internal.compile_javascript(content,"#"+name))),F.consoledebug("install",type+"#"+name),next&&next(),callback&&callback(null,name),setTimeout(function(){F.emit(type+"#"+name,obj),F.emit("install",type,name,obj),F.temporary.ready[type+"#"+name]=F.datetime},500),F)}if("model"===type||"source"===type){_controller="",_owner=(packageName?packageName+"@":"")+type+"#"+name,F.temporary.owners[_owner]=!0,err=null;try{if(useRequired){var relative=F.path.root(declaration);existsSync(relative)&&(declaration=relative),obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration))}else{if("string"!=typeof declaration&&(declaration=declaration.toString()),!name&&"string"==typeof internal){var tmp=internal.match(/[a-z0-9]+\.js$/i);tmp&&(name=tmp.toString().replace(/\.js/i,""))}var filename=F.path.temporary(plus+"installed-"+type+"-"+U.GUID(10)+".js");Fs.writeFileSync(filename,declaration),obj=require(filename),function(e,t){setTimeout(function(){Fs.unlinkSync(t),delete require.cache[e]},1e3)}(require.resolve(filename),filename)}}catch(ex){err=ex}return err?(F.error(err,"F.install('"+type+"', '"+name+"')",null),next&&next(),callback&&callback(err,name),F):("string"==typeof obj.id?name=obj.id:"string"==typeof obj.name&&(name=obj.name),_owner=(packageName?packageName+"@":"")+type+"#"+name,obj.$owner=_owner,name||(name=1e4*Math.random()>>0),key=type+"."+name,tmp=F.dependencies[key],F.uninstall(type,uptodateName||name,uptodateName?"uptodate":void 0),F.temporary.owners[_owner]=!0,tmp?(F.dependencies[key]=tmp,F.dependencies[key].updated=F.datetime):(F.dependencies[key]={name:name,type:type,installed:F.datetime,updated:null,count:0},internal&&(F.dependencies[key].url=internal)),F.dependencies[key].count++,obj.reinstall?F.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpiration():delete F.dependencies[key],"model"===type?F.models[name]=obj:F.sources[name]=obj,"function"==typeof obj.install&&obj.install(options||F.config[type+"#"+name],name),!skipEmit&&setTimeout(function(){F.emit(type+"#"+name,obj),F.emit("install",type,name,obj),F.temporary.ready[type+"#"+name]=F.datetime},500),F.consoledebug("install",type+"#"+name),next&&next(),callback&&callback(null,name),F)}if("module"===type||"controller"===type){var _ID=_controller="TMP"+U.random(1e4);_owner=(packageName?packageName+"@":"")+type+"#"+name,err=null;try{if(useRequired){var relative=F.path.root(declaration);existsSync(relative)&&(declaration=relative),obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration))}else{if("string"!=typeof declaration&&(declaration=declaration.toString()),!name&&"string"==typeof internal){var tmp=internal.match(/[a-z0-9]+\.js$/i);tmp&&(name=tmp.toString().replace(/\.js/i,""))}filename=F.path.temporary(plus+"installed-"+type+"-"+U.GUID(10)+".js"),Fs.writeFileSync(filename,declaration),obj=require(filename),function(e,t){setTimeout(function(){Fs.unlinkSync(t),delete require.cache[e]},1e3)}(require.resolve(filename),filename)}}catch(ex){err=ex}if(err)return F.error(err,"F.install('"+type+"', '"+(name?"":internal)+"')",null),next&&next(),callback&&callback(err,name),F;if("string"==typeof obj.id?name=obj.id:"string"==typeof obj.name&&(name=obj.name),name||(name=1e4*Math.random()>>0),_owner=(packageName?packageName+"@":"")+type+"#"+name,obj.$owner=_owner,obj.booting&&setTimeout(function(){var e=F.path.temp(name+("package"===U.getExtension(name)?"":".package/"));"root"===obj.booting?(F.directory=directory=e,F.temporary.path={},F.temporary.notfound={},F.$configure_configs(),F.$configure_versions(),F.$configure_dependencies(),F.$configure_sitemap(),F.$configure_workflows()):(F.$configure_configs("@"+name+"/config"),F.config.debug?F.$configure_configs("@"+name+"/config-debug"):F.$configure_configs("@"+name+"/config-release"),F.isTest&&F.$configure_configs("@"+name+"/config-test"),F.$configure_versions("@"+name+"/versions"),F.$configure_dependencies("@"+name+"/dependencies"),F.$configure_sitemap("@"+name+"/sitemap"),F.$configure_workflows("@"+name+"/workflows")),F.$load(void 0,e,void 0,name)},100),key=type+"."+name,tmp=F.dependencies[key],F.uninstall(type,uptodateName||name,uptodateName?"uptodate":void 0,void 0,packageName),F.temporary.owners[_owner]=!0,tmp?(F.dependencies[key]=tmp,F.dependencies[key].updated=F.datetime):(F.dependencies[key]={name:name,type:type,installed:F.datetime,updated:null,count:0,_id:_ID},internal&&(F.dependencies[key].url=internal)),F.dependencies[key].dependencies=obj.dependencies,F.dependencies[key].count++,F.dependencies[key].processed=!1,obj.reinstall?F.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpiration():delete F.dependencies[key].reinstall,_controller=_ID,obj.dependencies instanceof Array)for(var i=0,length=obj.dependencies.length;length>i;i++)if(!F.dependencies[type+"."+obj.dependencies[i]])return F.temporary.dependencies[key]={obj:obj,options:options,callback:callback,skipEmit:skipEmit},next&&next(),F;F.install_make(key,name,obj,options,callback,skipEmit,type),"module"===type?F.modules[name]=obj:F.controllers[name]=obj,F.install_prepare(),next&&next()}return F},F.restart=function(){return F.isRestarted||(F.isRestarted=!0,F.emit("restart"),setTimeout(function(){F.$restart()},1e3)),F},F.$restart=function(){return F.server.setTimeout(0),F.server.timeout=0,F.server.close(function(){Object.keys(F.modules).forEach(function(e){var t=F.modules[e];t&&t.uninstall&&t.uninstall()}),Object.keys(F.models).forEach(function(e){var t=F.models[e];t&&t.uninstall&&t.uninstall()}),Object.keys(F.controllers).forEach(function(e){var t=F.controllers[e];t&&t.uninstall&&t.uninstall()}),Object.keys(F.workers).forEach(function(e){var t=F.workers[e];t&&t.kill&&(t.removeAllListeners(),t.kill("SIGTERM"))}),Object.keys(F.connections).forEach(function(e){var t=F.connections[e];t&&(t.removeAllListeners(),t.close())}),framework_builders.restart(),framework_image.restart(),framework_mail.restart(),U.restart(),framework_internal.restart(),F.cache.clear(),F.cache.stop(),F.$events={},F.global={},F.resources={},F.connections={},F.functions={},F.themes={},F.uptodates=null,F.versions=null,F.schedules=[],F.isLoaded=!1,F.isRestarted=!1,F.components={has:!1,css:!1,js:!1,views:{},instances:{},version:null,links:"",groups:{}},F.routes={sitemap:null,web:[],system:{},files:[],cors:[],websockets:[],middleware:{},redirects:{},resize:{},request:[],views:{},merge:{},mapping:{},packages:{},blocks:{},resources:{},mmr:{}},F.temporary={path:{},notfound:{},processing:{},range:{},views:{},versions:{},dependencies:{},other:{},internal:{},owners:{},ready:{}},F.modificators=null,F.helpers={},F.modules={},F.models={},F.sources={},F.controllers={},F.dependencies={},F.isomorphic={},F.tests=[],F.errors=[],F.problems=[],F.changes=[],F.traces=[],F.workers={},F.convertors=[],F.databases={},F._request_check_redirect=!1,F._request_check_referer=!1,F._request_check_POST=!1,F._request_check_robot=!1,F._length_middleware=0,F._length_request_middleware=0,F._length_files=0,F._length_wait=0,F._length_themes=0,F._length_cors=0,F._length_subdomain_web=0,F._length_subdomain_websocket=0,F.isVirtualDirectory=!1,F.isTheme=!1,F.stats.other.restart++,setTimeout(function(){F.removeAllListeners()},2e3),setTimeout(function(){var e=F.temporary.init;F.mode(e.isHTTPS?require("https"):http,e.name,e.options)},1e3)}),F},F.install_prepare=function(e){var t=Object.keys(F.temporary.dependencies);if(t.length){for(var r=0,o=t.length;o>r;r++){var n=t[r],i=F.temporary.dependencies[n],s=F.dependencies[n],a=!1;if(!s.processed){for(var l=0,c=s.dependencies.length;c>l;l++){var u=F.dependencies["module."+s.dependencies[l]];if(!u||!u.processed){a=!0;break}}a||(delete F.temporary.dependencies[n],"module"===s.type?F.modules[s.name]=i.obj:F.controllers[s.name]=i.obj,F.install_make(n,s.name,i.obj,i.options,i.callback,i.skipEmit,s.type))}}return t=Object.keys(F.temporary.dependencies),clearTimeout(F.temporary.other.dependencies),F.temporary.other.dependencies=setTimeout(function(){var e=Object.keys(F.temporary.dependencies);if(e.length)throw new Error("Dependency exception, missing dependencies for: "+e.join(", ").trim());delete F.temporary.other.dependencies},F.config["default-dependency-timeout"]),!t.length||e?F:(F.install_prepare(!0),F)}},F.install_make=function(e,t,r,o,n,i,s){var a=F.dependencies[e],l=a._id,s=a.type;F.temporary.internal[a._id]=t,_controller=l,_owner=s+"#"+t.replace(/\.package$/gi,""),"function"==typeof r.install&&r.install(o||F.config[_owner],t),a.processed=!0;for(var c=("module"===s?"#":"")+t,u=F.routes.web.length,p=0;u>p;p++)F.routes.web[p].controller===l&&(F.routes.web[p].controller=c);u=F.routes.websockets.length;for(var p=0;u>p;p++)F.routes.websockets[p].controller===l&&(F.routes.websockets[p].controller=c);u=F.routes.files.length;for(var p=0;u>p;p++)F.routes.files[p].controller===l&&(F.routes.files[p].controller=c);return F.$routesSort(),_controller="",t=t.replace(/\.package$/gi,""),i||setTimeout(function(){F.emit(s+"#"+t,r),F.emit("install",s,t,r),F.temporary.ready[s+"#"+t]=F.datetime},500),F.consoledebug("install",s+"#"+t),n&&n(null,t),F},F.uninstall=function(e,t,r,o,n){var i,s,a,l=null;if("route"===e||"web"===e)return i="string"==typeof t?"id:"===t.substring(0,3)?"id":"urlraw":"execute",s="execute"===i?t:"id"===i?t.substring(3).trim():t,"urlraw"===i&&"#"===s[0]?delete F.routes.system[s]:F.routes.web=F.routes.web.remove(i,s),F.$routesSort(),F.consoledebug("uninstall",e+"#"+t),F.temporary.other={},F;if("cors"===e)return i="string"==typeof t&&"id:"===t.substring(0,3)?"id":"hash",s="id"===i?t.substring(3).trim():t,"id"!==i&&(s=framework_internal.preparePath(framework_internal.encodeUnicodeURL(s.replace("*","").trim()))),F.routes.cors=F.routes.cors.remove(i,s),F.consoledebug("uninstall",e+"#"+t),F;if("operation"===e)return NEWOPERATION(t,null),F.consoledebug("uninstall",e+"#"+t),F;if("schedule"===e)return F.clearSchedule(t),F.consoledebug("uninstall",e+"#"+t),F;var c=(n?n+"@":"")+e+"#"+t;if("websocket"===e)return i="string"==typeof t?"id:"===t.substring(0,3)?"id":"urlraw":"onInitialize",s="onInitialize"===i?t:"id"===i?t.substring(3).trim():t,F.routes.websockets=F.routes.websockets.remove(i,s),F.$routesSort(),F.consoledebug("uninstall",e+"#"+t),F;if("file"===e)return i="string"==typeof t?"id:"===t.substring(0,3)?"id":"urlraw":"execute",s="execute"===i?t:"id"===i?t.substring(3).trim():t,F.routes.files=F.routes.files.remove(i,s),F.consoledebug("uninstall",e+"#"+t),F;if("schema"===e)a=t.split("/"),2===a.length?framework_builders.remove(a[0],a[1]):framework_builders.remove(void 0,a[0]),F.consoledebug("uninstall",e+"#"+t);else if("mapping"===e)delete F.routes.mapping[t],F.consoledebug("uninstall",e+"#"+t);else if("isomorphic"===e){var l=F.isomorphic[t];l.url&&delete F.routes.mapping[F.$version(l.url)],delete F.isomorphic[t],delete F.temporary.ready[e+"#"+t],F.consoledebug("uninstall",e+"#"+t)}else if("middleware"===e){if(!F.routes.middleware[t])return F;delete F.routes.middleware[t],delete F.dependencies[e+"."+t],delete F.temporary.ready[e+"#"+t],F._length_middleware=Object.keys(F.routes.middleware).length;for(var u=0,p=F.routes.web.length;p>u;u++)a=F.routes.web[u],a.middleware&&a.middleware.length&&(a.middleware=a.middleware.remove(t));for(var u=0,p=F.routes.websockets.length;p>u;u++)a=F.routes.websockets[u],a.middleware&&a.middleware.length&&(a.middleware=a.middleware.remove(t));for(var u=0,p=F.routes.files.length;p>u;u++)a=F.routes.files[u],a.middleware&&a.middleware.length&&(a.middleware=a.middleware.remove(t));F.consoledebug("uninstall",e+"#"+t)}else{if("package"===e)return delete F.routes.packages[t],delete F.temporary.ready["package#"+t],F.uninstall("module",t,r,!0),F.consoledebug("uninstall",e+"#"+t),F;if("view"===e||"precompile"===e){if(l=F.routes.views[t],!l)return F;delete F.routes.views[t],delete F.dependencies[e+"."+t],delete F.temporary.ready[e+"#"+t],fsFileExists(l.filename,function(r){r&&Fs.unlink(l.filename,NOOP),F.consoledebug("uninstall",e+"#"+t)})}else if("model"===e||"source"===e){if(l="model"===e?F.models[t]:F.sources[t],!l)return F;F.$uninstall(c),"function"==typeof l.uninstall&&l.uninstall(r,t),"model"===e?delete F.models[t]:delete F.sources[t],delete F.dependencies[e+"."+t],delete F.temporary.ready[e+"#"+t],F.consoledebug("uninstall",e+"#"+t)}else if("module"===e||"controller"===e){var f="module"===e;if(l=f?F.modules[t]:F.controllers[t],!l)return F;F.$uninstall(c,n?"":(f?"#":"")+t),delete F.temporary.ready[e+"#"+t],F.consoledebug("uninstall",e+"#"+t),l&&(l.uninstall&&l.uninstall(r,t),f?delete F.modules[t]:delete F.controllers[t])}else if("component"===e){if(!F.components.instances[t])return F;l=F.components.instances[t],l&&(F.$uninstall(c),l.uninstall&&l.uninstall(r,t),delete F.components.instances[t]),delete F.components.instances[t],delete F.components.views[t],delete F.temporary.ready[e+"#"+t];var d,m,h=(F.id?"i-"+F.id+"_":"")+"components",g="\n/*"+t.hash()+"*/\n",y=g.substring(0,g.length-1),b=!1;F.components.js&&(d=Fs.readFileSync(F.path.temp(h+".js")).toString("utf-8"),m=d.indexOf(g),-1!==m&&(d=d.substring(0,m)+d.substring(d.indexOf(y,m+y.length)+y.length),Fs.writeFileSync(F.path.temp(h+".js"),d),b=!0)),F.components.css&&(d=Fs.readFileSync(F.path.temp(h+".css")).toString("utf-8"),m=d.indexOf(g),-1!==m&&(d=d.substring(0,m)+d.substring(d.indexOf(y,m+y.length)+y.length),Fs.writeFileSync(F.path.temp(h+".css"),d),b=!0)),l.group&&(h+="_g"+l.group.hash(),a=F.components.groups[l.group],a&&(a.js&&(d=Fs.readFileSync(F.path.temp(h+".js")).toString("utf-8"),m=d.indexOf(g),-1!==m&&(d=d.substring(0,m)+d.substring(d.indexOf(y,m+y.length)+y.length),Fs.writeFileSync(F.path.temp(h+".js"),d),b=!0)),a.css&&(d=Fs.readFileSync(F.path.temp(h+".css")).toString("utf-8"),m=d.indexOf(g),-1!==m&&(d=d.substring(0,m)+d.substring(d.indexOf(y,m+y.length)+y.length),Fs.writeFileSync(F.path.temp(h+".css"),d),b=!0)),a.version=F.datetime.getTime())),b&&(F.components.version=F.datetime.getTime()),F.consoledebug("uninstall",e+"#"+t)}}return!o&&F.emit("uninstall",e,t),F},F.$uninstall=function(e,t){if(!F.temporary.owners[e])return F;t&&(F.routes.web=F.routes.web.remove("controller",t),F.routes.files=F.routes.files.remove("controller",t),F.routes.websockets=F.routes.websockets.remove("controller",t)),F.routes.web=F.routes.web.remove("owner",e),F.routes.files=F.routes.files.remove("owner",e),F.routes.websockets=F.routes.websockets.remove("owner",e),F.routes.cors=F.routes.cors.remove("owner",e),F.schedules=F.schedules.remove("owner",e),F.modificators&&(F.modificators=F.modificators.remove("$owner",e)),framework_builders.uninstall(e);for(var r=[],o=!1,n=0,i=F.owners.length;i>n;n++){var s=F.owners[n];if(s.owner===e)switch(s.type){case"redirects":delete F.routes.redirects[s.id],o=!0;break;case"resize":delete F.routes.resize[s.id];break;case"merge":delete F.routes.merge[s.id];break;case"mapping":delete F.routes.mapping[s.id];break;case"blocks":delete F.routes.blocks[s.id];break;case"middleware":UNINSTALL("middleware",s.id)}else r.push(s)}return o&&(F._request_check_redirect=Object.keys(F.routes.redirects).length>0),F.owners=r,F.$routesSort(),delete F.temporary.owners[e],F},F.register=function(e){var t,r="."+U.getExtension(e),o=U.getName(e),n=e[0];switch("@"===n?e=F.path["package"](e.substring(1)):"="===n&&("?"===e[1]?F.path.themes(F.config["default-theme"]+e.substring(2)):e=F.path.themes(e.substring(1))),r){case".resource":t=o.replace(r,""),F.routes.resources[t]?F.routes.resources[t].push(e):F.routes.resources[t]=[e],delete F.resources[t];break;default:throw new Error('Not supported registration type "'+r+'".')}return F},F.eval=function(e){return F.install("eval",e)},F.onError=function(e,t,r){return F.datetime=new Date,F},F.onAuthorize=null,F.onLocale=null,F.onTheme=null,F.onVersion=null,F.onMapping=function(e,t,r,o){if("/"!==e[0]&&(e="/"+e),F._length_themes){var n=e.indexOf("/",1);if(-1!==n){var i=e.substring(1,n);if(F.themes[i])return F.themes[i]+"public"+e.substring(n)}}return F.routes.mapping[e]?F.routes.mapping[e]:(t=framework_internal.preparePath(t,!0),o&&(t=$decodeURIComponent(t)),t=r?F.path.public_cache(t):"~"===t[0]?t.substring(1):"."===t[0]?t:F.path.public_cache(t))},F.download=F.snapshot=function(e,t,r){if(!F.isLoaded)return setTimeout(function(e,t,r){F.snapshot(e,t,r)},200,e,t,r),F;if(e=framework_internal.preparePath(e),!REG_HTTPHTTPS.test(e)){if("/"!==e[0]&&(e="/"+e),F.isWorker)throw new Error('Worker can\'t create a snapshot from relative URL address "{0}".'.format(e));e="http://"+("auto"===F.ip?"0.0.0.0":F.ip)+":"+F.port+e}return U.download(e,FLAGS_INSTALL,function(e,o){if(e)return r&&r(e),void(r=null);var n=Fs.createWriteStream(t);o.pipe(n),o.on("error",function(e){r&&r(e),r=null}),CLEANUP(n,function(){r&&r(null,t),r=null})}),F},F.findConnection=function(e){for(var t=Object.keys(F.connections),r=U.isRegExp(e),o=0,n=t.length;n>o;o++){var i=t[o];if(r){if(e.test(i))return F.connections[i]}else if(-1!==i.indexOf(e))return F.connections[i]}},F.findConnections=function(e){for(var t=Object.keys(F.connections),r=U.isRegExp(e),o=[],n=0,i=t.length;i>n;n++){var s=t[n];e?r?e.test(s)&&o.push(F.connections[s]):-1!==s.indexOf(e)&&o.push(F.connections[s]):o.push(F.connections[s])}return o},F.onValidate=null,F.onParseXML=function(e){var t=U.parseXML(e);return F._length_convertors&&F.convert(t),t},F.onParseXML.$def=!0,F.$onParseXML=function(e){F.onParseXML.$def?(e.body=U.parseXML(e.buffer_data),F._length_convertors&&F.convert(e.body)):e.body=F.onParseXML(e.buffer_data)},F.onParseJSON=function(e){return JSON.parse(e)},F.onParseJSON.$def=!0,F.$onParseJSON=function(e){e.body=F.onParseJSON.$def?JSON.parse(e.buffer_data):F.onParseJSON(e.buffer_data)},F.onParseQuery=function(e){if(e){var t=Qs.parse(e,null,null,QUERYPARSEROPTIONS);return F._length_convertors&&F.convert(t),t}return{}},F.onParseQuery.$def=!0,F.$onParseQueryBody=function(e){F.onParseQuery.$def?e.buffer_data?(e.body=Qs.parse(e.buffer_data,null,null,QUERYPARSEROPTIONS),F._length_convertors&&F.convert(e.body)):e.body={}:e.body=F.onParseQuery(e.buffer_data,e)},F.$onParseQueryUrl=function(e){F.onParseQuery.$def?(e._querydata=Qs.parse(e.uri.query,null,null,QUERYPARSEROPTIONS),F._length_convertors&&F.convert(e._querydata)):e._querydata=F.onParseQuery(e.uri.query,e)},F.onSchema=function(e,t,r,o,n,i){var s=GETSCHEMA(t,r);s?s.make(e.body,n,onSchema_callback,o,i):o(new Error('Schema "'+t+"/"+r+'" not found.'))},F.onMail=function(e,t,r,o,n){var i;"string"==typeof o&&(i=n,n=o,o=i);var s=Mail.create(t,r);if(e instanceof Array)for(var a=0,l=e.length;l>a;a++)s.to(e[a]);else s.to(e);return s.from(F.config["mail-address-from"]||"",F.config.name),n?s.reply(n):(i=F.config["mail-address-reply"],i&&i.length>3&&s.reply(i)),i=F.config["mail-address-copy"],i&&i.length>3&&s.bcc(i),s.$sending=setImmediate(function(e){return s.send2(e)},o),s},F.onMeta=function(){for(var e="",t=arguments.length,r=this,o=0;t>o;o++){var n=U.encode(arguments[o]);if(null!=n&&n.length)switch(o){case 0:e+="<title>"+(n+("/"===F.url||F.config["allow-custom-titles"]?"":" - "+F.config.name))+"</title>";break;case 1:e+='<meta name="description" content="'+n+'" />';break;case 2:e+='<meta name="keywords" content="'+n+'" />';break;case 3:var i=n.substring(0,6),s="http:/"===i||"https:"===i||"//"===n.substring(0,2)?n:r.hostname(r.routeImage(n));e+='<meta property="og:image" content="'+s+'" /><meta name="twitter:image" content="'+s+'" />'}}return e},F.log=function(){F.datetime=new Date;for(var e=F.datetime.getFullYear()+"-"+(F.datetime.getMonth()+1).toString().padLeft(2,"0")+"-"+F.datetime.getDate().toString().padLeft(2,"0"),t=F.datetime.getHours().toString().padLeft(2,"0")+":"+F.datetime.getMinutes().toString().padLeft(2,"0")+":"+F.datetime.getSeconds().toString().padLeft(2,"0"),r="",o=arguments.length,n=0;o>n;n++){var i=arguments[n];void 0===i?i="undefined":null===i?i="null":"object"==typeof i&&(i=Util.inspect(i)),r+=(r?" ":"")+i}return F.path.verify("logs"),U.queue("F.log",5,function(o){return Fs.appendFile(U.combine(F.config["directory-logs"],e+".log"),t+" | "+r+"\n",o)}),F},F.logger=function(){F.datetime=new Date;for(var e=F.datetime.getFullYear()+"-"+(F.datetime.getMonth()+1).toString().padLeft(2,"0")+"-"+F.datetime.getDate().toString().padLeft(2,"0")+" "+F.datetime.getHours().toString().padLeft(2,"0")+":"+F.datetime.getMinutes().toString().padLeft(2,"0")+":"+F.datetime.getSeconds().toString().padLeft(2,"0"),t="",r=arguments.length,o=1;r>o;o++){var n=arguments[o];void 0===n?n="undefined":null===n?n="null":"object"==typeof n&&(n=Util.inspect(n)),t+=(t?" ":"")+n}return F.path.verify("logs"),U.queue("F.logger",5,function(r){return Fs.appendFile(U.combine(F.config["directory-logs"],arguments[0]+".log"),e+" | "+t+"\n",r)}),F},F.logmail=function(e,t,r,o){typeof r===FUNCTION?(o=r,r=t,t=null):void 0===r&&(r=t,t=null),t||(t=F.config.name+" v"+F.config.version);var r="<!DOCTYPE html><html><head><title>"+t+'</title><meta charset="utf-8" /></head><body><pre style="max-width:600px;font-size:13px;line-height:16px">'+("object"==typeof r?JSON.stringify(r).escape():r)+"</pre></body></html>";return F.onMail(e,t,r,o)},F.usage=function(e){var t=process.memoryUsage(),r=Object.keys(F.cache.items),o=Object.keys(F.resources),n=Object.keys(F.controllers),i=Object.keys(F.connections),s=Object.keys(F.workers),a=Object.keys(F.modules),l=Object.keys(F.isomorphic),c=Object.keys(F.models),u=Object.keys(F.helpers),p=Object.keys(F.temporary.path),f=Object.keys(F.temporary.notfound),d=Object.keys(F.temporary.range),m=Object.keys(F.routes.redirects),h={};h.framework={id:F.id,datetime:F.datetime,pid:process.pid,node:process.version,version:"v"+F.version_header,platform:process.platform,processor:process.arch,uptime:Math.floor(process.uptime()/60),memoryTotal:(t.heapTotal/1024/1024).floor(2),memoryUsage:(t.heapUsed/1024/1024).floor(2),memoryRss:(t.rss/1024/1024).floor(2),mode:F.config.debug?"debug":"release",port:F.port,ip:F.ip,directory:process.cwd()};for(var g=Object.keys(U.queuecache),y=0,b=0,E=g.length;E>b;b++)y+=U.queuecache[g[b]].pending.length;return h.counter={resource:o.length,controller:n.length,module:a.length,isomorphic:l.length,cache:r.length,worker:s.length,connection:i.length,schedule:F.schedules.length,helpers:u.length,error:F.errors.length,problem:F.problems.length,queue:y,files:p.length,notfound:f.length,streaming:d.length,modificator:F.modificators?F.modificators.length:0,viewphrases:$VIEWCACHE.length,uptodates:F.uptodates?F.uptodates.length:0},h.routing={webpage:F.routes.web.length,sitemap:F.routes.sitemap?Object.keys(F.routes.sitemap).length:0,websocket:F.routes.websockets.length,file:F.routes.files.length,middleware:Object.keys(F.routes.middleware).length,redirect:m.length,mmr:Object.keys(F.routes.mmr).length},h.stats=F.stats,h.redirects=m,e?(h.controllers=[],n.forEach(function(e){var t=F.controllers[e];h.controllers.push({name:e,usage:t.usage?t.usage():null})}),h.connections=[],i.forEach(function(e){h.connections.push({name:e,online:F.connections[e].online})}),h.modules=[],a.forEach(function(e){var t=F.modules[e];h.modules.push({name:e,usage:t.usage?t.usage():null})}),h.models=[],c.forEach(function(e){var t=F.models[e];h.models.push({name:e,usage:t.usage?t.usage():null})}),h.uptodates=F.uptodates,h.helpers=u,h.cache=r,h.resources=o,h.errors=F.errors,h.problems=F.problems,h.changes=F.changes,h.traces=F.traces,h.files=p,h.streaming=d,h.other=Object.keys(F.temporary.other),h):h},F.onCompileView=function(e,t,r){return t},F.onCompileStyle=null,F.onCompileScript=null,F.compile_virtual=function(e){var t=e.req,r=e.options.filename.replace(F.config["directory-public"],F.config["directory-public-virtual"]);return r===e.options.filename?(F.temporary.notfound[t.$key]=!0,delete F.temporary.processing[t.$key],void e.$file()):void fsFileExists(r,function(o,n,i,s){return o?void(e.noCompress||"js"!==t.extension&&"css"!==t.extension||!F.config["allow-compile"]||REG_NOCOMPRESS.test(e.options.filename)?(F.temporary.path[t.$key]=[r,n,s.mtime.toUTCString()],delete F.temporary.processing[t.$key],e.$file()):(e.options.filename=r,compile_file(e))):(F.temporary.notfound[t.$key]=!0,delete F.temporary.processing[t.$key],void e.$file())})},F.responseStatic=function(e,t,r){return t.options.callback=r,t["continue"](),F},F.restore=function(e,t,r,o){var n=U.createBuffer(":"),i=U.createBuffer("\n"),s=U.createBuffer("#"),a={},l=null,c=0,u=null,p=Fs.createReadStream(e),f=0,d={},m={},h=0,g=!1,y={};return y.count=0,y.path=t,d.parse_key=function(){f=l.indexOf(n),-1!==f&&(f++,u=l.slice(0,f-1).toString("utf8").trim(),l=l.slice(f),c=1,d.next())},d.parse_meta=function(){var e=Path.join(t,u);if(l[0]===s[0])return a[e]||(a[e]=!0,o&&o(u,!0)===!1||F.path.mkdir(e)),c=3,void d.next();if(!a[e]){a[e]=!0;var r=e.substring(0,e.lastIndexOf(F.isWindows?"\\":"/"));if(o&&o(u,!1)===!1)return c=5,void d.next();F.path.mkdir(r)}c=2;var n=m[u]={};n.path=e,n.name=u,n.writer=Fs.createWriteStream(e),n.zlib=Zlib.createGunzip(),n.zlib.$self=n,h++,y.count++,n.zlib.on("data",function(e){this.$self.writer.write(e)}),n.zlib.on("end",function(){h--;var e=this.$self;e.writer.end(),e.writer=null,e.zlib=null,delete m[e.name]}),d.next()},d.parse_dir=function(){f=l.indexOf(i),-1!==f&&(l=l.slice(f+1),c=0),d.next()},d.parse_data=function(){f=l.indexOf(i);var e=!1;if(-1!==f&&(c=0),c){var t=l.length%4;t?(m[u].zlib.write(U.createBuffer(l.slice(0,l.length-t).toString("ascii"),"base64")),l=l.slice(l.length-t),e=!0):(m[u].zlib.write(U.createBuffer(l.toString("ascii"),"base64")),l=null)}else m[u].zlib.end(U.createBuffer(l.slice(0,f).toString("ascii"),"base64")),l=l.slice(f+1);!e&&l&&l.length&&d.next()},d.next=function(){switch(c){case 0:d.parse_key();break;case 1:d.parse_meta();break;case 2:d.parse_data();break;case 3:d.parse_dir();break;case 5:f=l.indexOf(i),-1===f?l=null:(l=l.slice(f+1),c=0,d.next())}g&&!l.length&&r&&r(null,y)},d.end=function(){r&&(h?setTimeout(d.end,100):g&&!l.length&&r(null,y))},p.on("data",function(e){l?(CONCAT[0]=l,CONCAT[1]=e,l=Buffer.concat(CONCAT)):l=e,d.next()}),CLEANUP(p,function(){g=!0,d.end()}),F},F.backup=function(e,t,r,o){var n=100,i=t instanceof Array?F.path.root():t;t instanceof Array||(t=[""]);var s=0;return Fs.unlink(e,function(){t.sort(function(e,t){var r=e.split("/"),o=t.split("/");return r.length<o.length?-1:r.length>o.length?1:e.localeCompare(t)});var a=Fs.createWriteStream(e);t.wait(function(r,l){"/"!==r[0]&&(r="/"+r);var c=Path.join(i,r);Fs.stat(c,function(u,p){if(u)return F.error(u,"F.backup()",e),l();if(p.isDirectory()){var f=r.replace(/\\/g,"/")+"/";return o&&!o(f,!0)?l():void U.ls(c,function(e,r){var o=i.length;r.wait(function(e,t){a.write(e.substring(o).padRight(n)+":#\n","utf8"),t()},function(){for(var r=0;r<e.length;r++)t.push(e[r].substring(o));l()})})}var d=U.createBufferSize(0);a.write(r.padRight(n)+":"),CLEANUP(Fs.createReadStream(c).pipe(Zlib.createGzip(GZIPFILE)).on("data",function(e){CONCAT[0]=d,CONCAT[1]=e,d=Buffer.concat(CONCAT);var t=d.length%3;t&&(a.write(d.slice(0,d.length-t).toString("base64")),d=d.slice(d.length-t))}),function(){d.length&&a.write(d.toString("base64")),a.write("\n","utf8"),s++,l()})})},function(){r&&Fs.stat(e,function(t,o){return r(null,{filename:e,files:s,size:o.size})})})}),F},F.exists=function(e,t,r,o){"function"==typeof r&&(o=r,r=10);var n=e.$key=createTemporaryKey(e),i=F.path.temp(n),s=!1;return RELEASE&&e.headers["if-none-match"]===ETAG+F.config["etag-version"]&&(s=!0),F.isProcessed(n)||s?(t.options.filename=i,t.$file(),F):(U.queue("F.exists",r,function(r){fsFileExists(i,function(n){n?(t.options.filename=i,t.options.callback=r,t.$file()):o(r,i,e,t)})}),F)},F.isProcessed=function(e){if(e.url){var t=e.url,r=t.indexOf("?");-1!==r&&(t=t.substring(0,r)),e=F.path["public"]($decodeURIComponent(t))}return!F.temporary.notfound[e]&&void 0!==F.temporary.path[e]},F.isProcessing=function(e){if(!e.url)return!!F.temporary.processing[e];var t=e.url,r=t.indexOf("?");return-1!==r&&(t=t.substring(0,r)),e=U.combine(F.config["directory-public"],$decodeURIComponent(t)),!!F.temporary.processing[e]},F.noCache=function(e){return OBSOLETE("F.noCache()","Use req.noCache() or res.noCache() --> they have same functionality."),e.noCache(),F},F.responseFile=function(e,t,r,o,n,i,s){return t.$key=s,t.options.filename=r,t.options.download=o,t.options.headers=n,t.options.callback=i,t.$file(),F},F.touch=function(e){if(e){var t=createTemporaryKey(e);delete F.temporary.path[t],delete F.temporary.notfound[t]}else F.temporary.path={},F.temporary.notfound={};return F},F.responsePipe=function(e,t,r,o,n,i){return t.pipe(r,o,n,i),F},F.responseCustom=function(e,t){return t.$custom(),F},F.responseImage=function(e,t,r,o,n,i){return"object"==typeof r?t.options.stream=r:t.options.filename=r,t.options.headers=n,t.options.callback=i,t.options.make=o,t.$image(),F},F.responseImageWithoutCache=function(e,t,r,o,n,i){"object"==typeof r?t.options.stream=r:t.options.filename=r,t.options.headers=n,t.options.callback=i,t.options.make=o,t.options.cache=!1,t.$image()},F.responseStream=function(e,t,r,o,n,i,s,a){return t.options.type=r,t.options.stream=o,t.options.download=n,t.options.headers=i,t.options.compress=a?!1:!0,t.options.callback=s,t.$stream(),F},F.responseBinary=function(e,t,r,o,n,i,s,a){return t.options.type=r,t.options.body=o,t.options.encoding=n,t.options.download=i,t.options.headers=s,t.options.callback=a,t.$binary(),F},F.setModified=function(e,t,r){return"string"==typeof r?t.setHeader("Etag",r+F.config["etag-version"]):t.setHeader("Last-Modified",r.toUTCString()),F},F.notModified=function(e,t,r,o){var n=typeof r;if("boolean"===n){var i=r;r=o,o=i,n=typeof r}var s="string"===n,a=e.headers[s?"if-none-match":"if-modified-since"];if(s){if(a!==r+F.config["etag-version"])return!1}else{if(!a)return!1;var l=void 0===r?(new Date).toUTCString():r.toUTCString();if(o){if(new Date(Date.parse(a))===new Date(l))return!1}else if(new Date(Date.parse(a))<new Date(l))return!1}var c;return s?(c=HEADERS.notModifiedEtag,c.Etag=a):(c=HEADERS.notModifiedLastModifiedDate,c["Last-Modified"]=a),t.success=!0,t.writeHead(304,c),t.end(),F.stats.response.notModified++,response_end(t),!0},F.responseCode=function(e,t,r,o){return t.options.code=r,o&&(t.options.problem=o),t.$throw(),F},F.response400=function(e,t,r){return t.options.code=400,r&&(t.options.problem=r),t.$throw(),F},F.response401=function(e,t,r){return t.options.code=401,r&&(t.options.problem=r),t.$throw(),F},F.response403=function(e,t,r){return t.options.code=403,r&&(t.options.problem=r),t.$throw(),F},F.response404=function(e,t,r){return t.options.code=404,r&&(t.options.problem=r),t.$throw(),F},F.response408=function(e,t,r){return t.options.code=408,r&&(t.options.problem=r),t.$throw(),F},F.response431=function(e,t,r){return t.options.code=431,r&&(t.options.problem=r),t.$throw(),F},F.response500=function(e,t,r){return t.throw500(r),F},F.response501=function(e,t,r){return t.options.code=501,r&&(t.options.problem=r),t.$throw(),F},F.response503=function(e,t){var r="";for(var o in F.waits)r+=(t.options.body?", ":"")+"<u>"+o+"</u>";return t.options.code=503,t.options.headers=HEADERS.response503,t.options.body='<html><head><meta charset="utf-8" /></head><body style="font:normal normal 11px Arial;color:gray;line-height:16px;padding:10px;background-color:white"><div style="font-size:14px;color:#505050">Please wait ( <span id="time">10</span> ) for <b>'+(F.config.name+" v"+F.config.version)+"</b> application.</div>The application is waiting for : "+r+'.<script>var i=10;setInterval( function(){i--;if( i<0 )return;window.document.getElementById( "time" ).innerHTML=( i===0?"refreshing":i );if( i===0 )window.location.reload();},1000 );</script></body></html>',t.$throw(),F},F.responseContent=function(e,t,r,o,n,i,s){return t.options.code=r,t.options.body=o,t.options.type=n,t.options.compress=void 0===i||i===!0,t.options.headers=s,t.$text(),F},F.responseRedirect=function(e,t,r,o){return t.options.url=r,t.options.permanent=o,t.$redirect(),F},F.load=function(e,t,r){return r&&"."===r[0]&&r.length<4?F.directory=directory=U.$normalize(Path.normalize(directory+"/..")):r&&(F.directory=directory=U.$normalize(r)),"release"===e?e=!1:"debug"===e&&(e=!0),F.isWorker=!0,F.config.debug=e,F.isDebug=e,global.DEBUG=e,global.RELEASE=!e,global.I=global.isomorphic=F.isomorphic,F.consoledebug("startup"),F.$startup(function(){F.consoledebug("startup (done)"),F.$configure_configs(),t&&-1===t.indexOf("versions")||F.$configure_versions(),t&&-1===t.indexOf("workflows")||F.$configure_workflows(),t&&-1===t.indexOf("sitemap")||F.$configure_sitemap(),F.consoledebug("init"),F.cache.init(),F.emit("init"),F.$load(t,directory,function(){F.isLoaded=!0,process.send&&process.send("total:ready"),setTimeout(function(){try{F.emit("load",F),F.emit("ready",F)}catch(e){F.error(e,'F.on("load/ready")')}F.removeAllListeners("load"),F.removeAllListeners("ready"),delete F.tests,delete F.test,delete F.testing,delete F.assert},500),F.config["allow-debug"]&&(F.consoledebug("done"),F.usagesnapshot())})}),F},F.initialize=function(e,t,r,o){r||(r={});var n=r.port,i=r.ip,s=r.listenpath;if(r.config&&U.extend(F.config,r.config,!0),(r.debug||r["allow-debug"])&&(F.config["allow-debug"]=!0),F.isHTTPS=void 0===e.STATUS_CODES,isNaN(n)&&"string"!=typeof n&&(n=null),r.id&&(F.id=r.id),F.config.debug=t,F.isDebug=t,global.DEBUG=t,global.RELEASE=!t,global.I=global.isomorphic=F.isomorphic,F.$configure_configs(),F.$configure_versions(),F.$configure_workflows(),F.$configure_sitemap(),F.isTest&&F.$configure_configs("config-test",!0),F.cache.init(),F.consoledebug("init"),F.emit("init"),!n)if("auto"===F.config["default-port"]){var a=+(process.env.PORT||"");isNaN(a)||(n=a)}else n=F.config["default-port"];F.port=n||8e3,null!==i?(F.ip=i||F.config["default-ip"]||"0.0.0.0",("null"===F.ip||"undefined"===F.ip||"auto"===F.ip)&&(F.ip=null)):F.ip=void 0,null==F.ip&&(F.ip="0.0.0.0"),!s&&(s=F.config["default-listenpath"]),F.listenpath=s,F.server&&(F.server.removeAllListeners(),Object.keys(F.connections).forEach(function(e){var t=F.connections[e];t&&(t.removeAllListeners(),t.close())}),F.server.close());var l=function(){r.https?F.server=e.createServer(r.https,F.listener):F.server=e.createServer(F.listener),F.config["allow-performance"]&&F.server.on("connection",connection_tunning),F.initwebsocket&&F.initwebsocket(),F.consoledebug("HTTP listening"),s?F.server.listen(s):F.server.listen(F.port,F.ip),function(){global.server?global.TtwLog.warn("global.server  ."):global.server=global.b2link.server_http.legacyServer__WebServer__TotalJS(F.server)}()};return F.consoledebug("clear temporary"),F.clear(function(){F.consoledebug("clear temporary ( done )"),F.$load(void 0,directory,function(){if(F.isLoaded=!0,process.send&&process.send("total:ready"),r.middleware?r.middleware(l):l(),F.config["allow-debug"]&&(F.consoledebug("done"),F.usagesnapshot()),(!process.connected||o)&&F.console(),setTimeout(function(){try{F.emit("load",F),F.emit("ready",F)}catch(e){F.error(e,'F.on("load/ready")')}F.removeAllListeners("load"),F.removeAllListeners("ready"),r["package"]&&INSTALL("package",r["package"])},500),F.isTest){var e=r.sleep||r.delay||1e3;return setTimeout(function(){F.test(!0,r.tests||r.test)},e),F}setTimeout(function(){F.isTest||(delete F.tests,delete F.test,delete F.testing,delete F.assert)},5e3)})},!0),F},F.http=function(e,t,r){F.consoledebug("begin"),"function"==typeof t&&(r=t,t=null),null==t&&(t={}),!t.port&&(t.port=+process.argv[2]),"function"==typeof r&&(t.middleware=r);var o=require("http");return extend_request(o.IncomingMessage.prototype),extend_response(o.ServerResponse.prototype),F.mode(o,e,t)},F.https=function(e,t,r){F.consoledebug("begin");var o=require("http");return"function"==typeof t&&(r=t,t=null),null==t&&(t={}),!t.port&&(t.port=+process.argv[2]),"function"==typeof r&&(t.middleware=r),extend_request(o.IncomingMessage.prototype),extend_response(o.ServerResponse.prototype),F.mode(require("https"),e,t)},F.mode=function(e,t,r){var o=!1;if(r.directory&&(F.directory=directory=r.directory),"string"==typeof e){switch(e){case"debug":case"development":o=!0}return F.config.debug=o,F.config.trace=o,F.isDebug=o,global.DEBUG=o,global.RELEASE=!o,F}switch(F.isWorker=!1,t.toLowerCase().replace(/\.|\s/g,"-")){case"release":case"production":break;case"debug":case"develop":case"development":o=!0;break;case"test-debug":case"debug-test":case"testing-debug":o=!0,F.isTest=!0;break;case"test":case"testing":case"test-release":case"release-test":case"testing-release":case"test-production":case"testing-production":o=!1,F.isTest=!0}var n=!1;return F.temporary.init?n=!0:F.temporary.init={name:t,isHTTPS:"undefined"==typeof e.STATUS_CODES,options:r},F.config.trace=o,F.consoledebug("startup"),F.$startup(function(){F.consoledebug("startup ( done )"),F.initialize(e,o,r,n)}),F},F.custom=function(e,t,r,o,n){var i=!1;switch(n.directry&&(F.directory=directory=n.directory),F.consoledebug("begin"),extend_request(r),extend_response(o),e.toLowerCase().replace(/\.|\s/g,"-")){case"release":case"production":break;case"debug":case"develop":case"development":i=!0;break;case"test":case"testing":case"test-debug":case"debug-test":case"testing-debug":i=!0,F.isTest=!0;break;case"test-release":case"release-test":case"testing-release":case"test-production":case"testing-production":i=!1}var s=!1;return F.temporary.init?s=!0:F.temporary.init={name:e,isHTTPS:!1,options:n},F.config.trace=i,F.consoledebug("startup"),F.$startup(function(){F.consoledebug("startup ( done )"),F.initialize(t,i,n,s)}),F},F.console=function(){global.TtwLog.log("===================================================="),global.TtwLog.log("PID     : "+process.pid),global.TtwLog.log("Node.js : "+process.version),global.TtwLog.log("Total.js: v"+F.version_header),global.TtwLog.log("OS      : "+Os.platform()+" "+Os.release()),global.TtwLog.log("===================================================="),global.TtwLog.log("Name    : "+F.config.name),global.TtwLog.log("Version : "+F.config.version),global.TtwLog.log("Author  : "+F.config.author),global.TtwLog.log("Date    : "+F.datetime.format("yyyy-MM-dd HH:mm:ss")),global.TtwLog.log("Mode    : "+(F.config.debug?"debug":"release")),global.TtwLog.log("====================================================\n"),global.TtwLog.log("{2}://{0}:{1}/".format(F.ip,F.port,F.isHTTPS?"https":"http")),global.TtwLog.log("")},F.usagesnapshot=function(e){return Fs.writeFile(e||F.path.root("usage.log"),JSON.stringify(F.usage(!0),null,"    "),NOOP),F},F.consoledebug=function(){if(!F.config["allow-debug"])return F;for(var e=[(new Date).format("yyyy-MM-dd HH:mm:ss"),"--------->"],t=0;t<arguments.length;t++)e.push(arguments[t]);return F},F.reconnect=function(){return void 0!==F.config["default-port"]&&(F.port=F.config["default-port"]),void 0!==F.config["default-ip"]&&(F.ip=F.config["default-ip"]),F.server.close(function(){F.server.listen(F.port,F.ip)}),F},F.service=function(e){UIDGENERATOR.date=F.datetime.format("yyMMddHHmm"),UIDGENERATOR.index=1;var t=!1;if(F.temporary.notfound={},e%F.config["default-interval-clear-cache"]===0){F.$events.clear&&F.emit("clear","temporary",F.temporary),F.temporary.path={},F.temporary.range={},F.temporary.views={},F.temporary.other={},global.$VIEWCACHE&&global.$VIEWCACHE.length&&(global.$VIEWCACHE=[]),Image.clear();var r=F.datetime.add("-5 minutes");for(var o in F.databases)F.databases[o]&&F.databases[o].inmemorylastusage<r&&F.databases[o].release();t=!0,F.config["allow-debug"]&&F.consoledebug("clear temporary cache")}if(e%F.config["default-interval-precompile-views"]===0)for(var o in F.routes.views){var n=F.routes.views[o];F.install("view",o,n.url,null)}e%F.config["default-interval-clear-dnscache"]===0&&(F.$events.clear&&F.emit("clear","dns"),U.clearDNS(),F.config["allow-debug"]&&F.consoledebug("clear DNS cache"));var i=F.config["default-interval-websocket-ping"];if(i>0&&e%i===0){var s=!1;for(var n in F.connections){var a=F.connections[n];a&&(a.check(),a.ping(),s=!0)}s&&F.config["allow-debug"]&&F.consoledebug("ping websocket connections")}if(F.uptodates&&e%F.config["default-interval-uptodate"]===0&&F.uptodates.length){var l=!1;F.uptodates.wait(function(e,t){return e.updated.add(e.interval)>F.datetime?t():(e.updated=F.datetime,e.count++,void setTimeout(function(){F.config["allow-debug"]&&F.consoledebug("uptodate",e.type+"#"+e.url),F.install(e.type,e.url,e.options,function(r,o,n){return F.config["allow-debug"]&&F.consoledebug("uptodate",e.type+"#"+e.url+" (done)"),n?t():(r?(e.errors.push(r),e.errors.length>50&&F.errors.shift()):(l=!0,e.name=o,F.$events.uptodate&&F.emit("uptodate",e.type,o)),e.callback&&e.callback(r,o),void t())},void 0,void 0,void 0,void 0,e.name)},e.name?500:1))},function(){l&&(F.temporary.path={},F.temporary.range={},F.temporary.views={},F.temporary.other={},global.$VIEWCACHE&&global.$VIEWCACHE.length&&(global.$VIEWCACHE=[]))})}if(e%F.config["default-interval-clear-resources"]===0&&(F.$events.clear&&F.emit("clear","resources"),F.resources={},t=!0,F.config["allow-debug"]&&F.consoledebug("clear resources")),e%1e3===0&&(DATE_EXPIRES=F.datetime.add("y",1).toUTCString()),F.$events.service&&F.emit("service",e),F.config["allow-debug"]&&(F.consoledebug("service ({0}x )".format(e)),F.usagesnapshot()),t&&global.gc&&setTimeout(function(){global.gc(),F.config["allow-debug"]&&F.consoledebug("gc()")},1e3),!F.schedules.length)return F;for(var c=F.datetime.getTime(),u=0;;){var p=F.schedules[u++];if(!p)break;p.expire>c||(u--,p.repeat?p.expire=F.datetime.add(p.repeat):F.schedules.splice(u,1),F.config["allow-debug"]&&F.consoledebug("schedule",p.id),p.fn.call(F))}return F},F.listener=function(e,t){var r=global._$TATIC_VALUE_SERVER_HTTP_EVTS_REQUEST;if(r[e.url])return void r[e.url](e,t);if(e.options=t.options={},t.req=e,e.res=t,F._length_wait)return F.response503(e,t);if(!e.host)return t.throw400();var o=e.headers;if(e.$protocol=e.connection&&e.connection.encrypted||"https"===(o["x-forwarded-proto"]||["x-forwarded-protocol"])?"https":"http",e.uri=framework_internal.parseURI(e),F.stats.request.request++,F.$events.request&&F.emit("request",e,t),F._request_check_redirect){var n=F.routes.redirects[e.$protocol+"://"+e.host];if(n)return F.stats.response.forward++,t.options.url=n.url+(n.path?e.url:""),t.options.permanent=n.permanent,void t.$redirect()}e.path=framework_internal.routeSplit(e.uri.pathname),e.processing=0,e.isAuthorized=!0,e.xhr="XMLHttpRequest"===o["x-requested-with"],t.success=!1,e.user=e.session=null,e.isStaticFile=F.config["allow-static-files"]&&U.isStaticFile(e.uri.pathname),e.isStaticFile?e.extension=U.getExtension(e.uri.pathname):F.onLocale&&(e.$language=F.onLocale(e,t,e.isStaticFile)),F.reqstats(!0,!0),F._length_request_middleware?async_middleware(0,e,t,F.routes.request,requestcontinue_middleware):F.$requestcontinue(e,t,o)},F.$requestcontinue=function(e,t,r){if(e&&t&&!t.headersSent&&!t.success){if(e.isStaticFile)return F.stats.request.file++,void(F._length_files?e.$total_file():t["continue"]());if(!PERF[e.method])return void e.$total_status(404);F.stats.request.web++,e.body=EMPTYOBJECT,e.files=EMPTYARRAY,e.buffer_exceeded=!1,e.buffer_has=!1,e.$flags=e.method[0]+e.method[1],"total.js"===r["x-proxy"]&&(e.isProxy=!0,e.$flags+="f",n.push("proxy"));var o,n=[e.method.toLowerCase()];e.mobile?(e.$flags+="a",F.stats.request.mobile++):F.stats.request.desktop++,e.$protocol[5]&&(e.$flags+=e.$protocol[5]),e.$type=0,n.push(e.$protocol);var i=e.method,s=i[0];if("P"===s||"D"===s){o=e.headers["content-type"]||"",e.buffer_data=U.createBuffer();var a=o.lastIndexOf(";"),l=o;switch(-1!==a&&(l=l.substring(0,a)),l.substring(l.length-4)){case"json":e.$flags+="b",n.push("json"),e.$type=1,o="";break;case"oded":e.$type=3,o="";break;case"data":e.$flags+="c",e.$upload=!0,n.push("upload");break;case"/xml":e.$flags+="d",n.push("xml"),e.$type=2,o="";break;case"lace":e.$type=4,n.push("mmr"),e.$flags+="e";break;default:o?(o="",n.push("raw")):(e.$type=3,o="")}}if("text/event-stream"===r.accept&&(e.$flags+="g",n.push("sse")),F.config.debug&&(e.$flags+="h",n.push("debug")),e.xhr&&(F.stats.request.xhr++,e.$flags+="i",n.push("xhr")),F._request_check_robot&&e.robot&&(e.$flags+="j"),F._request_check_referer){var c=r.referer;c&&-1!==c.indexOf(r.host)&&(e.$flags+="k",n.push("referer"))}e.flags=n,F.$events["request-begin"]&&F.emit("request-begin",e,t);var u=F._length_cors&&e.headers.origin;switch(s){case"G":return F.stats.request.get++,void(u?F.$cors(e,t,cors_callback0):e.$total_end());case"O":return F.stats.request.options++,void(u?F.$cors(e,t,cors_callback0):e.$total_end());case"H":return F.stats.request.head++,void(u?F.$cors(e,t,cors_callback0):e.$total_end());case"D":return F.stats.request["delete"]++,void(u?F.$cors(e,t,cors_callback1):e.$total_urlencoded());case"P":if(F._request_check_POST)return void(o?u?F.$cors(e,t,cors_callback_multipart,o):4===e.$type?F.$requestcontinue_mmr(e,t,o):e.$total_multipart(o):("PUT"===i?F.stats.request.put++:"PATCH"===i?F.stats.request.path++:F.stats.request.post++,u?F.$cors(e,t,cors_callback1):e.$total_urlencoded()))}e.$total_status(404)}},F.$requestcontinue_mmr=function(e,t,r){var o=F.routes.mmr[e.url];F.stats.request.mmr++,o?(F.path.verify("temp"),framework_internal.parseMULTIPART_MIXED(e,r,F.config["directory-temp"],o.exec)):e.$total_status(404)},F.$cors=function(e,t,r,o){for(var n,i=!1,s=0;s<F._length_cors;s++)if(n=F.routes.cors[s],framework_internal.routeCompare(e.path,n.url,!1,n.isWILDCARD)){i=!0;break}if(!i)return r(e,t,o);var a=!1,l=e.headers;if(i||(a=!0),i=!1,!a&&n.headers){i=!1;for(var s=0,c=n.headers.length;c>s;s++)if(l[n.headers[s]]){i=!0;break}i||(a=!0)}if(!a&&n.methods){i=!1;var u=l["access-control-request-method"]||e.method;if("OPTIONS"!==u){for(var s=0,c=n.methods.length;c>s;s++)if(-1!==u.indexOf(n.methods[s])){i=!0;break}i||(a=!0)}}var p=l.origin.toLowerCase();if(!a&&n.origins){i=!1;for(var s=0,c=n.origins.length;c>s;s++)if(-1!==n.origins[s].indexOf(p)){i=!0;break}i||(a=!0)}var f,d="OPTIONS"===e.method;return t.setHeader("Access-Control-Allow-Origin",n.origins?n.origins:n.credentials?i?p:n.origins?n.origins:p:l.origin),n.credentials&&t.setHeader("Access-Control-Allow-Credentials","true"),f="Access-Control-Allow-Methods",n.methods?t.setHeader(f,n.methods.join(", ")):t.setHeader(f,d?l["access-control-request-method"]||"*":e.method),f="Access-Control-Allow-Headers",n.headers?t.setHeader(f,n.headers.join(", ")):t.setHeader(f,l["access-control-request-headers"]||"*"),n.age&&t.setHeader("Access-Control-Max-Age",n.age),a?(r=null,F.$events["request-end"]&&F.emit("request-end",e,t),F.reqstats(!1,!1),F.stats.request.blocked++,t.writeHead(404),void t.end()):d?(r=null,F.$events["request-end"]&&F.emit("request-end",e,t),F.reqstats(!1,!1),t.writeHead(200),t.end(),F):r(e,t,o)},F._upgrade=function(e,t,r){if("websocket"===(e.headers.upgrade||"").toLowerCase()){t.setTimeout(0),t.on("error",NOOP);var o=e.headers;e.$protocol=e.connection.encrypted||"https"===o["x-forwarded-protocol"]?"https":"http",e.uri=framework_internal.parseURI(e),F.$events.websocket&&F.emit("websocket",e,t,r),F.stats.request.websocket++,e.session=null,e.user=null,e.flags=[e.secured?"https":"http","get"],e.$wspath=U.path(e.uri.pathname);var n=new WebSocketClient(e,t,r);e.path=framework_internal.routeSplit(e.uri.pathname),e.websocket=n,F.onLocale&&(e.$language=F.onLocale(e,t)),F._length_request_middleware?async_middleware(0,e,e.websocket,F.routes.request,websocketcontinue_middleware):F.$websocketcontinue(e,e.$wspath,o)}},F.$websocketcontinue=function(e,t){var r=F.onAuthorize;if(r)r.call(F,e,e.websocket,e.flags,function(r,o){o&&(e.user=o);var n=F.lookup_websocket(e,e.websocket.uri.pathname,r?1:2);n?F.$websocketcontinue_process(n,e,t):(e.websocket.close(),e.connection.destroy())});else{var o=F.lookup_websocket(e,e.websocket.uri.pathname,0);o?F.$websocketcontinue_process(o,e,t):(e.websocket.close(),e.connection.destroy())}},F.$websocketcontinue_process=function(e,t,r){var o=t.websocket;if(!o.prepare(e.flags,e.protocols,e.allow,e.length,F.version_header))return o.close(),void t.connection.destroy();var n=r+(e.flags.length?"#"+e.flags.join("-"):"");e.isBINARY?o.type=1:e.isJSON&&(o.type=3);var i=function(){if(F.connections[n])return void o.upgrade(F.connections[n]);var i=new WebSocket(r,e.controller,n);i.route=e,i.options=e.options,F.connections[n]=i,e.onInitialize.apply(i,framework_internal.routeParam(e.param.length?t.split:t.path,e)),setImmediate(next_upgrade_continue,o,i)};e.middleware?async_middleware(0,t,t.websocket,e.middleware,i,e.options):i()},F.reqstats=function(e){return e?F.stats.request.pending++:F.stats.request.pending--,F.stats.request.pending<0&&(F.stats.request.pending=0),F},global.MODEL=F.model=function(e){var t=F.models[e];if(t||null===t)return t;var r=U.combine(F.config["directory-models"],e+".js");return existsSync(r)&&F.install("model",e,r,void 0,void 0,void 0,!0),F.models[e]||null},global.INCLUDE=global.SOURCE=F.source=function(e,t,r){var o=F.sources[e];if(o||null===o)return o;var n=U.combine(F.config["directory-source"],e+".js");return existsSync(n)&&F.install("source",e,n,t,r,void 0,!0),F.sources[e]||null},F.include=function(e,t,r){return F.source(e,t,r)},F.mail=function(e,t,r,o,n,i){if("string"==typeof n){var s=i;i=n,n=s}var a=EMPTYCONTROLLER;a.layoutName="",a.themeName=U.parseTheme(r),a.themeName?r=prepare_viewname(r):this.onTheme?a.themeName=this.onTheme(a):a.themeName="";var l;return"string"==typeof i&&(t=-1===t.indexOf("@(")?F.translate(i,t):F.translator(i,t),a.language=i),a.mail(e,t,r,o,n,l)},F.view=function(e,t,r,o,n){var i=EMPTYCONTROLLER;if("object"==typeof r){var s=o;o=r,r=s}i.layoutName=r||"",i.language=n||"",i.repository="object"==typeof o&&o?o:EMPTYOBJECT;var a=U.parseTheme(e);return a?(i.themeName=a,e=prepare_viewname(e)):this.onTheme?i.themeName=this.onTheme(i):i.themeName=void 0,i.view(e,t,!0)},F.viewCompile=function(e,t,r,o,n){var i=EMPTYCONTROLLER;if("object"==typeof r){var s=o;o=r,r=s}return i.layoutName=r||"",i.language=n||"",i.themeName=void 0,i.repository="object"==typeof o&&o?o:EMPTYOBJECT,i.viewCompile(e,t,!0)},F.test=function(){return F.isTest=!0,F.$configure_configs("config-test",!0),require("./test").load(),F},F.clear=function(e,t){var r=F.path.temp(),o=F.id?"i-"+F.id+"_":"";return t&&F.config["disable-clear-temporary-directory"]?(U.ls(r,function(t){F.unlink(t,function(){e&&e()})},function(e,t){if(t||o&&!e.substring(r.length).startsWith(o))return!1;if(-1!==e.indexOf(".package"))return!0;var n=U.getExtension(e);return"js"===n||"css"===n||"tmp"===n||"upload"===n||"html"===n||"htm"===n}),F):existsSync(r)?(U.ls(r,function(n,i){if(t){for(var s=[],a=0,l=n.length;l>a;a++){var c=n[a].substring(r.length);(!o||c.startsWith(o))&&(-1===c.indexOf("/")||-1!==c.indexOf(".package/"))&&!c.endsWith(".jsoncache")&&s.push(n[a])}n=s,i=i.remove(function(e){return-1===e.indexOf(".package")})}F.unlink(n,function(){return F.rmdir(i,e)})}),t||(F.temporary.path={},F.temporary.range={},F.temporary.notfound={}),F):(e&&e(),F)},F.unlink=F.path.unlink=function(e,t){if("string"==typeof e&&(e=[e]),!e.length)return t&&t(),F;var r=e.shift();return r?Fs.unlink(r,function(){return F.unlink(e,t)}):t&&t(),F},F.rmdir=F.path.rmdir=function(e,t){if("string"==typeof e&&(e=[e]),!e.length)return t&&t(),F;var r=e.shift();return r?U.ls(r,function(o,n){n.reverse(),n.push(r),o.wait(function(e,t){return Fs.unlink(e,t)},function(){n.wait(function(e,t){Fs.rmdir(e,t)},function(){return F.rmdir(e,t)})})}):t&&t(),F},F.encrypt=function(e,t,r){if(void 0===e)return"";var o=typeof e;if("boolean"==typeof t){var n=r;r=t,t=n}return"function"===o?e=e():"number"===o?e=e.toString():"object"===o&&(e=JSON.stringify(e)),e.encrypt(F.config.secret+"="+t,r)},F.decrypt=function(e,t,r){if("boolean"==typeof t){var o=r;r=t,t=o}"boolean"!=typeof r&&(r=!0);var n=(e||"").decrypt(F.config.secret+"="+t);if(!n)return null;if(r){if(n.isJSON())try{return n.parseJSON(!0)}catch(i){}return null}return n},F.hash=function(e,t,r){var o=Crypto.createHash(e),n="";return"string"==typeof r?n=r:r!==!1&&(n=F.config.secret||""),o.update(t.toString()+n,ENCODING),o.digest("hex")},F.resource=function(e,t){t||(t=e,e=null),e||(e="default");var r=F.resources[e];if(r)return null==r[t]?"":r[t];var o,n=F.routes.resources[e],i="";if(n)for(var s=0,a=n.length;a>s;s++)o=n[s],existsSync(o)&&(i+=(i?"\n":"")+Fs.readFileSync(o).toString(ENCODING));var o=U.combine(F.config["directory-resources"],e+".resource"),l=!1;existsSync(o)?i+=(i?"\n":"")+Fs.readFileSync(o).toString(ENCODING):l=!0;var c=i.parseConfig();return F.resources[e]=c,c.$empty=l,null==c[t]?"":c[t]},F.translate=function(e,t){if(t||(t=e,e=void 0),"#"===t[0]&&" "!==t[1])return F.resource(e,t.substring(1));var r=F.resource(e,"T"+t.hash());return r?r:t},F.translator=function(e,t){return framework_internal.parseLocalization(t,e)},F.$configure_sitemap=function(e,t){if(!e||"string"==typeof e){var r=prepare_filename(e||"sitemap");e=existsSync(r,!0)?Fs.readFileSync(r).toString(ENCODING).split("\n"):null}if(!e||!e.length)return F;(t||!F.routes.sitemap)&&(F.routes.sitemap={});for(var o=0,n=e.length;n>o;o++){var i=e[o];if(i&&"#"!==i[0]&&"//"!==i.substring(0,3)){var s=i.indexOf(" :");if(-1!==s||(s=i.indexOf("	:"),-1!==s)){var a=i.substring(0,s).trim(),l=i.substring(s+2).trim(),c=l.split("-->"),u=c[1].trim(),p=!1;u.endsWith("*")?(p=!0,u=u.substring(0,u.length-1)):u.endsWith("* )")&&(p=!0,u=u.substring(0,u.length-2));var f=c[0].trim(),d=f.startsWith("@("),m=u.startsWith("@(");d&&(f=f.substring(2,f.length-1).trim()),m&&(u=u.substring(2,u.length-1).trim()),F.routes.sitemap[a]={name:f,url:u,parent:c[2]?c[2].trim():null,wildcard:p,formatName:-1!==f.indexOf("{"),formatUrl:-1!==u.indexOf("{"),localizeName:d,localizeUrl:m}}}}return F},F.sitemap=function(e,t,r){if(!F.routes.sitemap)return EMPTYARRAY;"string"==typeof t&&(r=t,t=!1);var o=REPOSITORY_SITEMAP+e+"$"+(t?"1":"0")+"$"+(r||"");if(F.temporary.other[o])return F.temporary.other[o];var n,i,s,a=e;if(t===!0){n=F.routes.sitemap[e];var l={sitemap:a,id:"",name:"",url:"",last:!0,selected:!0,index:0,wildcard:!1,formatName:!1,formatUrl:!1};if(!n)return l;s=n.name,n.localizeName&&(s=F.translate(r,s)),i=n.url;var c=n.wildcard;return n.localizeUrl&&(n.wildcard&&("/"!==i[i.length-1]&&(i+="/"),i+="*"),i=F.translate(r,i),i.endsWith("*")?(i=i.substring(0,i.length-1),c=!0):c=!1),l.sitemap=a,l.id=e,l.formatName=n.formatName,l.formatUrl=n.formatUrl,l.localizeUrl=n.localizeUrl,l.localizeName=n.localizeName,l.name=s,l.url=i,l.wildcard=c,F.temporary.other[o]=l,l}for(var u=[],p=0;;){if(n=F.routes.sitemap[e],!n)break;s=n.name,i=n.url;var c=n.wildcard;if(n.localizeName&&(s=F.translate(r,n.name)),n.localizeUrl&&(n.wildcard&&("/"!==i[i.length-1]&&(i+="/"),i+="*"),i=F.translate(r,i),i.endsWith("*")?(i=i.substring(0,i.length-1),c=!0):c=!1),u.push({sitemap:a,id:e,name:s,url:i,last:0===p,first:n.parent?!1:!0,selected:0===p,index:p,wildcard:c,formatName:n.formatName,formatUrl:n.formatUrl,localizeName:n.localizeName,localizeUrl:n.localizeUrl}),p++,e=n.parent,!e)break}return u.reverse(),F.temporary.other[o]=u,u},F.sitemap_navigation=function(e,t){var r="$sitemap_n_"+(e||"")+"$"+(t||"");if(F.temporary.other[r])return F.temporary.other[r];for(var o=Object.keys(F.routes.sitemap),n=[],i=0,s=0,a=o.length;a>s;s++){var l=F.routes.sitemap[o[s]];if(!(e&&l.parent!==e||!e&&l.parent)){var c=l.name,u=l.url;l.localizeName&&(c=F.translate(t,c)),l.localizeUrl&&(u=F.translate(t,u)),n.push({id:e||"",name:c,url:u,last:0===i,first:l.parent?!1:!0,selected:0===i,index:i,wildcard:l.wildcard,formatName:l.formatName,formatUrl:l.formatUrl}),i++}}return n.quicksort("name"),F.temporary.other[r]=n,n},F.sitemap_add=function(e){return F.$configure_sitemap(e instanceof Array?e:[e]),F},F.$configure_dependencies=function(e,t){if(!e||"string"==typeof e){var r=prepare_filename(e||"dependencies");e=existsSync(r,!0)?Fs.readFileSync(r).toString(ENCODING).split("\n"):null}if(!e)return F;for(var o,n,i,s=[],a=0,l=e.length;l>a;a++){var c=e[a];if(c&&"#"!==c[0]&&"//"!==c.substring(0,3)){var u=c.indexOf(" :");if(-1!==u||(u=c.indexOf("	:"),-1!==u)){var p=c.substring(0,u).trim(),f=c.substring(u+2).trim(),d=0;if(n=void 0,i=void 0,u=p.indexOf("("),-1!==u&&(i=p.substring(u,p.indexOf(")",u)).replace(/\(|\)/g,"").trim(),p=p.substring(0,u).trim()),u=f.indexOf("-->"),-1!==u){var m=f.substring(u+3).trim();m.isJSON()&&(n=m.parseJSON(!0)),f=f.substring(0,u).trim()}switch(p){case"package":case"packages":case"pkg":o="package",d=9;break;case"module":case"modules":o="module",Priority=10;break;case"model":case"models":o="model",d=8;break;case"source":case"sources":o="source",d=3;break;case"controller":case"controllers":o="controller",d=4;break;case"view":case"views":d=3,o="view";break;case"version":case"versions":d=3,o="version";break;case"config":case"configuration":d=11,o="config";break;case"isomorphic":case"isomorphics":d=6,o="isomorphic";break;case"definition":case"definitions":d=5,o="definition";break;case"middleware":case"middlewares":o="middleware",d=4;break;case"component":case"components":d=7,o="component"}o&&!function(e,t,r,o){o?s.push({priority:d,fn:function(n){return F.uptodate(e,t,r,o,n)}}):s.push({priority:d,fn:function(o){return F.install(e,t,r,void 0,void 0,void 0,void 0,void 0,void 0,o)}})}(o,f,n,i)}}}return s.quicksort("priority",!1),s.wait(function(e,t){e.fn(t)},t),F},F.$configure_workflows=function(e,t){if(void 0===e||"string"==typeof e){var r=prepare_filename(e||"workflows");e=existsSync(r,!0)?Fs.readFileSync(r).toString(ENCODING).split("\n"):null}return t&&(F.workflows={}),e&&e.length?(e.forEach(function(e){if(e=e.trim(),!e.startsWith("//")){var t=e.indexOf(":");if(-1!==t){var r=e.substring(0,t).trim(),o=-1,n=[],i=r.indexOf("(");if(-1!==i){var s=r.substring(i+1,r.indexOf(")",i+1)).trim();r=r.substring(0,i).trim(),s=s.replace(/^default\//gi,""),r=s+"#"+r}e.substring(t+1).split("-->").forEach(function(e,t){var r="options||EMPTYOBJECT";e=e.trim().replace(/"/g,"'");var i=e.indexOf("{");-1!==i&&(r=e.substring(i,e.lastIndexOf("}")+1),e=e.replace(r,"").trim(),r="options||"+r),e.endsWith("(response)")&&(o=t,e=e.replace("(response)","").trim());var s=e.split(":");2===s.length?n.push("$"+s[0].trim()+"("+s[1].trim()+", {0})".format(r)):n.push("$"+s[0]+"({0})".format(r))}),F.workflows[r]=new Function("model","options","callback","return model.$async(callback"+(-1===o?"":", "+o)+")."+n.join(".")+";")}}}),F):F},F.$configure_versions=function(e,t){if(void 0===e||"string"==typeof e){var r=prepare_filename(e||"versions");e=existsSync(r,!0)?Fs.readFileSync(r).toString(ENCODING).split("\n"):null}if(!e)return t&&(F.versions=null),F;t||(F.versions={}),F.versions||(F.versions={});for(var o=0,n=e.length;n>o;o++){var i=e[o];if(i&&"#"!==i[0]&&"//"!==i.substring(0,3)){"/"!==i[0]&&(i="/"+i);var s=i.indexOf(" :"),a=!1;if(-1===s&&(s=i.indexOf("	:"),-1===s)){if(s=i.indexOf("-->"),-1===s)continue;a=!0}var l=a?3:2,c=i.substring(0,s).trim(),r=i.substring(s+l).trim();F.versions[c]=r,a&&F.map(r,F.path["public"](c))}}return F},F.$configure_configs=function(e,t){var r=typeof e;if("string"===r){var o=prepare_filename(e);if(!existsSync(o,!0))return F;e=Fs.readFileSync(o).toString(ENCODING).split("\n")}if(!e){var n=U.combine("/","config"),i=U.combine("/","config-"+(F.config.debug?"debug":"release"));e=[];var s=F.path.configs();if(existsSync(s))for(var a=Fs.readdirSync(s),l=0,c=a.length;c>l;l++){var u=a[l].match(/-( debug|release|test )$/i);if(u){if(u=u[0].toString().toLowerCase(),"-debug"===u&&!F.isDebug)continue;if("-release"===u&&F.isDebug)continue;if("-test"===u&&!F.isTest)continue}e=e.concat(Fs.readFileSync(s+a[l]).toString(ENCODING).split("\n"))}existsSync(n)&&Fs.lstatSync(n).isFile()&&(e=e.concat(Fs.readFileSync(n).toString(ENCODING).split("\n"))),existsSync(i)&&Fs.lstatSync(i).isFile()&&(e=e.concat(Fs.readFileSync(i).toString(ENCODING).split("\n")))}var p=function(){process.title="total : "+F.config.name.removeDiacritics().toLowerCase().replace(REG_EMPTY,"-").substring(0,8),F.isVirtualDirectory=existsSync(U.combine(F.config["directory-public-virtual"]))};if(!(e instanceof Array&&e.length))return p(),F;void 0===t&&(t=!0);for(var a,f,d,m={},h=null,c=e.length,l=0;c>l;l++){var g=e[l];if(g&&"#"!==g[0]&&"/"!==g[0]&&"/"!==g[1]){var y=g.indexOf(":");if(-1!==y){var b=g.substring(0,y).trim();if("debug"!==b&&"resources"!==b)switch(d=g.substring(y+1).trim(),y=b.indexOf("( "),-1!==y?(f=b.substring(y+1,b.indexOf(" )")).trim().toLowerCase(),b=b.substring(0,y).trim()):f="",b){case"default-cors-maxage":case"default-request-length":case"default-websocket-request-length":case"default-request-timeout":case"default-interval-clear-cache":case"default-interval-clear-resources":case"default-interval-precompile-views":case"default-interval-uptodate":case"default-interval-websocket-ping":case"default-maximum-file-descriptors":case"default-interval-clear-dnscache":case"default-dependency-timeout":m[b]=U.parseInt(d);break;case"default-image-consumption":case"default-image-quality":m[b]=U.parseInt(d.replace(/%|\s/g,""));break;case"static-accepts-custom":h=d.replace(REG_ACCEPTCLEANER,"").split(",");break;case"default-root":d&&(m[b]=U.path(d));break;case"static-accepts":a=d.replace(REG_ACCEPTCLEANER,"").split(",");for(var E=0;E<a.length;E++)m[b][a[E]]=!0;break;case"mail.smtp":case"mail.smtp.options":case"mail.address.from":case"mail.address.copy":case"mail.address.bcc":case"mail.address.reply":a="mail.address.bcc"===b?"mail-address-copy":b.replace(/\./g,"-"),OBSOLETE(b,'is renamed to "'+a+'"'),m[a]=d;break;case"allow-handle-static-files":OBSOLETE('config["allow-handle-static-files"]','The key has been renamed to "allow-static-files"'),m["allow-static-files"]=!0;break;case"allow-compile-html":case"allow-compile-script":case"allow-compile-style":case"allow-debug":case"allow-gzip":case"allow-performance":case"allow-static-files":case"allow-websocket":case"disable-strict-server-certificate-validation":case"disable-clear-temporary-directory":case"trace":case"allow-cache-snapshot":m[b]="true"===d.toLowerCase()||"1"===d||"on"===d;break;case"allow-compress-html":m["allow-compile-html"]="true"===d.toLowerCase()||"1"===d||"on"===d;break;case"version":m[b]=d;break;default:if("string"===f)m[b]=d;else if("number"===f||"currency"===f||"float"===f||"double"===f)Obj[b]=d.isNumber(!0)?d.parseFloat():d.parseInt();else if("boolean"===f||"bool"===f)m[b]=d.parseBoolean();else if("eval"===f||"object"===f||"array"===f)try{Obj[b]=new Function("return "+d)()}catch(v){F.error(v,"F.configure("+b+")")}else"json"===f?m[b]=d.parseJSON():"date"===f||"datetime"===f||"time"===f?m[b]=d.parseDate():"env"===f||"environment"===f?m[b]=process.env[d]:m[b]=d.isNumber()?U.parseInt(d):d.isNumber(!0)?U.parseFloat(d):d.isBoolean()?"true"===d.toLowerCase():d}}}}U.extend(F.config,m,t);var a=F.config["mail-smtp-options"];"string"==typeof a&&a&&(a=new Function("return "+a)(),F.config["mail-smtp-options"]=a),F.config["directory-temp"]||(F.config["directory-temp"]="~"+U.path(Path.join(Os.tmpdir(),"totaljs"+F.directory.hash()))),F.config["etag-version"]||(F.config["etag-version"]=F.config.version.replace(/\.|\s/g,"")),F.config["default-timezone"]&&(process.env.TZ=F.config["default-timezone"]),h&&h.length&&h.forEach(function(e){return F.config["static-accepts"][e]=!0}),F.config["disable-strict-server-certificate-validation"]===!0&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),F.config["allow-performance"]&&(http.globalAgent.maxSockets=9999);var _=F.config["default-xpoweredby"];return Object.keys(HEADERS).forEach(function(e){Object.keys(HEADERS[e]).forEach(function(t){RELEASE&&"Cache-Control"===t&&(HEADERS[e][t]=HEADERS[e][t].replace(/max-age=\d+/,"max-age="+F.config["default-response-maxage"])),"X-Powered-By"===t&&(_?HEADERS[e][t]=_:delete HEADERS[e][t])})}),IMAGEMAGICK="im"===F.config["default-image-converter"],p(),F.emit("configure",F.config),F},F.routeScript=function(e,t){return F.$routeStatic(e,F.config["static-url-script"],t)},F.routeStyle=function(e,t){return F.$routeStatic(e,F.config["static-url-style"],t)},F.routeImage=function(e,t){return F.$routeStatic(e,F.config["static-url-image"],t)},F.routeVideo=function(e,t){return F.$routeStatic(e,F.config["static-url-video"],t)},F.routeFont=function(e,t){return F.$routeStatic(e,F.config["static-url-font"],t)},F.routeDownload=function(e,t){return F.$routeStatic(e,F.config["static-url-download"],t)},F.routeStatic=function(e,t){return F.$routeStatic(e,F.config["static-url"],t)},F.$routeStatic=function(e,t,r){var o=e+t+"$"+r,n=F.temporary.other[o];if(RELEASE&&n)return n;if("~"===e[0])e=e.substring("~"===e[1]?2:1),r="";else if("="===e[0]){var i=e.indexOf("/");-1!==i&&(r=e.substring(1,i),"?"===r?(r=F.config["default-theme"],e=e.substring(i)):e=e.substring(i+1))}var s;return REG_ROUTESTATIC.test(e)?s=e:"/"===e[0]?s=U.join(r,F.$version(e)):(s=U.join(r,t,F.$version(e)),REG_HTTPHTTPS.test(s)&&"/"===s[0]&&(s=s.substring(1))),F.temporary.other[o]=framework_internal.preparePath(F.$version(s))},F.$version=function(e){return F.versions&&(e=F.versions[e]||e),F.onVersion&&(e=F.onVersion(e)||e),e},F.$versionprepare=function(e){var t=e.match(REG_VERSIONS);if(!t)return e;for(var r=0,o=t.length;o>r;r++){var n=t[r].toString(),i=5;"h"===n[0]&&(i=6);var s=n.substring(i,n.length-1);e=e.replace(t[r],n.substring(0,i)+F.$version(s)+'"')}return e},F.lookup=function(e,t,r,o){var n="#"===t[0],i=F._length_subdomain_web&&e.subdomain?e.subdomain.join("."):null;if(n)return F.routes.system[t];n&&(e.path=[t]);var s;if(e.$isAuthorized=!0,!n&&(s="1"+t+"$"+o+e.$flags+(i?"$"+i:""),F.temporary.other[s]))return F.temporary.other[s];for(var a=F.routes.web.length,l=0;a>l;l++){var c=F.routes.web[l];if(c.CUSTOM){if(!c.CUSTOM(t,e,r))continue}else{if(F._length_subdomain_web&&!framework_internal.routeCompareSubdomain(i,c.subdomain))continue;if(c.isWILDCARD){if(!framework_internal.routeCompare(e.path,c.url,n,!0))continue}else if(!framework_internal.routeCompare(e.path,c.url,n))continue}{if(!n){if(c.isPARAM&&c.regexp){for(var u=!1,p=0,f=c.regexpIndexer.length;f>p;p++){var d=e.path[c.regexpIndexer[p]];if(void 0===d){u=!0;break}if(!c.regexp[c.regexpIndexer[p]].test(d)){u=!0;break}}if(u)continue}if(c.flags&&c.flags.length){var m=framework_internal.routeCompareFlags2(e,c,o);if(-1===m&&(e.$isAuthorized=!1),1>m)continue}return s&&c.isCACHE&&e.$isAuthorized&&(F.temporary.other[s]=c),c}if(c.isSYSTEM)return c}}return null},F.lookup_websocket=function(e,t,r){var o=F._length_subdomain_websocket&&e.subdomain?e.subdomain.join("."):null,n=F.routes.websockets.length;e.$isAuthorized=!0;for(var i=0;n>i;i++){var s=F.routes.websockets[i];if(s.CUSTOM){if(!s.CUSTOM(t,e))continue}else{if(F._length_subdomain_websocket&&!framework_internal.routeCompareSubdomain(o,s.subdomain))continue;if(s.isWILDCARD){if(!framework_internal.routeCompare(e.path,s.url,!1,!0))continue}else if(!framework_internal.routeCompare(e.path,s.url,!1))continue}if(s.isPARAM&&s.regexp){for(var a=!1,l=0,c=s.regexpIndexer.length;c>l;l++){var u=e.path[s.regexpIndexer[l]];if(void 0===u){a=!0;break}if(!s.regexp[s.regexpIndexer[l]].test(u)){a=!0;break}}if(a)continue}if(s.flags&&s.flags.length){var p=framework_internal.routeCompareFlags2(e,s,r);if(-1===p&&(e.$isAuthorized=!1),1>p)continue}return s}return null},F.accept=function(e,t){return"."===e[0]&&(e=e.substring(1)),F.config["static-accepts"][e]=!0,t&&U.setContentType(e,t),F},F.worker=function(e,t,r,o){var n=null,i=typeof t;if("number"===i&&void 0===r&&(r=t,t=null,i="undefined"),"string"===i&&(n=F.workers[t]),t instanceof Array&&(o=t,t=null,r=void 0),r instanceof Array&&(o=r,r=void 0),n)return n;var s="@"===e[0]?F.path["package"](e.substring(1)):U.combine(F.config["directory-workers"],e);return o||(o=[]),n=Child.fork("."===s[s.length-3]?s:s+".js",o,HEADERS.workers),t||(t=e+"_"+(new Date).getTime()),n.__id=t,F.workers[t]=n,n.on("exit",function(){var e=this;e.__timeout&&clearTimeout(e.__timeout),delete F.workers[e.__id],n&&(n.removeAllListeners(),n=null)}),"number"!=typeof r?n:(n.__timeout=setTimeout(function(){n&&n.kill("SIGKILL")},r),n)},F.worker2=function(e,t,r,o){if("function"==typeof t)o=r,r=t,t=void 0;else if("number"==typeof r){var n=o;o=r,r=n}!t||t instanceof Array||(t=[t]);var i=F.worker(e,e,o,t);return i.__worker2?i:(i.__worker2=!0,i.on("error",function(e){r&&r(e),r=null}),i.on("exit",function(){r&&r(),r=null}),i)},F.wait=function(e,t){return F.waits||(F.waits={}),void 0!==t?(t?F.waits[e]=!0:delete F.waits[e],F._length_wait=Object.keys(F.waits).length,t):(F.waits[e]?delete F.waits[e]:(F.waits[e]=!0,t=!0),F._length_wait=Object.keys(F.waits).length,t===!0)},FrameworkRoute.prototype={},FrameworkRoute.prototype.__defineGetter__("flags",function(){return this.route.flags||EMPTYARRAY}),FrameworkRoute.prototype.__defineGetter__("url",function(){return this.route.urlraw}),FrameworkRoute.prototype.__defineGetter__("description",function(){return this.route.description}),FrameworkRoute.prototype.__defineSetter__("description",function(e){this.route.description=e}),FrameworkRoute.prototype.__defineGetter__("maxlength",function(){return this.route.length}),FrameworkRoute.prototype.__defineSetter__("maxlength",function(e){this.route.length=e}),FrameworkRoute.prototype.__defineGetter__("id",function(){return this.route.id}),FrameworkRoute.prototype.__defineSetter__("id",function(e){this.route.id=e}),FrameworkRoute.prototype.__defineGetter__("options",function(){return this.route.options}),FrameworkRoute.prototype.__defineSetter__("options",function(e){this.route.options=e}),FrameworkRoute.prototype.make=function(e){return e&&e.call(this,this),this},FrameworkRoute.prototype.setId=function(e){return this.route.id=e,this},FrameworkRoute.prototype.setDecription=function(e){return this.route.description=e,this},FrameworkRoute.prototype.setTimeout=function(e){return this.route.timeout=e,this},FrameworkRoute.prototype.setMaxLength=function(e){return this.route.length=e,this},FrameworkRoute.prototype.setOptions=function(e){return this.route.options=e,this},FrameworkPath.prototype.verify=function(e){var t="$directory-"+e;if(F.temporary.path[t])return F;var r=F.config["directory-"+e]||e,o=U.combine(r);return!existsSync(o)&&Fs.mkdirSync(o),F.temporary.path[t]=!0,F},FrameworkPath.prototype.mkdir=function(e){"/"===e[0]&&(e=e.substring(1));var t=F.isWindows,r=e.length-1;t?"\\"===e[r]&&(e=e.substring(0,r)):"/"===e[r]&&(e=e.substring(0,r));for(var o=t?e.replace(/\//g,"\\").split("\\"):e.split("/"),n=t?"":"/",i=0,s=o.length;s>i;i++){var a=o[i];n+=t?(n?"\\":"")+a:(n?"/":"")+a,!existsSync(n)&&Fs.mkdirSync(n)}},FrameworkPath.prototype.exists=function(e,t){return Fs.lstat(e,function(e,r){return t(e?!1:!0,r?r.size:0,r?r.isFile():!1)}),F},FrameworkPath.prototype["public"]=function(e){return U.combine(F.config["directory-public"],e)},FrameworkPath.prototype.public_cache=function(e){var t="public_"+e,r=F.temporary.other[t];return r?r:F.temporary.other[t]=U.combine(F.config["directory-public"],e)},FrameworkPath.prototype["private"]=function(e){return U.combine(F.config["directory-private"],e)},FrameworkPath.prototype.isomorphic=function(e){return U.combine(F.config["directory-isomorphic"],e)},FrameworkPath.prototype.configs=function(e){return U.combine(F.config["directory-configs"],e)},FrameworkPath.prototype.virtual=function(e){return U.combine(F.config["directory-public-virtual"],e)},FrameworkPath.prototype.logs=function(e){return this.verify("logs"),U.combine(F.config["directory-logs"],e)},FrameworkPath.prototype.models=function(e){return U.combine(F.config["directory-models"],e)},FrameworkPath.prototype.temp=function(e){return this.verify("temp"),U.combine(F.config["directory-temp"],e)},FrameworkPath.prototype.temporary=function(e){return this.temp(e)},FrameworkPath.prototype.views=function(e){return U.combine(F.config["directory-views"],e)},FrameworkPath.prototype.workers=function(e){return U.combine(F.config["directory-workers"],e)},FrameworkPath.prototype.databases=function(e){return this.verify("databases"),U.combine(F.config["directory-databases"],e)},FrameworkPath.prototype.modules=function(e){return U.combine(F.config["directory-modules"],e)},FrameworkPath.prototype.controllers=function(e){return U.combine(F.config["directory-controllers"],e)},FrameworkPath.prototype.definitions=function(e){return U.combine(F.config["directory-definitions"],e)},FrameworkPath.prototype.tests=function(e){return U.combine(F.config["directory-tests"],e)},FrameworkPath.prototype.resources=function(e){return U.combine(F.config["directory-resources"],e)},FrameworkPath.prototype.services=function(e){return U.combine(F.config["directory-services"],e)},FrameworkPath.prototype.packages=function(e){return U.combine(F.config["directory-packages"],e)},FrameworkPath.prototype.themes=function(e){return U.combine(F.config["directory-themes"],e)},FrameworkPath.prototype.components=function(e){return U.combine(F.config["directory-components"],e)},FrameworkPath.prototype.root=function(e){var t=Path.join(directory,e||"");return F.isWindows?t.replace(/\\/g,"/"):t},FrameworkPath.prototype["package"]=function(e,t){if(void 0===t){var r=e.indexOf("/");-1!==r&&(t=e.substring(r+1),e=e.substring(0,r))}var o=F.config["directory-temp"],n="~"===o[0]?Path.join(o.substring(1),e+".package",t||""):Path.join(directory,o,e+".package",t||"");return F.isWindows?n.replace(REG_WINDOWSPATH,"/"):n},FrameworkCache.prototype.init=function(){var e=this;return clearInterval(e.interval),e.interval=setInterval(function(){F.cache.recycle()},6e4),F.config["allow-cache-snapshot"]?e.load(function(){e.loadPersist()}):e.loadPersist(),e},FrameworkCache.prototype.save=function(){return Fs.writeFile(F.path.temp((F.id?"i-"+F.id+"_":"")+"framework_cachesnapshot.jsoncache"),JSON.stringify(this.items),NOOP),this},FrameworkCache.prototype.load=function(e){var t=this;return Fs.readFile(F.path.temp((F.id?"i-"+F.id+"_":"")+"framework_cachesnapshot.jsoncache"),function(r,o){if(!r)try{o=JSON.parse(o.toString("utf8"),function(e,t){"string"==typeof t&&t.isJSONDate()?new Date(t):t}),t.items=o}catch(n){}e&&e()}),t},FrameworkCache.prototype.savePersist=function(){return setTimeout2("framework_cachepersist",function(e){for(var t=Object.keys(e.items),r={},o=0,n=t.length;n>o;o++){var i=t[o],s=e.items[i];s.persist&&(r[i]=s)}Fs.writeFile(F.path.temp((F.id?"i-"+F.id+"_":"")+"framework_cachepersist.jsoncache"),JSON.stringify(r),NOOP)},1e3,50,this),this},FrameworkCache.prototype.loadPersist=function(e){var t=this;return Fs.readFile(F.path.temp((F.id?"i-"+F.id+"_":"")+"framework_cachepersist.jsoncache"),function(r,o){if(!r)try{o=JSON.parse(o.toString("utf8"),function(e,t){"string"==typeof t&&t.isJSONDate()?new Date(t):t});for(var n=Object.keys(o),i=0,s=n.length;s>i;i++){var a=n[i],l=o[a];l.expire>=F.datetime&&(t.items[a]=l)}}catch(c){}e&&e()}),t},FrameworkCache.prototype.stop=function(){return clearInterval(this.interval),this},FrameworkCache.prototype.clear=function(e){return this.items={},F.isCluster&&e!==!1&&process.send(CLUSTER_CACHE_CLEAR),this.savePersist(),this},FrameworkCache.prototype.recycle=function(){var e=this.items,t=!1;F.datetime=new Date,this.count++;for(var r in e){var o=e[r];o?o.expire<F.datetime&&(o.persist&&(t=!0),F.emit("cache-expire",r,o.value),delete e[r]):delete e[r]}return t&&this.savePersist(),F.config["allow-cache-snapshot"]&&this.save(),F.service(this.count),this},FrameworkCache.prototype.set2=function(e,t,r,o){return this.set(e,t,r,o,!0)},FrameworkCache.prototype.set=FrameworkCache.prototype.add=function(e,t,r,o,n){var i=typeof r;switch(F.isCluster&&o!==!1&&(CLUSTER_CACHE_SET.key=e,CLUSTER_CACHE_SET.value=t,CLUSTER_CACHE_SET.expire=r,process.send(CLUSTER_CACHE_SET)),i){case"string":r=r.parseDateExpiration();break;case"undefined":r=F.datetime.add("m",5)}var s={value:t,expire:r};return n&&(s.persist=!0,this.savePersist()),this.items[e]=s,F.$events["cache-set"]&&F.emit("cache-set",e,t,r,o!==!1),t},FrameworkCache.prototype.read=FrameworkCache.prototype.get=function(e,t){var r=this.items[e];return r?(F.datetime=new Date,r.expire<F.datetime?(this.items[e]=void 0,F.$events["cache-expire"]&&F.emit("cache-expire",e,r.value),t):r.value):t},FrameworkCache.prototype.read2=FrameworkCache.prototype.get2=function(e,t){var r=this.items[e];return r?r.expire<F.datetime?(this.items[e]=void 0,F.$events["cache-expire"]&&F.emit("cache-expire",e,r.value),t):r.value:t},FrameworkCache.prototype.setExpire=function(e,t){var r=this.items[e];return r&&(r.expire="string"==typeof t?t.parseDateExpiration():t),this},FrameworkCache.prototype.remove=function(e,t){var r=this.items[e];return r&&(this.items[e].persist&&this.savePersist(),this.items[e]=void 0),F.isCluster&&t!==!1&&(CLUSTER_CACHE_REMOVE.key=e,process.send(CLUSTER_CACHE_REMOVE)),r},FrameworkCache.prototype.removeAll=function(e,t){var r=0,o=U.isRegExp(e);for(var n in this.items){if(o){if(!e.test(n))continue}else if(-1===n.indexOf(e))continue;this.remove(n),r++}return F.isCluster&&t!==!1&&(CLUSTER_CACHE_REMOVEALL.key=e,process.send(CLUSTER_CACHE_REMOVEALL)),r},FrameworkCache.prototype.fn=function(e,t,r){var o=this,n=o.read2(e);return n?(r&&r(n,!0),o):(t(function(t,n){o.add(e,t,n),r&&r(t,!1)}),o)},Controller.prototype={get repository(){return this.$repository?this.$repository:this.$repository?this.$repository:this.$repository={}},set repository(e){this.$repository=e},get schema(){return"default"===this.req.$total_route.schema[0]?this.req.$total_route.schema[1]:this.req.$total_route.schema.join("/")},get workflow(){return this.req.$total_route.schema_workflow},get sseID(){return this.req.headers["last-event-id"]||null},get route(){return this.req.$total_route},get options(){return this.req.$total_route.options},get flags(){return this.req.$total_route.flags},get path(){return F.path},get query(){return this.req.query},get body(){return this.req.body},get files(){return this.req.files},get subdomain(){return this.req.subdomain},get ip(){return this.req.ip},get xhr(){return this.req.xhr},get url(){return U.path(this.req.uri.pathname)},get uri(){return this.req.uri},get cache(){return F.cache},get config(){return F.config},get controllers(){return F.controllers},get isProxy(){return this.req.isProxy===!0},get isDebug(){return F.config.debug},get isTest(){return"1"===this.req.headers["x-assertion-testing"]},get isSecure(){return this.req.isSecure},get secured(){return this.req.secured},get session(){return this.req.session},set session(e){this.req.session=e},get user(){return this.req.user},get referrer(){return this.req.headers.referer||""},set user(e){this.req.user=e},get mobile(){return this.req.mobile},get robot(){return this.req.robot},get viewname(){var e=this.req.path[this.req.path.length-1];return e&&"/"!==e?e:"index"},get sitemapid(){return this.$sitemapid||this.route.sitemap},get params(){if(this.$params)return this.$params;var e=this.req.$total_route,t=e.paramnames;if(t){for(var r={},o=0;o<t.length;o++)r[t[o]]=this.req.split[e.param[o]];return this.$params=r,r}return this.$params=EMPTYOBJECT,EMPTYOBJECT}},Controller.prototype.$get=Controller.prototype.$read=function(e,t){return this.getSchema().get(e,t,this),this},Controller.prototype.$query=function(e,t){return this.getSchema().query(e,t,this),this},Controller.prototype.$save=function(e,t){var r=this;if(framework_builders.isSchema(r.body))r.body.$$controller=r,r.body.$save(e,t);else{var o=r.getSchema()["default"]();o.$$controller=r,o.$save(e,t)}return r},Controller.prototype.$remove=function(e,t){var r=this;return r.getSchema().remove(e,t,r),this},Controller.prototype.$workflow=function(e,t,r){var o=this;return framework_builders.isSchema(o.body)?(o.body.$$controller=o,o.body.$workflow(e,t,r)):o.getSchema().workflow2(e,t,r,o),o},Controller.prototype.$workflow2=function(e,t,r){var o=this;return o.getSchema().workflow2(e,t,r,o),o},Controller.prototype.$hook=function(e,t,r){var o=this;return framework_builders.isSchema(o.body)?(o.body.$$controller=o,o.body.$hook(e,t,r)):o.getSchema().hook2(e,t,r,o),o},Controller.prototype.$hook2=function(e,t,r){var o=this;return o.getSchema().hook2(e,t,r,o),o},Controller.prototype.$transform=function(e,t,r){var o=this;return framework_builders.isSchema(o.body)?(o.body.$$controller=o,o.body.$transform(e,t,r)):o.getSchema().transform2(e,t,r,o),o},Controller.prototype.$transform2=function(e,t,r){var o=this;return o.getSchema().transform2(e,t,r,o),o},Controller.prototype.$operation=function(e,t,r){var o=this;return framework_builders.isSchema(o.body)?(o.body.$$controller=o,o.body.$operation(e,t,r)):o.getSchema().operation2(e,t,r,o),o},Controller.prototype.$operation2=function(e,t,r){var o=this;return o.getSchema().operation2(e,t,r,o),o},Controller.prototype.$exec=function(e,t,r){var o=this;if("function"==typeof t&&(r=t,t=EMPTYOBJECT),null==r&&(r=o.callback()),framework_builders.isSchema(o.body))return o.body.$$controller=o,o.body.$exec(e,t,r),o;var n=o.getSchema().create();return n.$$controller=o,n.$exec(e,t,r),o},Controller.prototype.$async=function(e,t){var r=this;if(framework_builders.isSchema(r.body))return r.body.$$controller=r,r.body.$async(e,t);var o=r.getSchema()["default"]();return o.$$controller=r,o.$async(e,t)},Controller.prototype.getSchema=function(){var e=this.req.$total_route;if(!e.schema||!e.schema[1])throw new Error("The controller's route does not define any schema.");var t=GETSCHEMA(e.schema[0],e.schema[1]);if(t)return t;throw new Error('Schema "{0}" does not exist.'.format(e.schema[1]))},Controller.prototype.component=function(e,t){var r=F.components.views[e];if(r){var o=framework_internal.viewEngine(e,r,this);if(o)return o.call(this,this,this.repository,this.$model,this.session,this.query,this.body,this.url,F.global,F.helpers,this.user,this.config,F.functions,0,this.outputPartial,this.req.cookie,this.req.files,this.req.mobile,t||EMPTYOBJECT)}return""},Controller.prototype.$components=function(e,t){if(e){for(var r=Object.keys(F.components.instances),o=[],n=0,i=r.length;i>n;n++){var s=F.components.instances[r[n]];if(s.group===e){var a=this.component(r[n],t);a&&o.push(a)}}return o.join("\n")}return""},Controller.prototype.cookie=function(e,t,r,o){var n=this;return void 0===t?n.req.cookie(e):(n.res.cookie(e,t,r,o),n)},Controller.prototype.clear=function(){var e=this;return e.req.clear(),e},Controller.prototype.translate=function(e,t){return t||(t=e,e=this.language),F.translate(e,t)},Controller.prototype.middleware=function(e,t,r){if("string"==typeof e&&(e=[e]),"function"==typeof t){var o=r;r=t,t=o}t||(t=EMPTYOBJECT);var n=this;return async_middleware(0,n.req,n.res,e,function(){return r&&r(),n}),n},Controller.prototype.pipe=function(e,t,r){return this.res.proxy(e,t,null,r),this},Controller.prototype.encrypt=function(){return F.encrypt.apply(framework,arguments)},Controller.prototype.decrypt=function(){return F.decrypt.apply(framework,arguments)},Controller.prototype.hash=function(){return F.hash.apply(framework,arguments)},Controller.prototype.header=function(e,t){return this.res.setHeader(e,t),this},Controller.prototype.host=function(e){return this.req.hostname(e)},Controller.prototype.hostname=function(e){return this.req.hostname(e)},Controller.prototype.resource=function(e,t){return F.resource(e,t)},Controller.prototype.error=function(e){var t=this;if(e instanceof ErrorBuilder)return t.content(e),t;var r=F.error("string"==typeof e?new Error(e):e,t.name,t.uri);return void 0===e?r:(t.req.$total_exception=e,t.exception=e,t)},Controller.prototype.invalid=function(e){var t=this;e&&(t.status=e);var r=new ErrorBuilder;return setImmediate(next_controller_invalid,t,r),r},Controller.prototype.wtf=Controller.prototype.problem=function(e){return F.problem(e,this.name,this.uri,this.ip),this},Controller.prototype.change=function(e){return F.change(e,this.name,this.uri,this.ip),this},Controller.prototype.trace=function(e){return F.trace(e,this.name,this.uri,this.ip),this},Controller.prototype.transfer=function(e,t){var r=this,o=F.routes.web.length,n=framework_internal.routeSplit(e.trim()),i="#"===e[0],s=t&&0!==t.length?!1:!0,a=null;r.req.$isAuthorized=!0;for(var l=0;o>l;l++){var c=F.routes.web[l];if(c.isWILDCARD){if(!framework_internal.routeCompare(n,c.url,i,!0))continue}else if(!framework_internal.routeCompare(n,c.url,i))continue;if(s){a=c;break}if(c.flags&&c.flags.length){var u=framework_internal.routeCompareFlags(c.flags,t,!0);if(-1===u&&(r.req.$isAuthorized=!1),1>u)continue}a=c;break}return a?(r.cancel(),r.req.path=EMPTYARRAY,r.req.$total_transfer=!0,r.req.$total_success(),r.req.$path=framework_internal.routeSplit(e,!0),r.req.$total_route=a,r.req.$total_execute(404),!0):!1},Controller.prototype.cancel=function(){return this.isCanceled=!0,this},Controller.prototype.log=function(){return F.log.apply(framework,arguments),this},Controller.prototype.logger=function(){return F.logger.apply(framework,arguments),this},Controller.prototype.meta=function(){var e=this;return arguments[0]&&(e.repository[REPOSITORY_META_TITLE]=arguments[0]),arguments[1]&&(e.repository[REPOSITORY_META_DESCRIPTION]=arguments[1]),arguments[2]&&arguments[2].length&&(e.repository[REPOSITORY_META_KEYWORDS]=arguments[2]instanceof Array?arguments[2].join(", "):arguments[2]),arguments[3]&&(e.repository[REPOSITORY_META_IMAGE]=arguments[3]),e},Controller.prototype.$dns=function(){for(var e="",t=arguments.length,r=0;t>r;r++)e+='<link rel="dns-prefetch" href="'+this._preparehostname(arguments[r])+'" />';return this.head(e),""},Controller.prototype.$prefetch=function(){for(var e="",t=arguments.length,r=0;t>r;r++)e+='<link rel="prefetch" href="'+this._preparehostname(arguments[r])+'" />';return this.head(e),""},Controller.prototype.$prerender=function(){for(var e="",t=arguments.length,r=0;t>r;r++)e+='<link rel="prerender" href="'+this._preparehostname(arguments[r])+'" />';return this.head(e),""},Controller.prototype.$next=function(e){return this.head('<link rel="next" href="'+this._preparehostname(e)+'" />'),""},Controller.prototype.$prev=function(e){return this.head('<link rel="prev" href="'+this._preparehostname(e)+'" />'),""},Controller.prototype.$canonical=function(e){return this.head('<link rel="canonical" href="'+this._preparehostname(e)+'" />'),""},Controller.prototype.$meta=function(){var e=this;if(arguments.length)return e.meta.apply(e,arguments),"";F.$events["controller-render-meta"]&&F.emit("controller-render-meta",e);var t=e.repository;return F.onMeta.call(e,t[REPOSITORY_META_TITLE],t[REPOSITORY_META_DESCRIPTION],t[REPOSITORY_META_KEYWORDS],t[REPOSITORY_META_IMAGE])},Controller.prototype.title=function(e){return this.$title(e),this},Controller.prototype.description=function(e){return this.$description(e),this},Controller.prototype.keywords=function(e){return this.$keywords(e),this},Controller.prototype.author=function(e){return this.$author(e),this},Controller.prototype.$title=function(e){return e&&(this.repository[REPOSITORY_META_TITLE]=e),""},Controller.prototype.$title2=function(e){var t=this.repository[REPOSITORY_META_TITLE];return e&&(this.repository[REPOSITORY_META_TITLE]=(t?t:"")+e),""},Controller.prototype.$description=function(e){return e&&(this.repository[REPOSITORY_META_DESCRIPTION]=e),""},Controller.prototype.$keywords=function(e){return e&&e.length&&(this.repository[REPOSITORY_META_KEYWORDS]=e instanceof Array?e.join(", "):e),""},Controller.prototype.$author=function(e){return e&&(this.repository[REPOSITORY_META_AUTHOR]=e),""},Controller.prototype.sitemap_navigation=function(e,t){return F.sitemap_navigation(e||this.sitemapid,t||this.language)},Controller.prototype.sitemap_url=function(e,t,r,o,n,i,s){var a=F.sitemap(e||this.sitemapid,!0,this.language);return a?a.url.format(t,r,o,n,i,s):""},Controller.prototype.sitemap_name=function(e,t,r,o,n,i,s){var a=F.sitemap(e||this.sitemapid,!0,this.language);return a?a.name.format(t,r,o,n,i,s):""},Controller.prototype.sitemap_add=function(e,t,r){var o=this,n=o.repository[REPOSITORY_SITEMAP];if(!n&&(n=o.sitemap(o.sitemapid||t),!n))return EMPTYARRAY;var i=n.findIndex("id",e);if(-1===i)return n;var s={sitemap:"",id:"",name:t,url:r,last:!1,first:!1,index:i,wildcard:!1,formatName:!1,formatUrl:!1,localizeName:!1,localizeUrl:!1};if(n.splice(i+1,0,s),i)for(var a=i,l=i+1;l>-1;l--)n[l].index=a++;return n},Controller.prototype.sitemap_change=function(e,t,r,o,n,i,s,a){var l=this,c=l.repository[REPOSITORY_SITEMAP];if(!c&&(c=l.sitemap(l.sitemapid||e),!c))return EMPTYARRAY;c.$cloned||(c=U.clone(c),c.$cloned=!0,l.repository[REPOSITORY_SITEMAP]=c);for(var u="function"==typeof r,p=0,f=c.length;f>p;p++){var d=c[p];if(d.id===e){var m=d[t];return u?d[t]=r(d[t]):"name"===t?d[t]=d.formatName?d[t].format(r,o,n,i,s,a):r:"url"===t?d[t]=d.formatUrl?d[t].format(r,o,n,i,s,a):r:d[t]=r,"name"===t&&l.repository[REPOSITORY_META_TITLE]===m&&(l.repository[REPOSITORY_META_TITLE]=d[t]),c}}return c},Controller.prototype.sitemap_replace=function(e,t,r){var o=this,n=o.repository[REPOSITORY_SITEMAP];if(!n&&(n=o.sitemap(o.sitemapid||e),!n))return EMPTYARRAY;n.$cloned||(n=U.clone(n),n.$cloned=!0,o.repository[REPOSITORY_SITEMAP]=n);for(var i=0,s=n.length;s>i;i++){var a=n[i];if(a.id===e){var l=o.repository[REPOSITORY_META_TITLE]===a.name;return t&&(a.name="function"==typeof t?t(a.name):a.formatName?a.name.format(t):t),r&&(a.url="function"==typeof r?r(a.url):a.formatUrl?a.url.format(r):r),l&&(o.repository[REPOSITORY_META_TITLE]=a.name),n}}return n},Controller.prototype.$sitemap_add=function(e,t,r){return this.sitemap_add(e,t,r),""},Controller.prototype.$sitemap_change=function(e,t,r,o,n,i,s,a){return this.sitemap_change(e,t,r,o,n,i,s,a),""},Controller.prototype.$sitemap_replace=function(e,t,r){return this.sitemap_replace(e,t,r),""},Controller.prototype.sitemap=function(e){var t,r=this;return e?e instanceof Array?(r.repository[REPOSITORY_SITEMAP]=e,r):(r.$sitemapid=e,t=U.clone(F.sitemap(e,!1,r.language)),t.$cloned=!0,r.repository[REPOSITORY_SITEMAP]=t,r.repository[REPOSITORY_META_TITLE]||(t=t.last(),t&&(r.repository[REPOSITORY_META_TITLE]=t.name)),r.repository[REPOSITORY_SITEMAP]):(t=r.repository[REPOSITORY_SITEMAP],t||!r.$sitemapid&&!r.route.sitemap?t?t:r.repository.sitemap||EMPTYARRAY:r.sitemap(r.$sitemapid||r.route.sitemap))},Controller.prototype.$sitemap=function(e){var t=this;return t.sitemap(e),""},Controller.prototype.module=function(e){return F.module(e)},Controller.prototype.layout=function(e){var t=this;return t.layoutName=e,t},Controller.prototype.theme=function(e){var t=this;return t.themeName=e,t},Controller.prototype.$layout=function(e){var t=this;return t.layoutName=e,""},Controller.prototype.model=function(e){return F.model(e)},Controller.prototype.mail=function(e,t,r,o,n){"function"==typeof o&&(n=o,o=null);var i=this;"string"==typeof i.language&&(t=-1===t.indexOf("@( ")?F.translate(i.language,t):F.translator(i.language,t));var s,a=i.layoutName,l=i.view(r,o,!0);return l instanceof Function?(s=F.onMail(e,t,""),s.manually(),l(function(e,t){s.body=t,s.send2(n)})):(s=F.onMail(e,t,l,n),i.layoutName=a),s},Controller.prototype.notModified=function(e,t){return F.notModified(this.req,this.res,e,t)},Controller.prototype.setModified=function(e){return F.setModified(this.req,this.res,e),this},Controller.prototype.setExpires=function(e){return e&&this.res.setHeader("Expires",e.toUTCString()),this},Controller.prototype.$template=function(e,t,r,o){return this.$viewToggle(!0,e,t,r,o)},Controller.prototype.$templateToggle=function(e,t,r,o,n){return this.$viewToggle(e,t,r,o,n)},Controller.prototype.$view=function(e,t,r,o){return this.$viewToggle(!0,e,t,r,o)},Controller.prototype.$viewCompile=function(e,t,r){var o=this,n=o.layoutName;o.layoutName="";var i=o.viewCompile(e,t,null,!0,r);return o.layoutName=n,i||""},Controller.prototype.$viewToggle=function(e,t,r,o,n){if(!e)return"";var i,s=this;if(o){i="$view."+t+"."+(n||"");var a=s.cache.read2(i);if(a)return a}var l=s.layoutName;s.layoutName="";var c=s.view(t,r,null,!0);return s.layoutName=l,c?(o&&s.cache.add(i,c,o,!1),c):""},Controller.prototype.place=function(e){var t="$place_"+e,r=arguments.length;if(1===r)return this.repository[t]||"";for(var o="",n=1;r>n;n++){var i=arguments[n];switch(i=i?i.toString():"",U.getExtension(i)){case"js":i='<script src="'+i+'"></script>';break;case"css":i='<link rel="stylesheet" href="'+i+'" />'}o+=i}return this.repository[t]=(this.repository[t]||"")+o,this},Controller.prototype.section=function(e,t,r){var o="$section_"+e;return void 0===t?this.repository[o]:r?(this.repository[o]=t,this):(this.repository[o]?this.repository[o]+=t:this.repository[o]=t,this)},Controller.prototype.$place=function(){var e=this;return 1===arguments.length?e.place.apply(e,arguments):(e.place.apply(e,arguments),"")},Controller.prototype.$url=function(e){return e?this.req.hostname(this.url):this.url},Controller.prototype.$helper=function(){return this.helper.apply(this,arguments)},Controller.prototype.href=function(e,t){var r=this;if(!arguments.length){var o=Qs.stringify(r.query);return o?"?"+o:""}var n,i=typeof e;if("string"===i){var s="$href"+e,a=r[s]||"";if(!a){n=U.copy(r.query);for(var l=2;l<arguments.length;l++)n[arguments[l]]=void 0;n[e]="\x00";for(var c=Object.keys(n),l=0,u=c.length;u>l;l++){var o=n[c[l]];void 0!==o&&(a+=(a?"&":"")+c[l]+"="+(e===c[l]?"\x00":querystring_encode(o)))}r[s]=a}a=a.replace("\x00",querystring_encode(t,r.query[e]));for(var l=2;l<arguments.length;l++){var p=a.indexOf(arguments[l]+"=");if(-1!==p){var f=a.indexOf("&",p);a=a.substring(0,p)+a.substring(-1===f?a.length:f+1)}}return a?"?"+a:""}return t&&(n=U.copy(r.query),U.extend(n,t)),null!=t&&(n[e]=t),n=Qs.stringify(n),void 0===t&&"string"===i&&(n+=(n?"&":"")+e),r.url+(n?"?"+n:"")},Controller.prototype.$checked=function(e,t,r){return this.$isValue(e,t,r,'checked="checked"')},Controller.prototype.$disabled=function(e,t,r){return this.$isValue(e,t,r,'disabled="disabled"')},Controller.prototype.$selected=function(e,t,r){return this.$isValue(e,t,r,'selected="selected"')},Controller.prototype.$set=function(){return""},Controller.prototype.$readonly=function(e,t,r){return this.$isValue(e,t,r,'readonly="readonly"')},Controller.prototype.$header=function(e,t){return this.header(e,t),""},Controller.prototype.$text=function(e,t,r){return this.$input(e,"text",t,r)},Controller.prototype.$password=function(e,t,r){return this.$input(e,"password",t,r)},Controller.prototype.$hidden=function(e,t,r){return this.$input(e,"hidden",t,r)},Controller.prototype.$radio=function(e,t,r,o){if("string"==typeof o){var n=o;o=SINGLETON("!$radio"),o.label=n}return o.value=r,this.$input(e,"radio",t,o)},Controller.prototype.$checkbox=function(e,t,r){if("string"==typeof r){var o=r;r=SINGLETON("!$checkbox"),r.label=o}return this.$input(e,"checkbox",t,r)},Controller.prototype.$textarea=function(e,t,r){var o="<textarea";"object"!=typeof r&&(r=EMPTYOBJECT),o+=' name="'+t+'" id="'+(r.id||t)+ATTR_END;for(var n in r)switch(n){case"name":case"id":break;case"required":case"disabled":case"readonly":case"value":o+=" "+n+'="'+n+ATTR_END;break;default:o+=" "+n+'="'+r[n].toString().encode()+ATTR_END}return void 0===e?o+"></textarea>":o+">"+(e[t]||r.value||"")+"</textarea>"},Controller.prototype.$input=function(e,t,r,o){var n=["<input"];"object"!=typeof o&&(o=EMPTYOBJECT);var i=o.value||"";n+=' type="'+t+ATTR_END,n+="radio"===t?' name="'+r+ATTR_END:' name="'+r+'" id="'+(o.id||r)+ATTR_END,o.autocomplete&&(n+=o.autocomplete===!0||"on"===o.autocomplete?' autocomplete="on"':' autocomplete="off"');for(var s in o)switch(s){case"name":case"id":case"type":case"autocomplete":case"checked":case"value":case"label":break;case"required":case"disabled":case"readonly":case"autofocus":n+=" "+s+'="'+s+ATTR_END;break;default:n+=" "+s+'="'+o[s].toString().encode()+ATTR_END}var a="";return void 0!==e&&(a=e[r],"checkbox"===t&&(("1"==a||"true"===a||a===!0||"on"===a)&&(n+=' checked="checked"'),a=i||"1"),"radio"===t&&(i=(i||"").toString(),a.toString()===i&&(n+=' checked="checked"'),a=i||"")),n+=void 0===a?' value="'+(o.value||"").toString().encode()+ATTR_END:' value="'+(a||"").toString().encode()+ATTR_END,n+=" />",o.label?"<label>"+n+" <span>"+o.label+"</span></label>":n},Controller.prototype._preparehostname=function(e){if(!e)return e;var t=e.substring(0,5);return"http:"===t||"https"===t||"/"===t[0]&&"/"===t[1]?e:this.host(e)},Controller.prototype.head=function(){var e=this;if(!arguments.length){var t=e.repository[REPOSITORY_META_AUTHOR]||e.config.author;return(t?'<meta name="author" content="'+t+'" />':"")+(e.repository[REPOSITORY_HEAD]||"")}for(var r=e.repository[REPOSITORY_HEAD]||"",o=0;o<arguments.length;o++){var n=arguments[o],i="$head-"+n;if(!e.repository[i])if(e.repository[i]=!0,"<"!==n[0]){var s=n.substring(0,7),a="/"!==s[0]&&"/"!==s[1]&&"http://"!==s&&"https:/"!==s,l=U.getExtension(n);"css"===l?r+='<link type="text/css" rel="stylesheet" href="'+(a?e.routeStyle(n):n)+'" />':"js"===l&&(r+='<script src="'+(a?e.routeScript(n):n)+'"></script>')}else r+=n}return e.repository[REPOSITORY_HEAD]=r,e},Controller.prototype.$modified=function(e){var t,r=this,o=typeof e;if("number"===o)t=new Date(e);else if("string"===o){var n=e.split(" ");t=n[0].split("-");var i=(n[1]||"").split(":"),s=U.parseInt(t[0]||""),a=U.parseInt(t[1]||"")-1,l=U.parseInt(t[2]||"")-1;0>a&&(a=0),0>l&&(l=0);var c=U.parseInt(i[0]||""),u=U.parseInt(i[1]||""),p=U.parseInt(i[2]||"");t=new Date(s,a,l,c,u,p,0)}else U.isDate(e)&&(t=e);return t&&r.setModified(t),""},Controller.prototype.$etag=function(e){return this.setModified(e),""},Controller.prototype.$options=function(e,t,r,o){var n=typeof e;if(!e)return"";var i=!1,s=null;e instanceof Array||"object"!==n||(i=!0,s=e,e=Object.keys(e)),U.isArray(e)||(e=[e]),t=t||"";var a="";i||(void 0===o&&(o=o||r||"value"),void 0===r&&(r=r||"name"));var l=!1,c=0;c=e.length;for(var u=0;c>u;u++){var p=e[u],n=typeof p,f="",d="",m=!1;i?r===!0?(d=s[p],f=p,o||(o="")):(d=p,f=s[p],f||(f="")):"object"===n?(f=p[r]||"",d=p[o]||"","function"==typeof f&&(f=f(u)),"function"==typeof d&&(d=d(u,f))):(f=p,d=p),l||(m=d==t,l=m),a+='<option value="'+d.toString().encode()+'"'+(m?' selected="selected"':"")+">"+f.toString().encode()+"</option>"}return a},Controller.prototype.$script=function(){return 1===arguments.length?this.$js(arguments[0]):this.$js.apply(this,arguments)},Controller.prototype.$js=function(){for(var e=this,t="",r=0;r<arguments.length;r++)t+=e.routeScript(arguments[r],!0);return t},Controller.prototype.$absolute=function(e,t){var r,o,n=this;if(t||(t=n.hostname()),e instanceof Array){o=U.getExtension(e[0]),r="";for(var i=0,s=e.length;s>i;i++)switch(o){case"js":r+=n.routeScript(e[i],!0,t);break;case"css":r+=n.routeStyle(e[i],!0,t);break;default:r+=n.routeStatic(e[i],t)}return r}switch(o=U.getExtension(e)){case"js":return n.routeScript(e,!0,t);case"css":return n.routeStyle(e,!0,t)}return n.routeStatic(e,t)},Controller.prototype.$import=function(){for(var e=this,t="",r=0;r<arguments.length;r++){var o=arguments[r];if("head"!==o)if("meta"!==o)if("components"===o&&F.components.has)t+=F.components.links;else if("favicon.ico"!==o&&"favicon.png"!==o){var n=o.substring(o.lastIndexOf(".")),i="!"!==o[0];switch(i||(o=o.substring(1)),"#"===o[0]&&(n=".js"),n){case".js":t+=e.routeScript(o,i);break;case".css":t+=e.routeStyle(o,i);break;case".ico":t+=e.$favicon(o);break;case".jpg":case".gif":case".svg":case".png":case".jpeg":t+=e.routeImage(o);break;case".mp4":case".avi":case".ogv":case".webm":case".mov":case".mpg":case".mpe":case".mpeg":case".m4v":t+=e.routeVideo(o);break;default:t+=e.routeStatic(o)}}else t+=e.$favicon(o);else t+=e.$meta();else t+=e.head()}return t},Controller.prototype.$css=function(){for(var e=this,t="",r=0;r<arguments.length;r++)t+=e.routeStyle(arguments[r],!0);return t},Controller.prototype.$image=function(e,t,r,o,n){var i="";"object"==typeof t&&(r=t.height,o=t.alt,n=t["class"],i=t.style,t=t.width);var s='<img src="'+this.routeImage(e)+ATTR_END;return t>0&&(s+=' width="'+t+ATTR_END),r>0&&(s+=' height="'+r+ATTR_END),o&&(s+=' alt="'+o.encode()+ATTR_END),n&&(s+=' class="'+n+ATTR_END),i&&(s+=' style="'+i+ATTR_END),s+' border="0" />'},Controller.prototype.$download=function(e,t,r,o){var n='<a href="'+F.routeDownload(e)+ATTR_END;return r&&(n+=' download="'+r+ATTR_END),o&&(n+=' class="'+o+ATTR_END),n+">"+(t||e)+"</a>"},Controller.prototype.$json=function(e,t,r,o){"boolean"==typeof t&&(o=r,r=t,t=null),"function"==typeof r&&(o=r,r=!1);var n=r?JSON.stringify(e,o,4):JSON.stringify(e,o);return t?'<script type="application/json" id="'+t+'">'+n+"</script>":n},Controller.prototype.$favicon=function(e){var t="image/x-icon";null==e&&(e="favicon.ico");var r="favicon#"+e;return F.temporary.other[r]?F.temporary.other[r]:(-1!==e.lastIndexOf(".png")?t="image/png":-1!==e.lastIndexOf(".gif")&&(t="image/gif"),F.temporary.other[r]='<link rel="icon" href="'+F.routeStatic("/"+e)+'" type="'+t+'" />')},Controller.prototype._routeHelper=function(e,t){return t.call(framework,prepare_staticurl(e,!1),this.themeName)},Controller.prototype.routeScript=function(e,t,r){void 0===e&&(e="default.js");var o,n=!1;if(t&&"a"===e[0]&&" "===e[5]&&(n=!0,e=e.substring(6)),"#"===e[0]){var i=F.isomorphic[e.substring(1)];if(!i)return F.error("Isomorphic library {0} doesn't exist.".format(e.substring(1))),"";o=i.url}else o=this._routeHelper(e,F.routeScript),r&&U.isRelative(o)&&(o=F.isWindows?U.join(r,o):U.join(r,o).substring(1));return t?'<script src="'+o+'"'+(n?" async":"")+"></script>":o},Controller.prototype.routeStyle=function(e,t,r){var o=this;void 0===e&&(e="default.css");var n=o._routeHelper(e,F.routeStyle);return r&&U.isRelative(n)&&(n=F.isWindows?U.join(r,n):U.join(r,n).substring(1)),t?'<link type="text/css" rel="stylesheet" href="'+n+'" />':n},Controller.prototype.routeImage=function(e){return this._routeHelper(e,F.routeImage)},Controller.prototype.routeVideo=function(e){return this._routeHelper(e,F.routeVideo)},Controller.prototype.routeFont=function(e){return F.routeFont(e)},Controller.prototype.routeDownload=function(e){return this._routeHelper(e,F.routeDownload)},Controller.prototype.routeStatic=function(e,t){var r=this._routeHelper(e,F.routeStatic);return t&&U.isRelative(r)?F.isWindows?U.join(t,r):U.join(t,r).substring(1):r},Controller.prototype.template=function(e,t){return this.view(e,t,!0)},Controller.prototype.helper=function(e){var t=F.helpers[e];if(!t)return"";for(var r=[],o=1;o<arguments.length;o++)r.push(arguments[o]);return t.apply(this,r)},Controller.prototype.json=function(e,t,r,o){var n=this,i=n.res;if("boolean"==typeof t&&(o=r,r=t),i.options.code=n.status||200,i.options.type=CT_JSON,i.options.headers=t,"HEAD"===n.req.method)return i.options.body=EMPTYBUFFER,i.options.type=CT_JSON,i.$text(),F.stats.response.json++,n;if(e instanceof framework_builders.ErrorBuilder){n.req.$language&&!e.isResourceCustom&&e.setResource(n.req.$language);var s=e.output(!0);e.contentType?i.options.type=e.contentType:i.options.type=CT_JSON,200!==e.status&&(i.options.code=e.status),e=s,F.stats.response.errorBuilder++}else framework_builders.isSchema(e)&&(e=e.$clean()),e=r?JSON.stringify(e,o,4):JSON.stringify(e,o);return F.stats.response.json++,i.options.body=e,i.$text(),n.precache&&n.precache(e,i.options.type,t),n},Controller.prototype.success=function(e,t){return void 0===e&&(e=!0),this.json(SUCCESS(e,t))},Controller.prototype.jsonp=function(e,t,r,o,n){var i=this,s=i.res;return"boolean"==typeof r&&(n=o,o=r),s.options.code=i.status||200,s.options.headers=r,s.options.type="application/x-javascript","HEAD"===i.req.method?(s.options.body=EMPTYBUFFER,s.$text(),F.stats.response.json++,i):(!e&&(e="callback"),t instanceof framework_builders.ErrorBuilder?(i.req.$language&&!t.isResourceCustom&&t.setResource(i.req.$language),t=t.json(o),200!==t.status&&(s.options.code=t.status),F.stats.response.errorBuilder++):(framework_builders.isSchema(t)&&(t=t.$clean()),t=o?JSON.stringify(t,n,4):JSON.stringify(t,n)),s.options.body=e+"("+t+")",s.$text(),F.stats.response.json++,i.precache&&i.precache(e+"("+t+")",s.options.type,r),i)},Controller.prototype.callback=function(e){var t=this;return function(r,o){var n=r instanceof framework_builders.ErrorBuilder;return void 0!==o||U.isError(r)||n||(o=r,r=null),r?n&&!e?(t.req.$language&&!r.isResourceCustom&&r.setResource(t.req.$language),t.content(r)):n&&r.unexpected?t.view500(r):t.view404(r):void("string"==typeof e?t.view(e,o):t.json(o))}},Controller.prototype.custom=function(){return this.res.success?!1:(this.res.$custom(),!0)},Controller.prototype.noClear=function(e){return this.req._manual=void 0===e?!0:e,this},Controller.prototype.html=function(e,t){return this.content(e,"text/html",t)},Controller.prototype.content=function(e,t,r){var o=this,n=o.res;if(n.options.headers=r,n.options.code=o.status||200,e instanceof ErrorBuilder){o.language&&!e.resourceName&&(e.resourceName=o.language);var i=e.output(!0);e.contentType?n.options.type=e.contentType:n.options.type=CT_JSON,200!==e.status&&(n.options.code=e.status),e=i,F.stats.response.errorBuilder++}else n.options.type=t||CT_TEXT;return n.options.body=e,n.$text(),!o.precache||o.status&&200!==o.status||(o.layout(""),o.precache(e,n.options.type,r,!0)),o},Controller.prototype.plain=function(e,t){var r=this,o=r.res;if(o.options.code=r.status||200,o.options.headers=t,o.options.type=CT_TEXT,"HEAD"===r.req.method)return o.options.body=EMPTYBUFFER,o.$text(),F.stats.response.plain++,r;var n=typeof e;return null==e?e="":"object"===n?(framework_builders.isSchema(e)&&(e=e.$clean()),e=e?JSON.stringify(e,null,4):""):e=e?e.toString():"",o.options.body=e,o.$text(),F.stats.response.plain++,r.precache&&r.precache(e,o.options.type,t),r},Controller.prototype.empty=function(e){var t=this,r=t.res;return"number"==typeof e&&(t.status=e,e=null),r.options.code=t.status||200,r.options.headers=e,r.options.body=EMPTYBUFFER,r.options.type=CT_TEXT,r.options.compress=!1,r.$text(),F.stats.response.empty++,t},Controller.prototype.destroy=function(e){var t=this;return e&&t.problem(e),t.res.success||t.res.headersSent||!t.isConnected?t:(t.req.$total_success(),t.req.connection&&t.req.connection.destroy(),F.stats.response.destroy++,t)},Controller.prototype.file=function(e,t,r,o){e="~"===e[0]?e.substring(1):F.path.public_cache(e);var n=this.res;return n.options.filename=e,n.options.download=t,n.options.headers=r,n.options.callback=o,n.$file(),this},Controller.prototype.image=function(e,t,r,o){var n=this.res;return"string"==typeof e?(e="~"===e[0]?e.substring(1):F.path.public_cache(e),n.options.filename=e):n.options.stream=e,n.options.make=t,r&&(n.options.headers=r),o&&(n.options.callback=o),n.$image(),this},Controller.prototype.stream=function(e,t,r,o,n,i){var s=this.res;return s.options.type=e,s.options.stream=t,s.options.download=r,s.options.headers=o,s.options.done=n,s.options.compress=i?!1:!0,s.$stream(),this},Controller.prototype.throw400=Controller.prototype.view400=function(e){return controller_error_status(this,400,e)},Controller.prototype.throw401=Controller.prototype.view401=function(e){return controller_error_status(this,401,e)},Controller.prototype.throw403=Controller.prototype.view403=function(e){return controller_error_status(this,403,e)},Controller.prototype.throw404=Controller.prototype.view404=function(e){return controller_error_status(this,404,e)},Controller.prototype.throw409=Controller.prototype.view409=function(e){return controller_error_status(this,409,e)},Controller.prototype.throw500=Controller.prototype.view500=function(e){var t=this;return F.error(e instanceof Error?e:new Error((e||"").toString()),t.name,t.req.uri),controller_error_status(t,500,e)},Controller.prototype.throw501=Controller.prototype.view501=function(e){return controller_error_status(this,501,e)},Controller.prototype.redirect=function(e,t){this.precache&&this.precache(null,null,null);var r=this.res;return r.options.url=e,r.options.permanent=t,r.$redirect(),this},Controller.prototype.binary=function(e,t,r,o,n){var i=this.res;if("object"==typeof r){var s=r;r=o,o=n,n=s}return"object"==typeof o&&(n=o,o=n),i.options.body=e,i.options.type=t,i.options.download=o,i.options.headers=n,i.options.encoding=r,i.$binary(),this},Controller.prototype.baa=function(e){var t=this;if(t.precache&&t.precache(null,null,null),void 0===e)return t.req.authorization();var r=t.res,o=SINGLETON("!controller.baa");return o["WWW-Authenticate"]='Basic realm="'+(e||"Administration")+'"',r.options.code=401,r.options.body="401: NOT AUTHORIZED",r.options.compress=!1,r.options.headers=o,r.options.type=CT_TEXT,r.$text(),t.cancel(),null},Controller.prototype.sse=function(e,t,r,o){var n=this,i=n.res;if(!n.isConnected)return n;if(!n.type&&i.success)throw new Error("Response was sent.");if(n.type>0&&1!==n.type)throw new Error("Response was used.");n.type||(n.type=1,void 0===o&&(o=n.req.$total_route.timeout),n.req.$total_success(),n.req.on("close",function(){n.close()}),i.success=!0,i.writeHead(n.status||200,HEADERS.sse)),e="object"==typeof e?JSON.stringify(e):e.replace(/\n/g,"\\n").replace(/\r/g,"\\r");var s="\n",a="";return t&&(a="event: "+t+s),a+="data: "+e+s,r&&(a+="id: "+r+s),o>0&&(a+="retry: "+o+s),a+=s,i.write(a),F.stats.response.sse++,n},Controller.prototype.mmr=function(e,t,r){var o=this,n=o.res;return"function"==typeof t&&(r=t,t=e),t||(t=e),!o.isConnected||!o.type&&n.success||o.type&&2!==o.type?(r=null,o):(o.type||(o.type=2,o.boundary="----totaljs"+U.GUID(10),o.req.$total_success(),o.req.on("close",function(){o.close()}),n.success=!0,HEADERS.mmr[HEADER_TYPE]="multipart/x-mixed-replace; boundary="+o.boundary,n.writeHead(o.status||200,HEADERS.mmr)),n.write("--"+o.boundary+NEWLINE+HEADER_TYPE+": "+U.getContentType(U.getExtension(e))+NEWLINE+NEWLINE),F.stats.response.mmr++,"string"==typeof t&&(t=Fs.createReadStream(t)),t.pipe(n,HEADERS.mmrpipe),CLEANUP(t,function(){return r&&r()}),o)},Controller.prototype.close=function(e){var t=this;return void 0===e&&(e=!0),t.isConnected?t.type?(t.isConnected=!1,t.res.success=!0,F.reqstats(!1,!1),F.$events["request-end"]&&F.emit("request-end",t.req,t.res),t.type=0,e&&t.res.end(),t.req.clear(!0),t):(t.isConnected=!1,t.res.success?t:(t.res.success=!0,F.reqstats(!1,!1),F.$events["request-end"]&&F.emit("request-end",t.req,t.res),e&&t.res.end(),t.req.clear(!0),t)):t},Controller.prototype.proxy=function(e,t,r,o){var n,i=this;return"number"==typeof r&&(n=o,o=r,r=n),"function"==typeof t&&(n=r,r=t,t=n),U.request(e,FLAGS_PROXY,t,function(e,t,o,n){r&&(-1!==(n["content-type"]||"").lastIndexOf("/json")&&(t=F.onParseJSON(t)),r.call(i,e,t,o,n))},null,HEADERS.proxy,ENCODING,o||1e4)},Controller.prototype.proxy2=function(e,t,r,o){"object"==typeof t&&(o=r,r=t,t=void 0);var n=this,i=[],s=n.req,a=s.headers["content-type"],l={};i.push(s.method),i.push("dnscache"),a===CT_JSON&&i.push("json");var c,u,p=s.method[0];("G"===p||"H"===p||"O"===p)&&-1===e.indexOf("?")&&(c=Qs.stringify(n.query),c&&(e+="?"+c)),u=Object.keys(s.headers);for(var f=0,d=u.length;d>f;f++)switch(u[f]){case"x-forwarded-for":case"x-forwarded-protocol":case"x-nginx-proxy":case"connection":case"content-type":case"host":case"accept-encoding":break;default:l[u[f]]=s.headers[u[f]]}if(r){u=Object.keys(r);for(var f=0,d=u.length;d>f;f++)l[u[f]]=r[u[f]]}return U.request(e,i,n.body,function(e,r,o,i){return e?(t&&t(e),void n.invalid().push(e)):(n.status=o,t&&t(e,r,o,i),void n.content(r,(i["content-type"]||"text/plain").replace(REG_ENCODINGCLEANER,"")))},null,l,ENCODING,o||1e4)},Controller.prototype.view=function(e,t,r,o){var n=this;if("string"!=typeof e?(o=r,r=t,t=e,e=n.viewname):void 0===o&&"boolean"==typeof r&&(o=r,r=null),!o&&n.res&&n.res.success)return n;void 0===n.layoutName&&(n.layoutName=F.config["default-layout"]),void 0===n.themeName&&(n.themeName=F.config["default-theme"]);var i="view#="+this.themeName+"/"+n._currentView+"/"+e;global.TtwLog.log("key : "+i);var s=F.temporary.other[i];global.TtwLog.log("fileName : "+s);var a=n.isLayout;if(n.isLayout=!1,!s){var l=e[0],c="/"===l?1:"~"===l&&"~"===e[1]?4:"~"===l?2:"@"===l?3:"."===l?5:"="===l?6:0,u=!1;if(REG_HTTPHTTPS.test(e)&&(c=7),s=e,n.themeName&&3>c&&(s="."+F.path.themes(n.themeName+"/views/"+(a||c?"":n._currentView.substring(1))+(c?e.substring(1):e)).replace(REG_SANITIZE_BACKSLASH,"/"),global.TtwLog.log("if( self.themeName && skip < 3 ) fileName : "+s),u=!0),4===c&&(s=s.substring(1),e=e.substring(1),c=2),u||a||c||(s=n._currentView+e),u||2!==c&&3!==c||(s=e.substring(1)),3===c&&(s="."+F.path["package"](s)),6===c&&(l=U.parseTheme(s),e=e.substring(e.indexOf("/")+1),s="."+F.path.themes(l+"/views/"+e).replace(REG_SANITIZE_BACKSLASH,"/"),global.TtwLog.log("if( skip === 6 ) fileName : "+s)),7===c){if(0===F.temporary.other[i])return void setTimeout(function(){n.view(e,t,r,o)},100,n);s=F.path.temp("view"+e.hash()+".html"),global.TtwLog.log("if( skip === 7 ) fileName : "+s),F.temporary.other[i]=0;var p={callback:NOOP};return F.download(e,s,function(a){a?(F.temporary.other[i]=void 0,p.callback===NOOP?F.throw500(a):p.callback(a)):(F.temporary.other[i]="."+s.substring(0,s.length-5),p.callback(null,n.view(e,t,r,o)))}),function(e){p.callback=e}}}return n.$viewrender(s,framework_internal.viewEngine(e,s,n),t,r,o,a)},Controller.prototype.viewCompile=function(e,t,r,o,n){return r===!0?(n=o,o=!0,r=void 0):"string"==typeof r?(n=r,r=void 0):"string"==typeof o&&(n=o,o=void 0),this.$viewrender("[dynamic view]",framework_internal.viewEngineCompile(e,this.language,this,n),t,r,o)},Controller.prototype.$viewrender=function(e,t,r,o,n,i){global.TtwLog.log("--- [ S ] - Controller.prototype.$viewrender:{Controller} ----------"),global.TtwLog.log("fileName : "+e),global.TtwLog.log("generator : "+t);try{global.TtwLog.log("model : "+JSON.stringify(r))}catch(s){}global.TtwLog.log("headers : "+o),global.TtwLog.log("partial : "+n),global.TtwLog.log("isLayout : "+i);var a,l=this;if(!t)return a=new Error('View "'+e+'" not found.'),n?(F.error(a,l.name,l.uri),l.outputPartial):i?(l.res.throw500(a),l):(l.view500(a),global.TtwLog.log("--- [ E ] - Controller.prototype.$viewrender:{Controller} ----------return self;"),l);var c="";l.$model=r,i&&(l._currentView=l._defaultView||"");var u=F.helpers;try{c=t.call(l,l,l.repository,r,l.session,l.query,l.body,l.url,F.global,u,l.user,l.config,F.functions,0,n?l.outputPartial:l.output,l.req.cookie,l.req.files,l.req.mobile,EMPTYOBJECT)}catch(p){return a=new Error('View "'+e+'": '+p.message),n?(l.error(a),l.partial?l.outputPartial="":l.output="",i=!1,global.TtwLog.log("--- [ E ] - Controller.prototype.$viewrender:{Controller} ----------return value;"),c):(l.view500(a),l)}if(i||!l.precache||l.status&&200!==l.status||n||l.precache(c,CT_HTML,o,!0),i||!l.layoutName){if(l.outputPartial="",l.output="",i=!1,n)return c;if(l.req.$total_success(),!l.isConnected)return l;var f=l.res;return f.options.body=c,f.options.code=l.status||200,f.options.type=CT_HTML,f.options.headers=o,f.$text(),F.stats.response.view++,global.TtwLog.log("--- [ E ] - Controller.prototype.$viewrender:{Controller} ----------return self;"),l}return n?l.outputPartial=c:l.output=c,l.isLayout=!0,c=l.view(l.layoutName,l.$model,o,n),n?(l.outputPartial="",l.isLayout=!1,global.TtwLog.log("--- [ E ] - Controller.prototype.$viewrender:{Controller} ----------return value;"),c):(global.TtwLog.log("--- [ E ] - Controller.prototype.$viewrender:{Controller} ----------return self;"),l)},Controller.prototype.memorize=function(e,t,r,o,n){global.TtwLog.log("--- [ S ] - Controller.prototype.memorize:{Controller} ----------"),global.TtwLog.log("key : "+e);var i=this;if(r===!0)return o.call(i),i;i.themeName&&(e+="#"+i.themeName);var s=i.cache.read2(e);if(!s)return i.$memorize_prepare(e,t,r,o,n);if("function"==typeof r){var a=o;o=r,n=a}i.layoutName=s.layout,i.themeName=s.theme;var l=i.res;if(l.options.code=i.status||200,l.options.type=s.type,l.options.headers=s.headers,l.options.body=s.content,s.type!==CT_HTML)return n&&n.call(i),l.$text(),void global.TtwLog.log("--- [ E ] - Controller.prototype.memorize:{Controller} ----------return;");switch(s.type){case CT_TEXT:return F.stats.response.plain++,i;case CT_JSON:return F.stats.response.json++,i;case CT_HTML:F.stats.response.view++}for(var c=s.repository.length,u=0;c>u;u++){var e=s.repository[u].key;void 0===i.repository[e]&&(i.repository[e]=s.repository[u].value)}return n&&n.call(i),i.layoutName?(i.output=U.createBuffer(s.content),i.isLayout=!0,i.view(i.layoutName,null)):(i.req.$total_success(),l.$text()),global.TtwLog.log("--- [ E ] - Controller.prototype.memorize:{Controller} ----------return self;"),i},Controller.prototype.$memorize_prepare=function(e,t,r,o,n){var i=this,s="$memorize"+e;return F.temporary.processing[s]?(setTimeout(function(){!i.req.$total_canceled&&i.memorize(e,t,r,o,n)},500),i):(i.precache=function(r,o,n,a){if(!r&&!o&&!n)return delete F.temporary.processing[s],void(i.precache=null);var l={content:r,type:o||CT_TEXT,layout:i.layoutName,theme:i.themeName};if(n&&(l.headers=n),a){l.repository=[];for(var c in i.repository){var r=i.repository[c];void 0!==r&&l.repository.push({key:c,value:r})}}i.cache.add(e,l,t,!1),i.precache=null,delete F.temporary.processing[s]},"function"==typeof r&&(o=r),F.temporary.processing[s]=!0,o.call(i),i)};const NEWLINE="\r\n",SOCKET_RESPONSE="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: {0}\r\n\r\n",SOCKET_RESPONSE_COMPRESS="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: {0}\r\nSec-WebSocket-Extensions: permessage-deflate\r\n\r\n",SOCKET_RESPONSE_PROTOCOL="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: {0}\r\nSec-WebSocket-Protocol: {1}\r\n\r\n",SOCKET_RESPONSE_PROTOCOL_COMPRESS="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: {0}\r\nSec-WebSocket-Protocol: {1}\r\nSec-WebSocket-Extensions: permessage-deflate\r\n\r\n",SOCKET_HASH="258EAFA5-E914-47DA-95CA-C5AB0DC85B11",SOCKET_ALLOW_VERSION=[13];WebSocket.prototype={get repository(){return this.$repository?this.$repository:this.$repository?this.$repository:this.$repository={}},get global(){return F.global},get config(){return F.config},get cache(){return F.cache},get isDebug(){return F.config.debug},get path(){return F.path},get fs(){return F.fs},get isSecure(){return this.req.isSecure},get secured(){return this.req.secured},get params(){if(this.$params)return this.$params;var e=framework_internal.routeSplit(this.url,!0),t=this.route.paramnames;if(t){for(var r={},o=0;o<t.length;o++)r[t[o]]=e[this.route.param[o]];return this.$params=r,r}return this.$params=EMPTYOBJECT,EMPTYOBJECT}},WebSocket.prototype.emit=function(e,t,r,o,n,i,s,a){var l=this.$events[e];if(l){for(var c=!1,u=0,p=l.length;p>u;u++)l[u].$once&&(c=!0),l[u].call(this,t,r,o,n,i,s,a);c&&(l=l.remove(function(e){return e.$once}),l.length?this.$events[e]=l:this.$events[e]=void 0)}return this},WebSocket.prototype.on=function(e,t){return this.$events[e]?this.$events[e].push(t):this.$events[e]=[t],this},WebSocket.prototype.once=function(e,t){return t.$once=!0,this.on(e,t)},WebSocket.prototype.removeListener=function(e,t){var r=this.$events[e];return r&&(r=r.remove(function(e){return e===t}),r.length?this.$events[e]=r:this.$events[e]=void 0),this},WebSocket.prototype.removeAllListeners=function(e){return e===!0?this.$events=EMPTYOBJECT:e?this.$events[e]=void 0:this.$events={},this},WebSocket.prototype.send=function(e,t,r,o){var n=this._keys;if(!n||!n.length)return this;for(var i,s=!1,a=0,l=n.length;l>a;a++){var c=this.connections[n[a]];if(t)if(t instanceof Array){if(!websocket_valid_array(c.id,t))continue}else{if(!(t instanceof Function))throw new Error('Invalid "id" argument.');if(!websocket_valid_fn(c.id,c,t))continue}if(r)if(r instanceof Array){if(websocket_valid_array(c.id,r))continue}else{if(!(r instanceof Function))throw new Error('Invalid "blacklist" argument.');if(websocket_valid_fn(c.id,c,r))continue}void 0===i&&(3===c.type?(s=!0,i=JSON.stringify(e,o)):i=e),c.send(i,s),F.stats.response.websocket++}return this},WebSocket.prototype.ping=function(){var e=this._keys;if(!e)return this;var t=e.length;if(t){this.$ping=!0,F.stats.other.websocketPing++;for(var r=0;t>r;r++)this.connections[e[r]].ping()}return this},WebSocket.prototype.close=function(e,t,r){var o=this._keys;if(!o)return this;"string"==typeof e&&(r=t,t=e,e=null);var n=o.length;if(!n)return this;if(!e||!e.length){for(var i=0;n>i;i++){var s=o[i];this.connections[s].close(t,r),this.$remove(s)}return this.$refresh(),this}for(var a=e instanceof Array,l="function"==typeof e?e:null,i=0;n>i;i++){var s=o[i];if(!a||-1!==e.indexOf(s)){var c=this.connections[s];(!l||l.call(this,s,c))&&(c.close(t,r),this.$remove(s))}}return this.$refresh(),this},WebSocket.prototype.error=function(e){var t=F.error("string"==typeof e?new Error(e):e,this.name,this.path);return e?this:t},WebSocket.prototype.wtf=WebSocket.prototype.problem=function(e){return F.problem(e,this.name,this.uri),this},WebSocket.prototype.change=function(e){return F.change(e,this.name,this.uri,this.ip),this},WebSocket.prototype.all=function(e){if(this._keys)for(var t=0,r=this._keys.length;r>t;t++)e(this.connections[this._keys[t]],t);return this},WebSocket.prototype.find=function(e){var t=this;if(!t._keys)return t;for(var r=t._keys.length,o="function"==typeof e,n=0;r>n;n++){var i=t.connections[t._keys[n]];if(o){if(e(i,i.id))return i}else if(i.id===e)return i}return null},WebSocket.prototype.destroy=function(e){var t=this;return e&&t.problem(e),t.connections||t._keys?(t.close(),t.$events.destroy&&t.emit("destroy"),setTimeout(function(){t._keys.forEach(function(e){var r=t.connections[e];r&&(r._isClosed=!0,r.socket.removeAllListeners())}),t.connections=null,t._keys=null,t.route=null,t.buffer=null,delete F.connections[t.id],t.removeAllListeners()},1e3),t):t},WebSocket.prototype.autodestroy=function(e){var t=this,r="websocket:"+t.id;return t.on("open",function(){clearTimeout2(r)}),t.on("close",function(){!t.online&&setTimeout2(r,function(){e&&e.call(t),t.destroy()},5e3)}),t},WebSocket.prototype.$refresh=function(){return this.connections?(this._keys=Object.keys(this.connections),this.online=this._keys.length):this.online=0,this},WebSocket.prototype.$remove=function(e){return this.connections&&delete this.connections[e],this},WebSocket.prototype.$add=function(e){return this.connections[e._id]=e,this},WebSocket.prototype.resource=function(e,t){return F.resource(e,t)},WebSocket.prototype.log=function(){return F.log.apply(framework,arguments),this},WebSocket.prototype.logger=function(){return F.logger.apply(framework,arguments),this},WebSocket.prototype.check=function(){return this.$ping&&this.all(websocketcheck_ping),this},WebSocketClient.prototype={get protocol(){return(this.req.headers["sec-websocket-protocol"]||"").replace(REG_EMPTY,"").split(",")},get ip(){return this.req.ip},get get(){return this.req.query},get query(){return this.req.query},get uri(){return this.req.uri},get config(){return this.container.config},get global(){return this.container.global},get session(){return this.req.session},set session(e){this.req.session=e},get user(){return this.req.user},set user(e){this.req.user=e},get mobile(){return this.req.mobile}},WebSocketClient.prototype.isWebSocket=!0,WebSocketClient.prototype.cookie=function(e){return this.req.cookie(e)},WebSocketClient.prototype.prepare=function(e,t,r,o){e=e||EMPTYARRAY,t=t||EMPTYARRAY,r=r||EMPTYARRAY;var n=this;if(-1===SOCKET_ALLOW_VERSION.indexOf(U.parseInt(n.req.headers["sec-websocket-version"])))return!1;n.length=o;var i=n.req.headers.origin||"",o=r.length;if(o&&-1===r.indexOf("*")){for(var s=!1,a=0;o>a;a++)if(-1!==i.indexOf(r[a])){s=!0;break}if(!s)return!1}if(o=t.length)for(var a=0;o>a;a++)if(-1===n.protocol.indexOf(t[a]))return!1;var l=-1!==(F.config["allow-websocket-compression"]&&n.req.headers["sec-websocket-extensions"]||"").indexOf("permessage-deflate"),c=t.length?(l?SOCKET_RESPONSE_PROTOCOL_COMPRESS:SOCKET_RESPONSE_PROTOCOL).format(n.$websocket_key(n.req),t.join(", ")):(l?SOCKET_RESPONSE_COMPRESS:SOCKET_RESPONSE).format(n.$websocket_key(n.req));return n.socket.write(U.createBuffer(c,"binary")),l&&(n.inflatepending=[],n.inflatelock=!1,n.inflate=Zlib.createInflateRaw(WEBSOCKET_COMPRESS_OPTIONS),n.inflate.$websocket=n,n.inflate.on("error",function(){n.$uerror||(n.$uerror=!0,n.close("Unexpected error"))}),n.inflate.on("data",websocket_inflate),n.deflatepending=[],n.deflatelock=!1,n.deflate=Zlib.createDeflateRaw(WEBSOCKET_COMPRESS_OPTIONS),n.deflate.$websocket=n,n.deflate.on("error",function(){n.$uerror||(n.$uerror=!0,n.close("Unexpected error"))}),n.deflate.on("data",websocket_deflate)),n._id=Date.now()+U.GUID(5),n.id=n._id,!0},WebSocketClient.prototype.upgrade=function(e){var t=this;return t.req.on("error",websocket_onerror),t.container=e,t.socket.$websocket=this,t.socket.on("data",websocket_ondata),t.socket.on("error",websocket_onerror),t.socket.on("close",websocket_close),t.socket.on("end",websocket_close),t.container.$add(t),t.container.$refresh(),F.$events["websocket-begin"]&&F.emit("websocket-begin",t.container,t),t.container.$events.open&&t.container.emit("open",t),t},WebSocketClient.prototype.$ondata=function(e){if(!this.isClosed){var t=this.current;if(e&&(t.buffer?(CONCAT[0]=t.buffer,CONCAT[1]=e,t.buffer=Buffer.concat(CONCAT)):t.buffer=e),this.$parse()){t["final"]||0===t.type||(t.type2=t.type);var r;switch(0===t.type?t.type2:t.type){case 1:this.inflate?t["final"]&&this.parseInflate():(r=this.$readbody(),t.body?t.body+=r:t.body=r,t["final"]&&this.$decode());break;case 2:this.inflate?t["final"]&&this.parseInflate():(r=this.$readbody(),t.body?(CONCAT[0]=t.body,CONCAT[1]=r,t.body=Buffer.concat(CONCAT)):t.body=r,t["final"]&&this.$decode());break;case 8:this.close();break;case 9:this.socket.write(U.getWebSocketFrame(0,"PONG",10)),t.buffer=null,t.inflatedata=null,this.$ping=!0;break;case 10:this.$ping=!0,t.buffer=null,t.inflatedata=null}t.buffer&&(t.buffer=t.buffer.slice(t.length,t.buffer.length),t.buffer.length&&this.$ondata())}}},WebSocketClient.prototype.$parse=function(){var e=this,t=e.current;if(t.buffer&&!(t.buffer.length<=2)&&(128&t.buffer[0])>>7===1){t.type=15&t.buffer[0],t["final"]=(128&t.buffer[0])>>7===1,t.isMask=(254&t.buffer[1])>>7===1;var r=U.getMessageLength(t.buffer,F.isLE),o=127&t.buffer[1];o=(126===o?4:127===o?10:2)+(t.isMask?4:0);var n=o+r;if(n>this.length)return void this.close("Maximum request length exceeded.");if(!(t.buffer.length<n)){if(t.length=n,9!==t.type&&10!==t.type)if(t.isMask&&(t.mask=U.createBufferSize(4),t.buffer.copy(t.mask,0,o-4,o)),this.inflate){var i=U.createBufferSize(r);if(t.buffer.copy(i,0,o,n),t.isMask)for(var s=0;r>s;s++)i[s]=i[s]^t.mask[s%4];i.$continue=t["final"]===!1,this.inflatepending.push(i)}else t.data=U.createBufferSize(r),t.buffer.copy(t.data,0,o,n);return!0}}},WebSocketClient.prototype.$readbody=function(){var e,t=this.current,r=t.data.length;if(1===t.type){e=U.createBufferSize(r);for(var o=0;r>o;o++)t.isMask?e[o]=t.data[o]^t.mask[o%4]:e[o]=t.data[o];return e.toString("utf8")}e=U.createBufferSize(r);for(var o=0;r>o;o++)t.isMask?e[o]=t.data[o]^t.mask[o%4]:e[o]=t.data[o];return e},WebSocketClient.prototype.$decode=function(){var e=this.current.body;switch(this.type){case 1:this.container.emit("message",this,new Uint8Array(e).buffer);break;case 3:e instanceof Buffer&&(e=e.toString(ENCODING)),F.config["default-websocket-encodedecode"]===!0&&(e=$decodeURIComponent(e)),e.isJSON()&&this.container.emit("message",this,F.onParseJSON(e,this.req));break;default:e instanceof Buffer&&(e=e.toString(ENCODING)),this.container.emit("message",this,F.config["default-websocket-encodedecode"]===!0?$decodeURIComponent(e):e)}this.current.body=null},WebSocketClient.prototype.parseInflate=function(){var e=this;if(!e.inflatelock){var t=e.inflatepending.shift();t&&(e.inflatechunks=[],e.inflatechunkslength=0,e.inflatelock=!0,e.inflate.write(t),!t.$continue&&e.inflate.write(U.createBuffer(WEBSOCKET_COMPRESS)),e.inflate.flush(function(){if(e.inflatechunks){var r=buffer_concat(e.inflatechunks,e.inflatechunkslength);if(e.inflatechunks=null,e.inflatelock=!1,r.length>e.length)return void e.close("Maximum request length exceeded.");e.current.body?(CONCAT[0]=e.current.body,CONCAT[1]=r,e.current.body=Buffer.concat(CONCAT)):e.current.body=r,!t.$continue&&e.$decode(),e.parseInflate()}}))}},WebSocketClient.prototype.$onerror=function(e){this.isClosed||(REG_WEBSOCKET_ERROR.test(e.stack)?(this.isClosed=!0,this.$onclose()):this.container.$events.error&&this.container.emit("error",e,this))},WebSocketClient.prototype.$onclose=function(){this._isClosed||(this.isClosed=!0,this._isClosed=!0,this.inflate&&(this.inflate.removeAllListeners(),this.inflate=null,this.inflatechunks=null),this.deflate&&(this.deflate.removeAllListeners(),this.deflate=null,this.deflatechunks=null),this.container.$remove(this._id),this.container.$refresh(),this.container.$events.close&&this.container.emit("close",this),this.socket.removeAllListeners(),F.$events["websocket-end"]&&F.emit("websocket-end",this.container,this))},WebSocketClient.prototype.send=function(e,t,r){if(this.isClosed)return this;if(1!==this.type){var o=3===this.type?t?e:JSON.stringify(e,r):(e||"").toString();F.config["default-websocket-encodedecode"]===!0&&o&&(o=encodeURIComponent(o)),this.deflate?(this.deflatepending.push(U.createBuffer(o)),this.sendDeflate()):this.socket.write(U.getWebSocketFrame(0,o,1))}else e&&(this.deflate?(this.deflatepending.push(U.createBuffer(e)),this.sendDeflate()):this.socket.write(U.getWebSocketFrame(0,new Int8Array(e),2)));return this},WebSocketClient.prototype.sendDeflate=function(){var e=this;if(!e.deflatelock){var t=e.deflatepending.shift();t&&(e.deflatechunks=[],e.deflatechunkslength=0,e.deflatelock=!0,e.deflate.write(t),e.deflate.flush(function(){if(e.deflatechunks){var t=buffer_concat(e.deflatechunks,e.deflatechunkslength);t=t.slice(0,t.length-4),e.deflatelock=!1,e.deflatechunks=null,e.socket.write(U.getWebSocketFrame(0,t,1===e.type?2:1,!0)),e.sendDeflate()}}))}},WebSocketClient.prototype.ping=function(){return this.isClosed||(this.socket.write(U.getWebSocketFrame(0,"PING",9)),this.$ping=!1),this},WebSocketClient.prototype.close=function(e,t){return this.isClosed||(this.isClosed=!0,this.socket.end(U.getWebSocketFrame(t||1e3,e?F.config["default-websocket-encodedecode"]?encodeURIComponent(e):e:"",8))),this},WebSocketClient.prototype.$websocket_key=function(e){var t=Crypto.createHash("sha1");return t.update((e.headers["sec-websocket-key"]||"")+SOCKET_HASH),t.digest("base64")},global.Controller=Controller,process.on("SIGTERM",function(){F.stop()}),process.on("SIGINT",function(){F.stop()}),process.on("exit",function(){F.stop()}),process.on("message",function(e,t){"total:debug"===e?U.wait(function(){return F.isLoaded},function(){F.isLoaded=void 0,F.console()},1e4,500):"reconnect"===e?F.reconnect():"reset"===e?F.cache.clear():"stop"===e||"exit"===e||"kill"===e?F.stop():e&&e.TYPE&&e.id!==F.id&&("cache-set"===e.TYPE&&F.cache.set(e.key,e.value,e.expire,!1),"cache-remove"===e.TYPE&&F.cache.remove(e.key,!1),"cache-remove-all"===e.TYPE&&F.cache.removeAll(e.key,!1),"cache-clear"===e.TYPE&&F.cache.clear(!1),"nosql-lock"===e.TYPE&&F.databases[e.name]&&F.databases[e.name].lock(),"nosql-unlock"===e.TYPE&&F.databases[e.name]&&F.databases[e.name].unlock(),"nosql-meta"===e.TYPE&&F.databases[e.name]&&F.databases[e.name].$meta(),"nosql-counter-lock"===e.TYPE&&F.databases[e.name]&&(F.databases[e.name].counter.locked=!0),"nosql-counter-unlock"===e.TYPE&&F.databases[e.name]&&(F.databases[e.name].counter.locked=!1),"req"===e.TYPE&&F.cluster.req(e),"res"===e.TYPE&&e.target===F.id&&F.cluster.res(e),"emit"===e.TYPE&&F.$events[e.name]&&F.emit(e.name,e.data)),F.$events.message&&F.emit("message",e,t)}),global.setTimeout2=function(e,t,r,o,n){var i=":"+e;if(o>0){var s=i+":limit";if(F.temporary.internal[s]>=o)return;return F.temporary.internal[s]=(F.temporary.internal[s]||0)+1,F.temporary.internal[i]&&clearTimeout(F.temporary.internal[i]),F.temporary.internal[i]=setTimeout(function(e){F.temporary.internal[s]=void 0,t&&t(e)},r,n)}return F.temporary.internal[i]&&clearTimeout(F.temporary.internal[i]),F.temporary.internal[i]=setTimeout(t,r,n)},global.clearTimeout2=function(e){var t=":"+e;return F.temporary.internal[t]?(clearTimeout(F.temporary.internal[t]),F.temporary.internal[t]=void 0,F.temporary.internal[t+":limit"]&&(F.temporary.internal[t+":limit"]=void 0),!0):!1};const EMPTYCONTROLLER=new Controller("",null,null,"");EMPTYCONTROLLER.isConnected=!1,EMPTYCONTROLLER.req={},EMPTYCONTROLLER.req.url="",EMPTYCONTROLLER.req.uri=EMPTYOBJECT,EMPTYCONTROLLER.req.query=EMPTYOBJECT,EMPTYCONTROLLER.req.body=EMPTYOBJECT,EMPTYCONTROLLER.req.files=EMPTYARRAY,global.EMPTYCONTROLLER=EMPTYCONTROLLER,global.LOGMAIL=F.logmail,global.MAIL=F.mail;