"use strict";function SchemaBuilder(e){this.name=e,this.collection={}}function SchemaOptions(e,t,r,o,n){this.error=e,this.value=this.model=t,this.options=r,this.callback=this.next=o,this.controller=n}function SchemaBuilderEntity(e,t){this.parent=e,this.name=t,this.primary,this.trim=!0,this.schema={},this.meta={},this.properties=[],this.inherits=[],this.resourcePrefix,this.resourceName,this.transforms,this.workflows,this.hooks,this.operations,this.constants,this.onPrepare,this.$onPrepare,this.onDefault,this.$onDefault,this.onValidate=F.onValidate,this.onSave,this.onGet,this.onRemove,this.onQuery,this.onError,this.gcache={},this.dependencies,this.fields,this.fields_allow,this.CurrentSchemaInstance=function(){},this.CurrentSchemaInstance.prototype=new SchemaInstance,this.CurrentSchemaInstance.prototype.$$schema=this}function copy_inherit(e,t,r){return r?r&&!e[t]?void(e[t]=framework_utils.clone(r)):void Object.keys(r).forEach(function(o){void 0===e[t][o]&&(e[t][o]=framework_utils.clone(r[o]))}):void 0}function parseLength(e,t){t.raw="string";var r=e.indexOf("( ");return-1!==r&&(t.length=e.substring(r+1,e.length-1).parseInt(),t.raw=e.substring(0,r)),t}function isGenerator(e,t,r){return e.gcache[t]?e.gcache[t]:e.gcache[t]="function*"===r.toString().substring(0,9)}function autotrim(e,t){return e.trim?t.trim():t}function copy(e){return F.isSuccess(e)?{success:e.success,value:e.value}:e}function clone(e){if(!e)return e;var t=typeof e;if("object"!==t||e instanceof Date)return e;var r,o;if(e instanceof Array){r=e.length,o=new Array(r);for(var n=0;r>n;n++)t=typeof e[n],"object"!==t||e[n]instanceof Date?"function"!==t&&(o[n]=e[n]):o[n]=clone(e[n]);return o}o={};for(var i in e)if(!SKIP[i]){var s=e[i];if(s instanceof SchemaInstance)o[i]=clone(s);else{var t=typeof s;"object"!==t||s instanceof Date?"function"!==t&&(o[i]=s):o[i]=clone(e[i])}}return o}function SchemaInstance(){}function async_continue(e){e.$$can=!1,async_queue(e.$$async,function(){e.$$callback(null,void 0!==e.$$index?e.$$result[e.$$index]:e.$$result),e.$$callback=null})}function ErrorBuilder(e){this.items=[],this.transformName=transforms.error_default,this.onResource=e,this.resourceName=F.config["default-errorbuilder-resource-name"],this.resourcePrefix=F.config["default-errorbuilder-resource-prefix"]||"",this.isResourceCustom=!1,this.count=0,this.replacer=[],this.isPrepared=!1,this.contentType="application/json",this.status=F.config["default-errorbuilder-status"]||200,!e&&this._resource()}function UrlBuilder(){this.builder={}}function isUndefined(e,t){return void 0===e?t:e}function Pagination(e,t,r,o){this.isNext=!1,this.isPrev=!1,this.isFirst=!1,this.isLast=!1,this.nextPage=0,this.prevPage=0,this.lastPage=0,this.firstPage=0,this.items=Math.max(0,+e),this.count=0,this.skip=0,this.take=0,this.page=0,this.max=0,this.visible=!1,this.format=o||"?page={0}",this.refresh(e,t,r),this.transformName=transforms.pagination_default}function Page(e,t,r,o){this.url=e,this.page=t,this.selected=r,this.enabled=o}function TransformBuilder(){}function async_queue(e,t){var r=e.shift();r?r(function(){return async_queue(e,t)}):t()}function async_wait(e,t,r,o){var n=e[o];n?t(n,function(){return async_wait(e,t,r,o+1)},o):r()}function RESTBuilder(e){this.$url=e,this.$headers={"user-agent":"Total.js/v"+F.version_header,accept:"application/json, text/plain, text/plain, text/xml"},this.$method="get",this.$timeout=1e4,this.$type=0,this.$schema,this.$length=0,this.$transform=transforms.restbuilder_default,this.$files=null,this.$persistentcookies=!1}function exec_removelisteners(e){e.removeAllListeners()}function RESTBuilderResponse(){}function $decodeURIComponent(e){try{return decodeURIComponent(e)}catch(t){return e}}function OperationOptions(e,t,r){this.model=this.value=t,this.error=e,this.options=r}const REQUIRED='The field "@" is invalid.',DEFAULT_SCHEMA="default",SKIP={$$schema:!0,$$result:!0,$$callback:!0,$$async:!0,$$index:!0,$$repository:!0,$$can:!0,$$controller:!0},REGEXP_CLEAN_EMAIL=/\s/g,REGEXP_CLEAN_PHONE=/\s|\.|-|\(|\)/g,REGEXP_NEWOPERATION=/^(async\s)?function(\s)?\([a-zA-Z0-9$]+\)|^function anonymous\(\$/,hasOwnProperty=Object.prototype.hasOwnProperty,Qs=require("querystring");var schemas={},operations={},transforms={pagination:{},error:{},transformbuilder:{},restbuilder:{}};SchemaOptions.prototype={get user(){return this.controller?this.controller.user:null},get session(){return this.controller?this.controller.session:null},get language(){return(this.controller?this.controller.language:"")||""},get ip(){return this.controller?this.controller.ip:null},get id(){return this.controller?this.controller.id:null},get params(){return this.controller?this.controller.params:null},get files(){return this.controller?this.controller.files:null},get body(){return this.controller?this.controller.body:null},get query(){return this.controller?this.controller.query:null}},SchemaOptions.prototype.DB=function(){return F.database(this.error)},SchemaOptions.prototype.success=function(e,t){return e&&void 0===t&&"boolean"!=typeof e&&(t=e,e=!0),this.callback(SUCCESS(void 0===e?!0:e,t)),this},SchemaOptions.prototype.done=function(e){var t=this;return function(r,o){!r||r instanceof ErrorBuilder||(t.error.push(r),t.callback()),e?t.callback(SUCCESS(null==r,o)):t.callback(SUCCESS(null==r))}},SchemaOptions.prototype.invalid=function(e,t,r,o){return this.error.push(e,t,r,o),this.callback(),this},SchemaOptions.prototype.repository=function(e,t){return this.model&&this.model.$repository?this.model.$repository(e,t):t},SchemaBuilder.prototype.get=function(e){return this.collection[e]},SchemaBuilder.prototype.create=function(e){return this.collection[e]=new SchemaBuilderEntity(this,e),this.collection[e]},SchemaBuilder.prototype.remove=function(e){if(e){var t=this.collection[e];t&&t.destroy(),t=null,delete this.collection[e]}else delete schemas[this.name],this.collection=null},SchemaBuilder.prototype.destroy=function(e){return this.remove(e)},SchemaBuilderEntity.prototype.allow=function(){var e=this;e.fields_allow||(e.fields_allow=[]);for(var t=0,r=arguments.length;r>t;t++)arguments[t]instanceof Array?arguments[t].forEach(function(t){e.fields_allow.push(t)}):e.fields_allow.push(arguments[t]);return e},SchemaBuilderEntity.prototype.required=function(e,t){var r=this;if(!e)return r;if(-1!==e.indexOf(",")){for(var o=e.split(","),n=0;n<o.length;n++)r.required(o[n].trim(),t);return r}if(t===!1)return r.properties&&(r.properties=r.properties.remove(e)),r;var i=r.schema[e];if(!i)throw new Error('Property "{0}" doesn\'t exist in "{1}" schema.'.format(e,r.name));return i.can="function"==typeof t?t:null,i.required||(i.required=!0,r.properties?-1===r.properties.indexOf(e)&&r.properties.push(e):r.properties=[e]),r},SchemaBuilderEntity.prototype.define=function(e,t,r,o){if(e instanceof Array){for(var n=0,i=e.length;i>n;n++)this.define(e[n],t,r,o);return this}var s=typeof r;switch(void 0!==r&&"string"===s&&(o=r,r=!1),t instanceof SchemaBuilderEntity&&(t=t.name),this.schema[e]=this.$parse(e,t,r,o),this.schema[e].type){case 7:this.dependencies?this.dependencies.push(e):this.dependencies=[e]}return this.fields=Object.keys(this.schema),r&&(null==this.properties&&(this.properties=[]),-1===this.properties.indexOf(e)&&this.properties.push(e)),this},SchemaBuilderEntity.prototype.inherit=function(e,t){t||(t=e,e=DEFAULT_SCHEMA);var r=this;return exports.getschema(e,t,function(e,t){if(e)throw e;r.primary=t.primary,r.inherits.push(t),!r.resourceName&&t.resourceName&&(r.resourceName=t.resourceName),!r.resourcePrefix&&t.resourcePrefix&&(r.resourcePrefix=t.resourcePrefix),copy_inherit(r,"schema",t.schema),copy_inherit(r,"meta",t.meta),copy_inherit(r,"transforms",t.transforms),copy_inherit(r,"workflows",t.workflows),copy_inherit(r,"hooks",t.hooks),copy_inherit(r,"operations",t.operations),copy_inherit(r,"constants",t.constants),t.properties.forEach(function(e){-1===r.properties.indexOf(e)&&r.properties.push(e)}),t.onPrepare&&(r.$onPrepare||(r.$onPrepare=[]),r.$onPrepare.push(t.onPrepare)),t.onDefault&&(r.$onDefault||(r.$onDefault=[]),r.$onDefault.push(t.onDefault)),r.onValidate===F.onValidate&&r.onValidate!==t.onValidate&&(r.onValidate=t.onValidate),!r.onSave&&t.onSave&&(r.onSave=t.onSave),!r.onGet&&t.onGet&&(r.onGet=t.onGet),!r.onRemove&&t.onRemove&&(r.onRemove=t.onRemove),!r.onQuery&&t.onQuery&&(r.onQuery=t.onQuery),!r.onError&&t.onError&&(r.onError=t.onError),r.fields=Object.keys(r.schema)}),r},SchemaBuilderEntity.prototype.setPrimary=function(e){return this.primary=e,this},SchemaBuilderEntity.prototype.filter=function(e,t,r){if("boolean"==typeof t){var o=r;r=t,t=o}var n=void 0===t?[]:{},i=typeof e,s="string"===i?"*"===e[0]||"%"===e[0]:!1,a=!1;s?e=e.substring(1):"object"===i&&(a=framework_utils.isRegExp(e));for(var u in this.schema){var c=this.schema[u];if(c){var h=typeof c.custom;if(s){if("string"!==h)continue;if(-1===c.custom.indexOf(e)){if(!r)continue}else if(r)continue}else if(a){if("string"!==h)continue;if(e.test(c.current)){if(r)continue}else if(!r)continue}else if(c.custom!==e){if(!r)continue}else if(r)continue;void 0===t?n.push(u):n[u]=t[u]}}return n},SchemaBuilderEntity.prototype.$parse=function(e,t,r,o){var n=typeof t,i={};if(i.raw=t,i.type=0,i.length=0,i.required=r?!0:!1,i.validate="function"==typeof r?r:null,i.can=null,i.isArray=!1,i.custom=o||"",null===t)return i;if("[]"===t)return i.isArray=!0,i;if("function"===n)return t===Number?(i.type=2,i):t===String?(i.type=3,i):t===Boolean?(i.type=4,i):t===Date?(i.type=5,i):t===Array?(i.isArray=!0,i):t===Object?(i.type=6,i):i;if("object"===n)return t instanceof Array?(i.type=8,i.subtype=typeof t[0]):i.type=9,i;"["===t[0]&&(t=t.substring(1,t.length-1),i.isArray=!0,i.raw=t);var s=t.toLowerCase();return"object"===s?(i.type=6,i):"array"===s?(i.isArray=!0,i):/^(string|text)+(\(\d+\))?$/.test(s)?(i.type=3,parseLength(s,i)):/^(capitalize|camelcase|camelize)+(\(\d+\))?$/.test(s)?(i.type=3,i.subtype="capitalize",parseLength(s,i)):/^(lower|lowercase)+(\(\d+\))?$/.test(s)?(i.subtype="lowercase",i.type=3,parseLength(s,i)):/^(upper|uppercase)+(\(\d+\))?$/.test(s)?(i.subtype="uppercase",i.type=3,parseLength(s,i)):"uid"===s?(i.type=3,i.length=20,i.raw="string",i.subtype="uid",i):"email"===s?(i.type=3,i.length=120,i.raw="string",i.subtype="email",i):"json"===s?(i.type=3,i.raw="string",i.subtype="json",i):"url"===s?(i.type=3,i.length=500,i.raw="string",i.subtype="url",i):"zip"===s?(i.type=3,i.length=10,i.raw="string",i.subtype="zip",i):"phone"===s?(i.type=3,i.length=20,i.raw="string",i.subtype="phone",i):-1!==["int","integer","byte"].indexOf(s)?(i.type=1,i):-1!==["decimal","number","float","double"].indexOf(s)?(i.type=2,i):-1!==["bool","boolean"].indexOf(s)?(i.type=4,i):-1!==["date","time","datetime"].indexOf(s)?(i.type=5,i):(i.type=7,i)},SchemaBuilderEntity.prototype.getDependencies=function(){var e=[];for(var t in this.schema){var r=this.schema[t];if("string"==typeof r){var o=" ]"===r[0];o&&(r=r.substring(1,r.length-1));var n=this.parent.get(r);n&&e.push({name:t,isArray:o,schema:n})}}return e},SchemaBuilderEntity.prototype.setValidate=function(e,t){return void 0===t&&e instanceof Array?(this.properties=e,this):("function"!=typeof e?(this.properties=e,this.onValidate=t):this.onValidate=e,this)},SchemaBuilderEntity.prototype.setPrefix=function(e){return this.resourcePrefix=e,this},SchemaBuilderEntity.prototype.setResource=function(e){return this.resourceName=e,this},SchemaBuilderEntity.prototype.setDefault=function(e){return this.onDefault=e,this},SchemaBuilderEntity.prototype.setPrepare=function(e){return this.onPrepare=e,this},SchemaBuilderEntity.prototype.setSave=function(e,t){return e.$newversion=REGEXP_NEWOPERATION.test(e.toString()),this.onSave=e,this.meta.save=t,this},SchemaBuilderEntity.prototype.setError=function(e){return this.onError=e,this},SchemaBuilderEntity.prototype.setGet=SchemaBuilderEntity.prototype.setRead=function(e,t){return e.$newversion=REGEXP_NEWOPERATION.test(e.toString()),this.onGet=e,this.meta.get=t,this},SchemaBuilderEntity.prototype.setQuery=function(e,t){return e.$newversion=REGEXP_NEWOPERATION.test(e.toString()),this.onQuery=e,this.meta.query=t,this},SchemaBuilderEntity.prototype.setRemove=function(e,t){return e.$newversion=REGEXP_NEWOPERATION.test(e.toString()),this.onRemove=e,this.meta.remove=t,this},SchemaBuilderEntity.prototype.constant=function(e,t,r){return void 0===t?this.constants?this.constants[e]:void 0:(!this.constants&&(this.constants={}),this.constants[e]=t,this.meta["constant#"+e]=r,this)},SchemaBuilderEntity.prototype.addTransform=function(e,t,r){return"function"==typeof e&&(t=e,e="default"),t.$newversion=REGEXP_NEWOPERATION.test(t.toString()),!this.transforms&&(this.transforms={}),this.transforms[e]=t,this.meta["transform#"+e]=r,this},SchemaBuilderEntity.prototype.addOperation=function(e,t,r){return"function"==typeof e&&(t=e,e="default"),t.$newversion=REGEXP_NEWOPERATION.test(t.toString()),!this.operations&&(this.operations={}),this.operations[e]=t,this.meta["operation#"+e]=r,this},SchemaBuilderEntity.prototype.addWorkflow=function(e,t,r){return"function"==typeof e&&(t=e,e="default"),t.$newversion=REGEXP_NEWOPERATION.test(t.toString()),!this.workflows&&(this.workflows={}),this.workflows[e]=t,this.meta["workflow#"+e]=r,this},SchemaBuilderEntity.prototype.addHook=function(e,t,r){return this.hooks||(this.hooks={}),t.$newversion=REGEXP_NEWOPERATION.test(t.toString()),!this.hooks[e]&&(this.hooks[e]=[]),this.hooks[e].push({owner:F.$owner(),fn:t}),this.meta["hook#"+e]=r,this},SchemaBuilderEntity.prototype.find=function(e){return this.parent.get(e)},SchemaBuilderEntity.prototype.destroy=function(){delete this.parent.collection[this.name],this.properties=void 0,this.schema=void 0,this.onDefault=void 0,this.$onDefault=void 0,this.onValidate=void 0,this.onSave=void 0,this.onRead=void 0,this.onGet=void 0,this.onRemove=void 0,this.onQuery=void 0,this.workflows=void 0,this.operations=void 0,this.transforms=void 0,this.meta=void 0,this.newversion=void 0,this.properties=void 0,this.hooks=void 0,this.constants=void 0,this.onPrepare=void 0,this.$onPrepare=void 0,this.onError=void 0,this.gcache=void 0,this.dependencies=void 0,this.fields=void 0,this.fields_allow=void 0},SchemaBuilderEntity.prototype.save=function(e,t,r,o,n){if("boolean"==typeof r?(n=r,r=t,t=void 0):"function"==typeof t&&(r=t,t=void 0),"boolean"==typeof o){var i=n;n=o,o=i}"function"!=typeof r&&(r=function(){});var s=this,a="save";return s.$prepare(e,function(e,i){if(e)return void r(e,i);i&&!o&&i.$$controller&&(o=i.$$controller);var u=new ErrorBuilder;if(s.resourceName&&u.setResource(s.resourceName),s.resourcePrefix&&u.setPrefix(s.resourcePrefix),!isGenerator(s,a,s.onSave))return s.onSave.$newversion?s.onSave(new SchemaOptions(u,i,t,function(e){s.$process(arguments,i,a,void 0,u,e,r)},o)):s.onSave(u,i,t,function(e){s.$process(arguments,i,a,void 0,u,e,r)},o,n!==!0),s;r.success=!1;var c=function(e){e&&!r.success&&(r.success=!0,u.push(e),s.onError&&s.onError(u,i,a),r(u))},h=function(e){if(!r.success){(2===arguments.length||e instanceof Error||e instanceof ErrorBuilder)&&((e instanceof Error||e instanceof ErrorBuilder)&&u!==e&&u.push(e),e=arguments[1]);var t=u.hasError();t&&s.onError&&s.onError(u,i,a),r.success=!0,r(t?u:null,void 0===e?i:e)}};s.onSave.$newversion?async.call(s,s.onSave)(c,new SchemaOptions(u,i,t,h,o)):async.call(s,s.onSave)(c,u,i,t,h,o,n!==!0)}),s},SchemaBuilderEntity.prototype.get=SchemaBuilderEntity.prototype.read=function(e,t,r){"function"==typeof e&&(t=e,e=void 0),"function"!=typeof t&&(t=function(){});var o=this,n=new ErrorBuilder;o.resourceName&&n.setResource(o.resourceName),o.resourcePrefix&&n.setPrefix(o.resourcePrefix);var i=o["default"](),s="get";if(!isGenerator(o,s,o.onGet))return o.onGet.$newversion?o.onGet(new SchemaOptions(n,i,e,function(e){o.$process(arguments,i,s,void 0,n,e,t)},r)):o.onGet(n,i,e,function(e){o.$process(arguments,i,s,void 0,n,e,t)},r),o;t.success=!1;var a=function(e){e&&!t.success&&(t.success=!0,n.push(e),o.onError&&o.onError(n,i,s),t(n))},u=function(e){if(!t.success){(2===arguments.length||e instanceof Error||e instanceof ErrorBuilder)&&((e instanceof Error||e instanceof ErrorBuilder)&&n!==e&&n.push(e),e=arguments[1]),t.success=!0;var r=n.hasError();r&&o.onError&&o.onError(n,i,s),t(r?n:null,void 0===e?i:e)}};return o.onGet.$newversion?async.call(o,o.onGet)(a,new SchemaOptions(n,i,e,u,r)):async.call(o,o.onGet)(a,n,i,e,u,r),o},SchemaBuilderEntity.prototype.remove=function(e,t,r){"function"==typeof e&&(t=e,e=void 0);var o=this,n=new ErrorBuilder,i="remove";if(o.resourceName&&n.setResource(o.resourceName),o.resourcePrefix&&n.setPrefix(o.resourcePrefix),!isGenerator(o,i,o.onRemove))return o.onRemove.$newversion?o.onRemove(new SchemaOptions(n,void 0,e,function(e){o.$process(arguments,void 0,i,void 0,n,e,t)},r)):o.onRemove(n,e,function(e){o.$process(arguments,void 0,i,void 0,n,e,t)},r),o;t.success=!1;var s=function(e){e&&!t.success&&(t.success=!0,n.push(e),o.onError&&o.onError(n,EMPTYOBJECT,i),t(n))},a=function(r){if(!t.success){(2===arguments.length||r instanceof Error||r instanceof ErrorBuilder)&&((r instanceof Error||r instanceof ErrorBuilder)&&n!==r&&n.push(r),r=arguments[1]);var s=n.hasError();s&&o.onError&&o.onError(n,EMPTYOBJECT,i),t.success=!0,t(s?n:null,void 0===r?e:r)}};return o.onRemove.$newversion?async.call(o,o.onRemove)(s,new SchemaOptions(n,void 0,e,a,r)):async.call(o,o.onRemove)(s,n,e,a,r),o},SchemaBuilderEntity.prototype.query=function(e,t,r){"function"==typeof e&&(t=e,e=void 0);var o=this,n=new ErrorBuilder,i="query";if(o.resourceName&&n.setResource(o.resourceName),o.resourcePrefix&&n.setPrefix(o.resourcePrefix),!isGenerator(o,i,o.onQuery))return o.onQuery.$newversion?o.onQuery(new SchemaOptions(n,void 0,e,function(e){o.$process(arguments,void 0,i,void 0,n,e,t)},r)):o.onQuery(n,e,function(e){o.$process(arguments,void 0,i,void 0,n,e,t)},r),o;t.success=!1;var s=function(e){e&&!t.success&&(t.success=!0,n.push(e),o.onError&&o.onError(n,EMPTYOBJECT,i),t(n))},a=function(e){if(!t.success){(2===arguments.length||e instanceof Error||e instanceof ErrorBuilder)&&((e instanceof Error||e instanceof ErrorBuilder)&&n!==e&&n.push(e),e=arguments[1]);var r=n.hasError();r&&o.onError&&o.onError(n,EMPTYOBJECT,i),t.success=!0,t(n.hasError()?n:null,e)}};return o.onQuery.$newversion?async.call(o,o.onQuery)(s,new SchemaOptions(n,void 0,e,a,r)):async.call(o,o.onQuery)(s,n,e,a,r),o},SchemaBuilderEntity.prototype.validate=function(e,t,r,o,n,i,s){var a=this;return void 0===o&&(o=new ErrorBuilder,a.resourceName&&o.setResource(a.resourceName),a.resourcePrefix&&o.setPrefix(a.resourcePrefix)),a.resourcePrefix&&(o.resourcePrefix=a.resourcePrefix),a.resourceName&&(o.resourceName=a.resourceName),r&&(o.resourceName=r),t&&(o.resourcePrefix=t),n&&(n=a.filter(n)),i?i+=".":i="",framework_utils.validate_builder.call(a,e,o,a.name,a.parent.collection,a.name,s,n,i),o},SchemaBuilderEntity.prototype.create=function(){return this["default"]()},SchemaBuilderEntity.prototype.Create=function(){return this["default"]()},SchemaBuilderEntity.prototype.$make=function(e){return e},SchemaBuilderEntity.prototype.$prepare=function(e,t){return e&&"function"==typeof e.$save?t(null,e):this.make(e,function(e,r){t(e,r)}),this},SchemaBuilderEntity.prototype["default"]=function(){var e=this.schema;if(null===e)return null;var t=new this.CurrentSchemaInstance,r=this.onDefault||this.$onDefault?!0:!1;for(var o in e){var n=e[o];if(r){var i=this.$ondefault(o,!0,this.name);if(void 0!==i){t[o]=i;continue}}switch(n.type){case 0:case 6:t[o]=n.isArray?[]:null;break;case 1:case 2:t[o]=n.isArray?[]:0;break;case 3:t[o]=n.isArray?[]:"";break;case 4:t[o]=n.isArray?[]:!1;break;case 5:t[o]=n.isArray?[]:F.datetime;break;case 7:if(n.isArray)t[o]=[];else{var s=this.find(n.raw);s?t[o]=s["default"]():(F.error(new Error('Schema : "'+o+"."+n.raw+'" not found in "'+this.parent.name+'".')),t[o]=null)}break;case 8:case 9:t[o]=void 0}}return t},SchemaBuilderEntity.prototype.make=function(e,t,r,o,n){if("function"==typeof e)return e.call(this,this),this;if("function"==typeof t){var i=r;r=t,t=i}var s=this.prepare(e);if(n)return r&&r(null,s,o),s;var a=this.validate(s,void 0,void 0,void 0,t);return a.hasError()?(this.onError&&this.onError(a,e,"make"),r&&r(a,null,o),s):(r&&r(null,s,o),s)},SchemaBuilderEntity.prototype.load=SchemaBuilderEntity.prototype.make,SchemaBuilderEntity.prototype.$onprepare=function(e,t,r,o){var n=t;if(this.$onPrepare)for(var i=0,s=this.$onPrepare.length;s>i;i++){var a=this.$onPrepare[i](e,n,r,o);void 0!==a&&(n=a)}return this.onPrepare&&(n=this.onPrepare(e,n,r,o)),void 0===n?t:n},SchemaBuilderEntity.prototype.$ondefault=function(e,t,r){var o;if(this.onDefault&&(o=this.onDefault(e,t,r),void 0!==o))return o;if(this.$onDefault)for(var n=0,i=this.$onDefault.length;i>n;n++)if(o=this.$onDefault[n](e,t,r),void 0!==o)return o},SchemaBuilderEntity.prototype.prepare=function(e,t){var r=this,o=r.schema;if(null===o)return null;if(null==e)return r["default"]();var n,i,s=new r.CurrentSchemaInstance,a=r.onDefault||r.$onDefault?!0:!1;for(var u in o){var c=e[u];hasOwnProperty.call(e,u)||(c=void 0),void 0===c&&a&&(c=r.$ondefault(u,!1,r.name)),void 0===c&&(c="");var h=o[u],l=typeof c;if("function"===l&&(c=c()),h.isArray)if(c instanceof Array){s[u]=[];for(var p=0,f=c.length;f>p;p++){switch(n=c[p],l=typeof n,h.type){case 0:n=r.$onprepare(u,n,p,e);break;case 1:n=r.$onprepare(u,framework_utils.parseInt(n),p,e);break;case 2:n=r.$onprepare(u,framework_utils.parseFloat(n),p,e);break;case 3:switch(n=null==n?"":autotrim(r,n.toString()),h.length&&n.length<n.length&&(n=n.substring(0,h.length)),h.subtype){case"uid":if(n&&!h.required&&!n.isUID())continue;break;case"url":if(n&&!h.required&&!n.isURL())continue;break;case"email":if(n=n.toLowerCase().replace(REGEXP_CLEAN_EMAIL,""),n&&!h.required&&!n.isEmail())continue;break;case"phone":if(n=n.replace(REGEXP_CLEAN_PHONE,""),n&&!h.required&&!n.isPhone())continue;break;case"capitalize":n=n.capitalize();break;case"lowercase":n=n.toLowerCase();break;case"uppercase":n=n.toUpperCase();break;case"json":if(n&&!h.required&&!n.isJSON())continue}n=r.$onprepare(u,n,p,e);break;case 4:n&&(n=n.toString().toLowerCase()),n=r.$onprepare(u,"true"===n||"1"===n||"on"===n,p,e);break;case 5:"string"===l?n&&(n=n.trim().parseDate()):"number"===l&&(n=new Date(n)),n=framework_utils.isDate(n)?r.$onprepare(u,n,p,e):void 0;break;case 6:n=r.$onprepare(u,n,p,e);break;case 7:i=r.parent.get(h.raw),i?(n=i.prepare(n,t),t&&t.push({name:h.raw,value:r.$onprepare(u,n,p,e)})):n=null,n=r.$onprepare(u,n,p,e)}void 0!==n&&s[u].push(n)}}else s[u]=a?isUndefined(r.$ondefault(u,!1,r.name),[]):[];else switch(h.type){case 0:break;case 1:s[u]=r.$onprepare(u,framework_utils.parseInt(c),void 0,e);break;case 2:s[u]=r.$onprepare(u,framework_utils.parseFloat(c),void 0,e);break;case 3:var d=typeof c;switch(n=null==c||"object"===d?"":"string"===d?autotrim(r,c):autotrim(r,c.toString()),h.length&&h.length<n.length&&(n=n.substring(0,h.length)),h.subtype){case"uid":!n||h.required||n.isUID()||(n="");break;case"email":n=n.toLowerCase().replace(REGEXP_CLEAN_EMAIL,""),!n||h.required||n.isEmail()||(n="");break;case"url":!n||h.required||n.isURL()||(n="");break;case"zip":!n||h.required||n.isZIP()||(n="");break;case"phone":n=n.replace(REGEXP_CLEAN_PHONE,""),!n||h.required||n.isPhone()||(n="");break;case"capitalize":n=n.capitalize();break;case"lowercase":n=n.toLowerCase();break;case"uppercase":n=n.toUpperCase();break;case"json":!n||h.required||n.isJSON()||(n="")}s[u]=r.$onprepare(u,n,void 0,e);break;case 4:n=c?c.toString().toLowerCase():null,s[u]=r.$onprepare(u,"true"===n||"1"===n||"on"===n,void 0,e);break;case 5:n=null,"string"===l?c&&(n=c.trim().parseDate()):n="number"===l?new Date(c):c,n=framework_utils.isDate(n)?r.$onprepare(u,n,void 0,e):a?isUndefined(r.$ondefault(u,!1,r.name),null):null,s[u]=n;break;case 6:s[u]=r.$onprepare(u,e[u],void 0,e);break;case 8:n=r.$onprepare(u,e[u],void 0,e),"number"===h.subtype&&"string"==typeof n&&(n=n.parseFloat(null)),s[u]=null!=n&&-1!==h.raw.indexOf(n)?n:void 0;break;case 9:n=r.$onprepare(u,e[u],void 0,e),s[u]=null!=n?h.raw[n]:void 0;break;case 7:if(!c&&(c=a?isUndefined(r.$ondefault(u,!1,r.name),null):null,null===c)){s[u]=null;break}if(c&&"function"==typeof c.$schema&&(n=c.$schema(),n&&n.name&&n.name===h.raw)){s[u]=c;break}i=r.parent.get(h.raw),i?(s[u]=i.prepare(c,void 0),t&&t.push({name:h.raw,value:r.$onprepare(u,s[u],void 0,e)})):s[u]=null}}if(r.fields_allow)for(var m=0,y=r.fields_allow.length;y>m;m++){var $=r.fields_allow[m],c=e[$];void 0!==c&&(s[$]=c)}return s},SchemaBuilderEntity.prototype.transform=function(e,t,r,o,n,i){return this.$execute("transform",e,t,r,o,n,i)},SchemaBuilderEntity.prototype.transform2=function(e,t,r,o){return"function"==typeof t&&(r=t,t=void 0),!r&&(r=function(){}),this.transform(e,this.create(),t,r,!0,o)},SchemaBuilderEntity.prototype.$process=function(e,t,r,o,n,i,s){var a=this;(e.length>1||i instanceof Error||i instanceof ErrorBuilder)&&((i instanceof Error||i instanceof ErrorBuilder||"string"==typeof i)&&n!==i&&n.push(i),i=e[1]);var u=n.hasError();return u&&a.onError&&a.onError(n,t,r,o),s(u?n:null,void 0===i?t:i,t),a},SchemaBuilderEntity.prototype.$process_hook=function(e,t,r,o,n,i){var s=this,a=o.hasError();return a&&s.onError&&s.onError(o,e,t,r),i(a?o:null,e),s},SchemaBuilderEntity.prototype.workflow=function(e,t,r,o,n,i){return this.$execute("workflow",e,t,r,o,n,i)},SchemaBuilderEntity.prototype.workflow2=function(e,t,r,o){return"function"==typeof t&&(r=t,t=void 0),!r&&(r=function(){}),this.workflow(e,this.create(),t,r,!0,o)},SchemaBuilderEntity.prototype.hook=function(e,t,r,o,n,i){var s=this;"string"!=typeof e&&(o=r,r=t,t=e,e="default"),"boolean"==typeof o?(n=o,o=r,r=void 0):"function"==typeof r&&(o=r,r=void 0),"function"!=typeof o&&(o=function(){});var a=s.hooks?s.hooks[e]:void 0;if(!a||!a.length)return o(null,t),s;t&&!i&&t.$$controller&&(i=t.$$controller);var u="hook";if(n===!0){var c=new ErrorBuilder;s.resourceName&&c.setResource(s.resourceName),s.resourcePrefix&&c.setPrefix(s.resourcePrefix);var h=[];return async_wait(a,function(e,o){e.fn.$newversion?e.fn.call(s,new SchemaOptions(c,t,r,function(e){h.push(void 0==e?t:e),o()},i)):e.fn.call(s,c,t,r,function(e){h.push(void 0==e?t:e),o()},i,n!==!0)},function(){s.$process_hook(t,u,e,c,h,o)},0),s}return s.$prepare(t,function(t,c){if(t)return void o(t,c);var h=new ErrorBuilder,l=[];s.resourceName&&h.setResource(s.resourceName),s.resourcePrefix&&h.setPrefix(s.resourcePrefix),async_wait(a,function(t,a,u){return isGenerator(s,"hook."+e+"."+u,t.fn)?(o.success=!1,void(t.fn.$newversion?async.call(s,t.fn)(function(e){e&&(h.push(e),a())},new SchemaOptions(h,c,r,function(e){l.push(void 0==e?c:e),a()},i)):async.call(s,t.fn)(function(e){e&&(h.push(e),a())},h,c,r,function(e){l.push(void 0==e?c:e),a()},i,n!==!0))):void(t.fn.$newversion?t.fn.call(s,new SchemaOptions(h,c,r,function(e){l.push(void 0===e?c:e),a()},i)):t.fn.call(s,h,c,r,function(e){l.push(void 0===e?c:e),a()},i,n!==!0))},function(){return s.$process_hook(c,u,e,h,l,o)},0)}),s},SchemaBuilderEntity.prototype.hook2=function(e,t,r,o){return"function"==typeof t&&(r=t,t=void 0),r||(r=function(){}),this.hook(e,this.create(),t,r,!0,o)},SchemaBuilderEntity.prototype.$execute=function(e,t,r,o,n,i,s){var a=this;"string"!=typeof t&&(n=o,o=r,r=t,t="default"),"boolean"==typeof n?(i=n,n=o,o=void 0):"function"==typeof o&&(n=o,o=void 0),"function"!=typeof n&&(n=function(){});var u=a[e+"s"],c=u?u[t]:void 0;if(!c)return n((new ErrorBuilder).push("",e.capitalize()+' "{0}" not found.'.format(t))),a;if(r&&!s&&r.$$controller&&(s=r.$$controller),i===!0){var h=new ErrorBuilder;return a.resourceName&&h.setResource(a.resourceName),a.resourcePrefix&&h.setPrefix(a.resourcePrefix),c.$newversion?c.call(a,new SchemaOptions(h,r,o,function(o){a.$process(arguments,r,e,t,h,o,n)},s)):c.call(a,h,r,o,function(o){a.$process(arguments,r,e,t,h,o,n)},s,i!==!0),a}return a.$prepare(r,function(r,i){if(r)return void n(r,i);var u=new ErrorBuilder;if(a.resourceName&&u.setResource(a.resourceName),a.resourcePrefix&&u.setPrefix(a.resourcePrefix),!isGenerator(a,e+"."+t,c))return void(c.$newversion?c.call(a,new SchemaOptions(u,i,o,function(r){a.$process(arguments,i,e,t,u,r,n)},s)):c.call(a,u,i,o,function(r){a.$process(arguments,i,e,t,u,r,n)},s));n.success=!1;var h=function(r){r&&!n.success&&(n.success=!0,u.push(r),a.onError&&a.onError(u,i,e,t),n(u))},l=function(r){if(!n.success){(2===arguments.length||r instanceof Error||r instanceof ErrorBuilder)&&((r instanceof Error||r instanceof ErrorBuilder)&&u!==r&&u.push(r),r=arguments[1]);var o=u.hasError();o&&a.onError&&a.onError(u,i,e,t),n.success=!0,n(o?u:null,void 0===r?i:r)}};c.$newversion?async.call(a,c)(h,new SchemaOptions(u,i,o,l,s)):async.call(a,c)(h,u,i,o,l,s)}),a},SchemaBuilderEntity.prototype.operation=function(e,t,r,o,n,i){var s=this,a=typeof r,u=typeof o;"undefined"===u?"function"===a?(o=r,r=t,t=void 0):"undefined"===a&&(r=t,t=void 0):"undefined"===a?(r=t,t=void 0):"boolean"===u&&(n=o,o=r,r=void 0),"function"==typeof r&&(o=r,r=void 0),"function"!=typeof o&&(o=function(){});var c=s.operations?s.operations[e]:void 0;if(!c)return o((new ErrorBuilder).push("",'Operation "{0}" not found.'.format(e))),s;var h=new ErrorBuilder,l="operation";if(s.resourceName&&h.setResource(s.resourceName),s.resourcePrefix&&h.setPrefix(s.resourcePrefix),t&&!i&&t.$$controller&&(i=t.$$controller),!isGenerator(s,"operation."+e,c))return c.$newversion?c.call(s,new SchemaOptions(h,t,r,function(r){s.$process(arguments,t,l,e,h,r,o)},i)):c.call(s,h,t,r,function(r){s.$process(arguments,t,l,e,h,r,o)},i,n!==!0),s;o.success=!1;var p=function(r){r&&!o.success&&(o.success=!0,h.push(r),s.onError&&s.onError(h,t,l,e),o(h))},f=function(r){if(!o.success){(2===arguments.length||r instanceof Error||r instanceof ErrorBuilder)&&((r instanceof Error||r instanceof ErrorBuilder)&&h!==r&&h.push(r),r=arguments[1]);var n=h.hasError();n&&s.onError&&s.onError(h,t,l,e),o.success=!0,o(n?h:null,r)}};return c.$newversion?async.call(s,c)(p,new SchemaOptions(h,t,r,f,i)):async.call(s,c)(p,h,t,r,f,i,n!==!0),s},SchemaBuilderEntity.prototype.operation2=function(e,t,r,o){return"function"==typeof t&&(r=t,t=void 0),!r&&(r=function(){}),this.operation(e,this.create(),t,r,!0,o)},SchemaBuilderEntity.prototype.clean=function(e){return clone(e)},SchemaBuilderEntity.prototype.instancePrototype=function(){return this.CurrentSchemaInstance.prototype},SchemaInstance.prototype.$$schema=null,SchemaInstance.prototype.$async=function(e,t){var r=this;return!e&&(e=function(){}),r.$$async=[],r.$$result=[],r.$$index=t,r.$$callback=e,r.$$can=!0,setImmediate(async_continue,r),r},SchemaInstance.prototype.$repository=function(e,t){if(void 0===this.$$repository){if(void 0===t)return void 0;this.$$repository={}}return void 0!==t?(this.$$repository[e]=t,t):this.$$repository[e]},SchemaInstance.prototype.$index=function(e){return"string"==typeof e&&(this.$$index=(this.$$index||0).add(e)),this.$$index=e,this},SchemaInstance.prototype.$callback=function(e){return this.$$callback=e,this},SchemaInstance.prototype.$response=SchemaInstance.prototype.$output=function(){return this.$$index=this.$$result.length,this},SchemaInstance.prototype.$push=function(e,t,r,o){var n,i=this;return"save"===e?(r=t,t=void 0,n=function(t){i.$$schema[e](i,r,function(e,r){return i.$$result&&i.$$result.push(e?null:copy(r)),e?(t=null,i.$$async=null,i.$$callback(e,i.$$result),void(i.$$callback=null)):t()},i.$$controller)}):"query"===e||"get"===e||"read"===e||"remove"===e?(r=t,t=void 0,n=function(t){i.$$schema[e](r,function(e,r){return i.$$result&&i.$$result.push(e?null:copy(r)),e?(t=null,i.$$async=null,i.$$callback(e,i.$$result),void(i.$$callback=null)):t()},i.$$controller)}):n=function(o){i.$$schema[e](t,i,r,function(e,t){return i.$$result&&i.$$result.push(e?null:copy(t)),e?(o=null,i.$$async=null,i.$$callback(e,i.$$result),void(i.$$callback=null)):o()},i.$$controller)},o?i.$$async.unshift(n):i.$$async.push(n),i},SchemaInstance.prototype.$next=function(e,t,r){return this.$push(e,t,r,!0)},SchemaInstance.prototype.$exec=function(e,t,r){"function"==typeof t&&(r=t,t=void 0);var o=this.$$schema.parent.name,n="default"!==o?o+"/"+this.$$schema.name:this.$$schema.name,i=F.workflows[n+"#"+e]||F.workflows[e];return i?i(this,t,r||NOOP):r&&r((new ErrorBuilder).push('Workflow "'+e+'" not found in workflows.')),this},SchemaInstance.prototype.$controller=function(e){return this.$$controller=e,this},SchemaInstance.prototype.$save=function(e,t){return this.$$can&&this.$$async?this.$push("save",e):this.$$schema.save(this,e,t,this.$$controller),this},SchemaInstance.prototype.$query=function(e,t){return this.$$can&&this.$$async?this.$push("query",e):this.$$schema.query(this,e,t,this.$$controller),this},SchemaInstance.prototype.$read=SchemaInstance.prototype.$get=function(e,t){return this.$$can&&this.$$async?this.$push("get",e):this.$$schema.get(this,e,t,this.$$controller),this},SchemaInstance.prototype.$delete=SchemaInstance.prototype.$remove=function(e,t){return this.$$can&&this.$$async?this.$push("remove",e):this.$$schema.remove(e,t,this.$$controller),this},SchemaInstance.prototype.$default=function(){return this.$$schema["default"]()},SchemaInstance.prototype.$destroy=function(){return this.$$schema.destroy()},SchemaInstance.prototype.$transform=function(e,t,r){return this.$$can&&this.$$async?this.$push("transform",e,t):this.$$schema.transform(e,this,t,r,void 0,this.$$controller),this},SchemaInstance.prototype.$workflow=function(e,t,r){return this.$$can&&this.$$async?this.$push("workflow",e,t):this.$$schema.workflow(e,this,t,r,void 0,this.$$controller),this},SchemaInstance.prototype.$hook=function(e,t,r){return this.$$can&&this.$$async?this.$push("hook",e,t):this.$$schema.hook(e,this,t,r,void 0,this.$$controller),this},SchemaInstance.prototype.$operation=function(e,t,r){return this.$$can&&this.$$async?this.$push("operation",e,t):this.$$schema.operation(e,this,t,r,void 0,this.$$controller),this},SchemaInstance.prototype.$clean=SchemaInstance.prototype.$plain=function(){return this.$$schema.clean(this)},SchemaInstance.prototype.$clone=function(){return framework_utils.extend(new this.$$schema.CurrentSchemaInstance,this,!0)},SchemaInstance.prototype.$prepare=function(){return this.$$schema.prepare(this)},SchemaInstance.prototype.$schema=function(){return this.$$schema},SchemaInstance.prototype.$validate=function(e,t,r){return this.$$schema.validate(this,e,t,r)},SchemaInstance.prototype.$constant=function(e){return this.$$schema.constant(e)},exports.isSchema=function(e){return e instanceof SchemaInstance},global.EACHSCHEMA=exports.eachschema=function(e,t){void 0===t&&(t=e,e=void 0);for(var r=e?[e]:Object.keys(schemas),o=0,n=r.length;n>o;o++){var i=schemas[r[o]];if(i)for(var s=Object.keys(i.collection),a=0,u=s.length;u>a;a++)t(i.name,i.collection[s[a]].name,i.collection[s[a]])}},exports.getschema=function(e,t,r,o){if(t&&"function"!=typeof t||(r=t,t=e,e=DEFAULT_SCHEMA),r)return void framework_utils.wait(function(){var r=schemas[e];return r&&r.get(t)?!0:!1},function(o){return r(o,schemas[e].get(t))},o||2e4);var n=schemas[e];return n?n.get(t):void 0},exports.newschema=function(e,t){e||(e=DEFAULT_SCHEMA),schemas[e]||(schemas[e]=new SchemaBuilder(e));var r=schemas[e].create(t);return r.owner=F.$owner(),r},exports.remove=function(e,t){if(t){var r=schemas[e||DEFAULT_SCHEMA];r&&r.remove(t)}else delete schemas[e]},global.EACHOPERATION=function(e){for(var t=Object.keys(operations),r=0,o=t.length;o>r;r++)e(t[r])},exports.isJoin=function(e,t){return t?"[ "===t[0]?!0:void 0===e?!1:void 0!==e[t]:!1},exports.validation=function(e,t,r){if(void 0===schemas[DEFAULT_SCHEMA])return EMPTYARRAY;var o=schemas[DEFAULT_SCHEMA].get(e);if(void 0===o)return EMPTYARRAY;if(r instanceof Array&&"function"==typeof t){var n=r;r=t,t=n}if("function"==typeof r)return o.onValidate=r,t?o.properties=t:o.properties=Object.keys(o.schema),!0;if(!r){var i=o.properties;return void 0===i?Object.keys(o.schema):i||[]}return o.onValidate=r,r},exports.validate=function(e,t,r,o){var n=schemas[DEFAULT_SCHEMA];return void 0===n?null:(n=n.get(e),t=n.prepare(t),void 0===n?null:n.validate(t,r,o))},exports.create=function(e){return exports.defaults(e)},exports.defaults=function(e){if(void 0===schemas[DEFAULT_SCHEMA])return null;var t=schemas[DEFAULT_SCHEMA].get(e);return void 0===t?null:t["default"]()},exports.prepare=function(e,t){if(void 0===schemas[DEFAULT_SCHEMA])return null;var r=schemas[DEFAULT_SCHEMA].get(e);return void 0===r?null:r.prepare(t)},ErrorBuilder.prototype={get errors(){var e=this;return!e.isPrepared&&e.prepare(),e._transform()},get error(){var e=this;return!e.isPrepared&&e.prepare(),e._transform()}},ErrorBuilder.prototype.resource=function(e,t){var r=this;return r.isResourceCustom=!0,r.resourceName=e,r.resourcePrefix=t||"",r._resource()},ErrorBuilder.prototype.setContentType=function(e){return this.contentType=e,this},ErrorBuilder.prototype.setResource=function(e){var t=this;return t.isResourceCustom=!0,t.resourceName=e,t._resource()},ErrorBuilder.prototype.setPrefix=function(e){var t=this;return t.resourcePrefix=e||"",t._resource()},ErrorBuilder.prototype._resource=function(){var e=this;return e.onResource=e._resource_handler,e},ErrorBuilder.prototype._resource_handler=function(e){var t=this;return"undefined"!=typeof F?F.resource(t.resourceName||"default",e):""},ErrorBuilder.prototype.exception=function(e){return this.items.push({name:"",error:e}),this},ErrorBuilder.prototype.add=function(e,t,r,o){return this.push(e,t,r,o)},ErrorBuilder.prototype.push=function(e,t,r,o,n){if(this.isPrepared=!1,e instanceof ErrorBuilder){if(e.hasError()){for(var i=0,s=e.items.length;s>i;i++)this.items.push(e.items[i]);this.count=this.items.length}return this}if(e instanceof Array){for(var i=0,s=e.length;s>i;i++)this.push(e[i],void 0,r,o,n);return this}if(t instanceof Array){for(var i=0,s=t.length;s>i;i++)this.push(e,t[i],r,o,n);return this}return"object"==typeof e&&(r=t,t=e,e=""),null===t||!e&&!t?this:(t>0?(this.status=t,t="@"):r>0&&(this.status=r,r=void 0),t||(t="@"),t instanceof Error&&(this.unexpected=!0,t=t.toString()),this.items.push({name:e,error:"string"==typeof t?t:t.toString(),path:r,index:o,prefix:n}),this.count=this.items.length,this)},ErrorBuilder.prototype.remove=function(e){return this.items=this.items.remove("name",e),this.count=this.items.length,this},ErrorBuilder.prototype.hasError=function(e){return e?-1!==this.items.findIndex("name",e):this.items.length>0},ErrorBuilder.prototype.read=function(e){!this.isPrepared&&this.prepare();var t=this.items.findItem("name",e);return t?t.error:null},ErrorBuilder.prototype.clear=function(){return this.items=[],this.count=0,this},ErrorBuilder.prototype.replace=function(e,t){return this.isPrepared=!1,this.replacer[e]=t,this},ErrorBuilder.prototype.json=function(e,t){var r=this.prepare().items;return e?JSON.stringify(r,t,"	"):JSON.stringify(r,t)},ErrorBuilder.prototype.plain=function(){for(var e=this.prepare().items,t="",r=0,o=e.length;o>r;r++)t+=(t?", ":"")+e[r].error;return t},ErrorBuilder.prototype.JSON=function(e,t){return this.json(e,t)},ErrorBuilder.prototype._prepare=function(){if(!this.onResource)return this;for(var e=this.items,t=0,r=e.length;r>t;t++){var o=e[t];"@"===o.error[0]&&(1===o.error.length?o.error=this.onResource(o.prefix?o.prefix:this.resourcePrefix+o.name):o.error=this.onResource(o.error.substring(1)),o.error||(o.error=REQUIRED.replace("@",o.name)))}return this},ErrorBuilder.prototype._transform=function(e){var t=e||this.transformName;if(t){var r=transforms.error[t];return r?r.call(this):this.items}return this.items},ErrorBuilder.prototype.output=function(e){if(!this.transformName)return e?this.json():this.items;var t=transforms.error[this.transformName];return t?(this.prepare(),t.call(this,e)):e?this.json():this.items},ErrorBuilder.prototype.toString=function(){!this.isPrepared&&this.prepare();for(var e=this.items,t=e.length,r=[],o=0;t>o;o++)r.push(e[o].error||e[o].name);return r.join("\n")},ErrorBuilder.prototype.setTransform=function(e){return this.transformName=e,this},ErrorBuilder.prototype.transform=function(e){return this.prepare()._transform(e)},ErrorBuilder.prototype._prepareReplace=function(){var e=this,t=e.items,r=t.length,o=Object.keys(e.replacer),n=o.length;if(!r||!n)return e;for(var i=0;r>i;i++)for(var s=t[i],a=0;n>a;a++){var u=o[a];s.error=s.error.replace(u,e.replacer[u])}return e},ErrorBuilder.prototype.prepare=function(){return this.isPrepared?this:(this._prepare()._prepareReplace(),this.isPrepared=!0,this)},ErrorBuilder.addTransform=function(e,t,r){transforms.error[e]=t,r&&ErrorBuilder.setDefaultTransform(e)},ErrorBuilder.removeTransform=function(e){delete transforms.error[e]},ErrorBuilder.setDefaultTransform=function(e){e?transforms.error_default=e:delete transforms.error_default},Page.prototype.html=function(e,t){var r=t?t:"";return this.selected&&(r+=(r?" ":"")+"selected"),'<a href="'+this.url+'"'+(r?' class="'+r+'"':"")+">"+(e||this.page)+"</a>"},Pagination.addTransform=function(e,t,r){transforms.pagination[e]=t,r&&Pagination.setDefaultTransform(e)},Pagination.setDefaultTransform=function(e){e?transforms.pagination_default=e:delete transforms.pagination_default},Pagination.removeTransform=function(e){delete transforms.pagination[e]},Pagination.prototype.refresh=function(e,t,r){return this.page=Math.max(1,+t)-1,this.page<=0&&(this.page=0),this.items=Math.max(0,+e),this.max=Math.max(1,+r),this.skip=this.page*this.max,this.count=Math.ceil(this.items/this.max),this.take=Math.min(this.max,this.items-this.skip),this.lastPage=this.count,this.firstPage=1,this.prevPage=this.page?this.page:1,this.nextPage=this.page+2<this.count-1?this.page+2:this.count,this.isPrev=this.page>0,this.isNext=this.page<this.count-1,this.isFirst=0===this.page,this.isLast=this.page===this.count-1,this.visible=this.count>1,this.page++,this},Pagination.prototype.setTransform=function(e){return this._transform=e,this},Pagination.prototype.transform=function(e){var t=e||this.transformName;if(!t)throw new Error("A transformation of Pagination not found.");var r=transforms.pagination[t];if(!r)return this.render();for(var o=[],n=1;n<arguments.length;n++)o.push(arguments[n]);return r.apply(this,o)},Pagination.prototype.prev=function(e){var t=0;return e=e||this.format,t=this.isPrev?this.page-1:this.count,new Page(e.format(t,this.items,this.count),t,!1,this.isPrev)},Pagination.prototype.next=function(e){var t=0;return e=e||this.format,t=this.isNext?this.page+1:1,new Page(e.format(t,this.items,this.count),t,!1,this.isNext)},Pagination.prototype.last=function(e){var t=this.count;return e=e||this.format,new Page(e.format(t,this.items,this.count),t,!1,this.count>0)},Pagination.prototype.first=function(e){var t=1;return e=e||this.format,new Page(e.format(t,this.items,this.count),t,!1,this.count>0)},Pagination.prototype.prepare=function(e,t,r){var o=this;if(o.transformName)return transforms.pagination[o.transformName].apply(o,arguments);var n=[];if(t=t||o.format,"string"==typeof e){var i=t;t=e,e=i}var s="html"===r;if(null==e){for(var a=1;a<o.count+1;a++){var u=new Page(t.format(a,o.items,o.count),a,a===o.page,!0);n.push(s?u.html():u)}return n}var c=Math.floor(e/2),h=o.count,l=o.page-c,p=o.page+c,f=0;0>=l&&(f=Math.abs(l),l=1,p+=f),p>=h&&(p=h,l=h-e,0>=l&&(l=1));for(var a=l;p+1>a;a++){var u=new Page(t.format(a,o.items,o.count),a,a===o.page,!0);n.push(s?u.html():u)}return n},Pagination.prototype.render=function(e,t){return this.prepare(e,t)},Pagination.prototype.html=function(e,t){return this.prepare(e,t,"html").join("")},Pagination.prototype.json=function(e,t){return JSON.stringify(this.prepare(e,t))},UrlBuilder.make=function(e){var t=new UrlBuilder;return e.call(t,t),t},UrlBuilder.prototype.add=function(e,t){if("object"!=typeof e)return this.builder[e]=t,this;for(var r=Object.keys(e),o=0,n=r.length;n>o;o++)this.builder[r[o]]=e[r[o]];return this},UrlBuilder.prototype.remove=function(e){return delete this.builder[e],this},UrlBuilder.prototype.read=function(e){return this.builder[e]||null},UrlBuilder.prototype.clear=function(){return this.builder={},this},UrlBuilder.prototype.toString=function(e,t){if("boolean"==typeof e){var r=t;t=e,e=r}var o=this,n=[];return Object.keys(o.builder).forEach(function(e){var r=o.builder[e];r=null==r?"":r.toString(),t&&""===r||n.push(e+"="+encodeURIComponent(r))}),"string"==typeof e?"?"!==e[e.length-1]&&(e+="?"):e="",e+n.join("&")},UrlBuilder.prototype.hasValue=function(e){if(void 0===e)return!1;"string"==typeof e&&(e=[e]);for(var t=0;t<e.length;t++){var r=this.builder[e[t]];if(null==r)return!1}return!0},UrlBuilder.prototype.toOne=function(e,t){var r=this,o=[];return e.forEach(function(e){return o.push(r.builder[e]||"")}),o.join(t||"&")},TransformBuilder.transform=function(e,t){OBSOLETE("TransformBuilder","Builders.TransformBuilder will be removed in next versions.");var r=2;void 0===t&&(t=e,e=transforms.transformbuilder_default,r=1);var o=transforms.transformbuilder[e];if(!o)return F.error('Transformation "'+e+'" not found.',"TransformBuilder.transform()"),t;var n=arguments.length-r;if(0>=n)return o.call(t,t);var i=new Array(n+1),s=1;i[0]=t;for(var a=r;a<arguments.length;a++)i[s++]=arguments[a];return o.apply(t,i)},TransformBuilder.addTransform=function(e,t,r){transforms.transformbuilder[e]=t,r&&TransformBuilder.setDefaultTransform(e)},TransformBuilder.setDefaultTransform=function(e){e?transforms.transformbuilder_default=e:delete transforms.transformbuilder_default},RESTBuilder.make=function(e){var t=new RESTBuilder;return e(t),t},RESTBuilder.addTransform=function(e,t,r){transforms.restbuilder[e]=t,r&&RESTBuilder.setDefaultTransform(e)},RESTBuilder.setDefaultTransform=function(e){e?transforms.restbuilder_default=e:delete transforms.restbuilder_default},RESTBuilder.prototype.setTransform=function(e){return this.$transform=e,this},RESTBuilder.prototype.url=function(e){return void 0===e?this.$url:(this.$url=e,this)},RESTBuilder.prototype.file=function(e,t,r){var o={name:e,filename:t,buffer:r};return this.$files?this.$files.push(o):this.$files=[o],this},RESTBuilder.prototype.maketransform=function(e,t){if(this.$transform){var r=transforms.restbuilder[this.$transform];return r?r(e,t):e}return e},RESTBuilder.prototype.timeout=function(e){return this.$timeout=e,this},RESTBuilder.prototype.maxlength=function(e){return this.$length=e,this.$flags=null,this},RESTBuilder.prototype.auth=function(e,t){return this.$headers.authorization="Basic "+framework_utils.createBuffer(e+":"+t).toString("base64"),this},RESTBuilder.prototype.schema=function(e,t){if(this.$schema=exports.getschema(e,t),!this.$schema)throw Error('RESTBuilder : Schema "{0}" not found.'.format(t?e+"/"+t:e));return this},RESTBuilder.prototype.noDnsCache=function(){return this.$nodnscache=!0,this.$flags=null,this},RESTBuilder.prototype.noCache=function(){return this.$nocache=!0,this},RESTBuilder.prototype.make=function(e){return e.call(this,this),this},RESTBuilder.prototype.xhr=function(){return this.$headers["X-Requested-With"]="XMLHttpRequest",this},RESTBuilder.prototype.method=function(e){return this.$method=e.toLowerCase(),this.$flags=null,this},RESTBuilder.prototype.referer=RESTBuilder.prototype.referrer=function(e){return this.$headers.Referer=e,this},RESTBuilder.prototype.origin=function(e){return this.$headers.Origin=e,this},RESTBuilder.prototype.robot=function(){return this.$headers["User-Agent"]?this.$headers["User-Agent"]+=" Bot":this.$headers["User-Agent"]="Bot",this},RESTBuilder.prototype.mobile=function(){return this.$headers["User-Agent"]?this.$headers["User-Agent"]+=" iPhone":this.$headers["User-Agent"]="iPhone",this},RESTBuilder.prototype.put=function(e){return"put"!==this.$method&&(this.$flags=null,this.$method="put",this.$type=1),e&&this.raw(e),this},RESTBuilder.prototype["delete"]=function(e){return"delete"!==this.$method&&(this.$flags=null,this.$method="delete",this.$type=1),e&&this.raw(e),this},RESTBuilder.prototype.get=function(e){return"get"!==this.$method&&(this.$flags=null,this.$method="get"),e&&this.raw(e),this},RESTBuilder.prototype.post=function(e){return"post"!==this.$method&&(this.$flags=null,this.$method="post",this.$type=1),e&&this.raw(e),this},RESTBuilder.prototype.json=function(e){return 1!==this.$type&&(this.$flags=null),e&&this.raw(e),this.$type=1,"get"===this.$method&&(this.$method="post"),this},RESTBuilder.prototype.urlencoded=function(e){return 2!==this.$type&&(this.$flags=null),"get"===this.$method&&(this.$method="post"),this.$type=2,e&&this.raw(e),this},RESTBuilder.prototype.accept=function(e){var t=framework_utils.getContentType(e);return this.$headers.Accept!==t&&(this.$flags=null),this.$headers.Accept=t,this},RESTBuilder.prototype.xml=function(e){return 3!==this.$type&&(this.$flags=null),"get"===this.$method&&(this.$method="post"),this.$type=3,e&&this.raw(e),this},RESTBuilder.prototype.redirect=function(e){return this.$redirect=e,this},RESTBuilder.prototype.raw=function(e){return this.$data=e&&e.$clean?e.$clean():e,this},RESTBuilder.prototype.cook=function(e){return this.$flags=null,this.$persistentcookies=e!==!1,this},RESTBuilder.prototype.cookies=function(e){return this.$cookies=e,this},RESTBuilder.prototype.cookie=function(e,t){return!this.$cookies&&(this.$cookies={}),this.$cookies[e]=t,this},RESTBuilder.prototype.header=function(e,t){return this.$headers[e]=t,this},RESTBuilder.prototype.cache=function(e){return this.$cache_expire=e,this},RESTBuilder.prototype.set=function(e,t){if(this.$data||(this.$data={}),"object"!=typeof e)return this.$data[e]=t,this;for(var r=Object.keys(e),o=0,n=r.length;n>o;o++)this.$data[r[o]]=e[r[o]];return this},RESTBuilder.prototype.rem=function(e){return this.$data&&this.$data[e]&&(this.$data[e]=void 0),this},RESTBuilder.prototype.stream=function(e){var t=this,r=t.$flags?t.$flags:[t.$method];if(!t.$flags){switch(!t.$nodnscache&&r.push("dnscache"),t.$persistentcookies&&r.push("cookies"),t.$type){case 1:r.push("json");break;case 3:r.push("xml")}t.$flags=r}return U.download(t.$url,r,t.$data,e,t.$cookies,t.$headers,void 0,t.$timeout)},RESTBuilder.prototype.exec=function(e){e||(e=NOOP);var t=this;t.$files&&"get"===t.$method&&(t.$method="post");var r,o=t.$flags?t.$flags:[t.$method];if(!t.$flags){if(!t.$nodnscache&&o.push("dnscache"),t.$persistentcookies&&o.push("cookies"),t.$length&&o.push("<"+t.$length),t.$redirect===!1&&o.push("noredirect"),t.$files)o.push("upload");else switch(t.$type){case 1:o.push("json");break;case 3:o.push("xml")}t.$flags=o}if(t.$cache_expire&&!t.$nocache){r="$rest_"+(t.$url+o.join(",")+(t.$data?Qs.stringify(t.$data):"")).hash();var n=F.cache.read2(r);if(n){var i=new framework_utils.EventEmitter2;return process.nextTick(exec_removelisteners,i),e(null,t.maketransform(this.$schema?this.$schema.make(n.value):n.value,n),n),i}}return U.request(t.$url,o,t.$data,function(o,n,i,s,a){var u=o?"":s["content-type"]||"",c=new RESTBuilderResponse;switch(u.toLowerCase()){case"text/xml":c.value=n.parseXML();break;case"application/x-www-form-urlencoded":c.value=F.onParseQuery(n);break;case"application/json":c.value=n.parseJSON(!0);break;default:c.value=n.isJSON()?n.parseJSON(!0):null}return null==c.value&&(c.value=EMPTYOBJECT),c.response=n,c.status=i,c.headers=s,c.hostname=a,c.cache=!1,c.datetime=F.datetime,t.$schema?o?e(o,EMPTYOBJECT,c):void t.$schema.make(t.maketransform(c.value,c),function(o,n){!o&&r&&F.cache.add(r,c,t.$cache_expire),e(o,o?EMPTYOBJECT:n,c),c.cache=!0}):(!o&&r&&F.cache.add(r,c,t.$cache_expire),e(o,t.maketransform(c.value,c),c),void(c.cache=!0))},t.$cookies,t.$headers,void 0,t.$timeout,t.$files)},RESTBuilderResponse.prototype.cookie=function(e){var t=this;if(t.cookies)return $decodeURIComponent(t.cookies[e]||"");var r=t.headers.cookie;if(!r)return"";t.cookies={};for(var o=r.split(";"),n=0,i=o.length;i>n;n++){var s=o[n].trim(),a=s.indexOf("=");-1!==a&&(t.cookies[s.substring(0,a)]=s.substring(a+1))}return $decodeURIComponent(t.cookies[e]||"")},global.NEWOPERATION=function(e,t){return null==t?(delete operations[e],this):(operations[e]=t,operations[e].$owner=F.$owner(),operations[e].$newversion=REGEXP_NEWOPERATION.test(t.toString()),this)},global.OPERATION=function(e,t,r,o){"function"==typeof t&&(r=t,t=EMPTYOBJECT);var n=operations[e],i=new ErrorBuilder;if(n)if(n.$newversion){var s=new OperationOptions(i,t,o);r&&r!==NOOP?s.callback=function(e){return arguments.length>1?e instanceof Error||e instanceof ErrorBuilder&&e.hasError()?(s.error.push(e),e=EMPTYOBJECT):e=arguments[1]:(e instanceof Error||e instanceof ErrorBuilder&&e.hasError())&&(s.error.push(e),e=EMPTYOBJECT),r(s.error.hasError()?s.error:null,e,s.options),s}:s.callback=NOOP,n(s)}else n(i,t,function(e){r&&(e instanceof Error&&(i.push(e),e=EMPTYOBJECT),r(i.hasError()?i:null,e,o))});else i.push('Operation "{0}" not found.'.format(e)),r&&r(i,EMPTYOBJECT,o)},OperationOptions.prototype.DB=function(){return F.database(this.error)},OperationOptions.prototype.done=function(e){var t=this;return function(r,o){!r||r instanceof ErrorBuilder||(t.error.push(r),t.callback()),e?t.callback(SUCCESS(null==r,o)):t.callback(SUCCESS(null==r))}},OperationOptions.prototype.success=function(e,t){return e&&void 0===t&&"boolean"!=typeof e&&(t=e,e=!0),this.callback(SUCCESS(void 0===e?!0:e,t)),this},OperationOptions.prototype.invalid=function(e,t,r,o){return this.error.push(e,t,r,o),this.callback(),this},exports.SchemaBuilder=SchemaBuilder,exports.RESTBuilder=RESTBuilder,exports.ErrorBuilder=ErrorBuilder,exports.Pagination=Pagination,exports.Page=Page,exports.UrlBuilder=UrlBuilder,exports.TransformBuilder=TransformBuilder,exports.SchemaOptions=SchemaOptions,exports.OperationOptions=OperationOptions,exports.RESTBuilderResponse=RESTBuilderResponse,global.RESTBuilder=RESTBuilder,global.RESTBuilderResponse=RESTBuilderResponse,global.ErrorBuilder=ErrorBuilder,global.TransformBuilder=TransformBuilder,global.Pagination=Pagination,global.Page=Page,global.UrlBuilder=global.URLBuilder=UrlBuilder,global.SchemaBuilder=SchemaBuilder,exports.uninstall=function(e){e&&(Object.keys(operations).forEach(function(t){operations[t].$owner===e&&delete operations[t]}),exports.eachschema(function(t,r,o){o.owner===e&&o.destroy()}))},exports.restart=function(){schemas={},operations={},Object.keys(transforms).forEach(function(e){-1===e.indexOf("_")&&(transforms[e]={})})};