function WebSocketClient(){this.current={},this.$events={},this.pending=[],this.reconnect=0,this.closed=!0,this.options={type:"json",compress:!0,reconnect:3e3,encodedecode:!0},this.cookies={},this.headers={}}function websocket_ondata(e){this.$websocket.$ondata(e)}function websocket_onerror(e){this.$websocket.$onerror(e)}function websocket_close(){var e=this.$websocket;e.closed=!0,e.$onclose(),e.options.reconnect&&setTimeout(function(e){e.reconnect++,e.connect(e.url,e.protocol,e.origin)},e.options.reconnect,e)}function buffer_concat(e,t){for(var n=U.createBufferSize(t),o=0,s=0,r=e.length;r>s;s++)e[s].copy(n,o),o+=e[s].length;return n}function websocket_inflate(e){this.$websocket.inflatechunks.push(e),this.$websocket.inflatechunkslength+=e.length}function websocket_deflate(e){this.$websocket.deflatechunks.push(e),this.$websocket.deflatechunkslength+=e.length}function $decodeURIComponent(e){try{return decodeURIComponent(e)}catch(t){return e}}global.framework_utils||(global.framework_utils=require("./utils"));const Crypto=require("crypto"),Https=require("https"),Http=require("http"),Url=require("url"),Zlib=require("zlib"),ENCODING="utf8",REG_WEBSOCKET_ERROR=/ECONNRESET|EHOSTUNREACH|EPIPE|is closed/i,WEBSOCKET_COMPRESS=U.createBuffer([0,0,255,255]),WEBSOCKET_COMPRESS_OPTIONS={windowBits:Zlib.Z_DEFAULT_WINDOWBITS},CONCAT=[null,null];WebSocketClient.prototype.connect=function(e,t,n){var o=this,s={},r=Crypto.randomBytes(16).toString("base64");o.url=e,o.origin=n,o.protocol=t,e=Url.parse(e);var i="wss:"===e.protocol;s.port=e.port||(i?443:80),s.host=e.hostname,s.path=e.path,s.query=e.query,s.headers={},s.headers["Sec-WebSocket-Version"]="13",s.headers["Sec-WebSocket-Key"]=r,s.headers["Sec-Websocket-Extensions"]=(o.options.compress?"permessage-deflate, ":"")+"client_max_window_bits",t&&(s.headers["Sec-WebSocket-Protocol"]=t),n&&(s.headers["Sec-WebSocket-Origin"]=n),s.headers.Connection="Upgrade",s.headers.Upgrade="websocket";for(var c=Object.keys(o.headers),a=0,f=c.length;f>a;a++)s.headers[c[a]]=o.headers[c[a]];if(c=Object.keys(o.cookies),c.length){for(var l=[],a=0,f=c.length;f>a;a++)l.push(c[a]+"="+o.headers[c[a]]);s.headers.Cookie=l.join(", ")}o.req=(i?Https:Http).get(s),o.req.$main=o,o.req.on("error",function(e){o.$events.error&&o.emit("error",e)}),o.req.on("response",function(){o.$events.error&&o.emit("error",new Error("Unexpected server response.")),o.free()}),o.req.on("upgrade",function(e,t){o.socket=t,o.socket.$websocket=o;var n=-1!==(e.headers["sec-websocket-extensions"]||"").indexOf("-deflate"),s=Crypto.createHash("sha1").update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11","binary").digest("base64");return e.headers["sec-websocket-accept"]!==s?(t.destroy(),o.closed=!0,o.$events.error&&o.emit("error",new Error("Invalid server key.")),void o.free()):(o.closed=!1,o.socket.setTimeout(0),o.socket.setNoDelay(),o.socket.on("data",websocket_ondata),o.socket.on("error",websocket_onerror),o.socket.on("close",websocket_close),o.socket.on("end",websocket_close),n&&(o.inflatepending=[],o.inflatelock=!1,o.inflate=Zlib.createInflateRaw(WEBSOCKET_COMPRESS_OPTIONS),o.inflate.$websocket=o,o.inflate.on("error",F.error()),o.inflate.on("data",websocket_inflate),o.deflatepending=[],o.deflatelock=!1,o.deflate=Zlib.createDeflateRaw(WEBSOCKET_COMPRESS_OPTIONS),o.deflate.$websocket=o,o.deflate.on("error",F.error()),o.deflate.on("data",websocket_deflate)),void(o.$events.open&&o.emit("open")))})},WebSocketClient.prototype.emit=function(e,t,n,o,s,r,i,c){var a=this.$events[e];if(a){for(var f=!1,l=0,h=a.length;h>l;l++)a[l].$once&&(f=!0),a[l].call(this,t,n,o,s,r,i,c);f&&(a=a.remove(function(e){return e.$once}),a.length?this.$events[e]=a:this.$events[e]=void 0)}return this},WebSocketClient.prototype.on=function(e,t){return this.$events[e]?this.$events[e].push(t):this.$events[e]=[t],this},WebSocketClient.prototype.once=function(e,t){return t.$once=!0,this.on(e,t)},WebSocketClient.prototype.removeListener=function(e,t){var n=this.$events[e];return n&&(n=n.remove(function(e){return e===t}),n.length?this.$events[e]=n:this.$events[e]=void 0),this},WebSocketClient.prototype.removeAllListeners=function(e){return e===!0?this.$events=EMPTYOBJECT:e?this.$events[e]=void 0:this.$events={},this},WebSocketClient.prototype.free=function(){var e=this;return e.socket&&e.socket.destroy(),e.socket=null,e.req&&e.req.abort(),e.req=null,e},WebSocketClient.prototype.$ondata=function(e){if(!this.isClosed){var t=this.current;if(e&&(t.buffer?(CONCAT[0]=t.buffer,CONCAT[1]=e,t.buffer=Buffer.concat(CONCAT)):t.buffer=e),this.$parse()){t["final"]||0===t.type||(t.type2=t.type);var n;switch(0===t.type?t.type2:t.type){case 1:this.inflate?t["final"]&&this.parseInflate():(n=this.$readbody(),t.body?t.body+=n:t.body=n,t["final"]&&this.$decode());break;case 2:this.inflate?t["final"]&&this.parseInflate():(n=this.$readbody(),t.body?(CONCAT[0]=t.body,CONCAT[1]=n,t.body=Buffer.concat(CONCAT)):t.body=n,t["final"]&&this.$decode());break;case 8:this.close();break;case 9:this.socket.write(U.getWebSocketFrame(0,"PONG",10)),t.buffer=null,t.inflatedata=null;break;case 10:t.buffer=null,t.inflatedata=null}t.buffer&&(t.buffer=t.buffer.slice(t.length,t.buffer.length),t.buffer.length&&this.$ondata())}}},WebSocketClient.prototype.$parse=function(){var e=this,t=e.current;if(t.buffer&&!(t.buffer.length<=2)&&(128&t.buffer[0])>>7===1){t.type=15&t.buffer[0],t["final"]=(128&t.buffer[0])>>7===1,t.isMask=(254&t.buffer[1])>>7===1;var n=U.getMessageLength(t.buffer,F.isLE),o=127&t.buffer[1];o=(126===o?4:127===o?10:2)+(t.isMask?4:0);var s=o+n;if(!(t.buffer.length<s)){if(t.length=s,9!==t.type&&10!==t.type)if(t.isMask&&(t.mask=U.createBufferSize(4),t.buffer.copy(t.mask,0,o-4,o)),this.inflate){var r=U.createBufferSize(n);if(t.buffer.copy(r,0,o,s),t.isMask)for(var i=0;n>i;i++)r[i]=r[i]^t.mask[i%4];r.$continue=t["final"]===!1,this.inflatepending.push(r)}else t.data=U.createBufferSize(n),t.buffer.copy(t.data,0,o,s);return!0}}},WebSocketClient.prototype.$readbody=function(){var e,t=this.current,n=t.data.length;if(1===t.type){e=U.createBufferSize(n);for(var o=0;n>o;o++)t.isMask?e[o]=t.data[o]^t.mask[o%4]:e[o]=t.data[o];return e.toString("utf8")}e=U.createBufferSize(n);for(var o=0;n>o;o++)t.isMask?e[o]=t.data[o]^t.mask[o%4]:e[o]=t.data[o];return e},WebSocketClient.prototype.$decode=function(){var e=this.current.body;switch(this.options.type){case"binary":this.emit("message",new Uint8Array(e).buffer);break;case"json":e instanceof Buffer&&(e=e.toString(ENCODING)),this.options.encodedecode&&(e=$decodeURIComponent(e)),e.isJSON()&&this.emit("message",F.onParseJSON(e,this.req));break;default:e instanceof Buffer&&(e=e.toString(ENCODING)),this.emit("message",this.options.encodedecode?$decodeURIComponent(e):e)}this.current.body=null},WebSocketClient.prototype.parseInflate=function(){var e=this;if(!e.inflatelock){var t=e.inflatepending.shift();t&&(e.inflatechunks=[],e.inflatechunkslength=0,e.inflatelock=!0,e.inflate.write(t),!t.$continue&&e.inflate.write(U.createBuffer(WEBSOCKET_COMPRESS)),e.inflate.flush(function(){if(e.inflatechunks){var n=buffer_concat(e.inflatechunks,e.inflatechunkslength);e.inflatechunks=null,e.inflatelock=!1,e.current.body?(CONCAT[0]=e.current.body,CONCAT[1]=n,e.current.body=Buffer.concat(CONCAT)):e.current.body=n,!t.$continue&&e.$decode(),e.parseInflate()}}))}},WebSocketClient.prototype.$onerror=function(e){this.isClosed||(REG_WEBSOCKET_ERROR.test(e.stack)?(this.isClosed=!0,this.$onclose()):this.$events.error&&this.emit("error",e))},WebSocketClient.prototype.$onclose=function(){this._isClosed||(this.isClosed=!0,this._isClosed=!0,this.inflate&&(this.inflate.removeAllListeners(),this.inflate=null,this.inflatechunks=null),this.deflate&&(this.deflate.removeAllListeners(),this.deflate=null,this.deflatechunks=null),this.$events.close&&this.emit("close"),this.socket.removeAllListeners())},WebSocketClient.prototype.send=function(e,t,n){if(this.isClosed)return this;var o=this.options.type;if("binary"!==o){var s="json"===o?t?e:JSON.stringify(e,n):(e||"").toString();this.options.encodedecode&&s&&(s=encodeURIComponent(s)),this.deflate?(this.deflatepending.push(U.createBuffer(s)),this.sendDeflate()):this.socket.write(U.getWebSocketFrame(0,s,1))}else e&&(this.deflate?(this.deflatepending.push(U.createBuffer(e)),this.sendDeflate()):this.socket.write(U.getWebSocketFrame(0,new Int8Array(e),2)));return this},WebSocketClient.prototype.sendDeflate=function(){var e=this;if(!e.deflatelock){var t=e.deflatepending.shift();t&&(e.deflatechunks=[],e.deflatechunkslength=0,e.deflatelock=!0,e.deflate.write(t),e.deflate.flush(function(){if(e.deflatechunks){var t=buffer_concat(e.deflatechunks,e.deflatechunkslength);t=t.slice(0,t.length-4),e.deflatelock=!1,e.deflatechunks=null,e.socket.write(U.getWebSocketFrame(0,t,1===e.type?2:1,!0)),e.sendDeflate()}}))}},WebSocketClient.prototype.ping=function(){return this.isClosed||(this.socket.write(U.getWebSocketFrame(0,"",9)),this.$ping=!1),this},WebSocketClient.prototype.close=function(e,t){return this.isClosed||(this.isClosed=!0,this.socket.end(U.getWebSocketFrame(t||1e3,e?this.options.encodedecode?encodeURIComponent(e):e:"",8))),this},exports.create=function(){return new WebSocketClient};