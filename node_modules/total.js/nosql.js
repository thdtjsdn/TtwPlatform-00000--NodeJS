"use strict";function Database(e,t){var r=t.substring(0,6),n=this;n.readonly="http:/"===r||"https:"===r,n.filename=n.readonly?t.format(""):t+EXTENSION,n.filenameCounter=n.readonly?t.format("counter","-"):t+EXTENSION+EXTENSION_COUNTER,n.filenameTemp=t+EXTENSION_TMP,n.filenameLog=n.readonly?"":t+EXTENSION_LOG,n.filenameBackup=n.readonly?"":t+EXTENSION_BACKUP,n.filenameMeta=t+EXTENSION_META,n.directory=Path.dirname(t),n.filenameBackup2=framework_utils.join(n.directory,e+"_backup"+EXTENSION),n.name=e,n.pending_update=[],n.pending_append=[],n.pending_reader=[],n.pending_reader_view=[],n.pending_remove=[],n.views={},n.step=0,n.pending_drops=!1,n.pending_views=!1,n.binary=n.readonly?null:new Binary(n,n.directory+"/"+n.name+"-binary/"),n.counter=new Counter(n),n.inmemory={},n.inmemorylastusage,n.metadata,n.$meta(),n.$timeoutmeta,n.$events={},n.$free=!0,n.locked=!1,n.renaming=!1}function next_operation(e,t,r){r&&r.$sortinline(),e.next(t)}function locker_timeout(e){e.lockwait=2,e.next(0)}function next_append(e){e.next(0),setImmediate(views_refresh,e)}function views_refresh(e){e.refresh()}function nosqlinlinesorter(e,t,r){if(!e.response)return void(e.response=[r]);var n=e.response.length;n<t.$limit?(e.response.push(r),n+1>=t.$limit&&e.response.quicksort(t.$sort.name,t.$sort.asc)):nosqlresort(e.response,t,r)}function nosqlsortvalue(e,t,r){var n=typeof e;if("number"===n)return r.asc?e>t:t>e;if("string"===n){var a=COMPARER(e,t);return r.asc?1===a:-1===a}return"boolean"===n?r.asc?e&&!t:!e&&t:e instanceof Date?r.asc?e>t:t>e:!1}function nosqlresort(e,t,r){var n=r[t.$sort.name],a=0,i=e.length,o=i-1,s=nosqlsortvalue(e[o][t.$sort.name],n,t.$sort);if(s){o=e.length/2>>0,s=nosqlsortvalue(e[o][t.$sort.name],n,t.$sort),s||(a=o+1);for(var u=a;i>u;u++){var c=e[u],s=nosqlsortvalue(c[t.$sort.name],n,t.$sort);if(s){for(var l=i-1;l>u;l--)e[l]=e[l-1];return void(e[u]=r)}}}}function DatabaseBuilder2(e){this.$callback=NOOP,this.db=e}function DatabaseBuilder(e){this.db=e,this.$take=0,this.$skip=0,this.$filter=[],this.$first=!1,this.$scope=0,this.$callback=NOOP}function scalar(e,t,r,n,a){if("count"===t&&!n)return e.length;for(var i="min"!==t&&"max"!==t?"group"===t?{}:0:null,o=0,s=0,u=e.length;u>s;s++){var c=e[s];if(!n||c[n]===a)switch(t){case"count":i++;break;case"sum":i+=c[r]||0;break;case"avg":i+=c[r]||0,o++;break;case"min":i=null===i?c[r]:i>c[r]?c[r]:i;break;case"group":i[c[r]]?i[c[r]]++:i[c[r]]=1;break;case"max":i=null===i?c[r]:i<c[r]?c[r]:i}}return"avg"===t&&(i/=o),i||0}function findItem(e,t,r){for(var n=0,a=e.length;a>n;n++)if(e[n][t]===r)return e[n]}function findItems(e,t,r){for(var n=[],a=0,i=e.length;i>a;a++)e[a][t]===r&&n.push(e[a]);return n}function Counter(e){var t=this;t.TIMEOUT=3e4,t.db=e,t.cache,t.key="nosql"+e.name.hash(),t.type=0,t.$events={},t.locked=!1;var r=t.db.filename+"-counter";if(!t.db.readonly)try{var n=Fs.statSync(r);n&&n.isFile()&&t.convert2(r)}catch(a){}}function counter_sort_sum(e,t){return e.count>t.count?-1:e.count===t.count?0:1}function counter_sort_min(e,t){return e.count>t.count?1:e.count===t.count?0:-1}function counter_parse_stats_avg(e,t,r,n,a,i){var o=e.length;if(t>o){for(var s=0;o>s;s++)if(e[s].id===r)return void(e[s].count+=n);if(e.push({id:r,count:n}),e.length===t)switch(a.type2||a.type){case"max":case"sum":e.sort(counter_sort_sum);break;case"min":e.sort(counter_sort_min)}}else{for(var s=0;o>s;s++)if(e[s].id===r)return void(e[s].count+=n);for(var s=0;o>s;s++){var u=e[s];if("min"===a.type){if(u.count<n)continue;if(u.count>n)continue}for(var c=o-1;c>s;c--)e[c].id=e[c-1].id,e[c].count=e[c-1].count;return u.id=r,void(u.count=n)}}}function counter_parse_stats(e,t){for(var r=null,n=0,a=e.length;a>n;n++){var i=e[n],o=i.substring(i.indexOf("=",3)+1);switch(t.type2||t.type){case"max":var s=counter_minmax(t,o);null==r?r=s:s>r&&(r=s);break;case"min":var s=counter_minmax(t,o);null==r?r=s:r>s&&(r=s);break;case"sum":r+=+o}}return r}function counter_minmax(e,t){var r=t.indexOf("X");switch(e.type2){case"min":return+t.substring(0,r);case"max":return+t.substring(r+1);case"avg":return(+t.substring(0,r)+ +t.substring(r+1))/2}}function counter_parse_years(e,t,r){for(var n=e.trim().split(";"),a={},i=1,o=n.length;o>i;i++){var s=n[i].substring(5);if(a[t])switch(r.type2||r.type){case"max":var u=counter_minmax(r,s);a[t].value<u&&(a[t].value=u);break;case"min":var u=counter_minmax(r,s);a[t].value>u&&(a[t].value=u);break;case"sum":a[t].value+=+s}else a[t]={id:t,year:+t,value:r.type2?counter_minmax(r,s):+s}}for(var c=[],l=Object.keys(a),i=0,o=l.length;o>i;i++)c.push(a[l[i]]);return c}function counter_parse_months(e,t,r){for(var n=e.trim().split(";"),a={},i=1,o=n.length;o>i;i++){var s=n[i].substring(5),u=t+n[i].substring(0,2);if(a[u])switch(r.type2||r.type){case"max":var c=counter_minmax(r,s);a[u].value<c&&(a[u].value=c);break;case"min":var c=counter_minmax(r,s);a[u].value>c&&(a[u].value=c);break;case"sum":a[u].value+=+s}else a[u]={id:u,year:+t,month:+u.substring(4),value:r.type2?counter_minmax(r,s):+s}}for(var l=[],p=Object.keys(a),i=0,o=p.length;o>i;i++)l.push(a[p[i]]);return l}function counter_parse_days(e,t,r){for(var n=e.trim().split(";"),a={},i=1,o=n.length;o>i;i++){var s=n[i].substring(5),u=t+n[i].substring(0,4);if(a[u])switch(r.type2||r.type){case"max":var c=counter_minmax(r,s);a[u].value<c&&(a[u].value=c);break;case"min":var c=counter_minmax(r,s);a[u].value>c&&(a[u].value=c);break;case"sum":a[u].value+=+s}else a[u]={id:u,year:+t,month:+u.substring(4,6),day:+u.substring(6),value:r.type2?counter_minmax(r,s):+s}}for(var l=[],p=Object.keys(a),i=0,o=p.length;o>i;i++)l.push(a[p[i]]);return l}function counter_parse_years_all(e,t,r,n){for(var a=t.trim().split(";"),i=1,o=a.length;o>i;i++){var s=a[i].substring(5);if(e[r])switch(n.type2||n.type){case"max":var u=counter_minmax(n,s);e[r]<u&&(e[r]=u);break;case"min":var u=counter_minmax(n,s);e[r]>u&&(e[r]=u);break;case"sum":e[r]+=+s}else e[r]=n.type2?counter_minmax(n,s):+s}}function counter_parse_months_all(e,t,r,n){for(var a=t.trim().split(";"),i=1,o=a.length;o>i;i++){var s=a[i].substring(5),u=r+a[i].substring(0,2);if(e[u])switch(n.type2||n.type){case"max":var c=counter_minmax(n,s);e[r]<c&&(e[r]=c);break;case"min":var c=counter_minmax(n,s);e[r]>c&&(e[r]=c);break;case"sum":e[u]+=+s}else e[u]=n.type2?counter_minmax(n,s):+s}}function counter_parse_days_all(e,t,r,n){for(var a=t.trim().split(";"),i=1,o=a.length;o>i;i++){var s=a[i].substring(5),u=r+a[i].substring(0,4);if(e[u])switch(n.type2||n.type){case"max":var c=counter_minmax(n,s);e[r]<c&&(e[r]=c);break;case"min":var c=counter_minmax(n,s);e[r]>c&&(e[r]=c);break;case"sum":e[u]+=+s}else e[u]=n.type2?counter_minmax(n,s):+s}}function Binary(e,t){this.db=e,this.directory=t,this.exists=!1,this.$events={}}function Backuper(e){this.filename=e,this.items=[],this.is=!1,this.callback}function compare_eq(e,t,r){return r.value===e[r.name]}function compare_lt(e,t,r){return r.value<e[r.name]}function compare_gt(e,t,r){return r.value>e[r.name]}function compare_eqlt(e,t,r){return r.value<=e[r.name]}function compare_eqgt(e,t,r){return r.value>=e[r.name]}function compare_not(e,t,r){return r.value!==e[r.name]}function compare_eq_date(e,t,r){var n=e[r.name];return n?r.ticks===(n instanceof Date?n:new Date(n)).getTime():!1}function compare_lt_date(e,t,r){var n=e[r.name];return n?r.value<(n instanceof Date?n:new Date(n)):!1}function compare_gt_date(e,t,r){var n=e[r.name];return n?r.value>(n instanceof Date?n:new Date(n)):!1}function compare_eqlt_date(e,t,r){var n=e[r.name];return n?r.value<=(n instanceof Date?n:new Date(n)):!1}function compare_eqgt_date(e,t,r){var n=e[r.name];return n?r.value>=(n instanceof Date?n:new Date(n)):!1}function compare_not_date(e,t,r){var n=e[r.name];return n?r.value!==(n instanceof Date?n:new Date(n)):!1}function compare_likebeg(e,t,r){var n=e[r.name];return n?n.startsWith(r.value):!1}function compare_likeend(e,t,r){var n=e[r.name];return n?n.endsWith(r.value):!1}function compare_like(e,t,r){var n=e[r.name];if(!n||!n.toLowerCase)return!1;if(r.value instanceof Array){for(var a=0,i=r.value.length;i>a;a++)if(-1!==n.toLowerCase().indexOf(r.value[a]))return!0;return!1}return-1!==n.toLowerCase().indexOf(r.value)}function compare_between(e,t,r){var n=e[r.name];return n>=r.a&&n<=r.b}function compare_in(e,t,r){var n=e[r.name];if(n instanceof Array){for(var a=0,i=n.length;i>a;a++)if(-1!==r.value.indexOf(n[a]))return!0;return!1}return-1!==r.value.indexOf(n)}function compare_notin(e,t,r){var n=e[r.name];if(n instanceof Array){for(var a=0,i=n.length;i>a;a++)if(-1!==r.value.indexOf(n[a]))return!1;return!0}return-1===r.value.indexOf(n)}function compare_notempty(e,t,r){var n=e[r.name];return n instanceof Array?n.length?!0:!1:n?!0:!1}function compare_empty(e,t,r){var n=e[r.name];return n instanceof Array?n.length?!1:!0:n?!1:!0}function compare_datetype(e,t,r,n){if(!n)return!1;if(!n.getTime&&(n=new Date(n),isNaN(n)))return!1;switch(e){case"month":n=n.getMonth()+1;break;case"day":n=n.getDate();break;case"year":n=n.getFullYear()}return"="===t?r===n:">"===t?r>n:"<"===t?n>r:">="===t?r>=n:"<="===t?n>=r:r!==n}function compare_eq_dtmonth(e,t,r){return compare_datetype("month","=",r.value,e[r.name])}function compare_lt_dtmonth(e,t,r){return compare_datetype("month","<",r.value,e[r.name])}function compare_gt_dtmonth(e,t,r){return compare_datetype("month",">",r.value,e[r.name])}function compare_eqlt_dtmonth(e,t,r){return compare_datetype("month","<=",r.value,e[r.name])}function compare_eqgt_dtmonth(e,t,r){return compare_datetype("month",">=",r.value,e[r.name])}function compare_not_dtmonth(e,t,r){return compare_datetype("month","!=",r.value,e[r.name])}function compare_eq_dtyear(e,t,r){return compare_datetype("year","=",r.value,e[r.name])}function compare_lt_dtyear(e,t,r){return compare_datetype("year","<",r.value,e[r.name])}function compare_gt_dtyear(e,t,r){return compare_datetype("year",">",r.value,e[r.name])}function compare_eqlt_dtyear(e,t,r){return compare_datetype("year","<=",r.value,e[r.name])}function compare_eqgt_dtyear(e,t,r){return compare_datetype("year",">=",r.value,e[r.name])}function compare_not_dtyear(e,t,r){return compare_datetype("year","!=",r.value,e[r.name])}function compare_eq_dtday(e,t,r){return compare_datetype("day","=",r.value,e[r.name])}function compare_lt_dtday(e,t,r){return compare_datetype("day","<",r.value,e[r.name])}function compare_gt_dtday(e,t,r){return compare_datetype("day",">",r.value,e[r.name])}function compare_eqlt_dtday(e,t,r){return compare_datetype("day","<=",r.value,e[r.name])}function compare_eqgt_dtday(e,t,r){return compare_datetype("day",">=",r.value,e[r.name])}function compare_not_dtday(e,t,r){return compare_datetype("day","!=",r.value,e[r.name])}function errorhandling(e,t,r){if(e)return e;var n=r instanceof Array;return(!r||n&&!r.length)&&t.$callback_emptyerror?(new ErrorBuilder).push(t.$callback_emptyerror):null}function jsonparser(e,t){return"string"==typeof t&&t.isJSONDate()?new Date(t):t}const Fs=require("fs"),Path=require("path");global.framework_utils||(global.framework_utils=require("./utils")),global.framework_image||(global.framework_image=require("./image")),global.framework_nosql||(global.framework_nosql=exports),global.framework_builders||(global.framework_builders=require("./builders"));const EXTENSION=".nosql",EXTENSION_BINARY=".nosql-binary",EXTENSION_TMP=".nosql-tmp",EXTENSION_LOG=".nosql-log",EXTENSION_BACKUP=".nosql-backup",EXTENSION_META=".meta",EXTENSION_COUNTER="-counter2",BINARY_HEADER_LENGTH=2e3,NEWLINE="\n",EMPTYARRAY=[],REG_CLEAN=/^[\s]+|[\s]+$/g,INMEMORY={},CLUSTER_TIMEOUT=150,CLUSTER_LOCK={TYPE:"nosql-lock"},CLUSTER_UNLOCK={TYPE:"nosql-unlock"},CLUSTER_META={TYPE:"nosql-meta"},CLUSTER_LOCK_COUNTER={TYPE:"nosql-counter-lock"},CLUSTER_UNLOCK_COUNTER={TYPE:"nosql-counter-unlock"},FLAGS_READ=["get"],COUNTER_MMA=[0,0],COMPARER=global.Intl?global.Intl.Collator().compare:function(e,t){return e.removeDiacritics().localeCompare(t.removeDiacritics())};Object.freeze(EMPTYARRAY),Database.prototype.emit=function(e,t,r,n,a,i,o,s){var u=this.$events[e];if(u){for(var c=!1,l=0,p=u.length;p>l;l++)u[l].$once&&(c=!0),u[l].call(this,t,r,n,a,i,o,s);c&&(u=u.remove(function(e){return e.$once}),u.length?this.$events[e]=u:this.$events[e]=void 0)}return this},Database.prototype.on=function(e,t){return t.$once||(this.$free=!1),this.$events[e]?this.$events[e].push(t):this.$events[e]=[t],this},Database.prototype.once=function(e,t){return t.$once=!0,this.on(e,t)},Database.prototype.removeListener=function(e,t){var r=this.$events[e];return r&&(r=r.remove(function(e){return e===t}),r.length?this.$events[e]=r:this.$events[e]=void 0),this},Database.prototype.removeAllListeners=function(e){return e===!0?this.$events=EMPTYOBJECT:e?this.$events[e]=void 0:this.$events[e]={},this},exports.Database=Database,exports.DatabaseBuilder=DatabaseBuilder,exports.DatabaseBuilder2=DatabaseBuilder2,exports.DatabaseCounter=Counter,exports.DatabaseBinary=Binary,exports.load=function(e,t){return CLUSTER_LOCK.id=F.id,CLUSTER_UNLOCK.id=F.id,CLUSTER_META.id=F.id,CLUSTER_LOCK_COUNTER.id=F.id,CLUSTER_UNLOCK_COUNTER.id=F.id,new Database(e,t)},exports.memory=exports.inmemory=function(e,t){return t&&(e+="#"+t),INMEMORY[e]=!0},Database.prototype.get=function(e){return this.meta(e)},Database.prototype.set=function(e,t){return this.meta(e,t)},Database.prototype.meta=function(e,t){var r=this;return void 0===t?r.metadata?r.metadata[e]:void 0:(r.metadata||(r.metadata={}),r.metadata[e]=t,clearTimeout(r.timeoutmeta),r.timeoutmeta=setTimeout(function(){r.$meta(!0)},500),r)},Database.prototype.backups=function(e,t){void 0===t&&(t=e,e=null);var r=this,n=Fs.createReadStream(r.filenameBackup),a=[];return n.on("data",U.streamer("\n",function(t,r){var n=t.indexOf("|",t.indexOf("|")+2),i=t.substring(0,n),o=i.split("|"),s=o[0].trim().replace(" ","T")+":00.000Z",u={id:r+1,date:s.parseDate(),user:o[1].trim(),data:t.substring(n+1).trim().parseJSON(!0)};(!e||e(u))&&a.push(u)}),n),CLEANUP(n,function(){return t(null,a)}),r},Database.prototype.insert=function(e,t){var r,n=this;if(n.readonly&&n.throwReadonly(),t){r=n.one();var a;return r.callback(function(t,r){r?a&&a(null,0):n.insert(e).callback(a)}),r.callback=function(e){return a=e,r},r}r=new DatabaseBuilder2(n);var i=framework_builders.isSchema(e)?e.$clean():e;return n.pending_append.push({doc:JSON.stringify(i),builder:r}),setImmediate(next_operation,n,1),n.emit("insert",i),r},Database.prototype.upsert=function(e){return this.insert(e,!0)},Database.prototype.update=function(e,t){var r=this;r.readonly&&r.throwReadonly();var n=new DatabaseBuilder(r),a=framework_builders.isSchema(e)?e.$clean():e;return r.pending_update.push({builder:n,doc:a,count:0,insert:t===!0?a:t}),setImmediate(next_operation,r,2),n},Database.prototype.modify=function(e,t){var r=this;r.readonly&&r.throwReadonly();var n=new DatabaseBuilder(r),a=framework_builders.isSchema(e)?e.$clean():e,i=Object.keys(a);return i.length?(r.pending_update.push({builder:n,doc:a,count:0,keys:i,insert:t===!0?a:t}),setImmediate(next_operation,r,2),n):n},Database.prototype.restore=function(e,t){var r=this;return r.readonly&&r.throwReadonly(),U.wait(function(){return!r.type},function(n){if(n)throw new Error("Database can't be restored because it's busy.");r.type=9,F.restore(e,F.path.root(),function(e,n){r.type=0,!e&&r.refresh(),t&&t(e,n)})}),r},Database.prototype.backup=function(e,t){var r=this;r.readonly&&r.throwReadonly();var n=[],a=[];return a.push(function(e){F.path.exists(r.filename,function(t){t&&n.push(Path.join(F.config["directory-databases"],r.name+EXTENSION)),e()})}),a.push(function(e){F.path.exists(F.path.databases(r.name+EXTENSION_META),function(t){t&&n.push(Path.join(F.config["directory-databases"],r.name+EXTENSION_META)),e()})}),a.push(function(e){F.path.exists(r.filenameBackup,function(t){t&&n.push(Path.join(F.config["directory-databases"],r.name+EXTENSION_BACKUP)),e()})}),a.push(function(e){F.path.exists(r.filenameCounter,function(t){t&&n.push(Path.join(F.config["directory-databases"],r.name+EXTENSION+EXTENSION_COUNTER)),e()})}),a.push(function(e){F.path.exists(r.filenameLog,function(t){t&&n.push(Path.join(F.config["directory-databases"],r.name+EXTENSION_LOG)),e()})}),a.push(function(e){F.path.exists(F.path.databases(r.name+"-binary"),function(t,a,i){t&&!i&&n.push(Path.join(F.config["directory-databases"],r.name+"-binary")),e()})}),a.async(function(){n.length?F.backup(e,n,t):t(new Error("No files for backuping."))}),r},Database.prototype.backup2=function(e,t){"boolean"==typeof e&&(t=e,e="");var r=this;if(r.readonly&&r.throwReadonly(),t)return r.remove(e||"");var n=new DatabaseBuilder2(r),a=Fs.createReadStream(r.filename);return a.pipe(Fs.createWriteStream(e||r.filenameBackup2)),a.on("error",function(e){n.$log&&n.$log(),n.$callback&&n.$callback(errorhandling(e,n)),n.$callback=null}),a.on("end",function(){n.$log&&n.$log(),n.$callback&&n.$callback(errorhandling(null,n,!0),!0),n.$callback=null}),n},Database.prototype.drop=function(){var e=this;return e.readonly&&e.throwReadonly(),e.pending_drops=!0,setImmediate(next_operation,e,7),e},Database.prototype.free=function(e){var t=this;return e||t.$free?(t.counter.removeAllListeners(!0),t.binary.removeAllListeners(!0),t.removeAllListeners(!0),delete F.databases[t.name],t):t},Database.prototype.release=function(){var e=this;return e.inmemory={},e.inmemorylastusage=void 0,e},Database.prototype.clear=Database.prototype.remove=function(e){var t=this;t.readonly&&t.throwReadonly();var r=new DatabaseBuilder(t),n=void 0===e?void 0:e||t.filenameBackup2;return n&&(n=new Backuper(n)),t.pending_remove.push({builder:r,count:0,backup:n}),setImmediate(next_operation,t,3),r},Database.prototype.find=function(e){var t=this,r=new DatabaseBuilder(t);return e?(t.pending_reader_view.push({builder:r,count:0,counter:0,view:e}),setImmediate(next_operation,t,6,r)):(t.pending_reader.push({builder:r,count:0,counter:0}),setImmediate(next_operation,t,4,r)),r},Database.prototype.throwReadonly=function(){throw new Error('Database "{0}" is readonly.'.format(this.name))},Database.prototype.scalar=function(e,t,r){return this.find(r).scalar(e,t)},Database.prototype.count=function(e){var t=this,r=new DatabaseBuilder(t);return e?(t.pending_reader_view.push({builder:r,count:0,view:e,type:1}),setImmediate(next_operation,t,6)):(t.pending_reader.push({builder:r,count:0,type:1}),setImmediate(next_operation,t,4)),r},Database.prototype.one=function(e){var t=this,r=new DatabaseBuilder(t);return r.first(),e?(t.pending_reader_view.push({builder:r,count:0,view:e}),setImmediate(next_operation,t,6,r)):(t.pending_reader.push({builder:r,count:0}),setImmediate(next_operation,t,4,r)),r},Database.prototype.top=function(e,t){var r=this,n=new DatabaseBuilder(r);return n.take(e),t?(r.pending_reader_view.push({builder:n,count:0,counter:0,view:t}),setImmediate(next_operation,r,6,n)):(r.pending_reader.push({builder:n,count:0,counter:0}),setImmediate(next_operation,r,4,n)),n},Database.prototype.view=function(e){var t=new DatabaseBuilder(this);return this.views[e]={},this.views[e]=t,this.views[e].$filename=this.filename.replace(/\.nosql/,"#"+e+".nosql"),t},Database.prototype.lock=function(){return this.locked=!0,this},Database.prototype.unlock=function(){return this.locked=!1,next_operation(this,0),this},Database.prototype.next=function(e){if(!(this.locked||e&&9===this.step)){if(this.renaming)return void(!e&&(this.step=0));if(this.step<2){if(2!==this.step&&this.pending_update.length)return void(INMEMORY[this.name]?this.$update_inmemory():this.$update());if(3!==this.step&&this.pending_remove.length)return void(INMEMORY[this.name]?this.$remove_inmemory():this.$remove())}return 6!==this.step&&this.pending_reader_view.length?void this.$readerview():4!==this.step&&this.pending_reader.length?void this.$reader():1!==this.step&&this.pending_append.length?void(INMEMORY[this.name]?this.$append_inmemory():this.$append()):7!==this.step&&this.pending_drops?void this.$drop():5!==this.step&&this.pending_views?void(INMEMORY[this.name]?this.$views_inmemory():this.$views()):void(this.step!==e&&(this.step=0,setImmediate(next_operation,this,0)))}},Database.prototype.refresh=function(){return this.views?(this.pending_views=!0,setImmediate(next_operation,this,5)):F.cluster&&this.$unlock(),this},Database.prototype.$lock=function(){return 2===this.lockwait?!1:(CLUSTER_LOCK.name=this.name,process.send(CLUSTER_LOCK),1===this.lockwait?!0:2===this.lockwait?!1:(this.lockwait=1,setTimeout(locker_timeout,CLUSTER_TIMEOUT,this),!0))},Database.prototype.$unlock=function(){this.lockwait&&(this.lockwait=0,CLUSTER_UNLOCK.name=this.name,process.send(CLUSTER_UNLOCK))},Database.prototype.$save=function(e){var t=this;return setTimeout2("nosql."+t.name+"."+e,function(){for(var r=t.inmemory[e]||EMPTYARRAY,n=[],a=0,i=r.length;i>a;a++)n.push(JSON.stringify(r[a]));var o=t.filename;"#"!==e&&(o=o.replace(/\.nosql/,"#"+e+".nosql")),Fs.writeFile(o,n.join(NEWLINE)+NEWLINE,NOOP)},50,100),t},Database.prototype.$inmemory=function(e,t){var r=this;if(r.readonly&&r.throwReadonly(),r.inmemorylastusage=global.F?global.F.datetime:void 0,r.inmemory[e])return t();var n=r.filename;return"#"!==e&&(n=n.replace(/\.nosql/,"#"+e+".nosql")),r.inmemory[e]=[],Fs.readFile(n,function(n,a){if(n)return t();for(var i=a.toString("utf8").split("\n"),o=0,s=i.length;s>o;o++){var u=i[o];if(u)try{u=JSON.parse(u.trim(),jsonparser),u&&r.inmemory[e].push(u)}catch(c){}}t()}),r},Database.prototype.$meta=function(e){var t=this;if(e)return t.readonly&&t.throwReadonly(),Fs.writeFile(t.filenameMeta,JSON.stringify(t.metadata),function(){F.isCluster&&(CLUSTER_META.name=t.name,process.send(CLUSTER_META))}),t;if(t.readonly)return t;try{t.metadata=JSON.parse(Fs.readFileSync(t.filenameMeta).toString("utf8"),jsonparser)}catch(r){}return t},Database.prototype.$append=function(){var e=this;return e.step=1,e.locked||!e.pending_append.length?void e.next(0):void(F.isCluster&&e.$lock()||e.pending_append.splice(0).limit(20,function(t,r){for(var n=[],a=0,i=t.length;i>a;a++)n.push(t[a].doc);Fs.appendFile(e.filename,n.join(NEWLINE)+NEWLINE,function(e){for(var n=0,a=t.length;a>n;n++){t[n].builder.$log&&t[n].builder.log();var i=t[n].builder.$callback;i&&i(e,1)}r()})},function(){return setImmediate(next_append,e)}))},Database.prototype.$append_inmemory=function(){var e=this;if(e.step=1,e.locked||!e.pending_append.length)return e.next(0),e;var t=e.pending_append.splice(0);return e.$inmemory("#",function(){for(var r=0,n=t.length;n>r;r++){e.inmemory["#"].push(JSON.parse(t[r].doc,jsonparser)),t[r].builder.$log&&t[r].builder.log();var a=t[r].builder.$callback;a&&a(null,1)}e.$save("#"),setImmediate(next_append,e)})},Database.prototype.$update=function(){var e=this;if(e.step=2,e.locked||!e.pending_update.length)return e.next(0),e;if(!F.isCluster||!e.$lock()){var t=Fs.createReadStream(e.filename),r=Fs.createWriteStream(e.filenameTemp),n=e.pending_update.splice(0),a=n.length,i=!1;t.on("data",framework_utils.streamer(NEWLINE,function(t,o){if("{"===t[0]){for(var s=JSON.parse(t.substring(0,t.length-1),jsonparser),u=0;a>u;u++){var c=n[u],l=c.builder,p=l.compare(s,o,!0);if(p){if(l.$backup&&l.$backupdoc(p),c.keys)for(var m=0,f=c.keys.length;f>m;m++){var d=c.doc[c.keys[m]];void 0!==d&&("function"==typeof d?p[c.keys[m]]=d(p[c.keys[m]],p):p[c.keys[m]]=d)}else p="function"==typeof c.doc?c.doc(p):c.doc;e.emit(c.keys?"modify":"update",p),c.count++,i=!0,s=p}}r.write(JSON.stringify(s)+NEWLINE)}}));var o=function(){return i?(e.renaming=!0,e.step&&9!==e.step?(e.next(0),setTimeout(o,100)):(e.step=9,void Fs.rename(e.filenameTemp,e.filename,function(t){for(var r=0;a>r;r++){var o=n[r];o.insert&&!o.count?e.insert(o.insert).$callback=o.builder.$callback:(o.builder.$log&&o.builder.log(),o.builder.$callback&&o.builder.$callback(errorhandling(t,o.builder,o.count),o.count))}setImmediate(function(){e.renaming=!1,e.next(0),i?setImmediate(views_refresh,e):F.isCluster&&e.$unlock()})}))):void Fs.unlink(e.filenameTemp,function(){for(var t=0;a>t;t++){var r=n[t];r.insert&&!r.count?e.insert(r.insert).$callback=r.builder.$callback:(r.builder.$log&&r.builder.log(),r.builder.$callback&&r.builder.$callback(errorhandling(null,r.builder,r.count),r.count))}e.next(0),F.cluster&&e.$unlock()})};return CLEANUP(r,o),CLEANUP(t,function(){return r.end()}),e}},Database.prototype.$update_inmemory=function(){var e=this;if(e.step=2,e.locked||!e.pending_update.length)return e.next(0),e;var t=e.pending_update.splice(0),r=t.length,n=!1;return e.$inmemory("#",function(){for(var a=e.inmemory["#"],i=0,o=a.length;o>i;i++)for(var s=a[i],u=0;r>u;u++){var c=t[u],l=c.builder,p=l.compare(s,i);if(p){if(l.$backup&&l.$backupdoc(s),c.keys)for(var i=0,o=c.keys.length;o>i;i++){var m=c.doc[c.keys[i]];void 0!==m&&("function"==typeof m?s[c.keys[i]]=m(s[c.keys[i]],s):s[c.keys[i]]=m)}else s="function"==typeof c.doc?c.doc(s):c.doc;e.emit(c.keys?"modify":"update",s),c.count++,n=!0}}e.$save("#");for(var u=0;r>u;u++){var c=t[u];c.insert&&!c.count?e.insert(c.insert).$callback=c.builder.$callback:(c.count&&e.emit(c.keys?"modify":"update",c.doc),c.builder.$log&&c.builder.log(),c.builder.$callback&&c.builder.$callback(errorhandling(null,c.builder,c.count),c.count))}setImmediate(function(){e.next(0),n&&setImmediate(views_refresh,e)})})},Database.prototype.$reader=function(){var e=this;if(e.step=4,e.locked||!e.pending_reader.length)return e.next(0),e;var t=e.pending_reader.splice(0);return INMEMORY[e.name]?e.$reader2_inmemory("#",t,function(){return e.next(0)}):e.$reader2(e.filename,t,function(){return e.next(0)}),e},Database.prototype.$readerview=function(){var e=this;if(e.step=6,e.locked||!e.pending_reader_view.length)return e.next(0),e;for(var t={},r=!0,n=0,a=e.pending_reader_view.length;a>n;n++){var i=e.pending_reader_view[n],o=INMEMORY[e.name]||INMEMORY[e.name+"#"+i.view]?i.view:e.views[i.view].$filename;r=!1,t[o]?t[o].push(i):t[o]=[i]}return e.pending_reader_view=[],r?(e.next(0),e):(Object.keys(t).wait(function(r,n){INMEMORY[e.name]||INMEMORY[e.name+"#"+r]?e.$reader2_inmemory(r,t[r],n):e.$reader2(r,t[r],n)},function(){return e.next(0)},5),e)},Database.prototype.$reader2=function(e,t,r,n){var a=this;if(a.readonly){if(void 0===n)return U.download(e,FLAGS_READ,function(n,i){n&&F.error(n,"NoSQL database: "+a.name),a.$reader2(e,t,r,n?null:i)}),a}else n=Fs.createReadStream(e);for(var i=t,o=i.length,s=!0,u=0;o>u;u++)i[u].builder.$first||(s=!1),i[u].scalarcount=0;s&&o>1&&(s=!1),n&&n.on("data",framework_utils.streamer(NEWLINE,function(e,t){if("{"===e[0])for(var r,a=JSON.parse(e.substring(0,e.length-1),jsonparser),u=0;o>u;u++){var c=i[u],l=c.builder,p=l.compare(a,t);if(p&&(c.count++,(l.$inlinesort||!(l.$skip&&l.$skip>=c.count||l.$take&&l.$take<=c.counter))&&(c.counter++,!c.type))){switch(l.$scalar){case"count":c.scalar=c.scalar?c.scalar+1:1;break;case"sum":r=p[l.$scalarfield]||0,c.scalar=c.scalar?c.scalar+r:r;break;case"min":r=p[l.$scalarfield]||0,null!=r&&(c.scalar?c.scalar>r&&(c.scalar=r):c.scalar=r);break;case"max":r=p[l.$scalarfield],null!=r&&(c.scalar?c.scalar<r&&(c.scalar=r):c.scalar=r);break;case"avg":r=p[l.$scalarfield],null!=r&&(c.scalar=c.scalar?c.scalar+r:r,c.scalarcount++);break;case"group":!c.scalar&&(c.scalar={}),r=p[l.$scalarfield],null!=r&&(c.scalar[r]?c.scalar[r]++:c.scalar[r]=1);break;default:l.$inlinesort?nosqlinlinesorter(c,l,p):c.response?c.response.push(p):c.response=[p]}if(s&&n.destroy)return n.destroy(),!1}}}));var c=function(){for(var e=0;o>e;e++){var t,n=i[e],a=n.builder;!a.$scalar&&a.$sort?(n.count&&(a.$sort.name?a.$inlinesort&&a.$take===n.response.length||n.response.quicksort(a.$sort.name,a.$sort.asc):a.$sort===EMPTYOBJECT?n.response.random():n.response.sort(a.$sort),a.$skip&&a.$take?n.response=n.response.splice(a.$skip,a.$take):a.$skip?n.response=n.response.splice(a.$skip):!a.$inlinesort&&a.$take&&(n.response=n.response.splice(0,a.$take))),t=a.$first?n.response?n.response[0]:void 0:n.response||EMPTYARRAY,a.$callback2(errorhandling(null,a,t),1===n.type?n.count:t,n.count),a.done()):(t=a.$scalar?"avg"===a.$scalar?n.scalar/n.scalarcount:n.scalar:a.$first?n.response?n.response[0]:void 0:n.response||EMPTYARRAY,a.$callback2(errorhandling(null,a,t),1===n.type?n.count:t,n.count))}r()};return n?CLEANUP(n,c):c(),a},Database.prototype.$reader2_inmemory=function(e,t,r){var n=this,a=t,i=a.length;return n.$inmemory(e,function(){for(var t,o=n.inmemory[e],s=0,u=o.length;u>s;s++)for(var c=o[s],l=0;i>l;l++){var p=a[l],m=p.builder,f=m.compare(U.clone(c),s);if(f&&(p.count++,(m.$sort||!(m.$skip&&m.$skip>=p.count||m.$take&&m.$take<=p.counter))&&(p.counter++,!p.type)))switch(m.$scalar){case"count":p.scalar=p.scalar?p.scalar+1:1;break;case"sum":t=c[m.$scalarfield]||0,p.scalar=p.scalar?p.scalar+t:t;break;case"min":t=c[m.$scalarfield]||0,null!=t&&(p.scalar?p.scalar>t&&(p.scalar=t):p.scalar=t);break;case"max":t=c[m.$scalarfield],null!=t&&(p.scalar?p.scalar<t&&(p.scalar=t):p.scalar=t);break;case"avg":t=c[m.$scalarfield],null!=t&&(p.scalar=p.scalar?p.scalar+t:0,p.scalarcount?p.scalarcount++:p.scalarcount=1);break;case"group":!p.scalar&&(p.scalar={}),t=f[m.$scalarfield],null!=t&&(p.scalar[t]?p.scalar[t]++:p.scalar[t]=1);break;default:p.response?p.response.push(f):p.response=[f]}}for(var l=0;i>l;l++){var f,p=a[l],m=p.builder;!m.$scalar&&m.$sort?(p.count&&(m.$sort.name?p.response.quicksort(m.$sort.name,m.$sort.asc):m.$sort===EMPTYOBJECT?p.response.random():p.response.sort(m.$sort),m.$skip&&m.$take?p.response=p.response.splice(m.$skip,m.$take):m.$skip?p.response=p.response.splice(m.$skip):m.$take&&(p.response=p.response.splice(0,m.$take))),f=m.$first?p.response?p.response[0]:void 0:p.response||EMPTYARRAY,m.$callback2(errorhandling(null,m,f),1===p.type?p.count:f,p.count),m.done()):(f=m.$scalar?"avg"===m.$scalar?p.scalar/p.counter:p.scalar:m.$first?p.response?p.response[0]:void 0:p.response||EMPTYARRAY,m.$callback2(errorhandling(null,m,f),1===p.type?p.count:f,p.count))}r()})},Database.prototype.$views=function(){var e=this;if(e.step=5,e.locked||!e.pending_views)return F.isCluster&&e.$unlock(),void e.next(0);e.pending_views=!1;var t=Object.keys(e.views),r=t.length;if(!r)return F.isCluster&&e.$unlock(),e.next(0),e;if(!F.isCluster||!e.$lock()){for(var n=[],a=0;r>a;a++)n.push({response:[],name:t[a],builder:e.views[t[a]],count:0,counter:0});var i=Fs.createReadStream(e.filename);i.on("data",framework_utils.streamer(NEWLINE,function(a,i){if("{"===a[0])for(var o=JSON.parse(a.substring(0,a.length-1),jsonparser),s=0;r>s;s++){var u=e.views[t[s]],c=u.compare(o,i);c&&(n[s].count++,(u.$sort||!(u.$skip&&u.$skip>=n[s].count||u.$take&&u.$take<n[s].counter))&&(n[s].counter++,!u.type&&n[s].response.push(c)))}})),CLEANUP(i,function(){n.wait(function(t,r){var n=t.builder;n.$sort&&(n.$sort.name?t.response.quicksort(n.$sort.name,n.$sort.asc):n.$sort===EMPTYOBJECT?t.response.random():t.response.sort(n.$sort),n.$skip&&n.$take?t.response=t.response.splice(n.$skip,n.$take):n.$skip?t.response=t.response.splice(n.$skip):n.$take&&(t.response=t.response.splice(0,n.$take)));var a=n.$filename;Fs.unlink(a,function(){t.response.limit(20,function(e,t){for(var r=[],n=0,i=e.length;i>n;n++)r.push(JSON.stringify(e[n]));Fs.appendFile(a,r.join(NEWLINE)+NEWLINE,t)},function(){e.inmemory[t.name]=void 0,r()})})},function(){F.isCluster&&e.$unlock(),e.next(0)},5)})}},Database.prototype.$views_inmemory=function(){var e=this;if(e.step=5,e.locked||!e.pending_views)return e.next(0),e;e.pending_views=!1;var t=Object.keys(e.views),r=t.length;if(!r)return e.next(0),e;for(var n=[],a=0;r>a;a++)n.push({response:[],name:t[a],builder:e.views[t[a]],count:0,counter:0});return e.$inmemory("#",function(){for(var a=e.inmemory["#"],i=0,o=a.length;o>i;i++)for(var s=a[i],u=0;r>u;u++){var c=e.views[t[u]],l=c.compare(s,i);l&&(n[u].count++,(c.$sort||!(c.$skip&&c.$skip>=n[u].count||c.$take&&c.$take<n[u].counter))&&(n[u].counter++,!c.type&&n[u].response.push(l)))}for(var i=0,o=n.length;o>i;i++){var c=n[i],p=c.builder;p.$sort&&(p.$sort.name?c.response.quicksort(p.$sort.name,p.$sort.asc):p.$sort===EMPTYOBJECT?c.response.random():c.response.sort(p.$sort),p.$skip&&p.$take?c.response=c.response.splice(p.$skip,p.$take):p.$skip?c.response=c.response.splice(p.$skip):p.$take&&(c.response=c.response.splice(0,p.$take))),e.inmemory[c.name]=c.response,e.$save(c.name)}e.next(0)})},Database.prototype.$remove=function(){var e=this;if(e.step=3,!e.pending_remove.length)return void e.next(0);var t=Fs.createReadStream(e.filename),r=Fs.createWriteStream(e.filenameTemp),n=e.pending_remove.splice(0),a=n.length,i=!1;if(!F.isCluster||!e.$lock()){t&&t.on("data",framework_utils.streamer(NEWLINE,function(t,o){if("{"===t[0]){for(var s=JSON.parse(t.substring(0,t.length-1),jsonparser),u=!1,c=0;a>c;c++){var l=n[c],p=l.builder,m=p.compare(s,o);if(m){p.$backup&&p.$backupdoc(m),u=!0,s=m;break}}if(u){for(var c=0;a>c;c++){var l=n[c];l.backup&&l.backup.write(t),l.count++}e.emit("remove",s),i=!0}else r.write(t)}}));var o=function(){return i?(e.renaming=!0,e.step&&9!==e.step?(e.next(0),setTimeout(o,100)):(e.step=9,void Fs.rename(e.filenameTemp,e.filename,function(){for(var t=0;a>t;t++){var r=n[t];r.builder.$log&&r.builder.log(),r.builder.$callback&&r.builder.$callback(errorhandling(null,r.builder,r.count),r.count)}setImmediate(function(){e.renaming=!1,e.next(0),i?setImmediate(views_refresh,e):F.cluster&&e.$unlock()})}))):void Fs.unlink(e.filenameTemp,function(){for(var t=0;a>t;t++){var r=n[t];r.builder.$log&&r.builder.log(),r.builder.$callback&&r.builder.$callback(errorhandling(null,r.builder,r.count),r.count)}e.next(0),F.cluster&&e.$unlock()})};CLEANUP(r,o),CLEANUP(t,function(){return r.end()})}},Database.prototype.$remove_inmemory=function(){var e=this;if(e.step=3,e.locked||!e.pending_remove.length)return e.next(0),e;var t=e.pending_remove.splice(0),r=t.length,n=!1;return e.$inmemory("#",function(){for(var a=e.inmemory["#"],i=[],o=0,s=a.length;s>o;o++){for(var u=a[o],c=!1,l=0;r>l;l++){var p=t[l],m=p.builder;if(m.compare(u,o)){c=!0;break}}if(c){for(var l=0;r>l;l++){var p=t[l];p.backup&&p.backup.write(JSON.stringify(u)),p.count++}n=!0,e.emit("remove",u)}else i.push(u)}n&&(e.inmemory["#"]=i,e.$save("#"));for(var l=0;r>l;l++){var p=t[l];p.builder.$log&&p.builder.log(),p.builder.$callback&&p.builder.$callback(errorhandling(null,p.builder,p.count),p.count)}e.next(0),n&&setImmediate(views_refresh,e)})},Database.prototype.$drop=function(){var e=this;if(e.step=7,e.locked||!e.pending_drops)return void e.next(0);if(!F.isCluster||!e.$lock()){e.pending_drops=!1;var t=[e.filename,e.filenameTemp];Object.keys(e.views).forEach(function(r){return t.push(e.views[r].$filename)});try{Fs.readdirSync(e.binary.directory).forEach(function(r){r.startsWith(e.name+"#")&&r.endsWith(EXTENSION_BINARY)&&t.push(framework_utils.join(e.binary.directory,r))})}catch(r){}t.wait(function(e,t){return Fs.unlink(e,t)},function(){F.isCluster&&e.$unlock(),e.next(0),e.free(!0)},5),Object.keys(e.inmemory).forEach(function(t){e.inmemory[t]=void 0})}},DatabaseBuilder2.prototype.log=function(e,t){var r=this;return e?(F.datetime=new Date,r.$log=(r.$log?r.$log:"")+F.datetime.format("yyyy-MM-dd HH:mm:ss")+" | "+(t?t.padRight(20)+" | ":"")+e+NEWLINE):r.$log&&(r.db.filenameLog&&Fs.appendFile(r.db.filenameLog,r.$log,NOOP),r.$log=""),r},DatabaseBuilder2.prototype.callback=function(e,t){if("string"==typeof e){var r=t;t=e,e=r}return this.$callback=e,this.$callback_emptyerror=t,this},DatabaseBuilder.prototype.log=function(e,t){var r=this;return e?(F.datetime=new Date,r.$log=(r.$log?r.$log:"")+F.datetime.format("yyyy-MM-dd HH:mm:ss")+" | "+(t?t.padRight(20)+" | ":"")+e+NEWLINE):r.$log&&(r.db.filenameLog&&Fs.appendFile(r.db.filenameLog,r.$log,NOOP),r.$log=""),r},DatabaseBuilder.prototype.$callback2=function(e,t,r){var n=this;if(e||!n.$join)return n.$log&&n.log(),n.$callback(e,t,r);if(n.$joincount)return setImmediate(function(){return n.$callback2(e,t,r)}),n;var a=Object.keys(n.$join),i=a.length;if(t instanceof Array)for(var o=0,s=t.length;s>o;o++)for(var u=t[o],c=0;i>c;c++){var l=n.$join[a[c]];u[l.field]=l.scalar?scalar(l.items,l.scalar,l.scalarfield,l.a,null!=l.b?u[l.b]:void 0):l.first?findItem(l.items,l.a,u[l.b],l.scalar,l.scalarfield):findItems(l.items,l.a,u[l.b])}else if(t)for(var c=0;i>c;c++){var l=n.$join[a[c]];t[l.field]=l.scalar?scalar(l.items,l.scalar,l.scalarfield,l.a,null!=l.b?t[l.b]:void 0):l.first?findItem(l.items,l.a,t[l.b],l.scalar,l.scalarfield):findItems(l.items,l.a,t[l.b])}return n.$log&&n.log(),n.$callback(e,t,r),n},DatabaseBuilder.prototype.join=function(e,t,r){var n=this;n.$join||(n.$join={},n.$joincount=0);var a=t+"."+(r||"")+"."+e,i=n.$join[a];return i?i:(n.$join[a]={},n.$join[a].field=e,n.$join[a].pending=!0,n.$joincount++,i=NOSQL(t).find(r),i.on=function(e,t){return n.$join[a].a=e,n.$join[a].b=t,i},i.$where=n.where,i.where=function(e,t,r){return void 0===r&&"string"==typeof t?i.on(e,t):i.$where(e,t,r)},i.scalar=function(e,t){return n.$join[a].scalar=e,n.$join[a].scalarfield=t,i},i.first=function(){return n.$join[a].first=!0,i},i.callback(function(e,t){n.$join[a].pending=!1,n.$join[a].items=t,n.$joincount--}),setImmediate(function(){i.$fields&&i.fields(n.$join[a].b),i.$fields&&n.$join[a].scalarfield&&i.fields(n.$join[a].scalarfield)}),i)},DatabaseBuilder.prototype.first=function(){return this.$first=!0,this.take(1)},DatabaseBuilder.prototype.make=function(e){return e.call(this,this),this},DatabaseBuilder.prototype.compare=function(e,t){for(var r=!0,n=!1,a=0,i=0,o=this.$filter.length;o>i;i++){var s=this.$filter[i];if(!n||!s.scope){if(a&&!s.scope&&!n)return;a=s.scope;var u=s.filter(e,i,s);if(u!==!0){if(!s.scope)return;r=!1,n=!1}else r=!0,s.scope&&(n=!0)}}if(r){if(this.$prepare)return this.$prepare(e,t);if(!this.$fields)return e;for(var c={},i=0,o=this.$fields.length;o>i;i++){var l=this.$fields[i];c[l]=e[l]}return c}},DatabaseBuilder.prototype.filter=function(e){return this.$filter.push({scope:this.$scope,filter:e}),this},DatabaseBuilder.prototype.scalar=function(e,t){return this.$scalar=e,this.$scalarfield=t,this},DatabaseBuilder.prototype.contains=function(e){return this.$filter.push({scope:this.$scope,filter:compare_notempty,name:e}),this},DatabaseBuilder.prototype.empty=function(e){return this.$filter.push({scope:this.$scope,filter:compare_empty,name:e}),this},DatabaseBuilder.prototype.backup=function(e){return this.db.filenameBackup?this.$backup="string"==typeof e?e:"unknown":this.$backup=null,this},DatabaseBuilder.prototype.$backupdoc=function(e){return this.db.filenameBackup&&Fs.appendFile(this.db.filenameBackup,F.datetime.format("yyyy-MM-dd HH:mm")+" | "+this.$backup.padRight(20)+" | "+JSON.stringify(e)+NEWLINE,NOOP),this},DatabaseBuilder.prototype.where=function(e,t,r){var n;void 0===r&&(r=t,t="=");var a=framework_utils.isDate(r);switch(t){case"=":n=a?compare_eq_date:compare_eq;break;case"<":n=a?compare_gt_date:compare_gt;break;case"<=":n=a?compare_eqgt_date:compare_eqgt;break;case">":n=a?compare_lt_date:compare_lt;break;case">=":n=a?compare_eqlt_date:compare_eqlt;break;case"<>":case"!=":n=a?compare_not_date:compare_not,t="!="}return this.$filter.push({scope:this.$scope,filter:n,name:e,value:r,operator:t,ticks:a?r.getTime():0}),this},DatabaseBuilder.prototype.month=function(e,t,r){var n;switch(void 0===r&&(r=t,t="="),t){case"=":n=compare_eq_dtmonth;break;case"<":n=compare_gt_dtmonth;break;case"<=":n=compare_eqgt_dtmonth;break;case">":n=compare_lt_dtmonth;break;case">=":n=compare_eqlt_dtmonth;break;case"<>":case"!=":n=compare_not_dtmonth}return this.$filter.push({scope:this.$scope,filter:n,name:e,value:r}),this},DatabaseBuilder.prototype.day=function(e,t,r){var n;switch(void 0===r&&(r=t,t="="),t){case"=":n=compare_eq_dtday;break;case"<":n=compare_gt_dtday;break;case"<=":n=compare_eqgt_dtday;break;case">":n=compare_lt_dtday;break;case">=":n=compare_eqlt_dtday;break;case"<>":case"!=":n=compare_not_dtday}return this.$filter.push({scope:this.$scope,filter:n,name:e,value:r}),this},DatabaseBuilder.prototype.year=function(e,t,r){var n;switch(void 0===r&&(r=t,t="="),t){case"=":n=compare_eq_dtyear;break;case"<":n=compare_gt_dtyear;break;case"<=":n=compare_eqgt_dtyear;break;case">":n=compare_lt_dtyear;break;case">=":n=compare_eqlt_dtyear;break;case"<>":case"!=":n=compare_not_dtyear}return this.$filter.push({scope:this.$scope,filter:n,name:e,value:r}),this},DatabaseBuilder.prototype.like=DatabaseBuilder.prototype.search=function(e,t,r){var n;switch(r||(r="*"),r){case"beg":n=compare_likebeg;break;case"end":n=compare_likeend;break;case"*":if(n=compare_like,t instanceof Array)for(var a=0,i=t.length;i>a;a++)t[a]=t[a].toLowerCase();else t=t.toLowerCase()}return this.$filter.push({scope:this.$scope,name:e,filter:n,value:t,operator:"beg"===r?10:"end"===r?11:12}),this},DatabaseBuilder.prototype.take=function(e){return this.$take=e,this},DatabaseBuilder.prototype.limit=function(e){return this.$take=e,this},DatabaseBuilder.prototype.page=function(e,t){return this.$skip=e*t,this.$take=t,this},DatabaseBuilder.prototype.paginate=function(e,t,r){var n=+(t||0),a=+(e||0)-1;return 0>a&&(a=0),r&&n>r&&(n=r),n||(n=r),this.$skip=a*n,this.$take=n,this},DatabaseBuilder.prototype.skip=function(e){return this.$skip=e,this},DatabaseBuilder.prototype.callback=function(e,t){if("string"==typeof e){var r=t;t=e,e=r}return this.$callback=e,this.$callback_emptyerror=t,this},DatabaseBuilder.prototype.random=function(){return this.$sort=EMPTYOBJECT,this},DatabaseBuilder.prototype.sort=function(e,t){return"function"==typeof e?(this.$sort=e,this):(this.$sort={name:e,asc:t?!1:!0},this)},DatabaseBuilder.prototype.$sortinline=function(){return this.$inlinesort=this.$take&&this.$sort&&this.$sort!==EMPTYOBJECT,this.$limit=(this.$take||0)+(this.$skip||0),this},DatabaseBuilder.prototype["in"]=function(e,t){return t instanceof Array||(t=[t]),this.$filter.push({scope:this.$scope,name:e,filter:compare_in,value:t}),this},DatabaseBuilder.prototype.notin=function(e,t){return t instanceof Array||(t=[t]),this.$filter.push({scope:this.$scope,name:e,filter:compare_notin,value:t}),this},DatabaseBuilder.prototype.between=function(e,t,r){return this.$filter.push({scope:this.$scope,name:e,filter:compare_between,a:t,b:r}),this},DatabaseBuilder.prototype.or=function(){return this.$scope=1,this},DatabaseBuilder.prototype.end=function(){return this.$scope=0,this},DatabaseBuilder.prototype.and=function(){return this.$scope=0,this},DatabaseBuilder.prototype.done=function(){return this.$filter=null,this.$sort=null,this},DatabaseBuilder.prototype.cache=function(){return OBSOLETE("DatabaseBuilder.cache()","NoSQL database supports in-memory mode."),this},DatabaseBuilder.prototype.fields=function(){this.$fields||(this.$fields=[]);for(var e=0,t=arguments.length;t>e;e++)this.$fields.push(arguments[e]);return this},DatabaseBuilder.prototype.prepare=function(e){return this.$prepare=e,this},Counter.prototype.convert2=function(e){var t=Fs.createReadStream(e),r=Fs.createWriteStream(e+"2"),n=this;return n.type=100,t.on("data",framework_utils.streamer(NEWLINE,function(e){for(var t=e.split(";"),n={},a=1,i=t.length;i>a;a++){var o=t[a],s=o.substring(0,4);!n[s]&&(n[s]=["sum"+s+t[0]]),n[s].push(o.substring(4,6)+"01"+o.substring(6).trim())}t=Object.keys(n);for(var a=0,i=t.length;i>a;a++){var s=t[a],o=n[s];r.write(o.join(";")+NEWLINE)}})),t.on("end",function(){r.end()}),r.on("finish",function(){Fs.rename(e,e+"-backup",function(){n.type=0})}),n},Counter.prototype.emit=function(e,t,r,n,a,i,o,s){var u=this.$events[e];if(u){for(var c=!1,l=0,p=u.length;p>l;l++)u[l].$once&&(c=!0),u[l].call(this,t,r,n,a,i,o,s);c&&(u=u.remove(function(e){return e.$once}),u.length?this.$events[e]=u:this.$events[e]=void 0)}return this},Counter.prototype.on=function(e,t){return t.$once||(this.db.$free=!1),this.$events[e]?this.$events[e].push(t):this.$events[e]=[t],this},Counter.prototype.once=function(e,t){return t.$once=!0,this.on(e,t)},Counter.prototype.removeListener=function(e,t){var r=this.$events[e];return r&&(r=r.remove(function(e){return e===t}),r.length?this.$events[e]=r:this.$events[e]=void 0),this},Counter.prototype.removeAllListeners=function(e){return e===!0?this.$events=EMPTYOBJECT:e?this.$events[e]=void 0:this.$events={},this},Counter.prototype.empty=function(e,t){var r=this;return!r.cache&&(r.cache={}),r.cache[e]="m"===e[2]?t:[t,t],r},Counter.prototype.min=function(e,t){var r=this;if(e instanceof Array){for(var n=0,a=e.length;a>n;n++)r.min(e[n],t);return r}var i="mma"+F.datetime.getFullYear()+e;if(r.cache&&r.cache[i]){var o=r.cache[i];o[0]>t&&(o[0]=t),o[1]<t&&(o[1]=t)}else r.empty(i,t);return setTimeout2(r.key,function(){return r.save()},r.TIMEOUT,5),this.$events.min&&r.emit("min",e,t||1),r},Counter.prototype.max=function(e,t){var r=this;if(e instanceof Array){for(var n=0,a=e.length;a>n;n++)r.min(e[n],t);return r}var i="mma"+F.datetime.getFullYear()+e;if(r.cache&&r.cache[i]){var o=r.cache[i];o[0]>t&&(o[0]=t),o[1]<t&&(o[1]=t)}else r.empty(i,t);return setTimeout2(r.key,function(){return r.save()},r.TIMEOUT,5),this.$events.max&&r.emit("max",e,t||1),r},Counter.prototype.inc=Counter.prototype.hit=function(e,t){var r=this;if(e instanceof Array){for(var n=0,a=e.length;a>n;n++)r.min(e[n],t);return r}var i="sum"+F.datetime.getFullYear()+e;return r.cache&&r.cache[i]?r.cache[i]+=t||1:r.empty(i,t||1),setTimeout2(r.key,function(){return r.save()},r.TIMEOUT,5),this.$events.sum&&r.emit("sum",e,t||1),this.$events.hits&&r.emit("hit",e,t||1),r},Counter.prototype.remove=function(e){var t=this;return!t.cache&&(t.cache={}),e instanceof Array?e.forEach(function(e){return t.cache[e]=null}):t.cache[e]=null,setTimeout2(t.key,function(){return t.save()},t.TIMEOUT,5),t.emit("remove",e),t},Counter.prototype.count=function(e,t){"function"==typeof e&&(t=e,e=null);var r={};return r.subtype=0,r.id=e,r.type="sum",this.read(r,t)},Counter.prototype.maximum=function(e,t){"function"==typeof e&&(t=e,e=null);var r={};return r.subtype=0,r.id=e,r.type="mma",r.type2="max",this.read(r,t)},Counter.prototype.minimum=function(e,t){"function"==typeof e&&(t=e,e=null);var r={};return r.subtype=0,r.id=e,r.type="mma",r.type2="min",this.read(r,t)},Counter.prototype.yearly=Counter.prototype.yearly_sum=function(e,t){"function"==typeof e&&(t=e,e=null);var r={};return r.subtype=1,r.id=e,r.type="sum",this.read(r,t)},Counter.prototype.monthly=Counter.prototype.monthly_sum=function(e,t){"function"==typeof e&&(t=e,e=null);var r={};return r.subtype=2,r.id=e,r.type="sum",this.read(r,t)},Counter.prototype.daily=Counter.prototype.daily_sum=function(e,t){"function"==typeof e&&(t=e,e=null);var r={};return r.subtype=3,r.id=e,r.type="sum",this.read(r,t)},Counter.prototype.yearly_max=function(e,t){"function"==typeof e&&(t=e,e=null);var r={};return r.subtype=1,r.id=e,r.type="mma",r.type2="max",this.read(r,t)},Counter.prototype.monthly_max=function(e,t){"function"==typeof e&&(t=e,e=null);var r={};return r.subtype=2,r.id=e,r.type="mma",r.type2="max",this.read(r,t)},Counter.prototype.daily_max=function(e,t){"function"==typeof e&&(t=e,e=null);var r={};return r.subtype=3,r.id=e,r.type="mma",r.type2="max",this.read(r,t)},Counter.prototype.yearly_min=function(e,t){"function"==typeof e&&(t=e,e=null);var r={};return r.subtype=1,r.id=e,r.type="mma",r.type2="min",this.read(r,t)},Counter.prototype.monthly_min=function(e,t){"function"==typeof e&&(t=e,e=null);var r={};return r.subtype=2,r.id=e,r.type="mma",r.type2="min",this.read(r,t)},Counter.prototype.daily_min=function(e,t){"function"==typeof e&&(t=e,e=null);var r={};return r.subtype=3,r.id=e,r.type="mma",r.type2="min",this.read(r,t)},Counter.prototype.read=function(e,t,r){var n=this;if(n.type&&void 0===r)return setTimeout(function(){return n.read(e,t)},200),n;if(n.type=2,n.db.readonly){if(void 0===r)return U.download(n.db.filenameCounter,FLAGS_READ,function(r,a){n.read(e,t,r?null:a)}),n}else r=Fs.createReadStream(n.db.filenameCounter);var a={},i=!1,o=e.id?!1:!0,s=o&&!e.subtype?null:{};if("string"==typeof e.id&&(e.id=[e.id],i=!0),e.id)for(var u=0,c=e.id.length;c>u;u++)a[e.type+e.id[u]]=!0;r&&(r.on("error",function(){n.type=0,t(null,i?e.subtype?EMPTYARRAY:0:o?EMPTYARRAY:s)}),r.on("data",framework_utils.streamer(NEWLINE,function(t,r){var r=t.indexOf("="),n=t.substring(7,r),i=t.substring(0,3);if(e.type===i){var u,c=t.substring(3,7);if(o||e.id===!0||a[i+n])switch(e.subtype){case 0:var l=t.substring(r+1,t.indexOf(";"));switch(e.type2||e.type){case"max":var p=counter_minmax(e,l);o?null==s?s=p:p>s&&(s=p):s[n]=p;break;case"min":var p=counter_minmax(e,l);o?null==s?s=p:s>p&&(s=p):s[n]=p;break;case"sum":o?s=(s||0)+ +l:s[n]=+l}break;case 1:o?counter_parse_years_all(s,t,c,e):(u=counter_parse_years(t,c,e),s[n]?s[n].push.apply(s[n],u):s[n]=u);break;case 2:o?counter_parse_months_all(s,t,c,e):(u=counter_parse_months(t,c,e),s[n]?s[n].push.apply(s[n],u):s[n]=u);break;case 3:o?counter_parse_days_all(s,t,c,e):(u=counter_parse_days(t,c,e),s[n]?s[n].push.apply(s[n],u):s[n]=u)}}})));var l=function(){if(n.type=0,o&&e.subtype){var r,a=[];switch(e.subtype){case 3:r=Object.keys(s);for(var u=0,c=r.length;c>u;u++){var l=r[u];a.push({id:l,year:+l.substring(0,4),month:+l.substring(4,6),day:+l.substring(6,8),value:s[l]})}break;case 2:r=Object.keys(s);for(var u=0,c=r.length;c>u;u++){var l=r[u];a.push({id:l,year:+l.substring(0,4),month:+l.substring(4,6),value:s[l]})}break;case 1:r=Object.keys(s);for(var u=0,c=r.length;c>u;u++){var l=r[u];a.push({id:l,year:+l.substring(0,4),value:s[l]})}}s=a}t(null,i?e.subtype?s[e.id[0]]||EMPTYARRAY:s[e.id[0]]||0:s)};return r?r.on("end",l):l(),n},Counter.prototype.stats_max=function(e,t,r,n,a){return this.stats(e,t,r,n,a,"max")},Counter.prototype.stats_min=function(e,t,r,n,a){return this.stats(e,t,r,n,a,"min")},Counter.prototype.stats=Counter.prototype.stats_sum=function(e,t,r,n,a,i,o){var s=this;if(s.type&&void 0===o)return setTimeout(function(){return s.stats(e,t,r,n,a,i)},200),s;if(s.type=3,s.db.readonly){if(void 0===o)return U.download(s.db.filenameCounter,FLAGS_READ,function(o,u){o?(s.type=0,a&&a(o,[])):s.stats(e,t,r,n,a,i,u)}),s}else o=Fs.createReadStream(s.db.filenameCounter);"function"==typeof n?(a=n,n=null):"function"==typeof r?(a=r,r=null):"function"==typeof t&&(a=t,t=r=null);var u=null,c=[];i||(i="sum"),t&&(n?(u=r.padLeft(2,"0")+n.padLeft(2,"0"),u=new RegExp(";"+u+"=[0-9X\\.]+","g")):r&&(u=r.padLeft(2,"0")+"\\d{2}",u=new RegExp(";"+u+"=[0-9X\\.]+","g"))),o.on("error",function(){s.type=0,a&&a(null,c)}),t>0&&(t=t.toString());var l={};return"sum"!==i?(l.type="mma",l.type2=i):l.type=i,o.on("data",framework_utils.streamer(NEWLINE,function(a,o){var o=a.indexOf("=");if(!(a.substring(0,3)!==l.type||t&&a.substring(3,7)!==t)){var s=null;if(u){var p=a.match(u);if(!p)return;s=counter_parse_stats(p,l)}else{var m=a.substring(o+1,a.indexOf(";",o));s=l.type2?counter_minmax(l,m):+m}null!=s&&counter_parse_stats_avg(c,e,a.substring(7,o),s,i,void 0,null==t&&null==r&&null==n)}})),o.on("end",function(){s.type=0,c.sort(counter_sort_sum),a&&a(null,c)}),s},Counter.prototype.save=function(){var e=this;if(e.db.readonly&&e.db.throwReadonly(),e.type||e.locked)return setTimeout(function(){return e.save()},200),e;var t=e.db.filename+EXTENSION_COUNTER,r=Fs.createReadStream(t),n=Fs.createWriteStream(t+"-tmp"),a=F.datetime.format("MMdd")+"=",i=e.cache,o=0;e.cache=null,e.type=1,F.isCluster&&(CLUSTER_LOCK_COUNTER.name=e.name,process.send(CLUSTER_LOCK_COUNTER));var s=function(){for(var e=Object.keys(i),t=0,r=e.length;r>t;t++){var s=i[e[t]];if(null!=s){var u=s instanceof Array?s[0]+"X"+s[1]:s;n.write(e[t]+"="+u+";"+a+u+NEWLINE),o++}}n.end()};return r.on("data",framework_utils.streamer(NEWLINE,function(e,t){var r=e.substring(0,e.indexOf("=")),s=i[r];if(null!==s){if(void 0===s)return void n.write(e);var u=e.trim().split(";"),c=!1,t=u[0].indexOf("="),l=r.substring(0,3);switch(l){case"mma":var p=u[0].substring(t+1),m=p.indexOf("X");COUNTER_MMA[0]=+p.substring(0,m),COUNTER_MMA[1]=+p.substring(m+1),COUNTER_MMA[0]>s[0]&&(COUNTER_MMA[0]=s[0]),COUNTER_MMA[1]<s[1]&&(COUNTER_MMA[1]=s[1]),u[0]=u[0].substring(0,t+1)+COUNTER_MMA[0]+"X"+COUNTER_MMA[1];break;case"max":u[0]=u[0].substring(0,t+1)+Math.max(+u[0].substring(t+1),s);break;case"min":u[0]=u[0].substring(0,t+1)+Math.min(+u[0].substring(t+1),s);break;case"sum":u[0]=u[0].substring(0,t+1)+(+u[0].substring(t+1)+s)}for(var f=1,d=u.length;d>f;f++){var h=u[f],v=h.substring(0,5);if(v===a){switch(c=!0,l){case"mma":var p=h.substring(5),m=p.indexOf("X");COUNTER_MMA[0]=+p.substring(0,m),COUNTER_MMA[1]=+p.substring(m+1),COUNTER_MMA[0]>s[0]&&(COUNTER_MMA[0]=s[0]),COUNTER_MMA[1]<s[1]&&(COUNTER_MMA[1]=s[1]),u[f]=v+COUNTER_MMA[0]+"X"+COUNTER_MMA[1];break;case"sum":u[f]=v+(+h.substring(5)+s)}break}}i[r]=void 0,!c&&u.push(a+(s instanceof Array?s[0]+"X"+s[1]:s)),n.write(u.join(";")+NEWLINE),o++}})),r.on("error",s),r.on("end",s),CLEANUP(n,function(){Fs.rename(t+"-tmp",t,function(){clearTimeout(e.timeout),e.timeout=0,e.type=0,F.isCluster&&(CLUSTER_UNLOCK_COUNTER.name=e.name,process.send(CLUSTER_UNLOCK_COUNTER)),o&&e.$events.stats&&setImmediate(function(){return e.emit("stats",o)})})}),e},Counter.prototype.clear=function(e){var t=this;return t.type||t.locked?(setTimeout(function(){return t.clear(e)},200),t):(F.isCluster&&(CLUSTER_LOCK_COUNTER.name=t.name,process.send(CLUSTER_LOCK_COUNTER)),t.type=3,Fs.unlink(t.db.filename+EXTENSION_COUNTER,function(){F.isCluster&&(CLUSTER_UNLOCK_COUNTER.name=t.name,process.send(CLUSTER_UNLOCK_COUNTER)),t.type=0,t.emit("clear"),e&&e()}),t)},Binary.prototype.emit=function(e,t,r,n,a,i,o,s){var u=this.$events[e];if(u){for(var c=!1,l=0,p=u.length;p>l;l++)u[l].$once&&(c=!0),u[l].call(this,t,r,n,a,i,o,s);c&&(u=u.remove(function(e){return e.$once}),u.length?this.$events[e]=u:this.$events[e]=void 0)}return this},Binary.prototype.on=function(e,t){return t.$once||(this.db.$free=!1),this.$events[e]?this.$events[e].push(t):this.$events[e]=[t],this},Binary.prototype.once=function(e,t){return t.$once=!0,this.on(e,t)},Binary.prototype.removeListener=function(e,t){var r=this.$events[e];return r&&(r=r.remove(function(e){return e===t}),r.length?this.$events[e]=r:this.$events[e]=void 0),this},Binary.prototype.removeAllListeners=function(e){return e===!0?this.$events=EMPTYOBJECT:e?this.$events[e]=void 0:this.$events={},this},Binary.prototype.insert=function(e,t,r){var n=this,a=framework_utils.getContentType(framework_utils.getExtension(e)),i="function"==typeof t;if(i||!t){i&&(r=t,t=void 0);var o=Fs.createReadStream(e);return CLEANUP(o),n.insert_stream(null,framework_utils.getName(e),a,o,r)}if("string"==typeof t)t=framework_utils.createBuffer(t,"base64");else if(t.resume)return n.insert_stream(null,e,a,t,r);var s,u=t.length,c=framework_utils.getExtension(e);switch(n.check(),c){case"gif":s=framework_image.measureGIF(t);break;case"png":s=framework_image.measurePNG(t);break;case"jpg":case"jpeg":s=framework_image.measureJPG(t);break;case"svg":s=framework_image.measureSVG(t)}s||(s={width:0,height:0});var l={name:e,size:u,type:a,width:s.width,height:s.height,created:F.created},p=framework_utils.createBufferSize(BINARY_HEADER_LENGTH);p.fill(" "),p.write(JSON.stringify(l));var m=F.datetime.format("yyMMddHHmm")+"T"+framework_utils.GUID(5),f=n.db.name+"#"+m,d=Fs.createWriteStream(Path.join(n.directory,f+EXTENSION_BINARY));return d.write(p,"binary"),d.end(t),CLEANUP(d),r&&r(null,m,l),n.$events.insert&&n.emit("insert",m,l),m},Binary.prototype.insert_stream=function(e,t,r,n,a){var i=this;i.check();var o={name:t,size:0,type:r,width:0,height:0},s=framework_utils.createBufferSize(BINARY_HEADER_LENGTH);s.fill(" "),s.write(JSON.stringify(o)),e||(e=F.datetime.format("yyMMddHHmm")+"T"+framework_utils.GUID(5));var u=i.db.name+"#"+e,c=Fs.createWriteStream(framework_utils.join(i.directory,u+EXTENSION_BINARY));return c.write(s,"binary"),n.pipe(c),CLEANUP(c),a&&a(null,e,o),i.$events.insert&&i.emit("insert",e,o),e},Binary.prototype.update=function(e,t,r,n){var a=framework_utils.getContentType(framework_utils.getExtension(t)),i="function"==typeof r;if(i||!r){i&&(n=r,r=void 0);var o=Fs.createReadStream(t);return CLEANUP(o),u.insert_stream(e,framework_utils.getName(t),a,o,n)}if("string"==typeof r&&(r=framework_utils.createBuffer(r,"base64")),r.resume)return this.insert_stream(e,t,a,r,n);var s,u=this,c=r.length,l=framework_utils.getExtension(t);switch(u.check(),l){case"gif":s=framework_image.measureGIF(r);break;case"png":s=framework_image.measurePNG(r);break;case"jpg":case"jpeg":s=framework_image.measureJPG(r);break;case"svg":s=framework_image.measureSVG(r)}s||(s={width:0,height:0});var p={name:t,size:c,type:a,width:s.width,height:s.height,created:F.datetime},m=framework_utils.createBufferSize(BINARY_HEADER_LENGTH),f=u.db.name+"#"+e;m.fill(" "),m.write(JSON.stringify(p));var d=Fs.createWriteStream(framework_utils.join(u.directory,f+EXTENSION_BINARY));return d.write(m,"binary"),d.end(r),CLEANUP(d),n&&n(null,e,p),u.$events.insert&&u.emit("insert",e,p),e},Binary.prototype.read=function(e,t){var r=this;r.check(),-1===e.indexOf("#")&&(e=r.db.name+"#"+e);var n=framework_utils.join(r.directory,e+EXTENSION_BINARY),a=Fs.createReadStream(n,{start:0,end:1999,encoding:"binary"});return a.on("error",function(e){t(e)}),a.on("data",function(e){var r=framework_utils.createBuffer(e,"binary").toString("utf8").replace(REG_CLEAN,"");a=Fs.createReadStream(n,{start:BINARY_HEADER_LENGTH}),t(null,a,JSON.parse(r,jsonparser)),CLEANUP(a)}),r},Binary.prototype.remove=function(e,t){var r=this,n=e;r.check(),-1===n.indexOf("#")&&(n=r.db.name+"#"+n);var a=framework_utils.join(r.directory,n+EXTENSION_BINARY);return Fs.unlink(a,function(e){return t&&t(null,e?!1:!0)}),r.$events.remove&&r.emit("remove",e),r},Binary.prototype.check=function(){var e=this;if(e.exists)return e;e.exists=!0;try{Fs.mkdirSync(e.directory)}catch(t){}return e},Binary.prototype.clear=function(e){var t=this;return Fs.readdir(t.directory,function(r,n){if(r)return e(r);for(var a=[],i=t.db.name+"#",o=i.length,s=framework_utils.join(t.directory),u=0,c=n.length;c>u;u++)n[u].substring(0,o)===i&&a.push(s+"/"+n[u]);t.$events.clear&&t.emit("clear",a.length),F.unlink(a,e)}),t},Binary.prototype.all=function(e){var t=this;return t.check(),Fs.readdir(t.directory,function(r,n){if(r)return e(r,EMPTYARRAY);for(var a=[],i=t.db.name+"#",o=i.length,s=0,u=n.length;u>s;s++)n[s].substring(0,o)===i&&a.push(n[s]);var c=framework_utils.join(t.directory),l=[],p=EXTENSION_BINARY.length;a.wait(function(e,t){Fs.stat(c+"/"+e,function(r,n){if(r)return t();var a=Fs.createReadStream(c+"/"+e,{start:0,end:1999,encoding:"binary"});a.on("data",function(t){var r=framework_utils.createBuffer(t,"binary").toString("utf8").replace(REG_CLEAN,"").parseJSON(!0);r&&(r.id=e.substring(o,e.length-p),r.ctime=n.ctime,r.mtime=n.mtime,l.push(r))}),CLEANUP(a,t)})},function(){return e(null,l)},2)}),t},Backuper.prototype.write=function(e){return this.items.push(e),this.flush(),this},Backuper.prototype.flush=function(){var e=this;if(e.is)return e;if(!e.items.length)return e;var t=e.items.join("");return e.is=!0,Fs.appendFile(e.filename,t,function(){e.is=!1,e.flush()}),e.items=[],e};