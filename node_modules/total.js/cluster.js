function master(e,t,s,n){(null==e||"auto"===e)&&(e=require("os").cpus().length),"function"==typeof s?(n=s,s={}):s||(s={}),OPTIONS.count=e,OPTIONS.mode=t,OPTIONS.options=s;require("os");require("./utils"),THREADS=e;for(var r=0;e>r;r++)exec(r);process.title="total : cluster",n&&n(FORKS)}function message(e){if("master"===e.TYPE){if(MASTER&&MASTER[e.name])for(var t=0,s=MASTER[e.name].length;s>t;t++)MASTER[e.name][t](e.data)}else if("master"===e.target)exports.res(e);else for(var t=0,s=FORKS.length;s>t;t++)FORKS[t]&&FORKS[t].send(e)}function mastersend(e){for(var t=0,s=FORKS.length;s>t;t++)FORKS[t]&&FORKS[t].send(e)}function exec(e){var t=Cluster.fork();t.$id=e.toString(),t.on("message",message),FORKS[e]?FORKS[e]=t:FORKS.push(t),function(t){setTimeout(function(){OPTIONS.options.id=t.$id,t.send({TYPE:"init",id:t.$id,mode:OPTIONS.mode,options:OPTIONS.options,threads:OPTIONS.count,index:e})},500*t.$id)}(t)}function fork(){require("./index"),F.on("message",on_init)}function on_init(e){switch(e.TYPE){case"init":CLUSTER_EMIT.id=e.id,CLUSTER_REQ.id=e.id,CLUSTER_RES.id=e.id,THREADS=e.threads,F.http(e.mode,e.options),F.isCluster=!0,F.removeListener(e.TYPE,on_init)}}const Cluster=require("cluster"),CLUSTER_REQ={TYPE:"req"},CLUSTER_RES={TYPE:"res"},CLUSTER_EMIT={TYPE:"emit"},CLUSTER_MASTER={TYPE:"master"},FORKS=[];var OPERATIONS={},CALLBACKS={},OPTIONS={},THREADS=0,MASTER=null;exports.on=function(e,t){return!MASTER&&(MASTER={}),MASTER[e]?MASTER.push(t):MASTER[e]=[t],F},exports.emit=function(e,t){return Cluster.isMaster?(CLUSTER_EMIT.name=e,CLUSTER_EMIT.data=t,message(CLUSTER_EMIT)):F.isCluster&&(CLUSTER_EMIT.name=e,CLUSTER_EMIT.data=t,process.send(CLUSTER_EMIT)),F},exports.master=function(e,t){return F.isCluster&&(CLUSTER_MASTER.name=e,CLUSTER_MASTER.data=t,process.send(CLUSTER_MASTER)),F},exports.request=function(e,t,s,n){"function"==typeof t&&(n=s,s=t,t=null),CLUSTER_REQ.name=e,CLUSTER_REQ.data=t,CLUSTER_REQ.callback=Math.random().toString(32).substring(3);var r=CALLBACKS[CLUSTER_REQ.callback]={fn:s,response:[],id:CLUSTER_REQ.callback};return r.timeout=setTimeout(function(e){delete CALLBACKS[e.id],e.fn&&e.fn(new Error("Timeout."),e.response)},n||3e3,r),Cluster.isMaster?mastersend(CLUSTER_REQ):process.send(CLUSTER_REQ),F},exports.response=function(e,t){return OPERATIONS[e]=t,F},exports.req=function(e){return F.isCluster?(OPERATIONS[e.name]?OPERATIONS[e.name](e.data,function(t){CLUSTER_RES.data=t,CLUSTER_RES.target=e.id,CLUSTER_RES.callback=e.callback,process.send(CLUSTER_RES)},e.id):(CLUSTER_RES.target=e.id,CLUSTER_RES.data=void 0,CLUSTER_RES.callback=e.callback,process.send(CLUSTER_RES)),F):F},exports.res=function(e){var t=CALLBACKS[e.callback];t.fn&&t.response.push(e.data);var s="master"===e.target?THREADS:THREADS-1;t.response.length>=s&&(delete CALLBACKS[t.id],clearTimeout(t.timeout),t.fn&&t.fn(null,t.response))},exports.http=function(e,t,s,n){Cluster.isMaster?(CLUSTER_REQ.id="master",CLUSTER_RES.id="master",CLUSTER_EMIT.id="master",master(e,t,s,n)):fork()},exports.restart=function(e){if(void 0===e)for(var t=0;THREADS>t;t++)exports.restart(t);else{var s=FORKS[e];s&&(s.removeAllListeners(),s.disconnect(),exec(e))}};